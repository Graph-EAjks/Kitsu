import{e as p,g as f,E as h,h as m,i as _,j as k,T as y,k as g,V as v,m as d,b as c,l as n,o as l,n as o,a as b,p as C,q as T,P as S,r as $,s as M,t as x}from"./index-CyeclmpI.js";import{P as w}from"./PageLayout-rOxvU8sq.js";const L={name:"all-task-list",mixins:[p,f],components:{EntityThumbnail:h,PeopleAvatarWithMenu:m,ProductionNameCell:_,Spinner:k,TableInfo:y,TaskTypeCell:g,ValidationCell:v},data(){return{lastSelection:null,page:1,selectionGrid:{}}},props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},isMore:{type:Boolean,default:!1},isMoreLoading:{type:Boolean,default:!1},stats:{type:Object,default:()=>{}},tasks:{type:Array,default:()=>[]}},mounted(){window.addEventListener("keydown",this.onKeyDown,!1)},beforeDestroy(){window.removeEventListener("keydown",this.onKeyDown)},computed:{...d(["assetMap","editMap","episodeMap","nbSelectedTasks","personMap","user","selectedTasks","sequenceMap","shotMap","taskMap","isCurrentUserManager","isCurrentUserSupervisor","taskTypeMap"]),isTimeSpentPlural(){return Math.floor((this.stats.total_duration?this.stats.total_duration:0)/60/8)>=1},isTimeEstimatedPlural(){return Math.floor((this.stats.total_estimation?this.stats.total_estimation:0)/60/8)>=1},nbFrames(){let e=0;return this.tasks.forEach(t=>{e+=t.entity_nb_frames}),e}},methods:{...c(["addSelectedTask","addSelectedTasks","clearSelectedTasks","updateTask","unassignPersonFromTask","removeSelectedTask"]),getParentName(e){return e.sequence_name?e.episode_name?`${e.episode_name} - ${e.sequence_name}`:e.sequence_name:e.entity_type_name},getTaskName(e){return e.entity_name},getDate(e){return e?n(e,"YYYY-MM-DD").toDate():null},formatDate(e){return e?n(e).format("YYYY-MM-DD"):""},isEstimationBurned(e){return e.estimation&&e.estimation>0&&e.duration>e.estimation},onKeyDown(e){if(this.tasks.length>0&&e.altKey){let t=this.lastSelection?this.lastSelection:0;[37,38].includes(e.keyCode)?(t=t-1<0?t=this.tasks.length-1:t-1,this.selectTask({},t,this.tasks[t]),this.pauseEvent(e)):[39,40].includes(e.keyCode)&&(t=t+1>=this.tasks.length?t=0:t+1,this.selectTask({},t,this.tasks[t]),this.pauseEvent(e))}},selectTask(e,t,s){if(e&&e.target&&(["INPUT"].includes(e.target.nodeName)||e.target.parentNode&&["HEADER"].includes(e.target.parentNode.nodeName)||["cell day selected"].includes(e.target.className)))return;const a=this.selectionGrid[s.id],r=Object.keys(this.selectionGrid).length>1;this.clearSelectedTasks({task:s}),this.resetSelection(),this.selectionGrid[s.id]?(this.removeSelectedTask({task:s}),l.set(this.selectionGrid,s.id,void 0)):(!a||r)&&(this.addSelectedTask({task:s}),this.$emit("task-selected",s),l.set(this.selectionGrid,s.id,!0),this.lastSelection=t)},setScrollPosition(e){this.$refs.body&&(this.$refs.body.scrollTop=e)},resetSelection(){this.selectionGrid={},this.lastSelection=null}},watch:{tasks(){this.page=1,this.resetSelection()},nbSelectedTasks(){this.nbSelectedTasks===0&&this.resetSelection()}}};var I=function(){var t=this,s=t._self._c;return s("div",{staticClass:"data-list"},[s("div",{ref:"body",staticClass:"datatable-wrapper"},[s("table",{staticClass:"datatable"},[s("thead",{ref:"thead",staticClass:"datatable-head"},[s("tr",{staticClass:"row-header"},[s("th",{ref:"th-name",staticClass:"project"},[t._v(" "+t._s(t.$t("tasks.fields.production"))+" ")]),s("th",{ref:"th-thumbnail",staticClass:"thumbnail"}),s("th",{ref:"th-type",staticClass:"asset-type"},[t._v(" "+t._s(t.$t("tasks.fields.parent"))+" ")]),s("th",{ref:"th-name",staticClass:"name"},[t._v(" "+t._s(t.$t("tasks.fields.entity"))+" ")]),s("th",{ref:"th-name",staticClass:"name"},[t._v(" "+t._s(t.$t("tasks.fields.task_type"))+" ")]),s("th",{ref:"th-status",staticClass:"status"},[t._v(" "+t._s(t.$t("tasks.fields.task_status"))+" ")]),s("th",{ref:"th-assignees",staticClass:"assignees"},[t._v(" "+t._s(t.$t("tasks.fields.assignees"))+" ")]),s("th",{ref:"th-estimation",staticClass:"estimation number-cell",attrs:{title:t.$t("main.estimation")}},[t._v(" "+t._s(t.$t("tasks.fields.estimation").substring(0,3))+". ")]),s("th",{ref:"th-duration",staticClass:"duration number-cell"},[t._v(" "+t._s(t.$t("tasks.fields.duration").substring(0,3))+". ")]),s("th",{ref:"th-date",staticClass:"start-date"},[t._v(" "+t._s(t.$t("tasks.fields.start_date"))+" ")]),s("th",{ref:"th-date",staticClass:"due-date"},[t._v(" "+t._s(t.$t("tasks.fields.due_date"))+" ")]),s("th",{ref:"th-date",staticClass:"done-date"},[t._v(" "+t._s(t.$t("tasks.fields.done_date"))+" ")]),s("th",{ref:"",staticClass:"empty"},[t._v("Â ")])])]),s("tbody",{staticClass:"datatable-body"},t._l(t.tasks,function(a,r){return s("tr",{key:a.id,ref:"task-"+a.id,refInFor:!0,class:{"task-line":!0,"datatable-row":!0,selected:t.selectionGrid[a.id]},on:{click:function(i){return t.selectTask(i,r,a)}}},[s("td",{staticClass:"project"},[s("production-name-cell",{staticClass:"project",attrs:{entry:{id:a.project_id,name:a.project_name},"only-avatar":!0,"is-link":!1}})],1),s("td",{staticClass:"thumbnail"},[s("entity-thumbnail",{staticClass:"flexrow-item",attrs:{"preview-file-id":a.last_preview_file_id,width:50,height:33,"empty-width":50,"empty-height":33}})],1),s("td",{staticClass:"asset-type"},[t._v(" "+t._s(t.getParentName(a))+" ")]),s("td",{staticClass:"name"},[t._v(" "+t._s(a.entity_name)+" ")]),s("task-type-cell",{staticClass:"name",attrs:{"task-type":t.taskTypeMap.get(a.task_type_id)}}),s("validation-cell",{staticClass:"status unselectable",attrs:{"task-test":a,"is-border":!1,"is-assignees":!1,selectable:!1,"is-static":!0}}),s("td",{staticClass:"assignees"},[s("div",{staticClass:"flexrow"},t._l(a.assignees,function(i){return s("people-avatar-with-menu",{key:a.id+"-"+i,staticClass:"flexrow-item",attrs:{person:t.personMap.get(i),size:30,"font-size":16},on:{unassign:u=>t.onUnassign(a,u)}})}),1)]),s("td",{staticClass:"estimation number-cell"},[t._v(" "+t._s(t.formatDuration(a.estimation))+" ")]),s("td",{class:{duration:!0,"number-cell":!0,error:t.isEstimationBurned(a)}},[t._v(" "+t._s(t.formatDuration(a.duration))+" ")]),s("td",{staticClass:"start-date"},[t._v(" "+t._s(t.formatDate(a.start_date))+" ")]),s("td",{staticClass:"due-date"},[t._v(" "+t._s(t.formatDate(a.due_date))+" ")]),s("td",{staticClass:"done-date"},[t._v(" "+t._s(t.formatDate(a.done_date))+" ")]),s("td",{staticClass:"empty"})],1)}),0)]),t.isMore?s("div",{staticClass:"has-text-centered"},[t.isMoreLoading?s("spinner",{staticClass:"mt2"}):s("button",{staticClass:"button mt2",on:{click:function(a){return t.$emit("more-clicked")}}},[t._v(" "+t._s(t.$t("main.load_more"))+" ")])],1):t._e(),s("table-info",{attrs:{"is-loading":t.isLoading,"is-error":t.isError}})],1),t.isLoading?t._e():s("p",{staticClass:"has-text-centered nb-tasks"},[t._v(" "+t._s(t.stats.total)+" "+t._s(t.$tc("tasks.number",t.stats.total))+" ("+t._s(t.formatDuration(t.stats.total_estimation))+" "+t._s(t.$tc("main.days_estimated",t.isTimeEstimatedPlural))+", "+t._s(t.formatDuration(t.stats.total_duration))+" "+t._s(t.$tc("main.days_spent",t.isTimeSpentPlural))+") ")])])},P=[],E=o(L,I,P,!1,null,"68577fa6");const D=E.exports,j={name:"status-stats",props:{stats:Array},computed:{statMax(){return this.stats?this.stats.reduce((e,t)=>Math.max(t.value,e),0):0}}};var A=function(){var t=this,s=t._self._c;return s("div",{staticClass:"status-stats"},t._l(t.stats,function(a){return s("div",{key:"stat-"+a.name,staticClass:"stat-wrapper"},[s("div",{key:"stat-value-"+a.name.toLowerCase(),staticClass:"stat-line",style:{background:a.color,width:a.value/t.statMax*100+"%"},attrs:{title:a.name+": "+a.value}},[s("span",{staticClass:"stat-text"},[t._v(t._s(a.name)+" : "+t._s(a.value))])])])}),0)},N=[],B=o(j,A,N,!1,null,"c23a229f");const G=B.exports,Y={name:"all-tasks",components:{AllTaskList:D,ComboboxProduction:b,ComboboxTaskType:C,ComboboxStatus:T,PageLayout:w,PageTitle:S,PeopleField:$,StatusStats:G,TaskInfo:M},data(){return{filters:{productionId:null,taskStatusId:null,taskTypeId:null,person:null},isMore:!1,isMoreLoading:!1,isLoading:!1,isLoadingError:!1,tasks:[],stats:{status:[]}}},mounted(){const e=this.$route.query;e.project_id&&(this.filters.productionId=e.project_id),e.task_status_id&&(this.filters.taskStatusId=e.task_status_id),e.task_type_id&&(this.filters.taskTypeId=e.task_type_id),e.person_id&&(this.filters.person=this.activePeopleWithoutBot.find(t=>t.id===e.person_id)),this.reload()},computed:{...d(["activePeopleWithoutBot","getProductionTaskStatuses","getProductionTaskTypes","nbSelectedTasks","openProductions","personMap","productionMap","selectedTasks","taskStatus","taskStatusMap","taskTypes"]),taskStatusList(){const e=this.filters.productionId,t=this.getProductionTaskStatuses(e).filter(s=>!s.for_concept);return this.addAllValue(t)},taskTypeList(){const e=this.filters.productionId,t=this.getProductionTaskTypes(e).filter(s=>s.for_entity!=="Concept");return this.addAllValue(t)},personList(){const e=this.filters.productionId,t=this.productionMap.get(e);return t?x(t.team.map(s=>this.personMap.get(s)).filter(s=>s&&!s.is_bot)):this.activePeopleWithoutBot},productionList(){return this.addAllValue(this.openProductions)},params(){return{project_id:this.filters.productionId,task_status_id:this.filters.taskStatusId,task_type_id:this.filters.taskTypeId,person_id:this.filters.person?this.filters.person.id:null}},statusStats(){return[...this.stats.status].sort((e,t)=>t.amount-e.amount).map(e=>{const t=this.taskStatusMap.get(e.task_status_id);return{name:t.short_name.toUpperCase(),color:t.color,value:e.amount}})}},methods:{...c(["clearSelectedTasks","loadOpenTasks","loadTask"]),addAllValue(e){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")}].concat([...e])},async reload(){this.isLoading=!0,this.page=1,this.clearSelectedTasks(),this.tasks=[];try{const e={};Object.keys(this.params).forEach(s=>{this.params[s]&&(e[s]=this.params[s])}),this.$router.push({query:e});const t=await this.loadOpenTasks(this.params);this.tasks=t.data,this.stats=t.stats,this.isMore=t.is_more}catch(e){this.isLoadingError=!0,console.error(e)}this.isLoading=!1},loadMore(){this.isMoreLoading=!0,this.page=(this.page||1)+1;const e={...this.params,page:this.page};this.loadOpenTasks(e).then(t=>{this.tasks=this.tasks.concat(t.data),this.isMore=t.is_more,this.isMoreLoading=!1}).catch(t=>{this.isMoreLoading=!1,this.isMoreLoadingError=!0,console.error(t)})},taskClicked(e){this.$router.push({name:"Task",params:{id:e.id}})}},watch:{filters:{handler(){this.reload()},deep:!0}},socket:{events:{"task:update"(e){const t=this.tasks.find(s=>s.id===e.task_id);t&&this.loadTask({taskId:t.id}).then(s=>{Object.assign(t,s)})}}},metaInfo(){return{title:`${this.$t("tasks.all_tasks")} - Kitsu`}}};var q=function(){var t=this,s=t._self._c;return s("page-layout",{scopedSlots:t._u([{key:"main",fn:function(){return[s("div",{staticClass:"all-tasks"},[s("page-title",{staticClass:"flexrow-item title mt1",attrs:{text:t.$t("tasks.all_tasks")}}),s("div",{staticClass:"filters flexrow"},[s("combobox-production",{staticClass:"flexrow-item",attrs:{label:t.$t("main.production"),"production-list":t.productionList},model:{value:t.filters.productionId,callback:function(a){t.$set(t.filters,"productionId",a)},expression:"filters.productionId"}}),s("combobox-status",{staticClass:"flexrow-item selector",attrs:{label:t.$t("news.task_status"),"task-status-list":t.taskStatusList},model:{value:t.filters.taskStatusId,callback:function(a){t.$set(t.filters,"taskStatusId",a)},expression:"filters.taskStatusId"}}),s("combobox-task-type",{staticClass:"flexrow-item selector",attrs:{label:t.$t("news.task_type"),"task-type-list":t.taskTypeList},model:{value:t.filters.taskTypeId,callback:function(a){t.$set(t.filters,"taskTypeId",a)},expression:"filters.taskTypeId"}}),s("div",{staticClass:"flexrow-item selector"},[s("label",{staticClass:"label person-label"},[t._v(" "+t._s(t.$t("main.person"))+" ")]),s("people-field",{staticClass:"person-field",attrs:{big:"",people:t.personList},model:{value:t.filters.person,callback:function(a){t.$set(t.filters,"person",a)},expression:"filters.person"}})],1)],1),s("all-task-list",{attrs:{tasks:t.tasks,stats:t.stats,"is-loading":t.isLoading,"is-error":t.isLoadingError,"is-more":t.isMore,"is-more-loading":t.isMoreLoading},on:{"task-clicked":t.taskClicked,"more-clicked":t.loadMore}})],1)]},proxy:!0},{key:"side",fn:function(){return[s("task-info",{attrs:{task:t.selectedTasks.values().next().value}},[s("status-stats",{attrs:{stats:t.statusStats}})],1)]},proxy:!0}])})},F=[],O=o(Y,q,F,!1,null,"ed4eca7d");const U=O.exports;export{U as default};
//# sourceMappingURL=AllTasks-pnFjNntu.js.map
