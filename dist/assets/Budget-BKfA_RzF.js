import{a as Y,_ as D,r as m,c,o as l,e as o,d as x,t as d,f as g,u as $,B as S,an as K,m as T,a2 as H,aC as z,aD as G,aE as J,aF as W,y as Z,ay as j,F as C,g as M,G as k,k as E,aa as I,aG as Q,n as X,a6 as O,a8 as A,b as U,j as F,w as V,ab as L,l as N,Z as tt,az as v,aB as et,I as nt,L as st,aH as B,aI as rt,aJ as ot,am as it,ac as dt,ae as at}from"./index-CvjDftx2.js";import{g as lt}from"./grablist-Da7oVI-6.js";import{P as ut}from"./PageLayout-DKjL4qDt.js";const ct={computed:{...Y(["currentProduction, currentEpisode, isTVShow"])},methods:{},head(){return this.currentProduction?this.isTVSHow&&this.currentEpisode?{title:`${this.currentProduction.name} - ${this.currentEpisode.name} | {this.pageTitle} - Kitsu`}:{title:`${this.currentProduction.name} | ${this.pageTitle} - Kitsu`}:{title:`${this.pageTitle} - Kitsu`}}},gt={class:"flexcolumn analytics-container"},mt={class:"has-text-centered strong mt1"},ht={key:0},bt={class:"has-text-centered mt1 strong total"},pt={class:"has-text-centered mt1"},ft={key:1},yt={class:"has-text-centered mt2"},_t={key:2,class:"mt1 flexcolumn"},Bt={__name:"BudgetAnalytics",props:{amount:{type:Number,default:0},currency:{type:String,default:"USD"},budgets:{type:Array,required:!0},budgetDepartments:{type:Array,required:!0},budgetEntries:{type:Array,required:!0},monthsBetweenProductionDates:{type:Array,required:!0},pieChartData:{type:Array,required:!0},pieChartColors:{type:Array,required:!0},columnChartData:{type:Array,required:!0}},setup(t){return(e,n)=>{const i=m("pie-chart"),s=m("column-chart");return l(),c("div",gt,[o("h3",mt,d(e.$t("budget.analytics")),1),t.budgets.length>0&&t.budgetDepartments.length>0?(l(),c("div",ht,[o("p",bt,d(t.amount.toLocaleString())+" "+d(t.currency||"USD"),1),o("p",pt,d(t.budgetDepartments.length)+" "+d(e.$t("budget.departments"))+" - "+d(t.budgetEntries.length)+" "+d(e.$t("budget.entries"))+" - "+d(t.monthsBetweenProductionDates.length)+" "+d(e.$t("budget.months")),1)])):x("",!0),t.budgets.length===0||t.budgetDepartments.length===0?(l(),c("div",ft,[o("p",yt,d(e.$t("budget.no_analytics_to_show")),1)])):(l(),c("div",_t,[o("h4",null,d(e.$t("budget.cash_repartition")),1),g(i,{class:"mb1",legend:!1,data:t.pieChartData,colors:t.pieChartColors,height:"240px"},null,8,["data","colors"]),o("h4",null,d(e.$t("budget.cash_evolution")),1),g(s,{legend:!1,data:t.columnChartData},null,8,["data"])]))])}}},Et=D(Bt,[["__scopeId","data-v-bbb03d69"]]),vt={class:"budget-header"},Dt={key:0,class:"has-text-centered"},Ct={key:1,class:"flexrow mt2"},wt={class:"list-error"},Pt={key:2,class:"no-budget has-text-centered mt2"},Mt={class:"mt1 has-text-centered create-budget-button"},kt={key:3,class:"flexrow mt1"},St={class:"selected-budget flexrow-item"},xt={__name:"BudgetHeader",props:{budgets:{type:Array,default:()=>[]},budgetOptions:{type:Array,default:()=>[]},budget:{type:Object},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["change-budget","delete-budget","edit-budget","new-version","export-budget"],setup(t){return(e,n)=>(l(),c("div",vt,[t.isLoading?(l(),c("div",Dt,[g($)])):t.isError?(l(),c("div",Ct,[o("p",wt,d(e.$t("budget.budgets_error")),1)])):!t.budget||!t.budget.id?(l(),c("div",Pt,[o("p",null,d(e.$t("budget.no_budget_found")),1),o("p",Mt,[g(S,{text:e.$t("budget.create_budget"),"is-big":"",onClick:n[0]||(n[0]=i=>e.$emit("new-version"))},null,8,["text"])])])):(l(),c("div",kt,[o("h3",St,[g(K,{options:t.budgetOptions,value:t.budget,onChange:n[1]||(n[1]=i=>e.$emit("change-budget",i))},null,8,["options","value"])]),g(S,{class:"mr05",title:e.$t("budget.edit_budget"),icon:"pencil",onClick:n[2]||(n[2]=i=>e.$emit("edit-budget"))},null,8,["title"]),g(S,{class:"mr05",title:e.$t("budget.delete_budget"),icon:"trash",onClick:n[3]||(n[3]=i=>e.$emit("delete-budget"))},null,8,["title"]),n[6]||(n[6]=o("div",{class:"filler"},null,-1)),g(S,{class:"flexrow-item",icon:"export",title:e.$t("main.csv.export_file"),onClick:n[4]||(n[4]=i=>e.$emit("export-budget"))},null,8,["title"]),g(S,{text:e.$t("budget.new_version"),icon:"plus",onClick:n[5]||(n[5]=i=>e.$emit("new-version"))},null,8,["text"])]))]))}},Yt=D(xt,[["__scopeId","data-v-9a5e1a8f"]]),Vt={name:"budget-list",mixins:[Z,lt],emits:["add-budget-entry","delete-budget-entry","edit-budget-entry"],components:{ButtonSimple:S,ChevronDownIcon:W,ChevronRightIcon:J,PeopleName:G,PeopleAvatar:z,RowActionsCell:H,Spinner:$},props:{budgetEntries:{type:Array,default:()=>[]},budgetDepartments:{type:Array,default:()=>[]},currency:{type:String,default:"USD"},currentBudget:{type:Object,default:()=>{}},monthsBetweenProductionDates:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},totalEntry:{type:Object,default:()=>({})}},data(){return{collapsedDepartments:{},domEvents:[["mousemove",this.onMouseMove],["touchmove",this.onMouseMove],["mouseup",this.stopBrowsing],["mouseleave",this.stopBrowsing],["touchend",this.stopBrowsing],["touchcancel",this.stopBrowsing],["keyup",this.stopBrowsing]]}},mounted(){const t=`budget:collapsed-departments-${this.currentProduction.id}`;this.addEvents(this.domEvents),this.collapsedDepartments=j.getObjectPreference(t)||{}},beforeUnmount(){this.removeEvents(this.domEvents),document.body.style.cursor="default"},computed:{...Y(["currentProduction","departmentMap","personMap"])},methods:{...T(["updateProductionBudgetEntry"]),getMonthCost(t,e){const n=e.format("YYYY-MM");return t.exceptions=t.exceptions||{},parseInt(t.exceptions[n])||parseInt(t.monthCosts[n])||0},toggleDepartment(t){this.collapsedDepartments[t]=!this.collapsedDepartments[t];const e=`budget:collapsed-departments-${this.currentProduction.id}`;j.setObjectPreference(e,this.collapsedDepartments)},getDepartmentStyle(t,e){return{backgroundColor:this.departmentMap.get(t).color+e}},addPersonException(t,e,n){const i=t.exceptions||{};i[e.format("YYYY-MM")]=n;const s={id:t.budget_entry_id,...t,exceptions:i};this.updateProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntryId:t.budget_entry_id,budgetEntry:s})}}},Tt={class:"budget-data"},It={key:0,class:"has-text-centered mt2"},jt={key:1,class:"flexrow mt2"},$t={class:"list-error"},Ot={key:2,class:"mt2"},At={class:"has-text-centered mt1"},Ut={class:"has-text-centered mt1"},Ft={key:3,class:"data-list filler"},Lt={ref:"body",class:"datatable-wrapper flexcolumn filler"},Nt={class:"datatable"},Rt={class:"datatable-head"},qt={class:"datatable-row-header department-header-header",colspan:"3"},Kt={class:"flexrow"},Ht={class:"flexrow-item"},zt={class:"datatable-row-header base-salary-header month"},Gt={class:"datatable-row-header duration-header month"},Jt={class:"datatable-row-header has-text-right"},Wt={class:"datatable-row"},Zt={class:"datatable-row-header total-header",colspan:"3"},Qt={class:"pa05"},Xt={class:"total-cost"},te=["onClick"],ee={class:"datatable-row-header strong department-header",colspan:"3"},ne={class:"flexrow-item"},se={class:"position datatable-row-header"},re={class:"seniority datatable-row-header"},oe={class:"name datatable-row-header"},ie={class:"flexrow"},de={key:2,class:"new-hiring"},ae={class:"base-salary-header text-right entry-data"},le={class:"duration-header text-right entry-data"},ue=["value","onChange"],ce={key:1},ge={class:"total-cost"};function me(t,e,n,i,s,r){const h=m("spinner"),b=m("button-simple"),f=m("chevron-right-icon"),y=m("chevron-down-icon"),_=m("people-avatar"),p=m("people-name"),w=m("row-actions-cell");return l(),c("div",Tt,[n.isLoading?(l(),c("div",It,[g(h)])):n.isError?(l(),c("div",jt,[o("p",$t,d(t.$t("budget.budget_entries_error")),1)])):n.budgetDepartments.length===0?(l(),c("div",Ot,[o("p",At,d(t.$t("budget.no_budget_entries_found")),1),o("p",Ut,[g(b,{text:t.$t("budget.add_entry"),onClick:e[0]||(e[0]=u=>t.$emit("add-budget-entry"))},null,8,["text"])])])):(l(),c("div",Ft,[o("div",Lt,[o("table",Nt,[o("thead",Rt,[o("tr",null,[o("th",qt,[o("div",Kt,[o("div",Ht,d(t.$t("budget.fields.department")),1),e[4]||(e[4]=o("div",{class:"filler"},null,-1)),g(b,{text:t.$t("budget.add_entry"),"is-thin":"",onClick:e[1]||(e[1]=u=>t.$emit("add-budget-entry"))},null,8,["text"])])]),o("th",zt,d(t.$t("budget.fields.base_salary")),1),o("th",Gt,d(t.$t("budget.fields.duration")),1),(l(!0),c(C,null,M(n.monthsBetweenProductionDates,u=>(l(),c("th",{key:u,class:"month datatable-row-header"},d(u.month()===0?u.format("MMM / YY"):u.format("MMM")),1))),128)),o("th",Jt,d(t.$t("main.total"))+" ("+d(n.currency)+") ",1),e[5]||(e[5]=o("th",{class:"actions datatable-row-header"},null,-1))])]),o("tbody",{class:"datatable-body",onMousedown:e[2]||(e[2]=(...u)=>t.startBrowsing&&t.startBrowsing(...u)),onTouchstart:e[3]||(e[3]=(...u)=>t.startBrowsing&&t.startBrowsing(...u))},[o("tr",Wt,[o("td",Zt,[o("div",Qt,d(t.$t("main.total")),1)]),e[6]||(e[6]=o("td",{class:"month"},null,-1)),e[7]||(e[7]=o("td",{class:"month"},null,-1)),(l(!0),c(C,null,M(n.monthsBetweenProductionDates,u=>(l(),c("td",{key:u,class:"month"},d(n.totalEntry.monthCosts[u.format("YYYY-MM")]?.toLocaleString()),1))),128)),o("td",Xt,d(n.totalEntry.total.toLocaleString()),1),e[8]||(e[8]=o("td",{class:"actions"},null,-1))]),(l(!0),c(C,null,M(n.budgetDepartments,u=>(l(),c(C,{key:u.id},[o("tr",{class:"datatable-row department-row pointer",onClick:a=>r.toggleDepartment(u.id)},[o("td",ee,[o("div",{class:"flexrow department-header-content",style:k(r.getDepartmentStyle(u.id,"99"))},[s.collapsedDepartments[u.id]?(l(),E(f,{key:0,class:"flexrow-item"})):(l(),E(y,{key:1,class:"flexrow-item"})),o("div",ne,d(t.departmentMap.get(u.id).name),1)],4)]),o("td",{class:"base-salary-header text-right month",style:k(r.getDepartmentStyle(u.id,"33"))},null,4),o("td",{class:"duration-header text-right month",style:k(r.getDepartmentStyle(u.id,"33"))},null,4),(l(!0),c(C,null,M(n.monthsBetweenProductionDates,a=>(l(),c("td",{key:a,class:"month",style:k(r.getDepartmentStyle(u.id,"33"))},d(u.monthCosts[a.format("YYYY-MM")]?.toLocaleString()),5))),128)),o("td",{class:"total-cost",style:k(r.getDepartmentStyle(u.id,"33"))},d(u.total.toLocaleString()),5),o("td",{class:"actions",style:k(r.getDepartmentStyle(u.id,"33"))},null,4)],8,te),s.collapsedDepartments[u.id]?x("",!0):(l(!0),c(C,{key:0},M(u.persons,a=>(l(),c("tr",{class:"datatable-row",key:a.id},[o("td",se,d(t.$t("budget.positions."+a.position||"artist")),1),o("td",re,d(t.$t("budget.seniorities."+a.seniority||"junior")),1),o("td",oe,[o("div",ie,[a.person_id?(l(),E(_,{key:0,class:"flexrow-item",person:t.personMap.get(a.person_id),"is-link":!1,"font-size":12,size:20},null,8,["person"])):x("",!0),a.person_id?(l(),E(p,{key:1,person:t.personMap.get(a.person_id)},null,8,["person"])):(l(),c("span",de,d(t.$t("budget.new_hiring")),1))])]),o("td",ae,d((a.monthly_salary||0).toLocaleString()),1),o("td",le,d(a.months_duration),1),(l(!0),c(C,null,M(n.monthsBetweenProductionDates,P=>(l(),c("td",{key:P,class:"month"},[a.monthCosts[P.format("YYYY-MM")]?(l(),c("input",{key:0,class:"input-editor",type:"number",min:"0",step:"1",value:r.getMonthCost(a,P),onChange:q=>r.addPersonException(a,P,q.target.value)},null,40,ue)):(l(),c("span",ce," "))]))),128)),o("td",ge,d(a.total.toLocaleString()),1),g(w,{class:"actions","entry-id":a.id,"hide-avatar":!0,"hide-change-password":!0,"hide-delete":!1,"hide-refresh":!0,onDeleteClicked:P=>t.$emit("delete-budget-entry",a),onEditClicked:P=>t.$emit("edit-budget-entry",a)},null,8,["entry-id","onDeleteClicked","onEditClicked"])]))),128))],64))),128))],32)])],512)]))])}const he=D(Vt,[["render",me],["__scopeId","data-v-55ddb855"]]),be={name:"base-modal",mixins:[I],emits:["cancel"],components:{},props:{active:{type:Boolean,default:!1},title:{type:String,default:""}},data(){return{}},methods:{onBackgroundClicked(){this.$emit("cancel")}},watch:{}},pe={class:"modal-content"},fe={class:"box"},ye={class:"title"};function _e(t,e,n,i,s,r){return l(),c("div",{class:X({modal:!0,"is-active":n.active})},[o("div",{class:"modal-background",onClick:e[0]||(e[0]=(...h)=>r.onBackgroundClicked&&r.onBackgroundClicked(...h))}),o("div",pe,[o("div",fe,[o("h1",ye,d(n.title),1),Q(t.$slots,"default",{},void 0,!0)])])],2)}const R=D(be,[["render",_e],["__scopeId","data-v-f749bbb4"]]),Be={name:"edit-budget-modal",mixins:[I],components:{BaseModal:R,Combobox:U,ModalFooter:A,TextField:O},props:{active:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},budgetToEdit:{type:Object,default:()=>{}},lastRevision:{type:Number,default:1}},emits:["cancel","confirm"],data(){return{form:{name:"",currency:"USD"},currencieOptions:[{label:"USD",value:"USD"},{label:"EUR",value:"EUR"},{label:"GBP",value:"GBP"},{label:"CAD",value:"CAD"},{label:"AUD",value:"AUD"},{label:"CHF",value:"CHF"},{label:"JPY",value:"JPY"},{label:"CNY",value:"CNY"},{label:"INR",value:"INR"}]}},computed:{...Y([]),isDisabled(){return this.form.name.length===0},isEditing(){return this.budgetToEdit&&this.budgetToEdit.id},modalTitle(){return this.isEditing?this.$t("budget.edit_budget"):this.$t("budget.create_budget")}},methods:{...T([""]),runConfirmation(){this.$emit("confirm",this.form)}},watch:{active(){this.active&&setTimeout(()=>{this.$refs.nameField.focus()},100)},budgetToEdit(){this.budgetToEdit.id?this.form={id:this.budgetToEdit.id,name:this.budgetToEdit.name,currency:this.budgetToEdit.currency||"USD"}:this.form={id:null,name:"",currency:"USD"}}}},Ee={class:"field"},ve={class:"label"},De={class:"revision-number"};function Ce(t,e,n,i,s,r){const h=m("text-field"),b=m("combobox"),f=m("modal-footer"),y=m("base-modal"),_=F("focus");return l(),E(y,{active:n.active,title:r.modalTitle,onCancel:e[4]||(e[4]=p=>t.$emit("cancel"))},{default:V(()=>[o("form",{onSubmit:e[2]||(e[2]=L(()=>{},["prevent"]))},[o("div",Ee,[o("label",ve,d(t.$t("budget.fields.revision")),1),o("p",De," v"+d(r.isEditing?n.budgetToEdit.revision:n.lastRevision+1),1)]),N(g(h,{ref:"nameField",label:t.$t("budget.fields.name"),maxlength:30,modelValue:s.form.name,"onUpdate:modelValue":e[0]||(e[0]=p=>s.form.name=p),onEnter:r.runConfirmation},null,8,["label","modelValue","onEnter"]),[[_]]),g(b,{label:t.$t("budget.fields.currency"),options:s.currencieOptions,modelValue:s.form.currency,"onUpdate:modelValue":e[1]||(e[1]=p=>s.form.currency=p)},null,8,["label","options","modelValue"])],32),g(f,{"error-text":t.$t("budget.create_budget_error"),"is-error":n.isError,"is-loading":n.isLoading,"is-disabled":r.isDisabled,onConfirm:r.runConfirmation,onCancel:e[3]||(e[3]=p=>t.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-disabled","onConfirm"])]),_:1},8,["active","title"])}const we=D(Be,[["render",Ce],["__scopeId","data-v-dddfe419"]]),Pe={name:"month-field",emits:["update:modelValue"],components:{ComboboxNumber:tt},props:{label:{type:String,default:""},minDate:{type:Date,required:!0},maxDate:{type:Date,required:!0},modelValue:{}},data(){return{selectedMonth:null,selectedYear:null,months:[]}},mounted(){this.months=et(1,12).map(t=>({value:t-1,label:v().month(t-1).format("MMMM")})),this.modelValue&&this.modelValue.getMonth&&(this.selectedMonth=this.modelValue.getMonth(),this.selectedYear=this.modelValue.getFullYear())},computed:{availableYears(){const t=[],e=this.minDate.getFullYear(),n=this.maxDate.getFullYear();for(let i=e;i<=n;i++)t.push(i);return t.map(i=>({value:i,label:i}))},availableMonths(){const t=this.selectedYear||this.availableYears[0].value,e=this.minDate.getFullYear(),n=this.maxDate.getFullYear(),i=this.minDate.getMonth(),s=this.maxDate.getMonth();return this.months.filter(r=>t===e&&t===n?r.value>=i&&r.value<=s:t===e?r.value>=i:t===n?r.value<=s:!0).map(r=>({value:r.value,label:r.label}))}},watch:{modelValue(){this.$options.silent=!0,this.modelValue&&this.modelValue.getMonth&&(this.selectedMonth=this.modelValue.getMonth(),this.selectedYear=this.modelValue.getFullYear()),this.$nextTick(()=>{this.$options.silent=!1})},selectedMonth(t){if(this.$options.silent)return;const e=v(new Date(this.selectedYear,t,1,0,0,0,0));this.$emit("update:modelValue",e.startOf("month").toDate())},selectedYear(t){this.$options.silent||this.$nextTick(()=>{this.selectedMonth=this.availableMonths[0].value;const e=v(new Date(t,this.selectedMonth,1,0,0,0,0));this.$emit("update:modelValue",e.startOf("month").toDate())})}}},Me={class:"month-field flexcolumn"},ke={key:0,class:"label"},Se={class:"date-selector"};function xe(t,e,n,i,s,r){const h=m("combobox-number");return l(),c("div",Me,[n.label.length>0?(l(),c("label",ke,d(n.label),1)):x("",!0),o("div",Se,[g(h,{options:r.availableYears,modelValue:s.selectedYear,"onUpdate:modelValue":e[0]||(e[0]=b=>s.selectedYear=b)},null,8,["options","modelValue"]),g(h,{options:r.availableMonths,modelValue:s.selectedMonth,"onUpdate:modelValue":e[1]||(e[1]=b=>s.selectedMonth=b)},null,8,["options","modelValue"])])])}const Ye=D(Pe,[["render",xe],["__scopeId","data-v-9914ab8b"]]),Ve={name:"edit-budget-entry-modal",mixins:[I],components:{BaseModal:R,Combobox:U,ComboboxDepartment:st,ModalFooter:A,MonthField:Ye,PeopleField:nt,TextField:O},props:{active:{type:Boolean,default:!1},budgetEntryToEdit:{type:Object,default:()=>{}},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},salaryScale:{type:Object,default:()=>{}}},emits:["cancel","confirm"],data(){return{form:{department_id:"",person:null,position:"artist",seniority:"junior",start_date:null,months_duration:1},positionOptions:[{label:"artist",value:"artist"},{label:"supervisor",value:"supervisor"},{label:"lead",value:"lead"}],refreshKeys:{endMonth:0,monthlySalary:0,totalSalary:0},seniorityOptions:[{label:"junior",value:"junior"},{label:"mid",value:"mid"},{label:"senior",value:"senior"}]}},mounted(){this.resetForm()},computed:{...Y(["activePeople","currentProduction","personMap"]),isDisabled(){return!this.form.department_id||this.form.months_duration<1},isEditing(){return this.budgetEntryToEdit&&this.budgetEntryToEdit.id},projectStartDate(){return B(this.currentProduction.start_date).toDate()},projectEndDate(){return B(this.currentProduction.end_date).toDate()},endMonth(){this.refreshKeys.endMonth;const t=B(this.form.start_date),e=B(this.currentProduction.end_date);let n=t.add(this.form.months_duration,"months");return n=v.min(n,e),n.format("YYYY-MM")},dailySalary(){return this.form.department_id?!this.form.person||!this.form.person.daily_salary?this.salaryScale[this.form.department_id][this.form.position||"artist"][this.form.seniority||"junior"].salary:this.form.person.daily_salary:0},monthlySalary(){return this.dailySalary*20},totalSalary(){if(this.form.department_id){const t=Math.min(this.form.months_duration,this.maxDuration);return this.monthlySalary*t}else return 0},maxDuration(){const t=B(this.form.start_date),n=B(this.currentProduction.end_date).endOf("month").diff(t,"months");return n>0?n:1},departmentPeople(){return this.form.department_id?this.activePeople.filter(t=>t.departments.includes(this.form.department_id)):this.activePeople}},methods:{...T([""]),runConfirmation(){this.$emit("confirm",{...this.form,person_id:this.form.person?.id,duration:Math.min(this.form.months_duration,this.maxDuration),salary:this.monthlySalary,total_salary:this.totalSalary})},onPersonChanged(t){t?(this.form.position=t.position||"artist",this.form.seniority=t.seniority||"junior"):(this.form.position="artist",this.form.seniority="junior")},formatDate(t){return rt(t)},resetForm(){if(this.isEditing){const t=this.personMap.get(this.budgetEntryToEdit.person_id);Object.assign(this.form,{id:this.budgetEntryToEdit.id,department_id:this.budgetEntryToEdit.department_id,person:t,position:this.budgetEntryToEdit.position||"artist",seniority:this.budgetEntryToEdit.seniority||"junior",start_date:B(this.budgetEntryToEdit.start_date).toDate(),months_duration:this.budgetEntryToEdit.months_duration,daily_salary:this.budgetEntryToEdit.daily_salary}),this.form.person=t,this.$nextTick(()=>{this.form.daily_salary=this.budgetEntryToEdit.daily_salary})}else this.form={id:null,department_id:"",person:null,position:"artist",seniority:"junior",start_date:B(this.currentProduction.start_date).startOf("month").toDate(),months_duration:1,daily_salary:0}}},watch:{active(){this.active&&(this.resetForm(),setTimeout(()=>{this.$refs.departmentField.focus()},100))},dailySalary(){this.form.daily_salary=this.dailySalary},budgetEntryToEdit(){this.resetForm()}}},Te={class:"flexrow"},Ie={class:"mt0"},je={class:"salary-label"},$e={class:"salary-value"},Oe={class:"salary-label"},Ae={class:"salary-value"},Ue={class:"salary-label"},Fe={class:"salary-value"},Le={class:"salary-label"},Ne={class:"salary-value"};function Re(t,e,n,i,s,r){const h=m("combobox-department"),b=m("people-field"),f=m("combobox"),y=m("month-field"),_=m("text-field"),p=m("modal-footer"),w=m("base-modal"),u=F("focus");return l(),E(w,{active:n.active,title:r.isEditing?t.$t("budget.edit_budget_entry"):t.$t("budget.add_entry"),onCancel:e[9]||(e[9]=a=>t.$emit("cancel"))},{default:V(()=>[o("form",{onSubmit:e[7]||(e[7]=L(()=>{},["prevent"]))},[N(g(h,{ref:"departmentField",label:t.$t("budget.fields.department"),modelValue:s.form.department_id,"onUpdate:modelValue":e[0]||(e[0]=a=>s.form.department_id=a),onEnter:r.runConfirmation},null,8,["label","modelValue","onEnter"]),[[u]]),g(b,{class:"mt2",label:t.$t("budget.fields.person"),people:r.departmentPeople,onSelect:r.onPersonChanged,onEnter:r.runConfirmation,modelValue:s.form.person,"onUpdate:modelValue":e[1]||(e[1]=a=>s.form.person=a)},null,8,["label","people","onSelect","onEnter","modelValue"]),g(f,{class:"mt2",label:t.$t("budget.fields.position"),options:s.positionOptions,"locale-key-prefix":"people.position.",modelValue:s.form.position,"onUpdate:modelValue":e[2]||(e[2]=a=>s.form.position=a),onEnter:r.runConfirmation},null,8,["label","options","modelValue","onEnter"]),g(f,{class:"mt2",label:t.$t("budget.fields.seniority"),options:s.seniorityOptions,"locale-key-prefix":"people.seniority.",modelValue:s.form.seniority,"onUpdate:modelValue":e[3]||(e[3]=a=>s.form.seniority=a),onEnter:r.runConfirmation},null,8,["label","options","modelValue","onEnter"]),o("div",Te,[g(y,{class:"mr1",label:t.$t("budget.fields.start_date"),"min-date":r.projectStartDate,"max-date":r.projectEndDate,modelValue:s.form.start_date,"onUpdate:modelValue":e[4]||(e[4]=a=>s.form.start_date=a)},null,8,["label","min-date","max-date","modelValue"]),g(_,{class:"month-duration",type:"number",min:1,max:r.maxDuration,label:t.$t("budget.fields.months_duration"),modelValue:s.form.months_duration,"onUpdate:modelValue":e[5]||(e[5]=a=>s.form.months_duration=a),onEnter:r.runConfirmation},null,8,["max","label","modelValue","onEnter"]),g(_,{class:"month-duration",type:"number",min:0,label:t.$t("budget.fields.daily_salary"),modelValue:s.form.daily_salary,"onUpdate:modelValue":e[6]||(e[6]=a=>s.form.daily_salary=a),onEnter:r.runConfirmation},null,8,["label","modelValue","onEnter"])]),o("div",Ie,[o("span",je,d(t.$t("budget.fields.start_date")),1),o("span",$e,d(r.formatDate(s.form.start_date).substring(0,7)),1),e[10]||(e[10]=o("br",null,null,-1)),o("span",Oe,d(t.$t("budget.fields.end_date")),1),o("span",Ae,d(r.endMonth),1),e[11]||(e[11]=o("br",null,null,-1)),o("span",Ue,d(t.$t("budget.fields.monthly_salary")),1),o("span",Fe,d(r.monthlySalary),1),e[12]||(e[12]=o("br",null,null,-1)),o("span",Le,d(t.$t("budget.fields.total_salary")),1),o("span",Ne,d(r.totalSalary),1)])],32),g(p,{"error-text":t.$t("budget.create_budget_error"),"is-error":n.isError,"is-loading":n.isLoading,"is-disabled":r.isDisabled,onConfirm:r.runConfirmation,onCancel:e[8]||(e[8]=a=>t.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-disabled","onConfirm"])]),_:1},8,["active","title"])}const qe=D(Ve,[["render",Re],["__scopeId","data-v-13f1e48c"]]),Ke={resetDepartmentTotals(t){t.total=t.persons.reduce((e,n)=>e+n.total,0),t.monthCosts=t.persons.reduce((e,n)=>(Object.keys(n.monthCosts).forEach(i=>{e[i]=(e[i]||0)+n.monthCosts[i]}),e),{})}},He={name:"budget",mixins:[ct],components:{BudgetAnalytics:Et,BudgetHeader:Yt,BudgetList:he,DeleteModal:dt,EditBudgetEntryModal:qe,EditBudgetModal:we,HardDeleteModal:it,PageLayout:ut},data(){return{budgets:[],budgetEntries:[],budgetEntryToEdit:{},budgetOptions:[],budgetToEdit:{},currentBudget:{},errors:{budgets:!1,createBudget:!1,editBudget:!1,editBudgetEntry:!1,entries:!1,deleteBudget:!1,deleteBudgetEntry:!1},loading:{budgets:!0,createBudget:!1,editBudget:!1,editBudgetEntry:!1,entries:!0,deleteBudget:!1,deleteBudgetEntry:!1},modals:{createBudget:!1,createBudgetEntry:!1,editBudgetEntry:!1,deleteBudget:!1,deleteBudgetEntry:!1},monthsBetweenProductionDates:[],salaryScale:{}}},async mounted(){this.pageTitle=this.$t("budget.title"),await this.setSalaryScale(),await this.loadBudgets(),await this.loadBudgetEntries(),this.monthsBetweenProductionDates=this.getMonthsBetweenDates(this.currentProduction.start_date,this.currentProduction.end_date)},computed:{...Y(["currentProduction","departments","departmentMap","personMap"]),lastRevision(){return this.budgets.length>0?this.budgets[0].revision:0},budgetDepartments(){const t=new Set(this.budgetEntries.map(n=>n.department_id)),e=[];return Array.from(t).map(n=>{const i=this.budgetEntries.filter(r=>r.department_id===n),s={id:n,monthCosts:{},total:0,duration:0,persons:[],start_date:null};i.forEach(r=>{const h=r.daily_salary*20,b={};let f=0;r.exceptions=r.exceptions||{};for(let p=0;p<r.months_duration;p++){const u=v(r.start_date).add(p,"month").format("YYYY-MM"),a=r.exceptions[u]||h;b[u]=a,f+=a}s.persons.push({id:r.id,person_id:r.person_id,budget_entry_id:r.id,department_id:r.department_id,monthCosts:b,position:r.position,seniority:r.seniority,total:f,months_duration:r.months_duration,monthly_salary:h,daily_salary:r.daily_salary,start_date:r.start_date,exceptions:r.exceptions});const y=v(r.start_date),_=v(s.start_date);(!s.start_date||y.isBefore(_))&&(s.start_date=r.start_date),s.persons.sort(this.sortDepartmentPersons)}),Ke.resetDepartmentTotals(s),e.push(s)}),e.sort((n,i)=>{const s=this.departmentMap.get(n.id),r=this.departmentMap.get(i.id);return s.name.localeCompare(r.name)}),e},totalEntry(){const t=this.budgetDepartments.reduce((n,i)=>n+i.total,0),e=this.budgetDepartments.reduce((n,i)=>(Object.keys(i.monthCosts).forEach(s=>{n[s]=(n[s]||0)+i.monthCosts[s]}),n),{});return{total:t,monthCosts:e}},pieChartData(){return this.budgetDepartments.map(t=>[this.departmentMap.get(t.id).name,t.total])},pieChartColors(){return this.budgetDepartments.map(t=>this.departmentMap.get(t.id).color)},columnChartData(){return this.monthsBetweenProductionDates.map(t=>{const e=t.format("YYYY-MM"),[n,i]=e.split("-");return[`${i}/${n.slice(2)}`,this.totalEntry.monthCosts[e]||0]})}},methods:{...T(["createProductionBudgetEntry","createProductionBudget","deleteProductionBudget","deleteProductionBudgetEntry","loadProductionBudget","loadProductionBudgets","loadProductionBudgetEntry","loadProductionBudgetEntries","loadSalaryScale","updateProductionBudget","updateProductionBudgetEntry"]),formatMonth:ot,sortDepartmentPersons(t,e){const n={junior:1,mid:2,senior:3},i={artist:1,lead:2,supervisor:3},s=n[t.seniority],r=n[e.seniority],h=i[t.position],b=i[e.position];if(t.person_id===null&&e.person_id===null)return h===b?r-s:b-h;if(t.person_id===null)return 1;if(e.person_id===null)return-1;{const f=this.personMap.get(t.person_id),y=this.personMap.get(e.person_id);return f.name===y.name?h===b?r-s:b-h:f.name.localeCompare(y.name)}},async setSalaryScale(){this.salaryScale=await this.loadSalaryScale()},onChangeBudget(t){this.currentBudget=t},onEditBudgetClicked(){this.budgetToEdit=this.currentBudget,this.modals.createBudget=!0},onExportBudgetClicked(){const t=[this.$t("budget.title").toLowerCase(),this.currentProduction.name,`v${this.currentBudget.revision}`,this.currentBudget.name,this.currentBudget.currency];at.generateBudget(this.$t,this.departmentMap,this.personMap,t,this.currentBudget.currency,this.monthsBetweenProductionDates,this.totalEntry,this.budgetDepartments)},onNewBudgetVersionClicked(){this.budgetToEdit={},this.modals.createBudget=!0},async createBudget(t){try{if(this.loading.createBudget=!0,t.id){await this.updateProductionBudget({productionId:this.currentProduction.id,budget:{id:this.currentBudget.id,name:t.name,currency:t.currency}});const e=this.budgets.find(n=>n.id===this.currentBudget.id);e&&Object.assign(e,{name:t.name,currency:t.currency})}else{this.loading.createBudget=!0;const e=await this.createProductionBudget({productionId:this.currentProduction.id,budget:t});this.budgets.unshift(e),this.currentBudget=e}this.resetBudgetOptions(),this.modals.createBudget=!1}catch(e){console.error(e),this.errors.createBudget=!0}finally{this.loading.createBudget=!1}},onDeleteBudgetClicked(){this.errors.deleteBudget=!1,this.modals.deleteBudget=!0},async deleteBudget(){this.loading.deleteBudget=!0;try{await this.deleteProductionBudget({productionId:this.currentProduction.id,budgetId:this.currentBudget.id}),this.postDeleteBudget(this.currentBudget),this.modals.deleteBudget=!1}catch(t){console.error(t),this.errors.deleteBudget=!0}finally{this.loading.deleteBudget=!1}},postDeleteBudget(t){this.budgets=this.budgets.filter(e=>e.id!==t.id),this.resetBudgetOptions(),this.budgets.length>0?this.currentBudget=this.budgets[0]:this.currentBudget={}},onAddBudgetEntry(){this.budgetEntryToEdit={},this.modals.createBudgetEntry=!0},async confirmCreateBudgetEntry(t){t.id?await this.runRemoteBudgetEntryEdition(t):await this.runRemoteBudgetEntryCreation(t)},async runRemoteBudgetEntryCreation(t){try{this.loading.createBudgetEntry=!0,await this.createProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntry:{...t,person_id:t.person?t.person.id:null}}),this.modals.createBudgetEntry=!1}catch(e){console.error(e),this.errors.createBudgetEntry=!0}finally{this.loading.createBudgetEntry=!1}},editBudgetEntry(t){this.budgetEntryToEdit=t,this.modals.createBudgetEntry=!0},async runRemoteBudgetEntryEdition(t){try{this.loading.editBudgetEntry=!0,this.errors.editBudgetEntry=!1,await this.updateProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntryId:t.id,budgetEntry:{id:t.id,department_id:t.department_id,person_id:t.person?t.person.id:null,position:t.position,seniority:t.seniority,start_date:t.start_date,months_duration:t.duration,daily_salary:t.daily_salary}}),this.modals.createBudgetEntry=!1}catch(e){console.error(e),this.errors.editBudgetEntry=!0}finally{this.loading.editBudgetEntry=!1}},afterEditBudgetEntry(t){const e=this.budgetEntries.find(n=>n.id===t.id);e&&Object.assign(e,t)},async deleteBudgetEntry(t){this.loading.deleteBudgetEntry=!1,this.errors.deleteBudgetEntry=!1,this.modals.deleteBudgetEntry=!0,this.budgetEntryToDelete=t},async confirmDeleteBudgetEntry(){this.loading.deleteBudgetEntry=!0;try{await this.deleteProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntryId:this.budgetEntryToDelete.budget_entry_id}),this.postDeleteBudgetEntry(this.budgetEntryToDelete),this.modals.deleteBudgetEntry=!1}catch(t){console.error(t),this.errors.deleteBudgetEntry=!0}finally{this.loading.deleteBudgetEntry=!1}},postDeleteBudgetEntry(t){this.budgetEntries=this.budgetEntries.filter(e=>e.id!==t.id)},async loadBudgets(){try{this.loading.budgets=!0,this.errors.budgets=!1,this.budgets=await this.loadProductionBudgets(this.currentProduction.id),this.budgets.sort((t,e)=>e.revision-t.revision),this.currentBudget=this.budgets.length>0?this.budgets[0]:{},this.resetBudgetOptions()}catch(t){console.error(t),this.errors.budgets=!0}finally{this.loading.budgets=!1}},async loadBudgetEntries(){if(!(!this.currentBudget||!this.currentBudget.id))try{this.loading.entries=!0,this.errors.entries=!1,this.budgetEntries=await this.loadProductionBudgetEntries({productionId:this.currentProduction.id,budgetId:this.currentBudget.id})}catch(t){console.error(t),this.errors.entries=!0}finally{this.loading.entries=!1}},resetBudgetOptions(){this.budgetOptions=this.budgets.map(t=>({label:`v${t.revision} - ${t.name}`,value:t}))},getMonthsBetweenDates(t,e){const n=[],i=B(t),s=B(e);for(;i<=s;)n.push(v(i)),i.add(1,"month");return n}},watch:{currentProduction(){this.loadBudgets()},currentBudget(){this.loadBudgetEntries()}},socket:{events:{"budget:create":async function(t){if(t.project_id!==this.currentProduction.id)return;const e=await this.loadProductionBudget({productionId:this.currentProduction.id,budgetId:t.budget_id}),n=this.budgets.find(i=>i.id===e.id);e&&!n&&(this.budgets.unshift(e),this.resetBudgetOptions())},"budget:update":async function(t){if(t.project_id!==this.currentProduction.id)return;const e=await this.loadProductionBudget({productionId:this.currentProduction.id,budgetId:t.budget_id});if(e){const n=this.budgets.find(i=>i.id===e.id);n&&(Object.assign(n,{name:e.name,currency:e.currency}),this.resetBudgetOptions())}},"budget:delete":function(t){if(t.project_id!==this.currentProduction.id)return;const e=this.budgets.find(i=>i.id===t.budget_id),n=this.currentBudget.id===t.budget_id;e&&(this.budgets=this.budgets.filter(i=>i.id!==t.budget_id),this.resetBudgetOptions(),n&&(this.currentBudget=this.budgets[0]))},"budget-entry:create":async function(t){if(t.project_id!==this.currentProduction.id||t.budget_id!==this.currentBudget.id||this.budgetEntries.find(i=>i.id===t.budget_entry_id))return;const n=await this.loadProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntryId:t.budget_entry_id});this.budgetEntries.push(n)},"budget-entry:update":async function(t){if(t.project_id!==this.currentProduction.id||t.budget_id!==this.currentBudget.id||!this.budgetEntries.find(i=>i.id===t.budget_entry_id))return;const n=await this.loadProductionBudgetEntry({productionId:this.currentProduction.id,budgetId:this.currentBudget.id,budgetEntryId:t.budget_entry_id});this.afterEditBudgetEntry(n)},"budget-entry:delete":async function(t){t.project_id!==this.currentProduction.id||t.budget_id!==this.currentBudget.id||!this.budgetEntries.find(n=>n.id===t.budget_entry_id)||this.postDeleteBudgetEntry({id:t.budget_entry_id})}}}},ze={class:"flexcolumn page"};function Ge(t,e,n,i,s,r){const h=m("budget-header"),b=m("budget-list"),f=m("edit-budget-modal"),y=m("edit-budget-entry-modal"),_=m("hard-delete-modal"),p=m("delete-modal"),w=m("budget-analytics"),u=m("page-layout");return l(),E(u,null,{main:V(()=>[o("div",ze,[g(h,{budgets:s.budgets,"budget-options":s.budgetOptions,budget:s.currentBudget,"is-loading":s.loading.budgets,"is-error":s.errors.budgets,onChangeBudget:r.onChangeBudget,onDeleteBudget:r.onDeleteBudgetClicked,onEditBudget:r.onEditBudgetClicked,onExportBudget:r.onExportBudgetClicked,onNewVersion:r.onNewBudgetVersionClicked},null,8,["budgets","budget-options","budget","is-loading","is-error","onChangeBudget","onDeleteBudget","onEditBudget","onExportBudget","onNewVersion"]),s.currentBudget.id?(l(),E(b,{key:0,"budget-departments":r.budgetDepartments,"budget-entries":s.budgetEntries,currency:s.currentBudget?.currency||"USD","current-budget":s.currentBudget,"is-loading":s.loading.entries,"is-error":s.errors.entries,"months-between-production-dates":s.monthsBetweenProductionDates,"total-entry":r.totalEntry,onAddBudgetEntry:r.onAddBudgetEntry,onDeleteBudgetEntry:r.deleteBudgetEntry,onEditBudgetEntry:r.editBudgetEntry},null,8,["budget-departments","budget-entries","currency","current-budget","is-loading","is-error","months-between-production-dates","total-entry","onAddBudgetEntry","onDeleteBudgetEntry","onEditBudgetEntry"])):x("",!0),g(f,{active:s.modals.createBudget,"budget-to-edit":s.budgetToEdit,"last-revision":r.lastRevision,"is-loading":s.loading.createBudget||s.loading.editBudget,"is-error":s.errors.createBudget||s.errors.editBudget,onCancel:e[0]||(e[0]=a=>s.modals.createBudget=!1),onConfirm:r.createBudget},null,8,["active","budget-to-edit","last-revision","is-loading","is-error","onConfirm"]),g(y,{active:s.modals.createBudgetEntry,"budget-entry-to-edit":s.budgetEntryToEdit,"is-loading":s.loading.createBudgetEntry,"is-error":s.errors.createBudgetEntry||s.errors.editBudgetEntry,"salary-scale":s.salaryScale,onCancel:e[1]||(e[1]=a=>s.modals.createBudgetEntry=!1),onConfirm:r.confirmCreateBudgetEntry},null,8,["active","budget-entry-to-edit","is-loading","is-error","salary-scale","onConfirm"]),g(_,{active:s.modals.deleteBudget,"error-text":t.$t("budget.delete_budget_error"),"is-loading":s.loading.del,"is-error":s.errors.deleteBudget,"lock-text":s.currentBudget?.name,text:t.$t("budget.delete_budget_message"),onCancel:e[2]||(e[2]=a=>s.modals.deleteBudget=!1),onConfirm:r.deleteBudget},null,8,["active","error-text","is-loading","is-error","lock-text","text","onConfirm"]),g(p,{active:s.modals.deleteBudgetEntry,"error-text":t.$t("budget.delete_budget_entry_error"),"is-loading":s.loading.deleteBudgetEntry,"is-error":s.errors.deleteBudgetEntry,text:t.$t("budget.delete_budget_entry_message"),onCancel:e[3]||(e[3]=a=>s.modals.deleteBudgetEntry=!1),onConfirm:r.confirmDeleteBudgetEntry},null,8,["active","error-text","is-loading","is-error","text","onConfirm"])])]),side:V(()=>[g(w,{amount:r.totalEntry.total,currency:s.currentBudget.currency,budgets:s.budgets,"budget-departments":r.budgetDepartments,"budget-entries":s.budgetEntries,"months-between-production-dates":s.monthsBetweenProductionDates,"pie-chart-data":r.pieChartData,"pie-chart-colors":r.pieChartColors,"column-chart-data":r.columnChartData},null,8,["amount","currency","budgets","budget-departments","budget-entries","months-between-production-dates","pie-chart-data","pie-chart-colors","column-chart-data"])]),_:1})}const Qe=D(He,[["render",Ge],["__scopeId","data-v-d1dda54f"]]);export{Qe as default};
//# sourceMappingURL=Budget-BKfA_RzF.js.map
