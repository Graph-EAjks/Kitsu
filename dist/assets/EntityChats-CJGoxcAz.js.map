{"version":3,"file":"EntityChats-CJGoxcAz.js","sources":["../../src/components/layouts/PageLeftSideLayout.vue","../../src/components/pages/EntityChats.vue"],"sourcesContent":["<template>\n  <div ref=\"page\" class=\"columns fixed-page\">\n    <div class=\"column left-side-column\">\n      <slot name=\"side\" />\n    </div>\n    <div class=\"column main-column\">\n      <slot name=\"main\" />\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'page-left-side-layout'\n}\n</script>\n","<template>\n  <page-left-side-layout>\n    <template #side>\n      <div class=\"chat-column\">\n        <spinner class=\"mt1\" v-if=\"loading.list\" />\n        <div class=\"chat-list\" v-else>\n          <div\n            :key=\"chat.id\"\n            :class=\"chatClass(chat)\"\n            @click=\"selectChat(chat)\"\n            v-for=\"chat in chatList\"\n          >\n            <div class=\"flexrow\">\n              <entity-thumbnail\n                class=\"flexrow-item mr1\"\n                :height=\"40\"\n                :empty-height=\"40\"\n                :empty-width=\"60\"\n                :entity=\"{\n                  id: chat.object_id,\n                  preview_file_id: chat.preview_file_id\n                }\"\n              />\n              <div class=\"flexcolumn flexrow-item ml1\">\n                <div class=\"chat-item-project-name\">\n                  {{ getChatProjectName(chat) }}\n                </div>\n                <div class=\"chat-item-title\">\n                  {{ chat.entity_name }}\n                </div>\n                <div class=\"chat-item-subtitle\">\n                  {{ getChatDate(chat) }}\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </template>\n\n    <template #main>\n      <div class=\"selected-entity-chat\">\n        <entity-chat\n          ref=\"entityChat\"\n          :entity=\"entity\"\n          :name=\"chatList.find(c => c.object_id === entity.id)?.entity_name\"\n        />\n      </div>\n    </template>\n  </page-left-side-layout>\n</template>\n\n<script>\nimport { mapGetters, mapActions } from 'vuex'\n\nimport { formatListMixin } from '@/components/mixins/format'\n\nimport EntityChat from '@/components/pages/entities/EntityChat.vue'\nimport EntityThumbnail from '@/components/widgets/EntityThumbnail.vue'\nimport PageLeftSideLayout from '@/components/layouts/PageLeftSideLayout.vue'\nimport Spinner from '@/components/widgets/Spinner.vue'\n\nexport default {\n  name: 'entity-chats',\n\n  mixins: [formatListMixin],\n\n  components: {\n    EntityChat,\n    EntityThumbnail,\n    PageLeftSideLayout,\n    Spinner\n  },\n\n  data() {\n    return {\n      chats: [],\n      entity: null,\n      loading: {\n        list: false\n      }\n    }\n  },\n\n  async mounted() {\n    this.loading.list = true\n    this.chats = await this.getEntityChats()\n    if (this.$route.query.entity_id) {\n      this.selectFromQuery()\n    } else {\n      this.selectFirstChat()\n    }\n    this.loading.list = false\n  },\n\n  computed: {\n    ...mapGetters(['productionMap', 'user']),\n\n    chatList() {\n      return [...this.chats].sort((a, b) => {\n        if (!a.last_message) return 1\n        if (!b.last_message) return -1\n        if (a.last_message === b.last_message) {\n          return a.entity_name.localeCompare(b.entity_name)\n        }\n        return a.last_message < b.last_message\n      })\n    }\n  },\n\n  methods: {\n    ...mapActions(['getEntityChats']),\n\n    selectFirstChat() {\n      if (this.chats.length > 0) {\n        const chat = this.chats[this.chats.length - 1]\n        this.entity = { id: chat.object_id }\n      }\n    },\n\n    selectFromQuery() {\n      const chat = this.chats.find(\n        c => c.object_id === this.$route.query.entity_id\n      )\n      if (chat) {\n        this.entity = { id: chat.object_id }\n      } else {\n        this.selectFirstChat()\n      }\n    },\n\n    selectChat(chat) {\n      this.entity = { id: chat.object_id }\n      this.$nextTick(() => {\n        this.$refs.entityChat.focusMessageBox()\n      })\n      this.$router.push({ query: { entity_id: chat.object_id } })\n    },\n\n    chatClass(chat) {\n      return {\n        'chat-item': true,\n        selected: this.entity && this.entity.id === chat.object_id\n      }\n    },\n\n    getChatProjectName(chat) {\n      return this.productionMap.get(chat.project_id).name\n    },\n\n    getChatDate(chat) {\n      if (!chat.last_message) return this.$t('chats.no_message_yet')\n      return this.formatDate(chat.last_message)\n    }\n  },\n\n  socket: {\n    events: {\n      async 'chat:joined'(eventData) {\n        if (\n          !this.chats.some(c => c.id === eventData.chat_id) &&\n          this.user.id === eventData.person_id\n        ) {\n          this.chats = await this.getEntityChats()\n        }\n      },\n\n      'chat:left'(eventData) {\n        if (\n          this.chats.some(c => c.id === eventData.chat_id) &&\n          this.user.id === eventData.person_id\n        ) {\n          this.chats = this.chats.filter(c => c.id !== eventData.chat_id)\n        }\n      },\n\n      'chat:new-message'(eventData) {\n        const chat = this.chats.find(c => c.id === eventData.chat_id)\n        if (chat) {\n          chat.last_message = eventData.last_message\n        }\n      }\n    }\n  },\n\n  metaInfo() {\n    return {\n      title: `${this.$t('chats.title')} - Kitsu`\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.chat-column {\n  border: 1px solid var(--border);\n  height: 100%;\n  overflow-y: auto;\n  padding-top: 60px;\n}\n\n.selected-entity-chat {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  max-height: 100%;\n  padding: 1em;\n  padding-top: 60px;\n}\n\n.chat-item {\n  border: 2px solid transparent;\n  border-bottom: 2px solid var(--border-alt);\n  color: var(--text);\n  cursor: pointer;\n  padding: 1em;\n\n  &:hover {\n    border-color: var(--background-selectable);\n  }\n\n  &.selected {\n    border-color: var(--background-selected);\n  }\n\n  .chat-item-project-name {\n    color: $grey;\n    font-size: 0.7em;\n    font-weight: bold;\n    text-transform: uppercase;\n  }\n\n  .chat-item-title {\n    font-weight: bold;\n  }\n\n  .chat-item-subtitle {\n    color: $grey;\n    font-size: 0.8em;\n  }\n}\n</style>\n"],"names":["_sfc_main","formatListMixin","EntityChat","EntityThumbnail","PageLeftSideLayout","Spinner","mapGetters","a","b","mapActions","chat","c","eventData"],"mappings":"mHAYA,MAAAA,EAAA,CACA,KAAA,uBACA,0RCgDAA,EAAA,CACA,KAAA,eAEA,OAAA,CAAAC,CAAA,EAEA,WAAA,CACA,WAAAC,EACA,gBAAAC,EACA,mBAAAC,EACA,QAAAC,CACA,EAEA,MAAA,CACA,MAAA,CACA,MAAA,CAAA,EACA,OAAA,KACA,QAAA,CACA,KAAA,EACA,CACA,CACA,EAEA,MAAA,SAAA,CACA,KAAA,QAAA,KAAA,GACA,KAAA,MAAA,MAAA,KAAA,eAAA,EACA,KAAA,OAAA,MAAA,UACA,KAAA,gBAAA,EAEA,KAAA,gBAAA,EAEA,KAAA,QAAA,KAAA,EACA,EAEA,SAAA,CACA,GAAAC,EAAA,CAAA,gBAAA,MAAA,CAAA,EAEA,UAAA,CACA,MAAA,CAAA,GAAA,KAAA,KAAA,EAAA,KAAA,CAAAC,EAAAC,IACAD,EAAA,aACAC,EAAA,aACAD,EAAA,eAAAC,EAAA,aACAD,EAAA,YAAA,cAAAC,EAAA,WAAA,EAEAD,EAAA,aAAAC,EAAA,aAJA,GADA,CAMA,CACA,CACA,EAEA,QAAA,CACA,GAAAC,EAAA,CAAA,gBAAA,CAAA,EAEA,iBAAA,CACA,GAAA,KAAA,MAAA,OAAA,EAAA,CACA,MAAAC,EAAA,KAAA,MAAA,KAAA,MAAA,OAAA,CAAA,EACA,KAAA,OAAA,CAAA,GAAAA,EAAA,SAAA,CACA,CACA,EAEA,iBAAA,CACA,MAAAA,EAAA,KAAA,MAAA,KACAC,GAAAA,EAAA,YAAA,KAAA,OAAA,MAAA,SACA,EACAD,EACA,KAAA,OAAA,CAAA,GAAAA,EAAA,SAAA,EAEA,KAAA,gBAAA,CAEA,EAEA,WAAAA,EAAA,CACA,KAAA,OAAA,CAAA,GAAAA,EAAA,SAAA,EACA,KAAA,UAAA,IAAA,CACA,KAAA,MAAA,WAAA,gBAAA,CACA,CAAA,EACA,KAAA,QAAA,KAAA,CAAA,MAAA,CAAA,UAAAA,EAAA,SAAA,EAAA,CACA,EAEA,UAAAA,EAAA,CACA,MAAA,CACA,YAAA,GACA,SAAA,KAAA,QAAA,KAAA,OAAA,KAAAA,EAAA,SACA,CACA,EAEA,mBAAAA,EAAA,CACA,OAAA,KAAA,cAAA,IAAAA,EAAA,UAAA,EAAA,IACA,EAEA,YAAAA,EAAA,CACA,OAAAA,EAAA,aACA,KAAA,WAAAA,EAAA,YAAA,EADA,KAAA,GAAA,sBAAA,CAEA,CACA,EAEA,OAAA,CACA,OAAA,CACA,KAAA,cAAAE,EAAA,CAEA,CAAA,KAAA,MAAA,KAAAD,GAAAA,EAAA,KAAAC,EAAA,OAAA,GACA,KAAA,KAAA,KAAAA,EAAA,YAEA,KAAA,MAAA,MAAA,KAAA,eAAA,EAEA,EAEA,YAAAA,EAAA,CAEA,KAAA,MAAA,KAAAD,GAAAA,EAAA,KAAAC,EAAA,OAAA,GACA,KAAA,KAAA,KAAAA,EAAA,YAEA,KAAA,MAAA,KAAA,MAAA,OAAAD,GAAAA,EAAA,KAAAC,EAAA,OAAA,EAEA,EAEA,mBAAAA,EAAA,CACA,MAAAF,EAAA,KAAA,MAAA,KAAAC,GAAAA,EAAA,KAAAC,EAAA,OAAA,EACAF,IACAA,EAAA,aAAAE,EAAA,aAEA,CACA,CACA,EAEA,UAAA,CACA,MAAA,CACA,MAAA,GAAA,KAAA,GAAA,aAAA,CAAA,UACA,CACA,CACA"}