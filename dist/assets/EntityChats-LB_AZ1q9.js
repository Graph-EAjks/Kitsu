import{_ as f,c as h,o as n,e as i,aG as _,m as j,a as x,u as k,E as w,z as b,r as o,k as m,w as u,f as y,F as E,g as F,n as L,t as r}from"./index-bjOq_gdX.js";import{E as B}from"./EntityChat-3dHTZyiJ.js";const M={name:"page-left-side-layout"},N={ref:"page",class:"columns fixed-page"},S={class:"column left-side-column"},q={class:"column main-column"};function P(t,e,l,p,c,a){return n(),h("div",N,[i("div",S,[_(t.$slots,"side")]),i("div",q,[_(t.$slots,"main")])],512)}const z=f(M,[["render",P]]),G={name:"entity-chats",mixins:[b],components:{EntityChat:B,EntityThumbnail:w,PageLeftSideLayout:z,Spinner:k},data(){return{chats:[],entity:null,loading:{list:!1}}},async mounted(){this.loading.list=!0,this.chats=await this.getEntityChats(),this.$route.query.entity_id?this.selectFromQuery():this.selectFirstChat(),this.loading.list=!1},computed:{...x(["productionMap","user"]),chatList(){return[...this.chats].sort((t,e)=>t.last_message?e.last_message?t.last_message===e.last_message?t.entity_name.localeCompare(e.entity_name):t.last_message<e.last_message:-1:1)}},methods:{...j(["getEntityChats"]),selectFirstChat(){if(this.chats.length>0){const t=this.chats[this.chats.length-1];this.entity={id:t.object_id}}},selectFromQuery(){const t=this.chats.find(e=>e.object_id===this.$route.query.entity_id);t?this.entity={id:t.object_id}:this.selectFirstChat()},selectChat(t){this.entity={id:t.object_id},this.$nextTick(()=>{this.$refs.entityChat.focusMessageBox()}),this.$router.push({query:{entity_id:t.object_id}})},chatClass(t){return{"chat-item":!0,selected:this.entity&&this.entity.id===t.object_id}},getChatProjectName(t){return this.productionMap.get(t.project_id).name},getChatDate(t){return t.last_message?this.formatDate(t.last_message):this.$t("chats.no_message_yet")}},socket:{events:{async"chat:joined"(t){!this.chats.some(e=>e.id===t.chat_id)&&this.user.id===t.person_id&&(this.chats=await this.getEntityChats())},"chat:left"(t){this.chats.some(e=>e.id===t.chat_id)&&this.user.id===t.person_id&&(this.chats=this.chats.filter(e=>e.id!==t.chat_id))},"chat:new-message"(t){const e=this.chats.find(l=>l.id===t.chat_id);e&&(e.last_message=t.last_message)}}},head(){return{title:`${this.$t("chats.title")} - Kitsu`}}},Q={class:"chat-column"},T={key:1,class:"chat-list"},V=["onClick"],A={class:"flexrow"},I={class:"flexcolumn flexrow-item ml1"},K={class:"chat-item-project-name"},D={class:"chat-item-title"},H={class:"chat-item-subtitle"},J={class:"selected-entity-chat"};function O(t,e,l,p,c,a){const g=o("spinner"),C=o("entity-thumbnail"),$=o("entity-chat"),v=o("page-left-side-layout");return n(),m(v,null,{side:u(()=>[i("div",Q,[c.loading.list?(n(),m(g,{key:0,class:"mt1"})):(n(),h("div",T,[(n(!0),h(E,null,F(a.chatList,s=>(n(),h("div",{key:s.id,class:L(a.chatClass(s)),onClick:d=>a.selectChat(s)},[i("div",A,[y(C,{class:"flexrow-item mr1",height:40,"empty-height":40,"empty-width":60,entity:{id:s.object_id,preview_file_id:s.preview_file_id}},null,8,["entity"]),i("div",I,[i("div",K,r(a.getChatProjectName(s)),1),i("div",D,r(s.entity_name),1),i("div",H,r(a.getChatDate(s)),1)])])],10,V))),128))]))])]),main:u(()=>{var s;return[i("div",J,[y($,{ref:"entityChat",entity:c.entity,name:(s=a.chatList.find(d=>d.object_id===c.entity.id))==null?void 0:s.entity_name},null,8,["entity","name"])])]}),_:1})}const W=f(G,[["render",O],["__scopeId","data-v-cea582c1"]]);export{W as default};
//# sourceMappingURL=EntityChats-LB_AZ1q9.js.map
