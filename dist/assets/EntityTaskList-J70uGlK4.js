import{m as T,ad as z,bw as C,bF as B,bx as N,aB as S,cl as D,b as M,bK as W,bL as H,u as P,aF as E,y as L,Z as V,aI as x,_ as $,r as p,o as a,c as r,f as _,F as g,g as v,e as s,p as O,t as i,l as b,d as k,aP as U,h as K,N as Y,B as Z,E as J,z as F,ay as A,bS as Q,T as X}from"./index-CmnPCMrI.js";import{P as j}from"./PeopleNameCell-BnrfNAfl.js";const Ot={data(){return{currentSection:"infos",zoomLevel:1,entityNavOptions:[{label:this.$t("main.label.info"),value:"infos"},{label:this.$t("main.label.chat"),value:"chat"},{label:this.$t("main.label.casting"),value:"casting"},{label:this.$t("main.label.schedule"),value:"schedule"},{label:this.$t("main.label.preview_files"),value:"preview-files"},{label:this.$t("main.label.timelog"),value:"time-logs"}],zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},computed:{...T(["organisation"]),entityTabs(){return this.entityNavOptions.map(e=>({label:e.label,name:e.value}))},thumbnailPath(){return`/api/pictures/originals/preview-files/${this.currentEntity.preview_file_id}.png`},isPreview(){return this.currentEntity&&this.currentEntity.preview_file_id&&this.currentEntity.preview_file_id.length>0},currentTasks(){const e=this[`current${z.capitalize(this.type)}`];return!e||!e.tasks?[]:e?e.tasks.map(t=>this.taskMap.get(t)).filter(t=>t).sort((t,o)=>{const y=this.getTaskTypePriority(t.task_type_id),c=this.getTaskTypePriority(o.task_type_id);return y-c}):[]},tasksStartDate(){return this.scheduleItems.length>0&&this.scheduleItems[0].children.length>0?C(this.scheduleItems[0].children).clone().add(-60,"days"):B(this.currentProduction.start_date)},tasksEndDate(){return this.scheduleItems.length>0&&this.scheduleItems[0].children.length>0?N(this.scheduleItems[0].children).clone().add(60,"days"):B(this.currentProduction.end_date)},scheduleItems(){let e=0;const t={avatar:!1,id:"root",name:"Tasks",color:"#888",priority:1,expanded:!0,loading:!1,children:[],editable:!0},o=S(),y=this.currentTasks.map(d=>{const f=d.estimation;let h=o.clone(),u;if(!d.start_date&&!d.real_start_date&&!d.due_date&&!d.end_date)return null;d.start_date?h=D(d.start_date):d.real_start_date&&(h=D(d.real_start_date)),d.due_date?u=D(d.due_date):d.end_date?u=D(d.end_date):d.estimation&&(u=h.clone().add(f,"days")),(!u||u.isBefore(h))&&(u=h.clone().add(1,"days")),f&&(e+=d.estimation);const l=this.taskTypeMap.get(d.task_type_id);return{...d,name:l.name,startDate:h,endDate:u,expanded:!1,loading:!1,man_days:f,editable:!0,unresizable:!1,parentElement:t,color:l.color,children:[]}}).filter(d=>d!==null);let c=S(),n=S().add(1,"days");return y.length>0&&(c=C(y),n=N(y)),Object.assign(t,{children:y,startDate:c,endDate:n,man_days:e}),[t]}},methods:{...M(["addSelectedTask","clearSelectedTasks","updateTask"]),changeTab(e){this.selectedTab=e},onEditClicked(){this.modals.edit=!0},onTaskSelected(e){this.clearSelectedTasks(),!this.currentTask||this.currentTask.id!==e.id?(this.addSelectedTask(e),this.currentTask=e):this.currentTask=null},saveTaskScheduleItem(e){const t=W(e.startDate,e.endDate),o=H(this.organisation,t);e.man_days=o,e.startDate&&e.endDate&&this.updateTask({taskId:e.id,data:{estimation:o,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})}},watch:{$route(){const e=this.route.params[`${this.type}_id`],t=this[`current${z.capitalize(this.type)}`];t&&t!==e&&this.init(),this.currentSection=this.route.query.section||"infos"},currentSection(){this.currentSection==="schedule"&&this.scheduleItems.length>0&&this.$refs["schedule-widget"]&&this.$refs["schedule-widget"].scrollToDate(this.scheduleItems[0].startDate)},zoomLevel(){this.$refs["schedule-widget"]&&this.$refs["schedule-widget"].scrollToDate(this.scheduleItems[0].startDate)}}},ee={name:"entity-news",mixins:[P],components:{PeopleAvatar:E,Spinner:L,TaskTypeName:V,ValidationTag:x},data(){return{isLoading:!1,newsList:[]}},props:{entity:{type:Object,default:()=>{}}},mounted(){this.reset()},computed:{...T(["currentProduction","personMap","taskTypeMap","taskStatusMap"])},methods:{...M(["getEntityNews"]),buildTaskFromNews(e){return{task_status_id:e.task_status_id}},buildTaskTypeFromNews(e){return{...this.taskTypeMap.get(e.task_type_id),episode_id:e.episode_id}},hasRetakeValue(e){const t=this.taskStatusMap.get(e.task_status_id);return t?e.change&&t.is_retake:!1},hasDoneValue(e){const t=this.taskStatusMap.get(e.task_status_id);return t?e.change&&t.is_done:!1},reset(){this.entity&&(this.isLoading=!0,this.getEntityNews(this.entity.id).then(e=>{this.newsList=e.data}).catch(e=>{console.error(e),this.newsList=[]}).finally(()=>{this.isLoading=!1}))}},watch:{entity(){this.reset()}},socket:{events:{"news:new"(e){e.project_id===this.currentProduction.id&&(!this.taskTypeId||this.taskTypeId===e.task_type_id)&&(!this.taskStatusId||this.taskStatusId===e.task_status_id)&&this.reset()}}}},te={class:"news flexcolumn"},se={key:0,class:"has-text-centered"},ie={key:1,class:"timeline mt1"},ae={class:"date flexrow-item"},ne={class:"flexrow-item task-type-wrapper ml1"},oe={class:"flexrow-item validation-wrapper"},re={key:2};function le(e,t,o,y,c,n){const d=p("spinner"),f=p("people-avatar"),h=p("task-type-name"),u=p("validation-tag");return a(),r("div",te,[c.isLoading?(a(),r("div",se,[_(d)])):c.newsList.length?(a(),r("div",ie,[(a(!0),r(g,null,v(c.newsList,l=>(a(),r("div",{class:"timeline-entry flexrow",key:`news-${l.id}`},[s("span",{class:O({dot:!0,red:n.hasRetakeValue(l),green:n.hasDoneValue(l)})},null,2),s("span",ae,i(e.formatFullDate(l.created_at).substring(10,0)),1),e.personMap.get(l.author_id)?(a(),b(f,{key:0,class:"flexrow-item","font-size":14,"is-link":!1,person:e.personMap.get(l.author_id),size:30},null,8,["person"])):k("",!0),s("div",ne,[_(h,{class:"task-type-name","is-static":!0,"production-id":e.currentProduction.id,"task-type":n.buildTaskTypeFromNews(l)},null,8,["production-id","task-type"])]),s("div",oe,[_(u,{"is-priority":!1,"is-static":!0,task:n.buildTaskFromNews(l),thin:!l.change},null,8,["task","thin"])])]))),128))])):(a(),r("div",re,i(e.$t("news.no_news")),1))])}const Ut=$(ee,[["render",le],["__scopeId","data-v-11195eac"]]),de={name:"entity-preview-file-card",components:{DownloadIcon:U,EntityPreview:K,PeopleAvatar:E},props:{previewFile:{type:Object,required:!0,default:()=>{}}},mounted(){},computed:{...T(["isCurrentUserArtist","personMap","taskMap","taskTypeMap"])},methods:{getTaskType(e){const t=this.taskMap.get(e.task_id);return this.taskTypeMap.get(t.task_type_id)},getDownloadPath(e){return`/api/${this.previewFile.extension==="mp4"?"movies":"pictures"}/originals/preview-files/${e}/download`},renderFileSize:Y}},ce={class:"preview-card-data"},pe={class:"flexrow"},ue={class:"card-revision tag strong flexrow-item"},_e=["title"],he={class:"card-extension flexrow-item mr0"},ye={class:"flexrow mt1"},me=["title","data-status"],fe={key:0,class:"card-file-size flexrow-item mr05"},ke=["href","title"];function ge(e,t,o,y,c,n){const d=p("entity-preview"),f=p("people-avatar"),h=p("download-icon");return a(),r("div",{class:"preview-card flexcolumn",key:o.previewFile.id},[_(d,{entity:{preview_file_id:o.previewFile.id,preview_file_extension:o.previewFile.extension},"empty-height":200,"empty-width":300,height:200,width:300,"is-rounded-top-border":"","show-movie":""},null,8,["entity"]),s("div",ce,[s("div",pe,[s("span",ue," v"+i(o.previewFile.revision),1),s("span",{class:"card-file-name flexrow-item",title:o.previewFile.original_name},i(o.previewFile.original_name),9,_e),t[0]||(t[0]=s("span",{class:"filler"},null,-1)),s("span",he,i(o.previewFile.extension),1)]),s("div",ye,[s("span",{class:"preview-status mr05",title:o.previewFile.validation_status,"data-status":o.previewFile.validation_status},null,8,me),_(f,{class:"person",person:e.personMap.get(o.previewFile.person_id),"font-size":10,size:20},null,8,["person"]),t[1]||(t[1]=s("span",{class:"filler"},null,-1)),o.previewFile.file_size?(a(),r("span",fe,i(n.renderFileSize(o.previewFile.file_size))+"B ",1)):k("",!0),e.isCurrentUserArtist?k("",!0):(a(),r("a",{key:1,class:"download-button",href:n.getDownloadPath(o.previewFile.id),title:e.$t("playlists.actions.download_file")},[_(h,{class:"icon is-small"})],8,ke))])])])}const ve=$(de,[["render",ge],["__scopeId","data-v-dc88db2d"]]),we={name:"entity-preview-files",components:{ButtonSimple:Z,DownloadIcon:U,EntityPreviewFileCard:ve,EntityThumbnail:J,PeopleNameCell:j,Spinner:L,TaskTypeCell:F,TaskTypeName:V},data(){return{contactSheetMode:!1,isLoading:!1,previewFiles:[]}},props:{entity:{type:Object,default:()=>{}}},mounted(){this.entity&&(this.reset(),this.contactSheetMode=A.getBoolPreference("entity:preview-files-contact-sheet"))},computed:{...T(["currentProduction","isCurrentUserArtist","personMap","taskMap","taskTypeMap"]),taskTypePreviewFileGroups(){const e=new Map;return this.previewFiles.forEach(t=>{const o=this.getTaskType(t);e.has(o.id)||e.set(o.id,[]),e.get(o.id).push(t)}),Array.from(e.values())}},methods:{...M(["getEntityPreviewFiles"]),getTaskType(e){const t=this.taskMap.get(e.task_id);return this.taskTypeMap.get(t.task_type_id)},getDownloadPath(e){const t=this.previewFiles.find(y=>y.id===e);return t?`/api/${t.extension==="mp4"?"movies":"pictures"}/originals/preview-files/${e}/download`:""},renderFileSize:Y,formatDate:Q,reset(){this.isLoading=!0,this.getEntityPreviewFiles(this.entity.id).then(e=>{this.previewFiles=e,this.isLoading=!1}).catch(e=>{console.error(e),this.previewFiles=[],this.isLoading=!1})}},watch:{entity(){this.entity&&this.reset()},contactSheetMode(){A.setPreference("entity:preview-files-contact-sheet",this.contactSheetMode)}}},Te={class:"mt1 flexcolumn wrapper preview-files"},be={class:"buttons flexrow mb1"},$e={key:0,class:"has-text-centered"},De={key:1},Me={key:0,class:"contact-sheet flexcolumn"},Se={class:"flexrow-item mb1"},Pe={class:"flexrow task-types-preview mb2"},Ee={key:1,class:"datatable"},Le={class:"datatable-head"},Fe={class:"datatable-row-header"},Ie={class:"type"},ze={class:"original-name"},Ce={class:"revision"},Be={class:"extension"},Ne={class:"size"},Ae={class:"status"},Ve={class:"person"},xe={class:"date"},Oe={class:"datatable-body"},Ue={class:"thumbnail"},Ye={class:"original-name"},je={class:"revision"},Ge={class:"extension"},qe={class:"size"},Re={class:"status"},We={class:"date"},He={class:"download"},Ke=["href","title"],Ze={key:2};function Je(e,t,o,y,c,n){const d=p("button-simple"),f=p("spinner"),h=p("task-type-name"),u=p("entity-preview-file-card"),l=p("entity-thumbnail"),w=p("task-type-cell"),G=p("people-name-cell"),q=p("download-icon");return a(),r("div",Te,[s("div",be,[t[1]||(t[1]=s("span",{class:"filler"},null,-1)),_(d,{class:"flexrow-item",icon:"grid","is-on":c.contactSheetMode,title:e.$t("tasks.show_contact_sheet"),onClick:t[0]||(t[0]=m=>c.contactSheetMode=!c.contactSheetMode)},null,8,["is-on","title"])]),c.isLoading?(a(),r("div",$e,[_(f)])):c.previewFiles.length>0&&!c.isLoading?(a(),r("div",De,[c.contactSheetMode?(a(),r("div",Me,[(a(!0),r(g,null,v(n.taskTypePreviewFileGroups,(m,R)=>(a(),r("div",{key:`task-type-group-${R}`},[s("div",Se,[_(h,{"task-type":n.getTaskType(m[0])},null,8,["task-type"])]),s("div",Pe,[(a(!0),r(g,null,v(m,I=>(a(),b(u,{key:I.id,"preview-file":I},null,8,["preview-file"]))),128))])]))),128))])):(a(),r("table",Ee,[s("thead",Le,[s("tr",Fe,[t[2]||(t[2]=s("th",{class:"thumbnail"},null,-1)),s("th",Ie,i(e.$t("entities.preview_files.task_type")),1),s("th",ze,i(e.$t("entities.preview_files.original_file_name")),1),s("th",Ce,i(e.$t("entities.preview_files.revision")),1),s("th",Be,i(e.$t("entities.preview_files.extension")),1),s("th",Ne,i(e.$t("entities.preview_files.size")),1),s("th",Ae,i(e.$t("entities.preview_files.status")),1),s("th",Ve,i(e.$t("entities.preview_files.uploader")),1),s("th",xe,i(e.$t("entities.preview_files.uploaded_at")),1),t[3]||(t[3]=s("th",{class:"end-cell"},null,-1))])]),s("tbody",Oe,[(a(!0),r(g,null,v(c.previewFiles,m=>(a(),r("tr",{key:m.id,class:"datatable-row"},[s("td",Ue,[_(l,{class:"preview-thumbnail","preview-file-id":m.id,"empty-width":60,width:60},null,8,["preview-file-id"])]),_(w,{class:"type","task-type":n.getTaskType(m),"production-id":e.currentProduction.id},null,8,["task-type","production-id"]),s("td",Ye,i(m.original_name),1),s("td",je,i(m.revision),1),s("td",Ge,i(m.extension),1),s("td",qe,i(n.renderFileSize(m.file_size)),1),s("td",Re,i(m.validation_status),1),_(G,{class:"person",person:e.personMap.get(m.person_id)},null,8,["person"]),s("td",We,i(n.formatDate(m.created_at)),1),s("td",He,[e.isCurrentUserArtist?k("",!0):(a(),r("a",{key:0,class:"button flexrow-item",href:n.getDownloadPath(m.id),title:e.$t("playlists.actions.download_file")},[_(q,{class:"icon is-small"})],8,Ke))])]))),128))])]))])):(a(),r("div",Ze,i(e.$t("entities.preview_files.no_preview_files")),1))])}const Yt=$(we,[["render",Je],["__scopeId","data-v-00b5f964"]]),Qe={name:"entity-time-logs",mixins:[P],components:{PeopleNameCell:j,Spinner:L,TaskTypeCell:F},props:{entity:{type:Object,default:()=>{}}},data(){return{logs:[],isLoading:!1}},mounted(){this.entity&&this.reset()},computed:{...T(["currentProduction","personMap","taskMap","taskTypeMap"])},methods:{...M(["getEntityTimeLogs"]),getTaskType(e){const t=this.taskMap.get(e.task_id);return this.taskTypeMap.get(t.task_type_id)},reset(){this.isLoading=!0,this.getEntityTimeLogs(this.entity.id).then(e=>{this.logs=e,this.isLoading=!1}).catch(e=>{console.error(e),this.logs=[],this.isLoading=!1})}},watch:{entity(){this.entity&&this.reset()}}},Xe={class:"mt1 wrapper time-logs"},et={key:0,class:"has-text-centered"},tt={key:1},st={class:"datatable"},it={class:"datatable-head"},at={class:"datatable-row-header"},nt={class:"date"},ot={class:"person"},rt={class:"type"},lt={class:"duration"},dt={class:"datatable"},ct={class:"datatable-body"},pt={class:"date"},ut={class:"duration"},_t={key:2};function ht(e,t,o,y,c,n){const d=p("spinner"),f=p("people-name-cell"),h=p("task-type-cell");return a(),r("div",Xe,[c.isLoading?(a(),r("div",et,[_(d)])):c.logs.length>0?(a(),r("div",tt,[s("table",st,[s("thead",it,[s("tr",at,[s("th",nt,i(e.$t("main.date")),1),s("th",ot,i(e.$t("main.person")),1),s("th",rt,i(e.$t("entities.preview_files.task_type")),1),s("th",lt,i(e.$t("tasks.fields.duration")),1),t[0]||(t[0]=s("th",{class:"end-cell"},null,-1))])])]),s("table",dt,[s("tbody",ct,[(a(!0),r(g,null,v(c.logs,u=>(a(),r("tr",{key:u.id,class:"datatable-row"},[s("td",pt,i(e.formatSimpleDate(u.date)),1),_(f,{class:"person",person:e.personMap.get(u.person_id)},null,8,["person"]),_(h,{class:"type","task-type":n.getTaskType(u),"production-id":e.currentProduction.id},null,8,["task-type","production-id"]),s("td",ut,i(e.formatDuration(u.duration)),1),t[1]||(t[1]=s("td",{class:"end-cell"},null,-1))]))),128))])])])):(a(),r("div",_t,i(e.$t("entities.logs.no_logs")),1))])}const jt=$(Qe,[["render",ht],["__scopeId","data-v-e24c23cf"]]),yt={name:"entity-task-list",mixins:[P],components:{PeopleAvatar:E,TableInfo:X,TaskTypeCell:F,ValidationTag:x},props:{entries:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["task-selected"],data(){return{currentTask:null}},computed:{...T(["currentProduction","getTaskTypePriority","isCurrentUserClient","isCurrentUserVendor","personMap","taskMap","taskTypeMap"]),sortedEntries(){return[...this.entries].sort((e,t)=>{if(!e)return!1;const o=this.taskTypeMap.get(e.task_type_id),y=this.taskTypeMap.get(t.task_type_id),c=this.getTaskTypePriority(e.task_type_id),n=this.getTaskTypePriority(t.task_type_id);return c===n?o.name.localeCompare(y.name,void 0,{numeric:!0}):c-n})}},methods:{onBodyScroll(e){const t=e.target;this.$refs.headerWrapper.style.left=`-${t.scrollLeft}px`},getTask(e){return typeof e=="string"?this.taskMap.get(e):e},getTaskStartDate(e){return e&&e.start_date?e.start_date.substring(0,10):""},getTaskDueDate(e){return e&&e.due_date?e.due_date.substring(0,10):""},getTaskEstimation(e){return e&&e.estimation?this.formatDuration(e.estimation):""},getTaskDuration(e){return e&&e.duration?this.formatDuration(e.duration):""},getTaskType(e){const t=this.getTask(e);return t?this.taskTypeMap.get(t.task_type_id):null},getAssignees(e){const t=this.getTask(e);return t?t.assignees:[]},selectTask(e){var t;e.id===((t=this.currentTask)==null?void 0:t.id)?this.currentTask=null:this.currentTask=e,this.$emit("task-selected",e)}}},mt={class:"data-list"},ft={class:"datatable",ref:"headerWrapper"},kt={class:"datatable-head"},gt={class:"datatable-row-header"},vt={class:"type"},wt={class:"status"},Tt={class:"estimation"},bt={class:"estimation"},$t={class:"startdate"},Dt={class:"duedate"},Mt={class:"assignees"},St={class:"datatable"},Pt={class:"datatable-body"},Et=["onClick"],Lt={class:"status"},Ft={class:"estimation"},It={class:"estimation"},zt={class:"startdate"},Ct={class:"duedate"},Bt={class:"assignees"},Nt={key:0,class:"flexrow"};function At(e,t,o,y,c,n){const d=p("table-info"),f=p("task-type-cell"),h=p("validation-tag"),u=p("people-avatar");return a(),r("div",mt,[s("div",null,[s("table",ft,[s("thead",kt,[s("tr",gt,[s("th",vt,i(e.$t("tasks.fields.task_type")),1),s("th",wt,i(e.$t("tasks.fields.task_status")),1),s("th",Tt,i(e.$t("tasks.fields.estimation").substring(0,3))+". ",1),s("th",bt,i(e.$t("tasks.fields.duration").substring(0,3))+". ",1),s("th",$t,i(e.$t("tasks.fields.start_date_short")),1),s("th",Dt,i(e.$t("tasks.fields.due_date")),1),s("th",Mt,i(e.$t("tasks.fields.assignees")),1),t[1]||(t[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),_(d,{"is-loading":o.isLoading,"is-error":o.isError},null,8,["is-loading","is-error"]),o.entries.length>0?(a(),r("div",{key:0,class:"task-list-body",onScrollPassive:t[0]||(t[0]=(...l)=>n.onBodyScroll&&n.onBodyScroll(...l))},[s("table",St,[s("tbody",Pt,[(a(!0),r(g,null,v(n.sortedEntries,l=>(a(),r("tr",{key:l.id,class:O({selected:c.currentTask&&c.currentTask.id===l.id,"datatable-row":!0,"datatable-row--selectable":!0}),onClick:w=>n.selectTask(l)},[n.getTaskType(l.id)?(a(),b(f,{key:0,class:"type","task-type":n.getTaskType(l.id),"production-id":e.currentProduction.id,"task-id":l.id},null,8,["task-type","production-id","task-id"])):k("",!0),s("td",Lt,[n.getTask(l.id)?(a(),b(h,{key:0,task:n.getTask(l.id),"is-static":!0},null,8,["task"])):k("",!0)]),s("td",Ft,i(n.getTaskEstimation(l)),1),s("td",It,i(n.getTaskDuration(l)),1),s("td",zt,i(n.getTaskStartDate(l)),1),s("td",Ct,i(n.getTaskDueDate(l)),1),s("td",Bt,[!e.isCurrentUserClient&&!e.isCurrentUserVendor?(a(),r("div",Nt,[(a(!0),r(g,null,v(n.getAssignees(l),w=>(a(),r("div",{class:"avatar-wrapper",key:w},[(a(),b(u,{class:"person-avatar flexrow-item",key:l.id+"-"+w,person:e.personMap.get(w),size:30,"font-size":15},null,8,["person"]))]))),128))])):k("",!0)]),t[2]||(t[2]=s("td",{class:"end-cell"},null,-1))],10,Et))),128))])])],32)):k("",!0)])}const Gt=$(yt,[["render",At],["__scopeId","data-v-0d1785a1"]]);export{Ut as E,Yt as a,Gt as b,jt as c,Ot as e};
//# sourceMappingURL=EntityTaskList-J70uGlK4.js.map
