import{ao as T,bk as V,bl as x,T as O,m as D,bm as B,bn as F,bo as U,bp as E,az as A,_ as P,r as g,o,c as r,e as l,t as p,F as f,g as C,G as M,l as S,w as Y,a5 as z,f as m,d as y,ba as L,s as G,B as Q,C as j,S as H,ay as _,b as K,aB as q,ad as J,ae as R}from"./index-CVkAUrXu.js";import{S as W}from"./StatsCell-DjHZBVit.js";const X={name:"episode-stats-list",mixins:[T],components:{ChevronDownIcon:V,ChevronRightIcon:x,StatsCell:W,TableInfo:O},props:{countMode:{type:String,default:"count"},dataMode:{type:String,default:"retakes"},displayMode:{type:String,default:"pie"},entries:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1},showAll:{type:Boolean,default:!1},validationColumns:{type:Array,default:()=>[]}},data(){return{expanded:{},lastSelection:null,takeLabelColors:["#FB8C00","#EF6C00","#d35400","#e74c3c","#c0392b"]}},mounted(){this.entries.forEach(e=>{this.expanded[e.id]=!1})},computed:{...D(["currentEpisode","currentProduction","displayedEpisodesLength","episodeSearchText","episodeStats","episodeRetakeStats","isCurrentUserClient","isCurrentUserManager","isSingleEpisode","isTVShow","taskTypeMap"]),isEmptyList(){return this.entries&&this.entries.length===0&&!this.isLoading&&!this.isError&&(!this.episodeSearchText||this.episodeSearchText.length===0)},isRetakes(){return this.dataMode==="retakes"}},methods:{chartColors(e,t){return this.isRetakes?["#ff3860","#6f727a","#22d160"]:B(this.episodeStats,e,t)},chartData(e,t,i="count"){return this.isRetakes?F(this.episodeRetakeStats,e,t,i):U(this.episodeStats,e,t,i)},chartTakeData(e,t,i,k="count"){const d=this.episodeRetakeStats[e][t].evolution,a=d[i].retake[k],b=d[i].done[k],h=d[i].other[k];return[["retake",a,"#ff3860"],["other",h,"#6f727a"],["done",b,"#22d160"]]},chartLabel(e,t){if(this.isRetakes){const i=E(this.episodeRetakeStats,e,t);return i>=1?`Take ${i+1}`:""}else return""},chartLabelColor(e,t){if(this.isRetakes){let i=E(this.episodeRetakeStats,e,t);return i=Math.min(i,4),this.takeLabelColors[i]}else return""},chartRetakeMaxCount(e,t){return E(this.episodeRetakeStats,e,t)},takeRange(e){return A(1,this.chartRetakeMaxCount(e,"all")+1)},isStats(e,t){return this.episodeStats[e]&&this.episodeStats[e][t]},taskTypePath(e){const t={name:"task-type",params:{production_id:this.currentProduction.id,task_type_id:e,type:"count"}};return this.isTVShow&&(t.name="episode-task-type",t.params.episode_id=this.currentEpisode.id),t},getPath(e,t){return{name:e,params:{production_id:this.currentProduction.id,episode_id:t}}},toggleExpanded(e){this.expanded[e]=!this.expanded[e]}},watch:{entries:{deep:!0,handler(){this.entries.forEach(e=>{const t=this.expanded[e.id]||!1;this.expanded[e.id]=t})}},isRetakes(){this.isRetakes||this.entries.forEach(e=>{this.expanded[e.id]=!1})}}},Z={class:"data-list"},N={class:"datatable"},I={class:"datatable-head"},$={scope:"col",class:"validation"},ee=["title"],te={key:0,class:"datatable-body"},se={key:0,class:"all-line datatable-row"},ae={scope:"col",class:"name datatable-row-header"},ie={class:"datatable-row"},oe=["onClick"],le={class:"name datatable-row-header"},de={key:1},ne={class:"name datatable-row-header"},re={key:0,class:"has-text-centered"},ce={class:"info"},he={key:1,class:"has-text-centered"},ue={class:"info"},pe={key:2,class:"has-text-centered nb-episodes"};function me(e,t,i,k,d,a){const b=g("router-link"),h=g("stats-cell"),w=g("chevron-right-icon"),v=g("chevron-down-icon"),u=g("table-info");return o(),r("div",Z,[l("div",{class:"datatable-wrapper",ref:"body",onScrollPassive:t[0]||(t[0]=(...s)=>e.onBodyScroll&&e.onBodyScroll(...s))},[l("table",N,[l("thead",I,[l("tr",null,[t[1]||(t[1]=l("th",{class:"expander"},null,-1)),l("th",{scope:"col",class:"name datatable-row-header",ref:"th-episode"},p(e.$t("shots.fields.episode")),513),l("th",$,p(e.$t("main.all")),1),(o(!0),r(f,null,C(i.validationColumns,s=>(o(),r("th",{scope:"col",class:"validation validation-cell",key:e.taskTypeMap.get(s).id},[l("div",{class:"flexrow validation-content",style:M(e.getValidationStyle(s))},[e.isCurrentUserClient?(o(),r("span",{key:1,class:"flexrow-item ellipsis",title:e.taskTypeMap.get(s).name},p(e.taskTypeMap.get(s).name),9,ee)):(o(),S(b,{key:0,class:"flexrow-item ellipsis",title:e.taskTypeMap.get(s).name,to:a.taskTypePath(s)},{default:Y(()=>[z(p(e.taskTypeMap.get(s).name),1)]),_:2},1032,["title","to"]))],4)]))),128)),t[2]||(t[2]=l("th",{scope:"col",class:"actions"},null,-1))])]),i.isLoading?y("",!0):(o(),r("tbody",te,[i.showAll&&!a.isEmptyList?(o(),r("tr",se,[t[3]||(t[3]=l("td",{class:"expander"},null,-1)),l("td",ae,p(e.$t("episodes.all_episodes")),1),m(h,{colors:a.chartColors("all","all"),data:a.chartData("all","all"),"frames-data":a.chartData("all","all","frames"),"drawings-data":a.chartData("all","all","drawings"),"count-mode":i.countMode,"display-mode":i.displayMode},null,8,["colors","data","frames-data","drawings-data","count-mode","display-mode"]),(o(!0),r(f,null,C(i.validationColumns,s=>(o(),S(h,{style:M(e.getValidationStyle(s)),key:"all-"+s,colors:a.chartColors("all",s),data:a.chartData("all",s),"frames-data":a.chartData("all",s,"frames"),"drawings-data":a.chartData("all",s,"drawings"),"count-mode":i.countMode,"display-mode":i.displayMode},null,8,["style","colors","data","frames-data","drawings-data","count-mode","display-mode"]))),128)),t[4]||(t[4]=l("td",{class:"actions"},null,-1))])):y("",!0),(o(!0),r(f,null,C(i.entries,s=>(o(),r(f,{key:s.id},[l("tr",ie,[l("td",{class:"expander",onClick:n=>a.toggleExpanded(s.id)},[a.isRetakes&&d.expanded[s.id]!==!0?(o(),S(w,{key:0})):y("",!0),a.isRetakes&&d.expanded[s.id]===!0?(o(),S(v,{key:1})):y("",!0)],8,oe),l("td",le,p(s.name),1),a.isStats(s.id,"all")?(o(),S(h,{key:0,colors:a.chartColors(s.id,"all"),data:a.chartData(s.id,"all"),"frames-data":a.chartData(s.id,"all","frames"),"drawings-data":a.chartData(s.id,"all","drawings"),"count-mode":i.countMode,"display-mode":i.displayMode},null,8,["colors","data","frames-data","drawings-data","count-mode","display-mode"])):(o(),r("td",de)),(o(!0),r(f,null,C(i.validationColumns,n=>(o(),r(f,null,[a.isStats(s.id,n)?(o(),S(h,{key:s.id+n,style:M(e.getValidationStyle(n)),colors:a.chartColors(s.id,n),data:a.chartData(s.id,n),"drawings-data":a.chartData(s.id,n,"drawings"),"count-mode":i.countMode,"display-mode":i.displayMode,label:a.chartLabel(s.id,n),"label-color":a.chartLabelColor(s.id,n)},null,8,["style","colors","data","drawings-data","count-mode","display-mode","label","label-color"])):(o(),r("td",{key:s.id+n+"-td",style:M(e.getValidationStyle(n))},null,4))],64))),256)),t[5]||(t[5]=l("td",{class:"actions"},null,-1))]),d.expanded[s.id]?(o(!0),r(f,{key:0},C(a.takeRange(s.id),n=>(o(),r("tr",{class:"datatable-row",key:n+"-"+s.id},[t[6]||(t[6]=l("td",{class:"expander"},null,-1)),l("td",ne," - Take "+p(n),1),t[7]||(t[7]=l("td",null,null,-1)),(o(!0),r(f,null,C(i.validationColumns,c=>(o(),r(f,null,[a.chartRetakeMaxCount(s.id,c)+1>n?(o(),S(h,{key:n+s.id+c,style:M(e.getValidationStyle(c)),colors:a.chartColors(s.id,c),data:a.chartTakeData(s.id,c,n),"frames-data":a.chartTakeData(s.id,c,n,"frames"),"drawings-data":a.chartTakeData(s.id,c,n,"drawings"),"count-mode":i.countMode,"display-mode":i.displayMode},null,8,["style","colors","data","frames-data","drawings-data","count-mode","display-mode"])):a.isStats(s.id,c)&&a.chartRetakeMaxCount(s.id,c)+1===n?(o(),S(h,{key:n+s.id+c,style:M(e.getValidationStyle(c)),colors:a.chartColors(s.id,c),data:a.chartData(s.id,c),"frames-data":a.chartData(s.id,c,"frames"),"drawings-data":a.chartData(s.id,c,"drawings"),"count-mode":i.countMode,"display-mode":i.displayMode},null,8,["style","colors","data","frames-data","drawings-data","count-mode","display-mode"])):(o(),r("td",{key:n+s.id+c,style:M(e.getValidationStyle(c))},null,4))],64))),256)),t[8]||(t[8]=l("td",{class:"actions"},null,-1))]))),128)):y("",!0)],64))),128))]))])],544),m(u,{"is-loading":i.isLoading,"is-error":i.isError},null,8,["is-loading","is-error"]),!i.isLoading&&a.isEmptyList&&!e.isCurrentUserClient?(o(),r("div",re,[t[9]||(t[9]=l("p",{class:"info"},[l("img",{src:L})],-1)),l("p",ce,p(e.$t("episodes.empty_list")),1)])):y("",!0),!i.isLoading&&a.isEmptyList&&e.isCurrentUserClient?(o(),r("div",he,[t[10]||(t[10]=l("p",{class:"info"},[l("img",{src:L})],-1)),l("p",ue,p(e.$t("episodes.empty_list_client")),1)])):y("",!0),a.isEmptyList?y("",!0):(o(),r("p",pe,p(e.displayedEpisodesLength)+" "+p(e.$tc("episodes.number",e.displayedEpisodesLength)),1))])}const fe=P(X,[["render",me],["__scopeId","data-v-53c7ca69"]]),ge={name:"episode-stats",mixins:[G],components:{ButtonSimple:Q,Combobox:j,EpisodeStatsList:fe,SearchField:H},data(){return{countMode:"count",dataMode:"retakes",displayMode:"pie",isLoading:!0,isLoadingError:!1,statusMode:"running",countModeOptions:[{label:"shots",value:"count"},{label:"frames",value:"frames"}],dataModeOptions:[{label:"retakes",value:"retakes"},{label:"status",value:"status"}],displayModeOptions:[{label:"pie",value:"pie"},{label:"count",value:"count"}],statusModeOptions:[{label:"only_running",value:"running"},{label:"all",value:"all"}]}},mounted(){this.setCountOptions();const e=_.getPreference("stats:episode-mode")||"retakes";this.dataMode=e,this.setDefaultListScrollPosition(),this.isLoading=!0,this.isLoadingError=!1,this.setSearchFromUrl(),this.initEpisodeStats().then(()=>{this.isLoading=!1,this.setSearchInUrl(),this.onSearchChange()}).catch(t=>{this.isLoading=!1,this.isLoadingError=!0,console.error(t)})},computed:{...D(["currentProduction","displayedEpisodes","episodeMap","episodeStats","episodeRetakeStats","episodeSearchText","episodeListScrollPosition","episodeValidationColumns","isPaperProduction","taskStatusMap","taskTypeMap"]),searchField(){return this.$refs["episode-search-field"]},isRetakeDataMode(){return this.dataMode==="retakes"}},methods:{...K(["editEpisode","initEpisodeStats","loadEpisodeStats","loadEpisodeRetakeStats","setEpisodeSearch","setEpisodeListScrollPosition"]),setCountOptions(){this.isPaperProduction?this.countModeOptions=[{label:"shots",value:"count"},{label:"drawings",value:"drawings"}]:this.countModeOptions=[{label:"shots",value:"count"},{label:"frames",value:"frames"}],this.countMode=this.countModeOptions[0].value},setDefaultListScrollPosition(){this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition)},onSearchChange(){const e=this.searchField.getValue();this.setSearchInUrl(),this.setEpisodeSearch(e)},saveScrollPosition(e){this.setEpisodeListScrollPosition(e)},exportStatisticsToCsv(){const e=[q().format("YYYYMMDD"),this.currentProduction.name,"episodes","statistics"];this.isRetakeDataMode&&e.splice(3,0,"retake");const t=J.slugify(e.join("_"));this.isRetakeDataMode?R.generateRetakeStatReports(t,this.episodeRetakeStats,this.taskTypeMap,this.taskStatusMap,this.episodeMap,this.countMode,this.currentProduction):R.generateStatReports(t,this.episodeStats,this.taskTypeMap,this.taskStatusMap,this.episodeMap,this.countMode,this.currentProduction)},onFieldChanged({entry:e,fieldName:t,value:i}){const k={id:e.id};k[t]=i,this.editEpisode(k)},reset(){this.isLoading=!0,this.isLoadingError=!1,this.loadEpisodeStats(this.currentProduction.id).then(()=>this.loadEpisodeRetakeStats(this.currentProduction.id)).then(()=>{this.isLoading=!1}).catch(e=>{this.isLoading=!1,this.isLoadingError=!0,console.error(e)})}},watch:{currentProduction(){this.searchField.setValue(""),this.$store.commit("SET_SEQUENCE_LIST_SCROLL_POSITION",0),this.reset()},dataMode(){_.setPreference("stats:episode-mode",this.dataMode)}},head(){return{title:`${this.currentProduction.name} ${this.$t("episodes.title")} - Kitsu`}}},ke={class:"episodes page fixed-page"},Se={class:"episode-list-header page-header flexrow"};function ye(e,t,i,k,d,a){const b=g("search-field"),h=g("combobox"),w=g("button-simple"),v=g("episode-stats-list");return o(),r("div",ke,[l("div",Se,[m(b,{class:"flexrow-item mt1",ref:"episode-search-field",onChange:a.onSearchChange,placeholder:"ex: e01 s01, anim=wip"},null,8,["onChange"]),m(h,{class:"mb0 flexrow-item","locale-key-prefix":"statistics.",label:e.$t("statistics.data_mode"),options:d.dataModeOptions,modelValue:d.dataMode,"onUpdate:modelValue":t[0]||(t[0]=u=>d.dataMode=u)},null,8,["label","options","modelValue"]),m(h,{class:"mb0 flexrow-item","locale-key-prefix":"statistics.",label:e.$t("statistics.display_mode"),options:d.displayModeOptions,modelValue:d.displayMode,"onUpdate:modelValue":t[1]||(t[1]=u=>d.displayMode=u)},null,8,["label","options","modelValue"]),m(h,{class:"mb0 flexrow-item",label:e.$t("statistics.count_mode"),"locale-key-prefix":"statistics.",options:d.countModeOptions,modelValue:d.countMode,"onUpdate:modelValue":t[2]||(t[2]=u=>d.countMode=u)},null,8,["label","options","modelValue"]),m(h,{class:"mb0 flexrow-item",label:e.$t("statistics.episode_status"),"locale-key-prefix":"statistics.",options:d.statusModeOptions,modelValue:d.statusMode,"onUpdate:modelValue":t[3]||(t[3]=u=>d.statusMode=u)},null,8,["label","options","modelValue"]),t[4]||(t[4]=l("span",{class:"filler"},null,-1)),m(w,{class:"flexrow-item",icon:"refresh",title:e.$t("main.reload"),onClick:a.reset},null,8,["title","onClick"]),m(w,{class:"flexrow-item",disabled:d.isLoading,icon:"download",onClick:a.exportStatisticsToCsv},null,8,["disabled","onClick"])]),m(v,{ref:"episode-list","count-mode":d.countMode,"data-mode":d.dataMode,"display-mode":d.displayMode,entries:d.statusMode==="running"?e.displayedEpisodes.filter(u=>u.status==="running"):e.displayedEpisodes,"episode-stats":e.episodeStats,"episode-retakes-stats":e.episodeRetakeStats,"is-loading":d.isLoading,"is-error":d.isLoadingError,"show-all":e.episodeSearchText.length===0,"validation-columns":e.episodeValidationColumns,onFieldChanged:a.onFieldChanged,onScroll:a.saveScrollPosition},null,8,["count-mode","data-mode","display-mode","entries","episode-stats","episode-retakes-stats","is-loading","is-error","show-all","validation-columns","onFieldChanged","onScroll"])])}const be=P(ge,[["render",ye]]);export{be as default};
//# sourceMappingURL=EpisodeStats-i_wUO38e.js.map
