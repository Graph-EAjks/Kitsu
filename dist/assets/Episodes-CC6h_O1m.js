import{ap as Q,q as R,s as K,ao as Y,b4 as W,B as I,O as G,E as J,b5 as X,b6 as Z,a1 as j,b7 as x,b8 as ee,ax as se,T as te,V as ie,b9 as ae,m as z,b as q,_ as $,r as d,k as oe,o as a,c as n,e as m,f as h,n as _,t as f,l as y,d as l,F as k,g as C,p as E,$ as O,w as ne,a3 as N,A as le,a9 as de,ba as re,ak as pe,bb as ue,bc as he,bd as me,be as ce,ar as fe,al as ye,bf as ge,aa as ke,an as Ce,S as Se,av as Ee,bg as Me,bh as De,aw as ve,J as Te,aB as be,ab as we,Y as Le,ac as Ae}from"./index-D3blfzsM.js";import{E as Ve}from"./EditEpisodeModal-B_otHh15.js";const Pe={name:"episode-list",mixins:[Q,R,K,Y,W],props:{displayedEpisodes:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},validationColumns:{type:Array,default:()=>[]},departmentFilter:{type:Array,default:()=>[]}},emits:["create-tasks","delete-clicked","edit-clicked","field-changed","metadata-changed"],data(){return{type:"episode",hiddenColumns:{},lastHeaderMenuDisplayed:null,lastMetadaDataHeaderMenuDisplayed:null,lastHeaderMenuDisplayedIndexInGrid:null,lastSelectedEpisode:null,lastSelection:null,metadataDisplayHeaders:{estimation:!0,timeSpent:!0,status:!0},offsets:{},stickedColumns:{},episodeStatusOptions:[{label:"canceled",value:"canceled"},{label:"complete",value:"complete"},{label:"running",value:"running"},{label:"standby",value:"standby"}]}},components:{ButtonSimple:I,DescriptionCell:G,EntityThumbnail:J,MetadataHeader:X,MetadataInput:Z,RowActionsCell:j,TableHeaderMenu:x,TableMetadataHeaderMenu:ee,TableMetadataSelectorMenu:se,TableInfo:te,ValidationCell:ie,ValidationHeader:ae},computed:{...z(["currentProduction","episodeMap","episodeFilledColumns","episodeMetadataDescriptors","episodes","episodeSearchText","episodeSelectionGrid","currentEpisode","displayedEpisodesEstimation","displayedEpisodesLength","displayedEpisodesTimeSpent","isBigThumbnails","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","isCurrentUserClient","isSingleEpisode","isEpisodeDescription","isEpisodeEstimation","isEpisodeResolution","isEpisodeTime","isShowAssignations","isShowInfos","nbSelectedTasks","selectedTasks","taskMap","taskTypeMap","user"]),isEmptyList(){return this.displayedEpisodes.length&&this.displayedEpisodes[0].length===0&&!this.isLoading&&!this.isError&&(!this.episodeSearchText||this.episodeSearchText.length===0)},isListVisible(){return!this.isLoading&&!this.isError&&this.displayedEpisodesLength>0},visibleColumns(){let e=2;return e+=!this.isCurrentUserClient&&this.isShowInfos&&this.isEpisodeDescription?1:0,e+=this.visibleMetadataDescriptors.length,e+=!this.isCurrentUserClient&&this.isShowInfos&&this.isEpisodeTime&&this.metadataDisplayHeaders.timeSpent?1:0,e+=!this.isCurrentUserClient&&this.isShowInfos&&this.isEpisodeEstimation&&this.metadataDisplayHeaders.estimation?1:0,e+=this.displayedValidationColumns.length,e},displayedValidationColumns(){return this.validationColumns.filter(e=>this.episodeFilledColumns[e]&&(!this.hiddenColumns[e]||this.isShowInfos))},metadataDescriptors(){return this.episodeMetadataDescriptors},localStorageStickKey(){return`stick-episodes-${this.currentProduction.id}`}},methods:{...q(["setEpisodeSelection"]),isSelected(e,s){return this.episodeSelectionGrid[e]&&this.episodeSelectionGrid[e][s]},episodePath(e){return this.getPath("episode",e)},getPath(e,s){const r={name:e,params:{production_id:this.currentProduction.id}};return s&&(r.params.episode_id=s),r},onEpisodeStatusChanged(e,s){this.$emit("field-changed",{entry:e,fieldName:"status",value:s})}},watch:{displayedEpisodes(){this.$options.lineIndex={}},validationColumns(){this.initHiddenColumns(this.validationColumns,this.hiddenColumns)},stickedColumns(){this.updateOffsets()},isLoading(){this.updateOffsets()},isBigThumbnails(){this.updateOffsets()}}},He={class:"data-list"},Ue={class:"datatable"},Be={class:"datatable-head",id:"datatable-episode"},Fe={scope:"col",class:"name episode-name datatable-row-header",ref:"th-episode"},_e={class:"flexrow"},Ne={class:"flexrow-item"},Ie={key:2,scope:"col",class:"description selectable"},ze=["title"],qe={key:7,scope:"col",class:"resolution selectable"},$e={scope:"col",class:"actions",ref:"actionsSection"},Oe={class:"datatable-body"},Qe={class:"flexrow"},Re=["title"],Ke=["title"],Ye={key:4,class:"time-spent selectable"},We={key:5,class:"estimation selectable"},Ge={class:"select"},Je=["onChange"],Xe=["value","selected"],Ze={key:7,class:"resolution"},je=["value","onInput","onKeyup"],xe={key:1,class:"metadata-value selectable"},es={key:10,class:"actions"},ss={key:0,class:"has-text-centered"},ts={class:"info"},is={key:1,class:"has-text-centered nb-episodes"},as={key:0};function os(e,s,r,g,t,c){const V=d("table-header-menu"),D=d("table-metadata-header-menu"),M=d("button-simple"),v=d("metadata-header"),T=d("validation-header"),P=d("table-metadata-selector-menu"),H=d("entity-thumbnail"),U=d("router-link"),b=d("metadata-input"),w=d("validation-cell"),L=d("description-cell"),A=d("row-actions-cell"),B=d("table-info"),F=oe("columns-resizable");return a(),n("div",He,[m("div",{class:"datatable-wrapper",ref:"body",onScrollPassive:s[15]||(s[15]=(...i)=>e.onBodyScroll&&e.onBodyScroll(...i))},[h(V,{ref:"headerMenu","is-minimized":t.hiddenColumns[t.lastHeaderMenuDisplayed],"is-edit-allowed":e.isCurrentUserManager,"is-sticked":t.stickedColumns[t.lastHeaderMenuDisplayed],onMinimizeClicked:s[0]||(s[0]=i=>e.onMinimizeColumnToggled()),onDeleteAllClicked:s[1]||(s[1]=i=>e.onDeleteAllTasksClicked()),onSortByClicked:s[2]||(s[2]=i=>e.onSortByTaskTypeClicked()),onSelectColumn:s[3]||(s[3]=i=>e.onSelectColumn("episode")),onToggleStick:s[4]||(s[4]=i=>e.stickColumnClicked())},null,8,["is-minimized","is-edit-allowed","is-sticked"]),h(D,{ref:"headerMetadataMenu","is-edit-allowed":e.isMetadataColumnEditAllowed(t.lastMetadaDataHeaderMenuDisplayed),"is-sticked":t.stickedColumns[t.lastMetadaDataHeaderMenuDisplayed],onEditClicked:s[5]||(s[5]=i=>e.onEditMetadataClicked()),onDeleteClicked:s[6]||(s[6]=i=>e.onDeleteMetadataClicked()),onSortByClicked:s[7]||(s[7]=i=>e.onSortByMetadataClicked()),onToggleStick:s[8]||(s[8]=i=>e.metadataStickColumnClicked(i))},null,8,["is-edit-allowed","is-sticked"]),m("table",Ue,[_((a(),n("thead",Be,[m("tr",null,[m("th",Fe,[m("div",_e,[m("span",Ne,f(e.$t("episodes.fields.name")),1),(e.isCurrentUserManager||e.isCurrentUserSupervisor)&&!r.isLoading?(a(),y(M,{key:0,class:"is-small flexrow-item",icon:"plus",text:"",onClick:e.onAddMetadataClicked},null,8,["onClick"])):l("",!0)])],512),e.isShowInfos?(a(!0),n(k,{key:0},C(e.stickedVisibleMetadataDescriptors,(i,p)=>(a(),y(v,{ref_for:!0,ref:`editor-${p}`,key:i.id,descriptor:i,left:t.offsets["editor-"+p]?`${t.offsets["editor-"+p]}px`:"0","is-stick":"",onShowMetadataHeaderMenu:o=>e.showMetadataHeaderMenu(i.id,o)},null,8,["descriptor","left","onShowMetadataHeaderMenu"]))),128)):l("",!0),r.isLoading?l("",!0):(a(!0),n(k,{key:1},C(e.stickedDisplayedValidationColumns,(i,p)=>(a(),y(T,{ref_for:!0,ref:`validation-${p}`,key:i,"hidden-columns":t.hiddenColumns,"column-id":i,"validation-style":e.getValidationStyle(i),left:t.offsets["validation-"+p]?`${t.offsets["validation-"+p]}px`:"0",type:"editor","is-stick":"",onShowHeaderMenu:o=>e.showHeaderMenu(i,p,o)},null,8,["hidden-columns","column-id","validation-style","left","onShowHeaderMenu"]))),128)),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeDescription?(a(),n("th",Ie,f(e.$t("episodes.fields.description")),1)):l("",!0),e.isShowInfos?(a(!0),n(k,{key:3},C(e.nonStickedVisibleMetadataDescriptors,i=>(a(),y(v,{key:i.id,descriptor:i,onShowMetadataHeaderMenu:p=>e.showMetadataHeaderMenu(i.id,p)},null,8,["descriptor","onShowMetadataHeaderMenu"]))),128)):l("",!0),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeTime&&t.metadataDisplayHeaders.timeSpent?(a(),n("th",{key:4,scope:"col",class:"time-spent",ref:"th-spent"},f(e.$t("episodes.fields.time_spent")),513)):l("",!0),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeEstimation&&t.metadataDisplayHeaders.estimation?(a(),n("th",{key:5,scope:"col",class:"estimation",title:e.$t("main.estimation"),ref:"th-spent"},f(e.$t("main.estimation_short")),9,ze)):l("",!0),e.isShowInfos&&t.metadataDisplayHeaders.status?(a(),n("th",{key:6,scope:"col",class:"status",ref:"th-status"},f(e.$t("main.status")),513)):l("",!0),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeResolution?(a(),n("th",qe,f(e.$t("shots.fields.resolution")),1)):l("",!0),r.isLoading?l("",!0):(a(!0),n(k,{key:8},C(e.nonStickedDisplayedValidationColumns,(i,p)=>(a(),y(T,{key:i,"hidden-columns":t.hiddenColumns,"column-id":i,"validation-style":e.getValidationStyle(i),type:"episodes",onShowHeaderMenu:o=>{e.showHeaderMenu(i,p,o)}},null,8,["hidden-columns","column-id","validation-style","onShowHeaderMenu"]))),128)),m("th",$e,[e.isCurrentUserManager&&r.displayedEpisodes.length>0&&!r.isLoading?(a(),y(M,{key:0,class:E({"is-small":!0,highlighted:e.isEmptyTask}),icon:"plus",text:e.$t("tasks.create_tasks"),onClick:s[9]||(s[9]=i=>e.$emit("create-tasks"))},null,8,["class","text"])):l("",!0),e.isShowInfos?_((a(),y(P,{key:1,descriptors:e.episodeMetadataDescriptors,exclude:{timeSpent:!e.isEpisodeTime,estimation:!e.isEpisodeEstimation},namespace:"episodes",modelValue:t.metadataDisplayHeaders,"onUpdate:modelValue":s[10]||(s[10]=i=>t.metadataDisplayHeaders=i)},null,8,["descriptors","exclude","modelValue"])),[[O,e.columnSelectorDisplayed]]):l("",!0),e.episodeMetadataDescriptors.length>0&&e.isShowInfos?(a(),y(M,{key:2,class:"is-small is-pulled-right mr05",icon:"down",onClick:e.toggleColumnSelector},null,8,["onClick"])):l("",!0)],512)])])),[[F]]),m("tbody",Oe,[!r.isLoading&&c.isListVisible?(a(!0),n(k,{key:0},C(r.displayedEpisodes,(i,p)=>(a(),n("tr",{class:E(["datatable-row",{canceled:i.canceled}]),scope:"row",key:i.id},[m("th",{class:E({"datatable-row-header":!0,"episode-name":!0,name:!0,strong:!i.canceled})},[m("div",Qe,[h(H,{entity:i,width:e.isBigThumbnails?150:50,height:e.isBigThumbnails?100:33,"empty-width":e.isBigThumbnails?150:50,"empty-height":e.isBigThumbnails?100:34},null,8,["entity","width","height","empty-width","empty-height"]),h(U,{tabindex:"-1",title:i.name,to:c.episodePath(i.id)},{default:ne(()=>[N(f(i.name),1)]),_:2},1032,["title","to"])])],2),e.isShowInfos?(a(!0),n(k,{key:0},C(e.stickedVisibleMetadataDescriptors,(o,u)=>(a(),n("td",{ref_for:!0,ref:`editor-${p}-${u}`,class:"metadata-descriptor datatable-row-header",title:i.data?i.data[o.field_name]:"",style:le({"z-index":1e3-p,left:t.offsets["editor-"+u]?`${t.offsets["editor-"+u]}px`:"0"}),key:i.id+"-"+o.id},[h(b,{entity:i,descriptor:o,indexes:{i:p,j:u},onMetadataChanged:s[11]||(s[11]=S=>e.$emit("metadata-changed",S))},null,8,["entity","descriptor","indexes"])],12,Re))),128)):l("",!0),r.isLoading?l("",!0):(a(!0),n(k,{key:1},C(e.stickedDisplayedValidationColumns,(o,u)=>(a(),y(w,{ref_for:!0,ref:`validation-${p}-${u}`,key:o+"-"+i.id,class:E({"validation-cell":!t.hiddenColumns[o],"hidden-validation-cell":t.hiddenColumns[o],"datatable-row-header":!0}),column:e.taskTypeMap.get(o),"column-y":u,entity:i,"is-assignees":e.isShowAssignations,"is-static":!0,left:t.offsets["validation-"+u]?`${t.offsets["validation-"+u]}px`:"0",minimized:t.hiddenColumns[o],"row-x":p,selected:c.isSelected(p,u),sticked:!0,"task-test":e.taskMap.get(i.validations.get(o)),onSelect:s[12]||(s[12]=S=>e.onTaskSelected(S,!0)),onUnselect:s[13]||(s[13]=S=>e.onTaskUnselected(S,!0))},null,8,["class","column","column-y","entity","is-assignees","left","minimized","row-x","selected","task-test"]))),128)),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeDescription?(a(),y(L,{key:2,class:"description",entry:i,editable:e.isCurrentUserManager,onDescriptionChanged:o=>e.onDescriptionChanged(i,o)},null,8,["entry","editable","onDescriptionChanged"])):l("",!0),e.isShowInfos?(a(!0),n(k,{key:3},C(e.nonStickedVisibleMetadataDescriptors,(o,u)=>(a(),n("td",{class:"metadata-descriptor",title:i.data?i.data[o.field_name]:"",key:i.id+"-"+o.id},[h(b,{entity:i,descriptor:o,indexes:{i:p,j:u},onMetadataChanged:s[14]||(s[14]=S=>e.$emit("metadata-changed",S))},null,8,["entity","descriptor","indexes"])],8,Ke))),128)):l("",!0),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeTime&&t.metadataDisplayHeaders.timeSpent?(a(),n("td",Ye,f(e.formatDuration(i.timeSpent)),1)):l("",!0),!e.isCurrentUserClient&&e.isShowInfos&&e.isEpisodeEstimation&&t.metadataDisplayHeaders.estimation?(a(),n("td",We,f(e.formatDuration(i.estimation)),1)):l("",!0),e.isShowInfos&&t.metadataDisplayHeaders.status?(a(),n("td",{key:6,scope:"col",class:"status metadata-descriptor",ref_for:!0,ref:"th-status"},[m("span",Ge,[m("select",{class:"select-input",onChange:o=>c.onEpisodeStatusChanged(i,o.target.value)},[(a(!0),n(k,null,C(t.episodeStatusOptions,o=>(a(),n("option",{key:`${i.id}-status-option-${o.value}`,value:o.value,selected:(i.status||"running")===o.value},f(e.$t("episodes.status."+o.label)),9,Xe))),128))],40,Je)])],512)):l("",!0),e.isEpisodeResolution&&e.isShowInfos?(a(),n("td",Ze,[e.isCurrentUserManager?(a(),n("input",{key:0,class:E({"input-editor":!0,error:!e.isValidResolution(i)}),value:e.getMetadataFieldValue({field_name:"resolution"},i),onInput:o=>e.onMetadataFieldChanged(i,{field_name:"resolution"},o),onKeyup:de(o=>e.onInputKeyUp(o,e.getIndex(p,e.k),e.descriptorLength+3),["ctrl"])},null,42,je)):(a(),n("span",xe,f(e.getMetadataFieldValue({field_name:"resolution"},i)),1))])):l("",!0),r.isLoading?l("",!0):(a(!0),n(k,{key:8},C(e.nonStickedDisplayedValidationColumns,(o,u)=>(a(),y(w,{ref_for:!0,ref:`validation-${p}-${u+e.stickedDisplayedValidationColumns.length}`,class:E({"validation-cell":!t.hiddenColumns[o],"hidden-validation-cell":t.hiddenColumns[o]}),key:`${o}-${i.id}`,column:e.taskTypeMap.get(o),entity:i,"task-test":e.taskMap.get(i.validations?i.validations.get(o):null),minimized:t.hiddenColumns[o],selected:c.isSelected(p,u+e.stickedDisplayedValidationColumns.length),"row-x":p,"column-y":u,"is-assignees":e.isShowAssignations,onSelect:e.onTaskSelected,onUnselect:e.onTaskUnselected},null,8,["class","column","entity","task-test","minimized","selected","row-x","column-y","is-assignees","onSelect","onUnselect"]))),128)),e.isCurrentUserManager?(a(),y(A,{key:9,entry:i,onDeleteClicked:o=>e.$emit("delete-clicked",i),onEditClicked:o=>e.$emit("edit-clicked",i)},null,8,["entry","onDeleteClicked","onEditClicked"])):(a(),n("td",es))],2))),128)):l("",!0)])])],544),h(B,{"is-loading":r.isLoading,"is-error":r.isError},null,8,["is-loading","is-error"]),c.isEmptyList&&e.isCurrentUserClient&&!r.isLoading?(a(),n("div",ss,[s[16]||(s[16]=m("p",{class:"info"},[m("img",{src:re})],-1)),m("p",ts,f(e.$t("episodes.empty_list_client")),1)])):l("",!0),!c.isEmptyList&&!r.isLoading?(a(),n("p",is,[N(f(e.displayedEpisodesLength)+" "+f(e.$tc("episodes.number",e.displayedEpisodesLength))+" ",1),e.displayedEpisodesTimeSpent>0&&e.displayedEpisodesEstimation>0?(a(),n("span",as," ("+f(e.formatDuration(e.displayedEpisodesTimeSpent))+" "+f(e.$tc("main.days_spent",e.displayedEpisodesTimeSpent))+", "+f(e.formatDuration(e.displayedEpisodesEstimation))+" "+f(e.$tc("main.man_days",e.displayedEpisodesEstimation))+") ",1)):l("",!0)])):l("",!0)])}const ns=$(Pe,[["render",os],["__scopeId","data-v-9eb1ff5c"]]),ls={name:"episodes",mixins:[pe,ue],components:{AddMetadataModal:he,AddThumbnailsModal:me,BigThumbnailsButton:ce,BuildFilterModal:fe,ButtonSimple:I,ComboboxDepartment:ye,CreateTasksModal:ge,DeleteModal:ke,EditEpisodeModal:Ve,EpisodeList:ns,HardDeleteModal:Ce,SearchField:Se,SearchQueryList:Ee,SortingInfo:Me,ShowAssignationsButton:De,ShowInfosButton:ve,TaskInfo:Te},data(){return{type:"episode",deleteAllTasksLockText:null,descriptorToEdit:{},departmentFilter:[],episodeToDelete:null,episodeToEdit:null,formData:null,genericColumns:["Metadata column name (text value)","Task type name (task status name value)","Task type name + comment (text value)"],historyEdit:{},initialLoading:!0,isSearchActive:!1,optionalColumns:["Description"],pageName:"Episodes",parsedCSV:[],selectedDepartment:"ALL",taskTypeForTaskDeletion:null,modals:{isAddMetadataDisplayed:!1,isAddThumbnailsDisplayed:!1,isBuildFilterDisplayed:!1,isCreateTasksDisplayed:!1,isDeleteDisplayed:!1,isDeleteMetadataDisplayed:!1,isDeleteAllTasksDisplayed:!1,isImportRenderDisplayed:!1,isImportDisplayed:!1,isNewDisplayed:!1},loading:{addMetadata:!1,addThumbnails:!1,creatingTasks:!1,creatingTasksStay:!1,del:!1,deleteAllTasks:!1,deleteMetadata:!1,edit:!1,episode:!1,importing:!1,savingSearch:!1,stay:!1},errors:{addMetadata:!1,creatingTasks:!1,deleteAllTasks:!1,deleteMetadata:!1,edit:!1,importing:!1,importingError:null}}},beforeUnmount(){this.clearSelectedEpisodes()},created(){this.setLastProductionScreen("episodes")},mounted(){let e="";this.episodeSearchText&&this.episodeSearchText.length>0&&this.searchField.setValue(this.episodeSearchText),this.$route.query.search&&this.$route.query.search.length>0&&(e=`${this.$route.query.search}`),e==="undefined"&&(e=""),this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition),this.onSearchChange(),this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition),!this.isCurrentUserManager&&this.user.departments.length>0?(this.selectedDepartment="MY_DEPARTMENTS",this.departmentFilter=this.user.departments):this.departmentFilter=[];const s=()=>{this.initialLoading=!1,this.$refs["episode-list"]&&(this.$refs["episode-search-field"].setValue(e),this.onSearchChange(),this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition),this.$nextTick(()=>{var r;(r=this.$refs["episode-list"])==null||r.selectTaskFromQuery()}))};this.episodeMap.size<1||this.episodeValidationColumns.length===0||this.episodeMap.values().next().project_id!==this.currentProduction.id?this.loadEpisodesWithTasks().then(()=>{setTimeout(()=>{s()},200)}).catch(console.error):(this.isEpisodesLoading||(this.initialLoading=!1),s())},computed:{...z(["currentEpisode","currentProduction","departmentMap","departments","displayedEpisodes","episodeMap","episodes","episodeMap","episodeFilledColumns","episodeSearchText","episodeValidationColumns","episodeListScrollPosition","episodeSorting","episodeSearchQueries","isCurrentUserClient","isCurrentUserManager","isEpisodeDescription","isEpisodeEstimation","isEpisodeTime","isEpisodesLoading","isEpisodesLoadingError","isShowAssignations","isTVShow","openProductions","productionEpisodeTaskTypes","selectedTasks","taskTypeMap","user"]),renderColumns(){const e=[...this.dataMatchers,...this.optionalColumns];return this.productionEpisodeTaskTypes.forEach(s=>{e.push(s.name),e.push(`${s.name} comment`)}),e},filteredEpisodes(){const e={};return this.displayedEpisodes.forEach(s=>{const r=s.name;e[r]=!0}),e},metadataDescriptors(){return this.episodeMetadataDescriptors}},methods:{...q(["addMetadataDescriptor","createTasks","changeEpisodeSort","clearSelectedEpisodes","commentTaskWithPreview","deleteAllTasks","deleteEpisode","deleteMetadataDescriptor","editEpisode","getEpisodesCsvLines","hideAssignations","loadEpisodesWithTasks","newEpisode","removeEpisodeSearch","saveEpisodeSearch","setLastProductionScreen","setPreview","setEpisodeSearch","showAssignations","uploadEpisodeFile"]),confirmAddMetadata(e){this.loading.addMetadata=!0,e.entity_type="Episode",this.addMetadataDescriptor(e).then(()=>{this.loading.addMetadata=!1,this.modals.isAddMetadataDisplayed=!1}).catch(s=>{console.error(s),this.loading.addMetadata=!1,this.errors.addMetadata=!0})},showNewModal(){this.episodeToEdit={},this.modals.isNewDisplayed=!0},confirmDeleteEpisode(){this.loading.del=!0,this.errors.del=!1,this.deleteEpisode(this.episodeToDelete).then(()=>{this.loading.del=!1,this.modals.isDeleteDisplayed=!1}).catch(e=>{console.error(e),this.loading.del=!1,this.errors.del=!0})},runTasksCreation(e,s){return this.errors.creatingTasks=!1,this.createTasks({type:"episodes",task_type_id:e.task_type_id,project_id:this.currentProduction.id,selectionOnly:s})},reset(){this.initialLoading=!1,this.loadEpisodesWithTasks(e=>{e&&console.error(e),this.initialLoading=!1})},resetEditModal(){const e={name:""};this.openProductions.length>0&&(e.production_id=this.openProductions[0].id),this.episodeToEdit=e},applySearch(e){this.setEpisodeSearch(e),this.setSearchInUrl(),this.isSearchActive=!0},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.saveEpisodeSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removeEpisodeSearch(e).catch(console.error)},onExportClick(){this.getEpisodesCsvLines().then(e=>{const s=[be().format("YYYY-MM-DD"),"kitsu",this.currentProduction.name,this.$t("episodes.title")],r=we.slugify(s.join("_")),g=[this.$t("episodes.fields.name"),this.$t("episodes.fields.description")];this.currentEpisode&&g.splice(0,0,"Episode"),Le([...this.currentProduction.descriptors]).filter(t=>t.entity_type==="Episode").forEach(t=>{g.push(t.name)}),this.isEpisodeTime&&g.push(this.$t("episodes.fields.time_spent")),this.isEpisodeEstimation&&g.push(this.$t("main.estimation_short")),this.episodeValidationColumns.forEach(t=>{g.push(this.taskTypeMap.get(t).name),g.push("Assignations")}),Ae.buildCsvFile(r,[g].concat(e))})},async onFieldChanged({entry:e,fieldName:s,value:r}){const g={id:e.id,description:e.description,[s]:r};await this.editEpisode(g),this.onSearchChange(!1)},async onMetadataChanged({entry:e,descriptor:s,value:r}){const g={id:e.id,data:{[s.field_name]:r}};await this.editEpisode(g),this.onSearchChange(!1)},onEditClicked(e){this.episodeToEdit=e,this.modals.isNewDisplayed=!0},onDeleteClicked(e){this.episodeToDelete=e,this.modals.isDeleteDisplayed=!0},confirmEditEpisode(e){this.loading.edit=!0,this.errors.edit=!1,e.id?this.editEpisode(e).then(()=>{this.loading.edit=!1,this.modals.isNewDisplayed=!1,this.onSearchChange(!1)}).catch(s=>{console.error(s),this.loading.edit=!1,this.errors.edit=!0}):(e.project_id=this.currentProduction.id,this.newEpisode(e).then(()=>{this.loading.edit=!1,this.modals.isNewDisplayed=!1}).catch(()=>{this.loading.edit=!1,this.errors.edit=!0}))},deleteText(){const e=this.episodeToDelete;return e?this.$t("episodes.delete_text",{name:e.name}):""}},watch:{$route(){if(!this.$route.query)return;const e=this.$route.query.search,s=this.$refs["episode-search-field"].getValue();e!==s&&(this.searchField.setValue(e),this.applySearch(e))},currentProduction(){this.$refs["episode-search-field"].setValue(""),this.$store.commit("SET_EDIT_LIST_SCROLL_POSITION",0),this.initialLoading=!1,this.reset()},isEpisodesLoading(){if(!this.isEpisodesLoading){let e="";this.$route.query.search&&this.$route.query.search.length>0&&(e=`${this.$route.query.search}`),this.initialLoading=!1,this.$refs["episode-search-field"].setValue(e),this.$nextTick(()=>{this.applySearch(e)}),this.$refs["episode-list"]&&this.$refs["episode-list"].setScrollPosition(this.episodeListScrollPosition)}}},head(){return{title:`${this.currentProduction.name} ${this.$t("episodes.title")} - Kitsu`}}},ds={class:"columns fixed-page"},rs={class:"column main-column"},ps={class:"episodes page"},us={class:"episode-list-header page-header"},hs={class:"flexrow"},ms={key:0,class:"flexrow flexrow-item"},cs={key:1,class:"flexrow"},fs={class:"query-list mt1"},ys={id:"side-column",class:"column side-column"};function gs(e,s,r,g,t,c){var o;const V=d("search-field"),D=d("button-simple"),M=d("combobox-department"),v=d("show-assignations-button"),T=d("show-infos-button"),P=d("big-thumbnails-button"),H=d("search-query-list"),U=d("sorting-info"),b=d("episode-list"),w=d("task-info"),L=d("delete-modal"),A=d("hard-delete-modal"),B=d("create-tasks-modal"),F=d("add-metadata-modal");d("add-thumbnails-modal");const i=d("build-filter-modal"),p=d("edit-episode-modal");return a(),n("div",ds,[m("div",rs,[m("div",ps,[m("div",us,[m("div",hs,[h(V,{ref:"episode-search-field","can-save":!0,active:t.isSearchActive,onChange:e.onSearchChange,onSave:c.saveSearchQuery,placeholder:"ex: e01 episode=wip"},null,8,["active","onChange","onSave"]),h(D,{class:"flexrow-item",title:e.$t("entities.build_filter.title"),icon:"filter",onClick:s[0]||(s[0]=()=>t.modals.isBuildFilterDisplayed=!0)},null,8,["title"]),s[9]||(s[9]=m("div",{class:"filler"},null,-1)),e.isCurrentUserClient?l("",!0):(a(),n("div",ms,[e.departments.length>0?(a(),y(M,{key:0,class:"combobox-department flexrow-item","selectable-departments":e.selectableDepartments("Episode"),"display-all-and-my-departments":!0,rounded:"",modelValue:t.selectedDepartment,"onUpdate:modelValue":s[1]||(s[1]=u=>t.selectedDepartment=u)},null,8,["selectable-departments","modelValue"])):l("",!0),h(v,{class:"flexrow-item"}),h(T,{class:"flexrow-item"}),h(P,{class:"flexrow-item"})])),e.isCurrentUserManager?(a(),n("div",cs,[h(D,{class:"flexrow-item",text:e.$t("episodes.new_episode"),icon:"plus",onClick:c.showNewModal},null,8,["text","onClick"])])):l("",!0)]),m("div",fs,[!e.isEpisodesLoading&&!t.initialLoading?(a(),y(H,{key:0,queries:e.episodeSearchQueries,type:"episode",onChangeSearch:e.changeSearch,onRemoveSearch:c.removeSearchQuery},null,8,["queries","onChangeSearch","onRemoveSearch"])):l("",!0)])]),(o=e.episodeSorting)!=null&&o.length?(a(),y(U,{key:0,sorting:e.episodeSorting,onClearSorting:s[2]||(s[2]=u=>e.onChangeSortClicked(null))},null,8,["sorting"])):l("",!0),h(b,{ref:"episode-list","displayed-episodes":e.displayedEpisodes,"is-loading":e.isEpisodesLoading||t.initialLoading,"is-error":e.isEpisodesLoadingError,"validation-columns":e.episodeValidationColumns,"department-filter":t.departmentFilter,onAddMetadata:e.onAddMetadataClicked,onChangeSort:e.onChangeSortClicked,onCreateTasks:e.showCreateTasksModal,onDeleteAllTasks:e.onDeleteAllTasksClicked,onDeleteClicked:c.onDeleteClicked,onDeleteMetadata:e.onDeleteMetadataClicked,onEditClicked:c.onEditClicked,onEditMetadata:e.onEditMetadataClicked,onFieldChanged:c.onFieldChanged,onMetadataChanged:c.onMetadataChanged,onScroll:e.saveScrollPosition,onKeepTaskPanelOpen:e.onKeepTaskPanelOpenChanged},null,8,["displayed-episodes","is-loading","is-error","validation-columns","department-filter","onAddMetadata","onChangeSort","onCreateTasks","onDeleteAllTasks","onDeleteClicked","onDeleteMetadata","onEditClicked","onEditMetadata","onFieldChanged","onMetadataChanged","onScroll","onKeepTaskPanelOpen"])])]),_(m("div",ys,[h(w,{task:e.selectedTasks.values().next().value,"entity-type":"Episode","with-actions":""},null,8,["task"])],512),[[O,e.isTaskSidePanelOpen]]),h(L,{ref:"delete-episode-modal",active:t.modals.isDeleteDisplayed,"is-loading":t.loading.del,"is-error":t.errors.del,text:c.deleteText(),"error-text":e.$t("episodes.delete_error"),onCancel:s[3]||(s[3]=u=>t.modals.isDeleteDisplayed=!1),onConfirm:c.confirmDeleteEpisode},null,8,["active","is-loading","is-error","text","error-text","onConfirm"]),h(L,{ref:"delete-metadata-modal",active:t.modals.isDeleteMetadataDisplayed,"is-loading":t.loading.deleteMetadata,"is-error":t.errors.deleteMetadata,text:e.$t("productions.metadata.delete_text"),"error-text":e.$t("productions.metadata.delete_error"),onCancel:s[4]||(s[4]=u=>t.modals.isDeleteMetadataDisplayed=!1),onConfirm:e.confirmDeleteMetadata},null,8,["active","is-loading","is-error","text","error-text","onConfirm"]),h(A,{ref:"delete-all-tasks-modal",active:t.modals.isDeleteAllTasksDisplayed,"is-loading":t.loading.deleteAllTasks,"is-error":t.errors.deleteAllTasks,text:e.deleteAllTasksText(),"error-text":e.$t("tasks.delete_all_error"),"lock-text":t.deleteAllTasksLockText,"selection-option":!0,onCancel:s[5]||(s[5]=u=>t.modals.isDeleteAllTasksDisplayed=!1),onConfirm:e.confirmDeleteAllTasks},null,8,["active","is-loading","is-error","text","error-text","lock-text","onConfirm"]),h(B,{active:t.modals.isCreateTasksDisplayed,"is-loading":t.loading.creatingTasks,"is-loading-stay":t.loading.creatingTasksStay,"is-error":t.errors.creatingTasks,title:e.$t("tasks.create_tasks_episode"),text:e.$t("tasks.create_tasks_episode_explaination"),"error-text":e.$t("tasks.create_tasks_episode_failed"),onCancel:e.hideCreateTasksModal,onConfirm:e.confirmCreateTasks,onConfirmAndStay:e.confirmCreateTasksAndStay},null,8,["active","is-loading","is-loading-stay","is-error","title","text","error-text","onCancel","onConfirm","onConfirmAndStay"]),h(F,{active:t.modals.isAddMetadataDisplayed,"is-loading":t.loading.addMetadata,"is-error":t.errors.addMetadata,"descriptor-to-edit":t.descriptorToEdit,"entity-type":"Episode",onCancel:e.closeMetadataModal,onConfirm:c.confirmAddMetadata},null,8,["active","is-loading","is-error","descriptor-to-edit","onCancel","onConfirm"]),l("",!0),h(i,{ref:"build-filter-modal",active:t.modals.isBuildFilterDisplayed,"entity-type":"episode",onCancel:s[6]||(s[6]=u=>t.modals.isBuildFilterDisplayed=!1),onConfirm:e.confirmBuildFilter},null,8,["active","onConfirm"]),h(p,{active:t.modals.isNewDisplayed,"is-loading":t.loading.edit,"is-error":t.errors.edit,"episode-to-edit":t.episodeToEdit,onCancel:s[7]||(s[7]=u=>t.modals.isNewDisplayed=!1),onConfirm:c.confirmEditEpisode},null,8,["active","is-loading","is-error","episode-to-edit","onConfirm"]),h(A,{active:t.modals.isDeleteDisplayed,"is-loading":t.loading.del,"is-error":t.errors.del,text:c.deleteText(),"error-text":e.$t("episodes.delete_error"),"lock-text":t.episodeToDelete?t.episodeToDelete.name:"",onCancel:s[8]||(s[8]=u=>t.modals.isDeleteDisplayed=!1),onConfirm:c.confirmDeleteEpisode},null,8,["active","is-loading","is-error","text","error-text","lock-text","onConfirm"])])}const Ss=$(ls,[["render",gs],["__scopeId","data-v-f90d7bd9"]]);export{Ss as default};
//# sourceMappingURL=Episodes-CC6h_O1m.js.map
