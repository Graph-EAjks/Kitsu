import{ah as M,B as L,aj as E,aF as P,bt as x,y as A,m as C,aB as w,b as B,bu as D,_ as g,r as p,o as i,c as r,e as s,f as h,t as a,d as v,F as $,g as T,n as j,a1 as S,l as k,u as I,x as z,T as V,z as N,bv as q,ab as K,p as F}from"./index-RDj5I9zu.js";const R={name:"events",mixins:[M],components:{ButtonSimple:L,DateField:E,PeopleAvatar:P,PeopleName:x,Spinner:A},data(){return{currentDate:new Date,events:[],isLoading:!0,selectedEvents:{}}},mounted(){this.loadDayEvents()},computed:{...C(["personMap","productionMap","user"]),today(){return w().toDate()}},methods:{...B(["loadEvents"]),formatType(e){return e.name.split(":")[1].substring(0,3)},loadDayEvents(){const e=w(this.currentDate).add(1,"days"),t=w(this.currentDate);this.selectedEvents={},this.isLoading=!0,this.loadEvents({after:D(t,this.timezone),before:D(e,this.timezone)}).then(c=>{this.isLoading=!1,this.events=c}).catch(c=>{this.isLoading=!1,console.error(c)})},selectLine(e){this.selectedEvents[e.id]=!this.selectedEvents[e.id]},isLink(e){return["project_id","task_id"].includes(e)},getLink(e,t){const c=e.data.project_id,f=t.substring(0,t.length-3);if(f==="project")return`/productions/${c}/news-feed`;{const n=e.data[t];return`/productions/${c}/${f}s/${n}`}}},watch:{currentDate(){this.loadDayEvents()}},head(){return{title:`${this.$t("logs.title")} - Kitsu`}}},W={class:"mt1"},G={class:"flexrow"},O={class:"flexrow-item nb-events"},U={key:0,class:"mt2 empty"},H={key:1,class:"has-text-centered"},J={key:2,class:"log-list"},Q=["onClick"],X={class:"date tag mr1"},Y=["title","data-status"],Z={class:"name tag mr1"},ee={class:"flexrow"},se={class:"key"},te=["href"],ie={key:1};function ae(e,t,c,f,n,l){const _=p("date-field"),u=p("button-simple"),y=p("spinner"),b=p("people-avatar"),d=p("people-name");return i(),r("div",W,[s("div",G,[h(_,{class:"flexrow-item","can-delete":!1,"max-date":l.today,label:e.$t("logs.current_date_label"),modelValue:n.currentDate,"onUpdate:modelValue":t[0]||(t[0]=o=>n.currentDate=o)},null,8,["max-date","label","modelValue"]),h(u,{class:"flexrow-item small",icon:"refresh",onClick:l.loadDayEvents},null,8,["onClick"]),s("span",O,a(n.events.length)+" "+a(e.$t("logs.events")),1)]),!n.isLoading&&n.events.length===0?(i(),r("div",U,a(e.$t("logs.empty_list")),1)):v("",!0),n.isLoading?(i(),r("div",H,[h(y)])):(i(),r("div",J,[(i(!0),r($,null,T(n.events,o=>(i(),r("div",{class:"mt05 event-line",key:o.id,onClick:m=>l.selectLine(o)},[s("div",null,[s("span",X,a(e.formatDate(o.created_at)),1),s("span",{class:"type tag",title:o.name.split(":")[1],"data-status":l.formatType(o)},a(l.formatType(o)),9,Y),s("span",Z,a(o.name.split(":")[0]),1)]),j(s("ul",null,[s("li",ee,[t[1]||(t[1]=s("span",{class:"key"},"user",-1)),o.user_id?(i(),k(b,{key:0,class:"flexrow-item",size:20,person:e.personMap.get(o.user_id)},null,8,["person"])):v("",!0),o.user_id?(i(),k(d,{key:1,class:"flexrow-item",person:e.personMap.get(o.user_id)},null,8,["person"])):v("",!0)]),(i(!0),r($,null,T(Object.keys(o.data).sort(),m=>(i(),r("li",{class:"variable",key:o.id+"-"+m},[s("span",se,a(m),1),l.isLink(m)?(i(),r("a",{key:0,href:l.getLink(o,m)},a(o.data[m]),9,te)):(i(),r("span",ie,a(o.data[m]),1))]))),128))],512),[[S,n.selectedEvents[o.id]]])],8,Q))),128))]))])}const oe=g(R,[["render",ae],["__scopeId","data-v-631689ea"]]),ne={name:"preview-file-list",mixins:[I],components:{ButtonSimple:L,ProductionNameCell:z,TableInfo:V,TaskTypeCell:N},props:{previewFiles:{type:Array,default:()=>[]},isLoading:{type:Boolean,default:!1},isError:{type:Boolean,default:!1}},emits:["mark-broken-clicked"],computed:{...C(["productionMap","taskTypeMap"])},methods:{...B(["loadTask"]),onBodyScroll(e){const t=e.target;this.$refs.headerWrapper.style.left=`-${t.scrollLeft}px`},async redirectToTask(e){const t=await this.loadTask({taskId:e.task_id});return this.$router.push(q(t,t.project,t.project.production_type==="tvshow",t.episode,this.taskTypeMap))}}},le={class:"data-list"},re={style:{overflow:"hidden"}},ce={class:"datatable",ref:"headerWrapper"},de={class:"datatable-head"},pe={class:"datatable-row-header"},_e={class:"date"},ue={class:"production"},me={class:"entity-name"},he={class:"task-type"},ve={class:"revision"},fe={class:"status"},ke={class:"datatable"},ye={class:"datatable-body"},ge=["onClick"],be={class:"date"},we={class:"production"},$e={class:"entity-name"},Te={class:"revision"},Le=["data-status"],Ce={class:"end-cell has-text-right"};function Be(e,t,c,f,n,l){const _=p("table-info"),u=p("production-name-cell"),y=p("task-type-cell"),b=p("button-simple");return i(),r("div",le,[s("div",re,[s("table",ce,[s("thead",de,[s("tr",pe,[s("th",_e,a(e.$t("logs.preview_files.date")),1),s("th",ue,a(e.$t("logs.preview_files.production")),1),s("th",me,a(e.$t("logs.preview_files.entity_name")),1),s("th",he,a(e.$t("logs.preview_files.task_type_id")),1),s("th",ve,a(e.$t("logs.preview_files.revision")),1),s("th",fe,a(e.$t("logs.preview_files.status")),1),t[1]||(t[1]=s("th",{class:"end-cell"},null,-1))])])],512)]),h(_,{"is-loading":c.isLoading,"is-error":c.isError},null,8,["is-loading","is-error"]),c.previewFiles.length>0?(i(),r("div",{key:0,onScrollPassive:t[0]||(t[0]=(...d)=>l.onBodyScroll&&l.onBodyScroll(...d))},[s("table",ke,[s("tbody",ye,[(i(!0),r($,null,T(c.previewFiles,d=>(i(),r("tr",{key:d.id,class:"datatable-row",onClick:o=>l.redirectToTask(d)},[s("td",be,a(e.formatDate(d.created_at)),1),s("td",we,[h(u,{entry:e.productionMap.get(d.project_id)},null,8,["entry"])]),s("td",$e,a(d.full_entity_name),1),h(y,{class:"task-type","task-type":e.taskTypeMap.get(d.task_type_id)},null,8,["task-type"]),s("td",Te,a(d.revision),1),s("td",{class:"status","data-status":d.status},a(d.status),9,Le),s("td",Ce,[d.status==="processing"?(i(),k(b,{key:0,class:"mark-broken-button",text:e.$t("logs.preview_files.mark_broken"),onClick:K(o=>e.$emit("mark-broken-clicked",d.id),["stop"])},null,8,["text","onClick"])):v("",!0)])],8,ge))),128))])])],32)):v("",!0)])}const De=g(ne,[["render",Be],["__scopeId","data-v-fa444a29"]]),Fe={name:"preview-files",mixins:[M],components:{ButtonSimple:L,PreviewFileList:De},data(){return{previewFilesLoading:!0,previewFiles:[]}},computed:{...C(["personMap","taskTypeMap","user"]),displayedPreviewFiles(){return this.previewFiles.filter(e=>e.status!=="ready")}},methods:{...B(["getRunningPreviewFiles","markPreviewFileAsBroken"]),async reload(){this.previewFiles=[],this.previewFilesLoading=!0,this.previewFiles=await this.getRunningPreviewFiles(),this.previewFilesLoading=!1},async markBrokenClicked(e){const t=this.previewFiles.find(c=>c.id===e);t.status="broken",await this.markPreviewFileAsBroken(e)}},mounted(){this.reload()}},Me={class:"mt1"},Ee={class:"flexrow"},Pe={class:"flexrow-item"},xe={key:0,class:"empty"};function Ae(e,t,c,f,n,l){const _=p("button-simple"),u=p("preview-file-list");return i(),r("div",Me,[s("p",Ee,[s("em",Pe,a(e.$t("logs.preview_files.explanation")),1),t[0]||(t[0]=s("span",{class:"filler"},null,-1)),h(_,{class:"flexrow-item",icon:"refresh",onClick:l.reload},null,8,["onClick"])]),n.previewFiles.length===0&&!n.previewFilesLoading?(i(),r("p",xe,a(e.$t("logs.preview_files.empty_list")),1)):(i(),k(u,{key:1,"preview-files":n.previewFiles,"is-loading":n.previewFilesLoading,onMarkBrokenClicked:l.markBrokenClicked},null,8,["preview-files","is-loading","onMarkBrokenClicked"]))])}const je=g(Fe,[["render",Ae],["__scopeId","data-v-41e06691"]]),Se={name:"logs",components:{Events:oe,PreviewFiles:je},data(){return{activeTab:"events"}},mounted(){this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},methods:{isActiveTab(e){return this.activeTab===e}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})}}},Ie={class:"logs fixed-page"},ze={class:"tabs logs-tabs"};function Ve(e,t,c,f,n,l){const _=p("events"),u=p("preview-files");return i(),r("div",Ie,[s("div",ze,[s("ul",null,[s("li",{class:F({"is-active":l.isActiveTab("events")})},[s("a",{onClick:t[0]||(t[0]=y=>n.activeTab="events")},a(e.$t("logs.title")),1)],2),s("li",{class:F({"is-active":l.isActiveTab("preview_files")})},[s("a",{onClick:t[1]||(t[1]=y=>n.activeTab="preview_files")},a(e.$t("logs.preview_files.title")),1)],2)])]),l.isActiveTab("events")?(i(),k(_,{key:0})):v("",!0),l.isActiveTab("preview_files")?(i(),k(u,{key:1})):v("",!0)])}const qe=g(Se,[["render",Ve],["__scopeId","data-v-1c1caddd"]]);export{qe as default};
//# sourceMappingURL=Logs-C1YNDbl3.js.map
