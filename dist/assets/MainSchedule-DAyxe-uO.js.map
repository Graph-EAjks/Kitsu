{"version":3,"file":"MainSchedule-DAyxe-uO.js","sources":["../../src/components/pages/MainSchedule.vue"],"sourcesContent":["<template>\n  <div class=\"columns fixed-page\">\n    <div class=\"column main-column\">\n      <div class=\"flexrow project-dates\">\n        <div class=\"flexrow-item\">\n          <label class=\"label\">\n            {{ $t('main.start_date') }}\n          </label>\n          <date-field week-days-disabled v-model=\"selectedStartDate\" />\n        </div>\n        <div class=\"flexrow-item field\">\n          <label class=\"label\">\n            {{ $t('main.end_date') }}\n          </label>\n          <date-field week-days-disabled v-model=\"selectedEndDate\" />\n        </div>\n        <combobox-number\n          class=\"flexrow-item zoom-level\"\n          :label=\"$t('schedule.zoom_level')\"\n          :options=\"zoomOptions\"\n          v-model=\"zoomLevel\"\n        />\n      </div>\n\n      <schedule\n        :end-date=\"endDate\"\n        :hierarchy=\"scheduleItems\"\n        :is-loading=\"loading.schedule\"\n        :is-error=\"errors.schedule\"\n        :start-date=\"startDate\"\n        :zoom-level=\"zoomLevel\"\n        :hide-man-days=\"true\"\n        :with-milestones=\"false\"\n        @item-changed=\"onScheduleItemChanged\"\n        @root-element-expanded=\"expandProductionElement\"\n      />\n    </div>\n  </div>\n</template>\n\n<script>\n/*\n * Page to manage the schedule of the big steps of the production. It allows\n * to set milestones too.\n */\nimport { mapGetters, mapActions } from 'vuex'\nimport moment from 'moment-timezone'\nimport { getProductionSchedulePath } from '@/lib/path'\n\nimport {\n  getFirstStartDate,\n  getLastEndDate,\n  getStartDateFromString,\n  getEndDateFromString\n} from '@/lib/time'\nimport colors from '@/lib/colors'\n\nimport ComboboxNumber from '@/components/widgets/ComboboxNumber.vue'\nimport DateField from '@/components/widgets/DateField.vue'\nimport Schedule from '@/components/widgets/Schedule.vue'\n\nexport default {\n  name: 'main-schedule',\n\n  components: {\n    ComboboxNumber,\n    DateField,\n    Schedule\n  },\n\n  data() {\n    return {\n      endDate: moment().add(6, 'months'),\n      scheduleItems: [],\n      startDate: moment(),\n      selectedStartDate: null,\n      selectedEndDate: null,\n      zoomLevel: 0,\n      zoomOptions: [\n        { label: this.$t('main.week'), value: 0 },\n        { label: '1', value: 1 },\n        { label: '2', value: 2 },\n        { label: '3', value: 3 }\n      ],\n      loading: {\n        schedule: false\n      },\n      errors: {\n        schedule: false\n      }\n    }\n  },\n\n  mounted() {\n    let zoom = parseInt(this.$route.query.zoom)\n    zoom = isNaN(zoom) ? 1 : zoom\n    this.zoomLevel = Math.min(Math.max(zoom, 0), 3)\n\n    this.init()\n  },\n\n  computed: {\n    ...mapGetters(['openProductions', 'taskTypeMap', 'user'])\n  },\n\n  methods: {\n    ...mapActions(['editProduction', 'loadScheduleItems', 'saveScheduleItem']),\n\n    init() {\n      if (!this.openProductions.length) {\n        return\n      }\n      this.scheduleItems = this.convertScheduleItems(this.openProductions)\n      this.startDate = getFirstStartDate(this.scheduleItems)\n      this.endDate = getLastEndDate(this.scheduleItems)\n      this.selectedStartDate = this.startDate.toDate()\n      this.selectedEndDate = this.endDate.toDate()\n    },\n\n    convertScheduleItems(scheduleItems) {\n      return scheduleItems.map(item => {\n        const startDate = getStartDateFromString(item.start_date)\n        const endDate = getEndDateFromString(startDate, item.end_date)\n        return {\n          ...item,\n          avatar: item.type === 'Project',\n          color: item.color || colors.fromString(item.name, true),\n          startDate: startDate,\n          endDate: endDate,\n          expanded: false,\n          loading: false,\n          editable: true,\n          route: getProductionSchedulePath(item.id),\n          children: []\n        }\n      })\n    },\n\n    convertTaskTypeScheduleItems(scheduleItems) {\n      return scheduleItems.map(item => {\n        const startDate = getStartDateFromString(item.start_date)\n        const endDate = getEndDateFromString(startDate, item.end_date)\n        const taskType = this.taskTypeMap.get(item.task_type_id)\n\n        return {\n          ...item,\n          name: taskType.name,\n          color: taskType.color,\n          startDate: startDate,\n          endDate: endDate,\n          expanded: false,\n          loading: false,\n          editable: true,\n          children: []\n        }\n      })\n    },\n\n    expandProductionElement(productionElement) {\n      if (!productionElement.expanded) {\n        productionElement.loading = true\n        productionElement.expanded = true\n        this.loadScheduleItems(productionElement).then(scheduleItems => {\n          scheduleItems = this.convertTaskTypeScheduleItems(scheduleItems)\n          productionElement.children = scheduleItems\n          productionElement.loading = false\n        })\n      } else {\n        productionElement.expanded = false\n      }\n    },\n\n    onScheduleItemChanged(item) {\n      if (item.type !== 'Project') {\n        this.saveScheduleItem(item)\n      } else {\n        this.editProduction({\n          id: item.id,\n          start_date: item.startDate.format('YYYY-MM-DD'),\n          end_date: item.endDate.format('YYYY-MM-DD')\n        })\n      }\n    },\n\n    updateRoute({ zoom }) {\n      const query = { ...this.$route.query }\n\n      if (zoom !== undefined) {\n        query.zoom = String(zoom)\n      }\n\n      if (JSON.stringify(query) !== JSON.stringify(this.$route.query)) {\n        this.$router.push({ query })\n      }\n    }\n  },\n\n  watch: {\n    zoomLevel(value) {\n      this.updateRoute({ zoom: value })\n    }\n  },\n\n  head() {\n    return {\n      title: `${this.$t('schedule.title_main')} - Kitsu`\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n.dark {\n  .project-dates {\n    color: $white-grey;\n    border-bottom: 1px solid $grey;\n  }\n}\n\n.project-dates {\n  border-bottom: 1px solid #eee;\n  padding-bottom: 1em;\n\n  .field {\n    padding-bottom: 0;\n    margin-bottom: 0;\n  }\n\n  .overall-man-days {\n    width: 120px;\n    font-size: 0.9em;\n    margin-right: 1em;\n  }\n}\n\n.fixed-page {\n  padding: 1em;\n  padding-top: 90px;\n  padding-left: 2em;\n}\n\n.main-column {\n  display: flex;\n  border: 0;\n  overflow: hidden;\n  flex-direction: column;\n}\n\n.zoom-level {\n  margin-top: -10px;\n}\n</style>\n"],"names":["_sfc_main","ComboboxNumber","DateField","Schedule","moment","zoom","mapGetters","mapActions","getFirstStartDate","getLastEndDate","scheduleItems","item","startDate","getStartDateFromString","endDate","getEndDateFromString","colors","getProductionSchedulePath","taskType","productionElement","query","value","_hoisted_1","_hoisted_2","_hoisted_3","_hoisted_4","_hoisted_5","_hoisted_6","_hoisted_7","_openBlock","_createElementBlock","_createElementVNode","_toDisplayString","_ctx","_createVNode","_component_date_field","$data","_cache","$event","_component_combobox_number","_component_schedule","$options"],"mappings":"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"}