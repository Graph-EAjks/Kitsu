{"version":3,"file":"MyChecks-3e79b960.js","sources":["../../src/components/pages/MyChecks.vue"],"sourcesContent":["<template>\n<div class=\"columns fixed-page\">\n  <!--action-panel /-->\n\n  <div class=\"column main-column\">\n    <div class=\"todos page\">\n      <div class=\"flexrow\">\n\n        <combobox-production\n          class=\"flexrow-item\"\n          :label=\"$t('main.production')\"\n          :production-list=\"productionList\"\n          v-model=\"productionId\"\n          v-if=\"productionList.length > 0\"\n        />\n\n        <combobox-task-type\n          class=\"flexrow-item selector\"\n          :label=\"$t('news.task_type')\"\n          :task-type-list=\"taskTypeList\"\n          v-model=\"taskTypeId\"\n          v-if=\"taskTypeList.length > 0\"\n        />\n\n        <combobox\n          class=\"flexrow-item\"\n          :label=\"$t('main.show')\"\n          :options=\"filterOptions\"\n          locale-key-prefix=\"tasks.\"\n          v-model=\"currentFilter\"\n        />\n\n        <combobox\n          class=\"flexrow-item\"\n          :label=\"$t('main.sorted_by')\"\n          :options=\"sortOptions\"\n          locale-key-prefix=\"tasks.fields.\"\n          v-model=\"currentSort\"\n        />\n      </div>\n\n      <div class=\"flexrow\">\n        <h1 class=\"title mt1 flerow-item\">\n         {{ nbTasksToCheck }} tasks to check\n        </h1>\n        <div class=\"filler\"></div>\n        <ButtonSimple\n          class=\"flexrow-item\"\n          @click=\"isPlaylist = true\"\n          text=\"Build playlist from list\"\n        />\n      </div>\n\n      <todos-list\n        :tasks=\"sortedTasks\"\n        :is-loading=\"isLoading\"\n        :is-error=\"isLoadingError\"\n        :selection-grid=\"selectionGrid\"\n        :is-to-check=\"true\"\n        @task-selection-cleared=\"onTaskSelectionCleared\"\n        @task-selection-addition=\"onTaskSelectionAdded\"\n        @task-selection-removal=\"onTaskSelectionRemoved\"\n      />\n    </div>\n\n  </div>\n\n  <div\n    class=\"column side-column\"\n    v-if=\"nbSelectedTasks === 1\"\n  >\n    <task-info\n      :task=\"selectedTasks.values().next().value\"\n    />\n  </div>\n\n  <view-playlist-modal\n    :active=\"isPlaylist\"\n    :task-ids=\"sortedTasks.map(t => t.id)\"\n    @cancel=\"isPlaylist = false\"\n  />\n</div>\n</template>\n\n<script>\nimport { mapGetters, mapActions } from 'vuex'\nimport moment from 'moment-timezone'\nimport firstBy from 'thenby'\n\nimport { populateTask } from '@/lib/models'\nimport { sortByName } from '@/lib/sorting'\nimport {\n  buildSelectionGrid,\n  clearSelectionGrid\n} from '@/lib/selection'\nimport { parseDate } from '@/lib/time'\n\nimport ActionPanel from '@/components/tops/ActionPanel'\nimport ButtonSimple from '@/components/widgets/ButtonSimple'\nimport Combobox from '@/components/widgets/Combobox'\nimport ComboboxProduction from '@/components/widgets/ComboboxProduction'\nimport ComboboxTaskType from '@/components/widgets/ComboboxTaskType'\nimport TaskInfo from '@/components/sides/TaskInfo'\nimport TimesheetList from '@/components/lists/TimesheetList'\nimport TodosList from '@/components/lists/TodosList'\nimport ViewPlaylistModal from '@/components/modals/ViewPlaylistModal'\n\nexport default {\n  name: 'todos',\n\n  components: {\n    ActionPanel,\n    ButtonSimple,\n    Combobox,\n    ComboboxProduction,\n    ComboboxTaskType,\n    TaskInfo,\n    TimesheetList,\n    TodosList,\n    ViewPlaylistModal\n  },\n\n  data () {\n    return {\n      currentFilter: 'all_tasks',\n      currentSort: 'priority',\n      isLoading: false,\n      isLoadingError: false,\n      isPlaylist: false,\n      filterOptions: [\n        'all_tasks',\n        'due_this_week'\n      ].map(name => ({ label: name, value: name })),\n      productionId: '',\n      productionList: [],\n      selectionGrid: {},\n      sortOptions: [\n        'entity_name',\n        'priority',\n        'due_date',\n        'estimation',\n        'last_comment_date'\n      ].map(name => ({ label: name, value: name })),\n      taskTypeId: '',\n      taskTypeList: [],\n      tasksToCheck: []\n    }\n  },\n\n  mounted () {\n    this.isLoading = true\n    this.loadTasksToCheck()\n      .then(tasks => {\n        if (tasks) {\n          tasks.forEach(populateTask)\n          this.buildSelectionGrid(tasks)\n          this.resetProductionList(tasks)\n          this.resetTaskTypeList(tasks)\n          this.tasksToCheck = tasks\n          this.isLoading = false\n        }\n      })\n      .catch(err => {\n        console.error(err)\n      })\n  },\n\n  afterDestroy () {\n  },\n\n  computed: {\n    ...mapGetters([\n      'nbSelectedTasks',\n      'productionMap',\n      'taskStatusMap',\n      'taskTypeMap',\n      'selectedTasks'\n    ]),\n\n    nbTasksToCheck () {\n      return this.sortedTasks.filter(task => {\n        return this.taskStatusMap.get(task.task_status_id).is_feedback_request\n      }).length\n    },\n\n    sortedTasks () {\n      const isName = this.currentSort === 'entity_name'\n      const isPriority = this.currentSort === 'priority'\n      const isDueDate = this.currentSort === 'due_date'\n      let tasks = this.currentFilter === 'all_tasks'\n        ? [...this.tasksToCheck]\n        : this.tasksToCheck.filter(t => {\n          const dueDate = parseDate(t.due_date)\n          return moment().startOf('week').isSame(dueDate, 'week')\n        })\n      if (this.productionId !== '') {\n        tasks = tasks.filter(t => t.project_id === this.productionId)\n      }\n      if (this.taskTypeId !== '') {\n        tasks = tasks.filter(t => t.task_type_id === this.taskTypeId)\n      }\n\n      if (isName) {\n        return tasks.sort(\n          firstBy('project_name')\n            .thenBy('task_type_name')\n            .thenBy('full_entity_name')\n        )\n      } else if (isPriority) {\n        return tasks.sort(\n          firstBy('priority', -1)\n            .thenBy(\n              (a, b) => {\n                if (!a.due_date) return 1\n                else if (!b.due_date) return -1\n                else return a.due_date.localeCompare(b.due_date)\n              }\n            )\n            .thenBy('project_name')\n            .thenBy('task_type_name')\n            .thenBy('entity_name')\n        )\n      } else if (isDueDate) {\n        return tasks.sort(\n          firstBy(\n            (a, b) => {\n              if (!a.due_date) return 1\n              else if (!b.due_date) return -1\n              else return a.due_date.localeCompare(b.due_date)\n            }\n          )\n            .thenBy('project_name')\n            .thenBy('task_type_name')\n            .thenBy('entity_name')\n        )\n      } else {\n        return tasks.sort(\n          firstBy(this.currentSort, -1)\n            .thenBy('project_name')\n            .thenBy('task_type_name')\n            .thenBy('entity_name')\n        )\n      }\n    }\n  },\n\n  methods: {\n    ...mapActions([\n      'loadTasksToCheck',\n      'removeTodoSearch',\n      'saveTodoSearch',\n      'setTodosSearch'\n    ]),\n\n    buildSelectionGrid (tasks) {\n      this.selectionGrid = buildSelectionGrid(tasks.length, 1)\n    },\n\n    resetProductionList (tasks = []) {\n      const productionIds = {}\n      const productionList = []\n      tasks.forEach(task => {\n        if (!productionIds[task.project_id]) {\n          productionIds[task.project_id] = true\n          productionList.push(this.productionMap.get(task.project_id))\n        }\n      })\n      this.productionList = [{\n        id: '',\n        name: this.$t('main.all')\n      }].concat(sortByName(productionList))\n    },\n\n    resetTaskTypeList (tasks) {\n      const taskTypeIds = {}\n      const taskTypeList = []\n      tasks.forEach(task => {\n        if (!taskTypeIds[task.task_type_id]) {\n          taskTypeIds[task.task_type_id] = true\n          taskTypeList.push(this.taskTypeMap.get(task.task_type_id))\n        }\n      })\n      this.taskTypeList = [{\n        id: '',\n        color: '#999',\n        name: this.$t('news.all')\n      }].concat(sortByName(taskTypeList))\n    },\n\n    onTaskSelectionCleared () {\n      this.buildSelectionGrid(this.sortedTasks)\n    },\n\n    onTaskSelectionAdded (selection) {\n      this.selectionGrid[selection.x][selection.y] = true\n    },\n\n    onTaskSelectionRemoved (selection) {\n      this.selectionGrid[selection.x][selection.y] = false\n    }\n  },\n\n  socket: {\n    events: {\n      'task:assign' (eventData) {\n      },\n\n      'task:unassign' (eventData) {\n      }\n    }\n  },\n\n  watch: {\n    nbSelectedTasks () {\n      if (this.nbSelectedTasks === 0) {\n        this.buildSelectionGrid(this.sortedTasks)\n      }\n    }\n  },\n\n  metaInfo () {\n    return {\n      title: `${this.$t('tasks.my_checks')} - Kitsu`\n    }\n  }\n}\n</script>\n\n<style lang=\"scss\" scoped>\n\n.data-list {\n  margin-top: 0;\n}\n\n.data-list {\n  margin-top: 0;\n}\n\n.todos {\n  display: flex;\n  flex-direction: column;\n}\n\n.columns {\n  display: flex;\n  flex-direction: row;\n  padding: 0;\n}\n\n.column {\n  overflow-y: auto;\n  padding: 0;\n}\n\n.main-column {\n  border-right: 3px solid $light-grey;\n}\n\n.push-right {\n  flex: 1;\n  text-align: right;\n}\n\n.field {\n  margin-bottom: 0;\n}\n\n</style>\n"],"names":["_sfc_main","ActionPanel","ButtonSimple","Combobox","ComboboxProduction","ComboboxTaskType","TaskInfo","TimesheetList","TodosList","ViewPlaylistModal","name","tasks","populateTask","err","mapGetters","task","isName","isPriority","isDueDate","t","dueDate","parseDate","moment","firstBy","a","b","mapActions","buildSelectionGrid","productionIds","productionList","sortByName","taskTypeIds","taskTypeList","selection","eventData"],"mappings":"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"}