import{_ as b,m as w,a6 as R,aa as x,r,c as f,o as m,e as n,d as h,t as p,ab as U,f as l,n as g,a as q,at as N,S as B,h as Q,au as O,av as H,am as K,an as j,L as z,B as G,s as J,k as v,ae as C}from"./index-bjOq_gdX.js";import{B as W}from"./ButtonHrefLink-DM0j2rH7.js";import{C as X}from"./ComboboxStudio-CYabQpxb.js";import{P as Y,E as Z,a as $}from"./PeopleList-B3ZGyWQj.js";import{R as ee}from"./RouteTabs-B9bnrOWi.js";import"./upload-DBCibe42.js";import"./grablist-Da7oVI-6.js";import"./DepartmentNamesCell-DVXEoiYc.js";import"./PeopleNameCell-DsbS1twk.js";const te={name:"change-password-modal",mixins:[x],props:{active:{type:Boolean,default:!1},person:{type:Object,default:()=>{}}},emits:["cancel","confirm"],data(){return{form:{password:"",password2:""},isLoading:!1,isError:!1,isErrorDisableTwoFactorAuthentication:!1,isValid:!0}},components:{TextField:R},methods:{...w(["changePasswordPerson","disableTwoFactorAuthenticationPerson"]),confirmClicked(){this.isErrorDisableTwoFactorAuthentication=!1,this.isError=!1,this.isLoading=!0,this.changePasswordPerson({person:this.person,form:this.form}).then(()=>{this.$emit("confirm")}).catch(e=>{e.isValidPassword===!1?this.isValid=!1:this.isError=!0}).finally(()=>{this.isLoading=!1})},disableTwoFactorAuthenticationClicked(){this.isErrorDisableTwoFactorAuthentication=!1,this.isError=!1,this.isLoading=!0,this.disableTwoFactorAuthenticationPerson(this.person).catch(()=>{this.isErrorDisableTwoFactorAuthentication=!0}).finally(()=>{this.isLoading=!1})},resetForm(){this.person&&(this.form={password:"",password2:""},this.isLoading=!1,this.isError=!1,this.isErrorDisableTwoFactorAuthentication=!1,this.isValid=!0)}},watch:{person(){this.resetForm()},active(){this.active&&(this.resetForm(),setTimeout(()=>{this.$refs["first-password"].focus()},100))}}},se={class:"modal-content"},oe={class:"box"},ie={class:"title"},re={class:"flexrow"},le=["disabled"],ae=["disabled"],ne={key:0,class:"error has-text-right mt1"},de={key:1,class:"error has-text-right mt1"},ce={key:2,class:"error has-text-right mt1"};function me(e,t,i,c,s,o){const u=r("text-field");return m(),f("div",{class:g({modal:!0,"is-active":i.active})},[n("div",{class:"modal-background",onClick:t[0]||(t[0]=a=>e.$emit("cancel"))}),n("div",se,[n("div",oe,[n("h1",ie,p(e.$t("people.change_password_for"))+" "+p(i.person.name),1),n("form",{onSubmit:t[5]||(t[5]=U(()=>{},["prevent"]))},[l(u,{disabled:i.person.is_generated_from_ldap,label:e.$t("people.fields.password"),ref:"first-password",type:"password",onEnter:t[1]||(t[1]=a=>o.confirmClicked()),modelValue:s.form.password,"onUpdate:modelValue":t[2]||(t[2]=a=>s.form.password=a)},null,8,["disabled","label","modelValue"]),l(u,{disabled:i.person.is_generated_from_ldap,label:e.$t("people.fields.password_2"),type:"password",onEnter:t[3]||(t[3]=a=>o.confirmClicked()),modelValue:s.form.password2,"onUpdate:modelValue":t[4]||(t[4]=a=>s.form.password2=a)},null,8,["disabled","label","modelValue"])],32),n("div",re,[n("button",{class:g({button:!0,"is-primary":!0,"flexrow-item":!0,"is-loading":s.isLoading}),disabled:i.person.is_generated_from_ldap,onClick:t[6]||(t[6]=(...a)=>o.confirmClicked&&o.confirmClicked(...a))},p(e.$t("profile.change_password.button")),11,le),n("button",{class:g({button:!0,"flexrow-item":!0,"is-loading":s.isLoading,"is-warning":!0}),disabled:!(i.person.totp_enabled||i.person.email_otp_enabled),onClick:t[7]||(t[7]=(...a)=>o.disableTwoFactorAuthenticationClicked&&o.disableTwoFactorAuthenticationClicked(...a))},p(e.$t("people.disable_2FA")),11,ae),t[9]||(t[9]=n("div",{class:"filler"},null,-1)),n("button",{class:"button is-link flexrow-item",onClick:t[8]||(t[8]=a=>e.$emit("cancel"))},p(e.$t("main.cancel")),1)]),s.isValid?h("",!0):(m(),f("div",ne,p(e.$t("profile.change_password.unvalid")),1)),s.isError?(m(),f("div",de,p(e.$t("people.change_password_error")),1)):h("",!0),s.isErrorDisableTwoFactorAuthentication?(m(),f("div",ce,p(e.$t("people.disable_2FA_error")),1)):h("",!0)])])],2)}const pe=b(te,[["render",me],["__scopeId","data-v-5a96c128"]]),he={name:"people",mixins:[J],components:{ButtonHrefLink:W,ButtonSimple:G,ChangePasswordModal:pe,ComboboxDepartment:z,ComboboxStudio:X,ComboboxStyled:j,EditAvatarModal:$,EditPersonModal:Z,HardDeleteModal:K,ImportModal:H,ImportRenderModal:O,PageTitle:Q,PeopleList:Y,RouteTabs:ee,SearchField:B,SearchQueryList:N},data(){return{activeTab:"active",csvColumns:["First Name","Last Name"],optionalCsvColumns:["Phone","Role","Contract Type","Studio","Active"],dataMatchers:["Email"],role:"all",roleOptions:[{label:"all",value:"all"},{label:"admin",value:"admin"},{label:"client",value:"client"},{label:"manager",value:"manager"},{label:"supervisor",value:"supervisor"},{label:"user",value:"user"},{label:"vendor",value:"vendor"}],errors:{avatar:!1,del:!1,edit:!1,invite:!1,userLimit:!1},loading:{createAndInvite:!1,del:!1,deletingAvatar:!1,edit:!1,invite:!1,savingSearch:!1,updatingAvatar:!1},modals:{avatar:!1,changePassword:!1,del:!1,edit:!1,importModal:!1,isImportRenderDisplayed:!1},parsedCSV:[],personToDelete:{},personToEdit:{role:"user"},personToChangePassword:{},selectedDepartment:"",selectedStudio:"",success:{invite:!1},tabs:[{name:"active",label:this.$t("main.active")},{name:"unactive",label:this.$t("people.unactive")}]}},mounted(){this.role=this.$route.query.role||"all",this.selectedDepartment=this.$route.query.department||"",this.selectedStudio=this.$route.query.studio||"",this.setSearchFromUrl(),this.loadPeople(()=>{this.onSearchChange()})},computed:{...q(["displayedPeople","isCurrentUserAdmin","isPeopleLoading","isPeopleLoadingError","isImportPeopleLoading","isImportPeopleLoadingError","people","peopleSearchQueries","personCsvFormData","studioMap"]),currentPeople(){let e=this.displayedPeople.filter(t=>!t.is_bot);return this.role!=="all"&&(e=e.filter(t=>t.role===this.role)),this.selectedDepartment&&(e=e.filter(t=>t.departments.includes(this.selectedDepartment))),this.selectedStudio&&(e=e.filter(t=>t.studio_id===this.selectedStudio)),e.map(t=>({...t,studio:this.studioMap.get(t.studio_id)}))},deleteText(){var t;const e=(t=this.personToDelete)==null?void 0:t.full_name;return e?this.$t("people.delete_text",{personName:e}):""},filteredPeople(){const e={};return this.displayedPeople.forEach(t=>{const i=t.email;e[i]=!0}),e},searchField(){return this.$refs["people-search-field"]},activePeople(){return this.currentPeople.filter(e=>e.active)},unactivePeople(){return this.currentPeople.filter(e=>!e.active)}},methods:{...w(["clearPersonAvatar","deletePeople","editPerson","invitePerson","loadPeople","newPerson","newPersonAndInvite","removePeopleSearch","savePeopleSearch","setPeopleSearch","uploadPersonAvatar","uploadPersonFile"]),renderImport(e,t){this.loading.importing=!0,this.errors.importing=!1,this.formData=e,t==="file"&&(e=e.get("file")),C.processCSV(e).then(i=>{this.parsedCSV=i,this.hideImportModal(),this.loading.importing=!1,this.showImportRenderModal()})},uploadImportFile(e,t){const i=new FormData,c="import.csv",s=C.turnEntriesToCsvString(e),o=new File([s],c,{type:"text/csv"});i.append("file",o),this.loading.importing=!0,this.errors.importing=!1,this.$store.commit("PERSON_CSV_FILE_SELECTED",i),this.uploadPersonFile(t).then(()=>{this.$store.dispatch("loadPeople"),this.hideImportRenderModal()}).catch(u=>{console.error(u),this.loading.importing=!1,this.errors.importing=!0})},resetImport(){this.errors.importing=!1,this.hideImportRenderModal(),this.$store.commit("PERSON_CSV_FILE_SELECTED",null),this.$refs["import-modal"].reset(),this.showImportModal()},async deleteAvatar(){this.loading.deletingAvatar=!0;try{await this.clearPersonAvatar(this.personToEdit),this.modals.avatar=!1}catch{this.errors.avatar=!0}this.loading.deletingAvatar=!1},async updateAvatar(e){this.loading.updatingAvatar=!0;try{await this.uploadPersonAvatar({person:this.personToEdit,formData:e}),this.modals.avatar=!1}catch{this.errors.avatar=!0}this.loading.updatingAvatar=!1},confirmEditPeople(e){let t="editPerson";this.personToEdit.id===void 0?t="newPerson":e.id=this.personToEdit.id,this.loading.edit=!0,this.errors.edit=!1,this.errors.userLimit=!1,this[t](e).then(()=>{this.loading.edit=!1,this.modals.edit=!1}).catch(i=>{var s,o;((o=(s=i.body)==null?void 0:s.message)==null?void 0:o.includes("limit"))??!1?this.errors.userLimit=!0:this.errors.edit=!0,this.loading.edit=!1})},confirmCreateAndInvite(e){this.loading.createAndInvite=!0,this.errors.edit=!1,this.errors.userLimit=!1,this.newPersonAndInvite(e).then(()=>{this.loading.createAndInvite=!1,this.modals.edit=!1}).catch(t=>{var c,s;console.error(t),((s=(c=t.body)==null?void 0:c.message)==null?void 0:s.includes("limit"))??!1?this.errors.userLimit=!0:this.errors.edit=!0,this.loading.createAndInvite=!1}),this.onSearchChange()},confirmInvite(e){e.id=this.personToEdit.id,this.loading.invite=!0,this.errors.invite=!1,this.invitePerson(e).then(()=>{this.loading.invite=!1,this.success.invite=!0}).catch(t=>{console.error(t),this.loading.invite=!1,this.success.invite=!1,this.errors.invite=!0}),this.onSearchChange()},confirmDeletePeople(){this.loading.del=!0,this.errors.del=!1,this.deletePeople(this.personToDelete).then(()=>{this.loading.del=!1,this.modals.del=!1}).catch(e=>{console.error(e),this.loading.del=!1,this.errors.del=!0})},onSearchChange(){if(!this.searchField)return;const e=this.searchField.getValue();e.length!==1&&this.setPeopleSearch(e),this.setSearchInUrl(),this.tabs[0].label=this.$t("main.active")+" ("+this.activePeople.length+")",this.tabs[1].label=this.$t("people.unactive")+" ("+this.unactivePeople.length+")"},onAvatarClicked(e){this.personToEdit=e,this.errors.avatar=!1,this.modals.avatar=!0},onDeleteClicked(e){this.personToDelete=e,this.modals.del=!0},onEditClicked(e){this.errors.invite=!1,this.success.invite=!1,this.personToEdit=e,this.modals.edit=!0},onChangePasswordClicked(e){this.personToChangePassword=e,this.modals.changePassword=!0},onNewClicked(){this.errors.invite=!1,this.success.invite=!1,this.personToEdit={role:"user"},this.modals.edit=!0},showImportModal(){this.modals.importModal=!0},hideImportModal(){this.modals.importModal=!1},showImportRenderModal(){this.modals.isImportRenderDisplayed=!0},hideImportRenderModal(){this.modals.isImportRenderDisplayed=!1},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePeopleSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removePeopleSearch(e).catch(console.error)},updateRoute(){const e=this.searchField.getValue(),t=this.selectedDepartment,i=this.selectedStudio,c=this.role;this.$router.push({query:{search:e,department:t,studio:i,role:c}})}},watch:{"modals.edit"(){this.modals.edit&&(this.loading.createAndInvite=!1,this.errors.edit=!1,this.errors.invite=!1,this.errors.userLimit=!1,this.loading.edit=!1,this.loading.invite=!1,this.success.invite=!1)},selectedDepartment(){this.updateRoute()},selectedStudio(){this.updateRoute()},role(){this.updateRoute()},"$route.query.tab"(){this.activeTab=this.$route.query.tab||"active"},"$route.query.search"(){this.onSearchChange()}},head(){return{title:`${this.$t("people.title")} - Kitsu`}}},ue={class:"people page fixed-page"},fe={class:"flexrow page-header"},ve={class:"flexrow search-options"},ge={class:"query-list"};function Ce(e,t,i,c,s,o){const u=r("page-title"),a=r("button-simple"),P=r("button-href-link"),_=r("search-field"),S=r("combobox-department"),y=r("combobox-studio"),k=r("combobox-styled"),E=r("search-query-list"),I=r("route-tabs"),A=r("people-list"),D=r("import-render-modal"),T=r("import-modal"),L=r("edit-avatar-modal"),F=r("edit-person-modal"),M=r("change-password-modal"),V=r("hard-delete-modal");return m(),f("div",ue,[n("div",fe,[l(u,{class:"flexrow-item filler",text:e.$t("people.title")},null,8,["text"]),e.isCurrentUserAdmin?(m(),v(a,{key:0,class:"flexrow-item",title:e.$t("main.csv.import_file"),"is-responsive":!0,icon:"import",onClick:o.showImportModal},null,8,["title","onClick"])):h("",!0),l(P,{class:"flexrow-item",title:e.$t("main.csv.export_file"),icon:"export",path:"/api/export/csv/persons.csv"},null,8,["title"]),e.isCurrentUserAdmin?(m(),v(a,{key:1,class:"flexrow-item",text:e.$t("people.new_person"),"is-responsive":!0,icon:"plus",onClick:o.onNewClicked},null,8,["text","onClick"])):h("",!0)]),n("div",ve,[l(_,{ref:"people-search-field",class:"search flexrow-item","can-save":!0,onChange:o.onSearchChange,onSave:o.saveSearchQuery,placeholder:"ex: John Doe"},null,8,["onChange","onSave"]),l(S,{class:"flexrow-item",label:e.$t("main.department"),modelValue:s.selectedDepartment,"onUpdate:modelValue":t[0]||(t[0]=d=>s.selectedDepartment=d)},null,8,["label","modelValue"]),l(y,{class:"flexrow-item",label:e.$t("main.studio"),modelValue:s.selectedStudio,"onUpdate:modelValue":t[1]||(t[1]=d=>s.selectedStudio=d)},null,8,["label","modelValue"]),l(k,{class:"flexrow-item",label:e.$t("people.fields.role"),"locale-key-prefix":"people.role.",options:s.roleOptions,modelValue:s.role,"onUpdate:modelValue":t[2]||(t[2]=d=>s.role=d)},null,8,["label","options","modelValue"])]),n("div",ge,[e.isPeopleLoading?h("",!0):(m(),v(E,{key:0,queries:e.peopleSearchQueries,type:"people",onRemoveSearch:o.removeSearchQuery},null,8,["queries","onRemoveSearch"]))]),l(I,{class:"mb0","active-tab":s.activeTab,tabs:s.tabs},null,8,["active-tab","tabs"]),l(A,{entries:s.activeTab==="active"?o.activePeople:o.unactivePeople,"is-loading":e.isPeopleLoading,"is-error":e.isPeopleLoadingError,onAvatarClicked:o.onAvatarClicked,onDeleteClicked:o.onDeleteClicked,onEditClicked:o.onEditClicked,onChangePasswordClicked:o.onChangePasswordClicked},null,8,["entries","is-loading","is-error","onAvatarClicked","onDeleteClicked","onEditClicked","onChangePasswordClicked"]),s.modals.isImportRenderDisplayed?(m(),v(D,{key:0,active:s.modals.isImportRenderDisplayed,"is-loading":e.isImportPeopleLoading,"is-error":e.isImportPeopleLoadingError,"parsed-csv":s.parsedCSV,"form-data":e.personCsvFormData,columns:[...s.dataMatchers,...s.csvColumns,...s.optionalCsvColumns],"data-matchers":s.dataMatchers,database:o.filteredPeople,onReupload:o.resetImport,onCancel:o.hideImportRenderModal,onConfirm:o.uploadImportFile},null,8,["active","is-loading","is-error","parsed-csv","form-data","columns","data-matchers","database","onReupload","onCancel","onConfirm"])):h("",!0),l(T,{ref:"import-modal",active:s.modals.importModal,"is-loading":e.isImportPeopleLoading,"is-error":e.isImportPeopleLoadingError,"form-data":e.personCsvFormData,columns:[...s.dataMatchers,...s.csvColumns],"optional-columns":s.optionalCsvColumns,onCancel:o.hideImportModal,onConfirm:o.renderImport},null,8,["active","is-loading","is-error","form-data","columns","optional-columns","onCancel","onConfirm"]),l(L,{active:s.modals.avatar,"error-text":e.$t("people.edit_avatar_error"),"is-deleting":s.loading.deletingAvatar,"is-error":s.errors.avatar,"is-updating":s.loading.updatingAvatar,person:s.personToEdit,onClose:t[3]||(t[3]=d=>s.modals.avatar=!1),onDelete:o.deleteAvatar,onUpdate:o.updateAvatar},null,8,["active","error-text","is-deleting","is-error","is-updating","person","onDelete","onUpdate"]),l(F,{active:s.modals.edit,"is-create-invite-loading":s.loading.createAndInvite,"is-error":s.errors.edit,"is-invite-loading":s.loading.invite,"is-invitation-success":s.success.invite,"is-invitation-error":s.errors.invite,"is-loading":s.loading.edit,"is-user-limit-error":s.errors.userLimit,"person-to-edit":s.personToEdit,onCancel:t[4]||(t[4]=d=>s.modals.edit=!1),onConfirm:o.confirmEditPeople,onConfirmInvite:o.confirmCreateAndInvite,onInvite:o.confirmInvite},null,8,["active","is-create-invite-loading","is-error","is-invite-loading","is-invitation-success","is-invitation-error","is-loading","is-user-limit-error","person-to-edit","onConfirm","onConfirmInvite","onInvite"]),l(M,{active:s.modals.changePassword,person:s.personToChangePassword,onCancel:t[5]||(t[5]=d=>s.modals.changePassword=!1),onConfirm:t[6]||(t[6]=d=>s.modals.changePassword=!1)},null,8,["active","person"]),l(V,{active:s.modals.del,"error-text":e.$t("people.delete_error"),"is-loading":s.loading.del,"is-error":s.errors.del,"lock-text":s.personToDelete?s.personToDelete.full_name:"",text:o.deleteText,onCancel:t[7]||(t[7]=d=>s.modals.del=!1),onConfirm:o.confirmDeletePeople},null,8,["active","error-text","is-loading","is-error","lock-text","text","onConfirm"])])}const Ae=b(he,[["render",Ce],["__scopeId","data-v-3c3f5c96"]]);export{Ae as default};
//# sourceMappingURL=People-Cl9IlwEB.js.map
