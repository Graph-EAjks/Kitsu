import{f as _,i as T,C as g,aI as k,S as v,x as y,aq as b,d as S,a_ as D,b5 as P,aP as n,m as L,L as l,aR as c,aS as u,g as x,aV as C,b1 as d,n as $}from"./index-f306e22c.js";const A={name:"person",mixins:[_],components:{Combobox:T,ComboboxNumber:g,PeopleAvatar:k,Schedule:v,SearchField:y,SearchQueryList:b,TaskInfo:S,TodosList:D,TimesheetList:P},data(){return{activeTab:"todos",currentSort:"entity_name",isTasksLoading:!1,isTasksLoadingError:!1,loading:{savingSearch:!1},person:null,scheduleHeight:0,selectedDate:n().format("YYYY-MM-DD"),sortOptions:["entity_name","priority","task_status_short_name","start_date","due_date","estimation","last_comment_date"].map(t=>({label:t,value:t})),zoomLevel:1,zoomOptions:[{label:"Week",value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},mounted(){this.updateActiveTab(),this.personTasksSearchText.length>0&&this.searchField.setValue(this.personTasksSearchText),setTimeout(()=>{this.searchField&&this.searchField.focus()},100),this.loadPerson(this.$route.params.person_id),window.addEventListener("resize",this.resetScheduleHeight)},afterDestroy(){window.removeEventListener("resize",this.resetScheduleHeight),this.$store.commit("LOAD_PERSON_TASKS_END",{tasks:[],userFilters:{},taskTypeMap:this.taskTypeMap})},computed:{...L(["displayedPersonTasks","displayedPersonDoneTasks","isCurrentUserAdmin","isCurrentUserManager","nbSelectedTasks","personMap","personTasksScrollPosition","personTasksSearchText","personTaskSearchQueries","personTaskSelectionGrid","personTimeSpentMap","personTimeSpentTotal","productionMap","selectedTasks","taskTypeMap","user"]),loggablePersonTasks(){return this.displayedPersonTasks.filter(t=>this.taskTypeMap.get(t.task_type_id).allow_timelog)},loggableDoneTasks(){return this.displayedPersonDoneTasks.filter(t=>this.taskTypeMap.get(t.task_type_id).allow_timelog)},searchField(){return this.$refs["person-tasks-search-field"]},taskList(){return this.$refs["task-list"]},haveDoneList(){return this.$refs["done-list"]},sortedTasks(){const t=this.currentSort==="entity_name",e=this.currentSort==="priority",s=this.currentSort==="due_date",a=this.currentSort==="start_date",r=[...this.displayedPersonTasks];return t?r.sort(l("project_name").thenBy("task_type_name").thenBy("full_entity_name")):e?r.sort(l("priority",-1).thenBy((i,o)=>i.due_date?o.due_date?i.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):s?r.sort(l((i,o)=>i.due_date?o.due_date?i.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):a?r.sort(l((i,o)=>i.start_date?o.start_date?i.start_date.localeCompare(o.start_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):r.sort(l(this.currentSort,-1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name"))},tasksStartDate(){return this.scheduleTasks.length?c(this.scheduleTasks):n()},tasksEndDate(){return this.scheduleTasks.length?u(this.scheduleTasks):n().add(15,"days")},scheduleTasks(){return this.scheduleItems.flatMap(t=>t.children)},scheduleItems(){const t=new Map;this.sortedTasks.forEach(s=>{if(!t.get(s.project_id)){const i=this.productionMap.get(s.project_id),o=this.buildProjectScheduleItem(i);t.set(s.project_id,o)}const a=t.get(s.project_id),r=this.buildTaskScheduleItem(a,s);r&&a.children.push(r)});const e=Array.from(t.values());return e.forEach(s=>{let a=n(),r=n().add(1,"days"),i=0;s.children.length>0&&(a=c(s.children),r=u(s.children)),s.children.forEach(o=>{this.formatDuration(o.estimation)&&(i+=o.estimation)}),Object.assign(s,{startDate:a,endDate:r,man_days:i})}),e}},methods:{...x(["loadPersonTasks","setPersonTasksSearch","savePersonTasksSearch","removePersonTasksSearch","setDayOff","setPersonTasksScrollPosition","setTimeSpent","unsetDayOff"]),resetScheduleHeight(){this.$nextTick(()=>{var t,e,s,a,r,i;if(this.isActiveTab("schedule")){const o=((t=this.$refs.page)==null?void 0:t.offsetHeight)||0,h=((e=this.$refs.header)==null?void 0:e.offsetHeight)||0,p=((s=this.$refs.tabs)==null?void 0:s.offsetHeight)||0,f=((a=this.$refs.search)==null?void 0:a.offsetHeight)||0,m=((r=this.$refs.query)==null?void 0:r.offsetHeight)||0;this.scheduleHeight=o-h-p-f-m,(i=this.$refs["schedule-widget"])==null||i.resetScheduleSize()}})},buildProjectScheduleItem(t){return{...t,avatar:!0,color:C.fromString(t.name,!0),priority:1,expanded:!0,loading:!1,children:[],editable:!1}},buildTaskScheduleItem(t,e){let s=n(),a;if(!e.start_date&&!e.real_start_date&&!e.due_date&&!e.end_date)return null;e.start_date?s=d(e.start_date):e.real_start_date&&(s=d(e.real_start_date));const r=this.formatDuration(e.estimation);e.due_date?a=d(e.due_date):e.end_date?a=d(e.end_date):e.estimation&&(a=s.clone().add(r,"days")),(!a||a.isBefore(s))&&(a=s.clone().add(1,"days"));const i=this.taskTypeMap.get(e.task_type_id);return{...e,name:e.full_entity_name+" / "+i.name,startDate:s,endDate:a,expanded:!1,loading:!1,man_days:r,editable:!1,unresizable:!1,parentElement:t,color:i.color,children:[]}},isActiveTab(t){return this.activeTab===t},selectTab(t){this.activeTab=t,this.isActiveTab("todos")&&setTimeout(()=>{this.searchField&&this.searchField.focus()},100)},onSearchChange(t){this.setPersonTasksSearch(t)},loadPerson(t){this.person=this.personMap.get(t),this.isTasksLoading=!0,this.loadPersonTasks({personId:this.person.id,date:this.selectedDate,callback:e=>{e&&console.error(e),this.isTasksLoading=!1,this.isTasksLoadingError=!1,setTimeout(()=>{this.taskList&&this.$nextTick(()=>{this.taskList.setScrollPosition(this.personTasksScrollPosition)}),this.resizeHeaders()},0)}})},resizeHeaders(){this.$nextTick(()=>{this.taskList&&this.taskList.resizeHeaders(),this.haveDoneList&&this.haveDoneList.resizeHeaders()})},selectCurrent(){this.activeTab="current",setTimeout(()=>{this.$refs["person-tasks-search-field"].focus()},100)},selectDone(){this.activeTab="done"},changeSearch(t){this.$refs["person-tasks-search-field"].setValue(t.search_query),this.$refs["person-tasks-search-field"].$emit("change",t.search_query)},saveSearchQuery(t){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePersonTasksSearch(t).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(t){this.removePersonTasksSearch(t).catch(e=>{e&&console.error(e)})},updateActiveTab(){["done","timesheets","schedule"].includes(this.$route.params.tab)?this.activeTab=this.$route.params.tab:this.activeTab="todos"},onTimeSpentChange(t){t.personId=this.person.id,t.date=this.selectedDate,this.setTimeSpent(t)},onDateChanged(t){this.selectedDate=n(t).format("YYYY-MM-DD"),this.loadPerson(this.person.id)},onSetDayOff(){const t={personId:this.person.id,date:this.selectedDate};this.setDayOff(t)},onUnsetDayOff(){const t={personId:this.person.id,date:this.selectedDate};this.unsetDayOff(t)}},metaInfo(){return{title:this.person?`${this.person.name} - Kitsu`:"... - Kitsu"}},watch:{$route(){const t=this.$route.params.person_id;this.updateActiveTab(),this.person&&this.person.id!==t&&this.loadPerson(t)},activeTab(){this.resetScheduleHeight()}}};var M=function(){var e=this,s=e._self._c;return s("div",{ref:"page",staticClass:"columns fixed-page"},[s("div",{staticClass:"column main-column"},[s("div",{staticClass:"person page"},[s("div",{ref:"header",staticClass:"flexrow page-header"},[e.person?s("div",{staticClass:"flexrow-item"},[s("people-avatar",{attrs:{person:e.person,size:80,"font-size":30,"is-text":!1}})],1):e._e(),s("div",{staticClass:"flexrow-item entity-title"},[e._v(" "+e._s(e.person?e.person.name:"")+" ")])]),s("div",{ref:"tabs",staticClass:"task-tabs tabs"},[e.person?s("ul",[s("li",{class:{"is-active":e.isActiveTab("todos")}},[s("router-link",{attrs:{to:{name:"person",params:{person_id:e.person.id}}}},[e._v(" "+e._s(e.$t("tasks.current"))+" ")])],1),s("li",{class:{"is-active":e.isActiveTab("done")}},[s("router-link",{attrs:{to:{name:"person-tab",params:{tab:"done",person_id:e.person.id}}}},[e._v(" "+e._s(e.$t("tasks.done"))+" ("+e._s(e.displayedPersonDoneTasks.length)+") ")])],1),e.isCurrentUserManager?s("li",{class:{"is-active":e.isActiveTab("timesheets")}},[s("router-link",{attrs:{to:{name:"person-tab",params:{tab:"timesheets",person_id:e.person.id}}}},[e._v(" "+e._s(e.$t("timesheets.title"))+" ")])],1):e._e(),s("li",{class:{"is-active":e.isActiveTab("schedule")}},[s("router-link",{attrs:{to:{name:"person-tab",params:{tab:"schedule",person_id:e.person.id}}}},[e._v(" "+e._s(e.$t("schedule.title"))+" ")])],1)]):e._e()]),s("div",{ref:"search",staticClass:"flexrow"},[s("search-field",{ref:"person-tasks-search-field",class:{"search-field":!0,"flexrow-item":!0},attrs:{"can-save":!0},on:{change:e.onSearchChange,save:e.saveSearchQuery}}),s("span",{staticClass:"filler"}),e.isActiveTab("schedule")?s("combobox-number",{staticClass:"flexrow-item zoom-level",attrs:{label:e.$t("schedule.zoom_level"),options:e.zoomOptions},model:{value:e.zoomLevel,callback:function(a){e.zoomLevel=a},expression:"zoomLevel"}}):e._e(),s("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("main.sorted_by"),options:e.sortOptions,"locale-key-prefix":"tasks.fields."},model:{value:e.currentSort,callback:function(a){e.currentSort=a},expression:"currentSort"}})],1),s("div",{ref:"query"},[s("div",{staticClass:"query-list"},[s("search-query-list",{attrs:{queries:e.personTaskSearchQueries,type:"person"},on:{"change-search":e.changeSearch,"remove-search":e.removeSearchQuery}})],1)]),e.isActiveTab("todos")?s("todos-list",{ref:"task-list",attrs:{tasks:e.sortedTasks,"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,"selection-grid":e.personTaskSelectionGrid},on:{scroll:e.setPersonTasksScrollPosition}}):e._e(),e.isActiveTab("done")?s("todos-list",{ref:"done-list",attrs:{tasks:e.displayedPersonDoneTasks,"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,done:!0,selectionGrid:e.personTaskSelectionGrid}}):e._e(),e.isActiveTab("timesheets")?s("timesheet-list",{attrs:{tasks:e.loggablePersonTasks,"done-tasks":e.loggableDoneTasks,"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,"time-spent-map":e.personTimeSpentMap,"time-spent-total":e.personTimeSpentTotal,"hide-done":e.personTasksSearchText.length===0,"hide-day-off":!(e.isCurrentUserAdmin||this.user.id==this.person.id)},on:{"date-changed":e.onDateChanged,"time-spent-change":e.onTimeSpentChange,"set-day-off":e.onSetDayOff,"unset-day-off":e.onUnsetDayOff}}):e._e(),e.isActiveTab("schedule")?s("div",[e.scheduleItems.length>0?s("schedule",{ref:"schedule-widget",attrs:{"start-date":e.tasksStartDate,"end-date":e.tasksEndDate,hierarchy:e.scheduleItems,"zoom-level":e.zoomLevel,height:e.scheduleHeight,"is-loading":e.isTasksLoading,"is-estimation-linked":!0,"with-milestones":!1}}):s("div",{staticClass:"has-text-centered"},[e._v(" There is no tasks scheduled for current person. ")])],1):e._e()],1)]),e.nbSelectedTasks===1?s("div",{staticClass:"column side-column"},[s("task-info",{attrs:{task:e.selectedTasks.values().next().value}})],1):e._e()])},z=[],H=$(A,M,z,!1,null,"f99b2ad7",null,null);const B=H.exports;export{B as default};
//# sourceMappingURL=Person-8ba51a36.js.map
