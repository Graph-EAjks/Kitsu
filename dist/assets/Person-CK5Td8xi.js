import{_ as I,u as E,s as H,C as z,O as U,a as x,bH as Y,aF as q,X as j,Y as V,S as F,av as N,L as Q,bI as G,bC as K,bJ as R,A as u,m as J,j as y,bw as v,bx as D,b as X,bA as W,bF as k,bK as Z,bL as $,bM as ee,r as d,o as n,c as f,e as m,f as p,t as P,F as se,n as te,a1 as ae,l,d as c}from"./index-8IMIcgVQ.js";const re={name:"person",mixins:[E,H],components:{Combobox:z,ComboboxNumber:U,ComboboxProduction:x,KanbanBoard:Y,PeopleAvatar:q,RouteSectionTabs:j,Schedule:V,SearchField:F,SearchQueryList:N,TaskInfo:Q,TimesheetList:G,TodosList:K,UserCalendar:R},data(){return{activeTab:"todos",currentSort:"entity_name",daysOff:[],dayOffError:!1,init:!1,isTasksLoading:!1,isTasksLoadingError:!1,loading:{savingSearch:!1},person:null,productionId:void 0,scheduleHeight:0,selectedDate:u().format("YYYY-MM-DD"),sortOptions:["entity_name","priority","task_status_short_name","start_date","due_date","estimation","last_comment_date"].map(e=>({label:e,value:e})),zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},async mounted(){this.updateActiveTab(),await this.loadPerson(this.$route.params.person_id),this.person&&(setTimeout(()=>{var e,s;(e=this.searchField)==null||e.focus(),(s=this.$refs["schedule-widget"])==null||s.scrollToDate(this.tasksStartDate)},300),window.addEventListener("resize",this.resetScheduleHeight),this.setSearchFromUrl(),this.onSearchChange(),this.init=!0)},afterDestroy(){window.removeEventListener("resize",this.resetScheduleHeight),this.$store.commit("LOAD_PERSON_TASKS_END",{tasks:[],userFilters:{},taskTypeMap:this.taskTypeMap})},computed:{...J(["displayedPersonTasks","displayedPersonDoneTasks","getProductionTaskStatuses","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","nbSelectedTasks","personMap","personTasksScrollPosition","personTaskSearchQueries","personTaskSelectionGrid","personTimeSpentMap","personTimeSpentTotal","openProductions","productionMap","selectedTasks","taskStatuses","taskTypeMap","user"]),isCurrentUserAllowed(){return this.isCurrentUserManager||this.user.id===this.person.id?!0:this.isCurrentUserSupervisor?this.user.departments.some(s=>this.person.departments.includes(s)):!1},loggablePersonTasks(){return this.displayedPersonTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},loggableDoneTasks(){return this.displayedPersonDoneTasks.filter(e=>this.taskTypeMap.get(e.task_type_id).allow_timelog)},searchField(){return this.$refs["person-tasks-search-field"]},taskList(){return this.$refs["task-list"]},haveDoneList(){return this.$refs["done-list"]},sortedTasks(){const e=this.currentSort==="entity_name",s=this.currentSort==="priority",r=this.currentSort==="due_date",i=this.currentSort==="start_date",a=[...this.displayedPersonTasks];return e?a.sort(y("project_name").thenBy("task_type_name").thenBy("full_entity_name")):s?a.sort(y("priority",-1).thenBy((t,o)=>t.due_date?o.due_date?t.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):r?a.sort(y((t,o)=>t.due_date?o.due_date?t.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):i?a.sort(y((t,o)=>t.start_date?o.start_date?t.start_date.localeCompare(o.start_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):a.sort(y(this.currentSort,-1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name"))},tasksStartDate(){return this.scheduleTasks.length?v(this.scheduleTasks):u()},tasksEndDate(){return this.scheduleTasks.length?D(this.scheduleTasks):u().add(15,"days")},scheduleTasks(){return this.scheduleItems.flatMap(e=>e.children)},scheduleItems(){const e=new Map;this.sortedTasks.forEach(r=>{if(!e.get(r.project_id)){const t=this.productionMap.get(r.project_id),o=this.buildProjectScheduleItem(t);e.set(r.project_id,o)}const i=e.get(r.project_id),a=this.buildTaskScheduleItem(i,r);a&&i.children.push(a)});const s=Array.from(e.values());return s.forEach(r=>{let i=u(),a=u().add(1,"days"),t=0;r.children.length>0&&(i=v(r.children),a=D(r.children)),r.children.forEach(o=>{this.formatDuration(o.estimation)&&(t+=o.estimation)}),Object.assign(r,{startDate:i,endDate:a,man_days:t,daysOff:this.daysOff})}),s},boardTasks(){const e=this.sortedTasks.concat(this.displayedPersonDoneTasks);return this.selectedProduction?e.filter(s=>s.project_id===this.selectedProduction.id):e},boardStatuses(){if(this.selectedProduction)return this.getBoardStatusesByProduction(this.selectedProduction);const e={};return this.userOpenProductions.forEach(s=>{this.getBoardStatusesByProduction(s).forEach(i=>{e[i.id]||(e[i.id]=[]),e[i.id].push(s.id)})}),this.taskStatuses.filter(s=>!s.for_concept).map(s=>({...s,productions:e[s.id]||[]})).filter(s=>s.productions.length>0).sort((s,r)=>s.priority-r.priority)},productionList(){return[{name:this.$t("main.all")},...this.userOpenProductions]},selectedProduction(){return this.productionMap.get(this.productionId)},userOpenProductions(){return this.person?this.openProductions.filter(e=>e.team.includes(this.person.id)):[]},todoTabs(){const e=this.openProductions.some(s=>this.getBoardStatusesByProduction(s).length);return[{label:this.$t("main.tasks"),name:"todos"},e?{label:this.$t("board.title"),name:"board"}:void 0,{label:this.$t("tasks.calendar"),name:"calendar"},{label:this.$t("schedule.title"),name:"schedule"},{label:`${this.$t("tasks.validated")} (${this.displayedPersonDoneTasks.length})`,name:"done"},{label:this.$t("timesheets.title"),name:"timesheets"}].filter(Boolean)}},methods:{...X(["clearSelectedTasks","loadAggregatedPersonDaysOff","loadPersonTasks","loadPersonTimeSpents","setPersonTasksSearch","savePersonTasksSearch","removePersonTasksSearch","setDayOff","setPersonTasksScrollPosition","setTimeSpent","unsetDayOff","updateTask"]),onAssignation(e){this.person.id===e.person_id&&this.loadPerson(this.person.id)},resetScheduleHeight(){this.$nextTick(()=>{var e,s,r,i,a,t;if(this.isActiveTab("schedule")){const o=((e=this.$refs.page)==null?void 0:e.offsetHeight)||0,g=((s=this.$refs.header)==null?void 0:s.offsetHeight)||0,_=((r=this.$refs.tabs)==null?void 0:r.offsetHeight)||0,T=((i=this.$refs.search)==null?void 0:i.offsetHeight)||0,b=((a=this.$refs.query)==null?void 0:a.offsetHeight)||0;this.scheduleHeight=o-g-_-T-b,(t=this.$refs["schedule-widget"])==null||t.resetScheduleSize()}})},buildProjectScheduleItem(e){return{...e,avatar:!0,color:W.fromString(e.name,!0),priority:1,expanded:!0,loading:!1,children:[],editable:!1}},buildTaskScheduleItem(e,s){let r=u(),i;if(!s.start_date&&!s.real_start_date&&!s.due_date&&!s.end_date)return null;s.start_date?r=k(s.start_date):s.real_start_date&&(r=k(s.real_start_date));const a=s.estimation;s.due_date?i=k(s.due_date):s.end_date?i=k(s.end_date):s.estimation&&(i=r.clone().add(a,"days")),(!i||i.isBefore(r))&&(i=r.clone().add(1,"days"));const t=this.taskTypeMap.get(s.task_type_id);return{...s,name:`${s.full_entity_name} / ${t.name}`,startDate:r,endDate:i,expanded:!1,loading:!1,man_days:a,editable:!1,unresizable:!1,parentElement:e,color:t.color,children:[]}},isActiveTab(e){return this.init&&this.activeTab===e},onSearchChange(e){var s;e=e||((s=this.searchField)==null?void 0:s.getValue()),this.setSearchInUrl(e),this.setPersonTasksSearch(e)},async loadPerson(e){if(this.person=this.personMap.get(e),!this.person){this.$router.push({name:"not-found"});return}if(!(this.person.is_bot||!this.isCurrentUserAllowed)){this.isTasksLoading=!0,this.isTasksLoadingError=!1,await this.loadPersonTasks({personId:this.person.id,date:this.selectedDate}).then(()=>{setTimeout(()=>{this.$nextTick(()=>{var s;(s=this.taskList)==null||s.setScrollPosition(this.personTasksScrollPosition)}),this.resizeHeaders()},0)}).catch(s=>{console.error(s),this.isTasksLoadingError=!0}).finally(()=>{this.isTasksLoading=!1});try{this.daysOff=await this.loadAggregatedPersonDaysOff({personId:e})}catch(s){console.error(s)}}},async loadTimeSpents(){this.isTasksLoading=!0,await this.loadPersonTimeSpents({personId:this.person.id,date:this.selectedDate}),this.isTasksLoading=!1},resizeHeaders(){this.$nextTick(()=>{var e,s;(e=this.taskList)==null||e.resizeHeaders(),(s=this.haveDoneList)==null||s.resizeHeaders()})},saveSearchQuery(e){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePersonTasksSearch(e).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(e){this.removePersonTasksSearch(e).catch(s=>{s&&console.error(s)})},updateActiveTab(){const e=["board","calendar","done","schedule","timesheets"],s=this.$route.query.section;if(this.activeTab=e.includes(s)?s:"todos",this.activeTab==="board"){const r=this.userOpenProductions.find(({id:i})=>i===this.$route.query.productionId);r?this.productionId=r.id:this.$router.push({query:{productionId:this.productionId,section:this.activeTab,search:this.$route.query.search}})}this.clearSelectedTasks()},onTimeSpentChange(e){e.personId=this.person.id,e.date=this.selectedDate,this.setTimeSpent(e)},async onDateChanged(e){this.selectedDate=u(e).format("YYYY-MM-DD"),await this.loadTimeSpents()},async onSetDayOff(e){var s,r;this.dayOffError=!1;try{await this.setDayOff({...e,personId:this.person.id}),(s=this.$refs["timesheet-list"])==null||s.closeSetDayOffModal()}catch(i){this.dayOffError=((r=i.body)==null?void 0:r.message)||!0}},async onUnsetDayOff(){var e,s;this.dayOffError=!1;try{await this.unsetDayOff(),(e=this.$refs["timesheet-list"])==null||e.closeUnsetDayOffModal()}catch(r){this.dayOffError=((s=r.body)==null?void 0:s.message)||!0}},saveTaskScheduleItem(e){const s=Z(e.startDate,e.endDate),r=$(this.organisation,s);e.man_days=r,e.startDate&&e.endDate&&this.updateTask({taskId:e.id,data:{estimation:r,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})},getBoardStatusesByProduction(e){const s=this.getProductionTaskStatuses(e.id).filter(r=>{var a,t;if(r.for_concept)return!1;const i=(t=(a=e.task_statuses_link)==null?void 0:a[r.id])==null?void 0:t.roles_for_board;return i==null?void 0:i.includes(this.user.role)});return ee(s,e)}},head(){var e;return{title:`${((e=this.person)==null?void 0:e.name)||"..."} - Kitsu`}},watch:{"$route.params.person_id"(e){this.updateActiveTab(),this.person&&this.person.id!==e&&this.loadPerson(e)},"$route.query.search"(e){var s;(s=this.searchField)==null||s.setValue(e),this.onSearchChange(e)},activeTab(){this.resetScheduleHeight(),this.$nextTick(()=>{var e;(e=this.$refs["schedule-widget"])==null||e.scrollToDate(this.tasksStartDate)})},"$route.query.section"(){this.updateActiveTab()},productionId(){this.$router.push({query:{productionId:this.productionId,tab:this.activeTab}})},zoomLevel(){var e;(e=this.$refs["schedule-widget"])==null||e.scrollToDate(this.tasksStartDate)}},socket:{events:{"task:assign"(e){this.onAssignation(e)},"task:unassign"(e){this.onAssignation(e)}}}},ie={ref:"page",class:"columns fixed-page"},oe={class:"column main-column"},ne={key:0,class:"person page"},de={ref:"header",class:"flexrow page-header"},le={class:"flexrow-item"},ce={class:"flexrow-item entity-title"},he={ref:"search",class:"flexrow"},ue={key:0,ref:"query",class:"query-list"},fe={key:6},me={key:1,class:"has-text-centered"},pe={key:0,class:"column side-column"};function ye(e,s,r,i,a,t){const o=d("people-avatar"),g=d("route-section-tabs"),_=d("search-field"),T=d("combobox-production"),b=d("combobox-number"),L=d("combobox"),O=d("search-query-list"),S=d("todos-list"),C=d("kanban-board"),w=d("user-calendar"),A=d("timesheet-list"),B=d("schedule"),M=d("task-info");return n(),f("div",ie,[m("div",oe,[a.person?(n(),f("div",ne,[m("div",de,[m("div",le,[p(o,{person:a.person,size:80,"font-size":30,"is-text":!1},null,8,["person"])]),m("div",ce,P(a.person.name),1)],512),!a.person.is_bot&&t.isCurrentUserAllowed?(n(),f(se,{key:0},[p(g,{class:"section-tabs mt1","active-tab":a.activeTab,route:e.$route,tabs:t.todoTabs},null,8,["active-tab","route","tabs"]),te(m("div",he,[p(_,{ref:"person-tasks-search-field",class:"search-field flexrow-item","can-save":"",onChange:t.onSearchChange,onSave:t.saveSearchQuery},null,8,["onChange","onSave"]),t.isActiveTab("board")?(n(),l(T,{key:0,class:"flexrow-item production-field",label:e.$t("main.production"),"production-list":t.productionList,modelValue:a.productionId,"onUpdate:modelValue":s[0]||(s[0]=h=>a.productionId=h)},null,8,["label","production-list","modelValue"])):c("",!0),s[4]||(s[4]=m("span",{class:"filler"},null,-1)),t.isActiveTab("schedule")?(n(),l(b,{key:1,class:"flexrow-item zoom-level mb0",label:e.$t("schedule.zoom_level"),options:a.zoomOptions,modelValue:a.zoomLevel,"onUpdate:modelValue":s[1]||(s[1]=h=>a.zoomLevel=h)},null,8,["label","options","modelValue"])):c("",!0),p(L,{class:"flexrow-item",label:e.$t("main.sorted_by"),options:a.sortOptions,"locale-key-prefix":"tasks.fields.",modelValue:a.currentSort,"onUpdate:modelValue":s[2]||(s[2]=h=>a.currentSort=h)},null,8,["label","options","modelValue"])],512),[[ae,!t.isActiveTab("calendar")]]),t.isActiveTab("calendar")?c("",!0):(n(),f("div",ue,[p(O,{queries:e.personTaskSearchQueries,type:"person",onRemoveSearch:t.removeSearchQuery},null,8,["queries","onRemoveSearch"])],512)),t.isActiveTab("todos")?(n(),l(S,{key:1,ref:"task-list","empty-text":e.$t("people.no_task_assigned"),"is-loading":a.isTasksLoading,"is-error":a.isTasksLoadingError,"selection-grid":e.personTaskSelectionGrid,tasks:t.sortedTasks,onScroll:e.setPersonTasksScrollPosition},null,8,["empty-text","is-loading","is-error","selection-grid","tasks","onScroll"])):t.isActiveTab("done")?(n(),l(S,{key:2,ref:"done-list",tasks:e.displayedPersonDoneTasks,"is-loading":a.isTasksLoading,"is-error":a.isTasksLoadingError,done:!0,"selection-grid":e.personTaskSelectionGrid},null,8,["tasks","is-loading","is-error","selection-grid"])):t.isActiveTab("board")?(n(),l(C,{key:3,"is-loading":a.isTasksLoading,"is-error":a.isTasksLoadingError,statuses:t.boardStatuses,tasks:t.boardTasks,user:e.user,production:t.selectedProduction},null,8,["is-loading","is-error","statuses","tasks","user","production"])):c("",!0),t.isActiveTab("calendar")?(n(),l(w,{key:4,ref:"user-calendar",class:"calendar","days-off":a.daysOff,tasks:t.sortedTasks},null,8,["days-off","tasks"])):t.isActiveTab("timesheets")&&e.isCurrentUserManager?(n(),l(A,{key:5,ref:"timesheet-list",tasks:t.loggablePersonTasks,"done-tasks":t.loggableDoneTasks,"is-loading":a.isTasksLoading,"is-error":a.isTasksLoadingError,"day-off-error":a.dayOffError,"time-spent-map":e.personTimeSpentMap,"time-spent-total":e.personTimeSpentTotal,"hide-done":!1,"hide-day-off":!(e.isCurrentUserAdmin||e.user.id===a.person.id),onDateChanged:t.onDateChanged,onTimeSpentChange:t.onTimeSpentChange,onSetDayOff:t.onSetDayOff,onUnsetDayOff:t.onUnsetDayOff},null,8,["tasks","done-tasks","is-loading","is-error","day-off-error","time-spent-map","time-spent-total","hide-day-off","onDateChanged","onTimeSpentChange","onSetDayOff","onUnsetDayOff"])):t.isActiveTab("schedule")?(n(),f("div",fe,[t.scheduleItems.length>0?(n(),l(B,{key:0,ref:"schedule-widget","days-off":a.daysOff,"start-date":t.tasksStartDate.clone().add(-3,"months"),"end-date":t.tasksEndDate.clone().add(3,"months"),hierarchy:t.scheduleItems,"zoom-level":a.zoomLevel,height:a.scheduleHeight,"is-loading":a.isTasksLoading,"is-estimation-linked":!0,"with-milestones":!1,onItemChanged:t.saveTaskScheduleItem,onEstimationChanged:s[3]||(s[3]=h=>t.saveTaskScheduleItem(h.item))},null,8,["days-off","start-date","end-date","hierarchy","zoom-level","height","is-loading","onItemChanged"])):(n(),f("div",me,P(e.$t("main.empty_schedule")),1))])):c("",!0)],64)):c("",!0)])):c("",!0)]),e.nbSelectedTasks===1?(n(),f("div",pe,[p(M,{task:e.selectedTasks.values().next().value},null,8,["task"])])):c("",!0)],512)}const ke=I(re,[["render",ye],["__scopeId","data-v-4fb50580"]]);export{ke as default};
//# sourceMappingURL=Person-CK5Td8xi.js.map
