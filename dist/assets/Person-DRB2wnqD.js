import{g as T,C as y,v as g,a as _,bj as k,al as b,R as S,A as v,S as D,ab as P,s as $,be as C,bk as x,bl as L,l as n,m as O,f as d,b8 as h,b9 as u,b as A,bc as M,bh as l,bm as B,bn as I,bo as w,n as E}from"./index-D97y86BJ.js";const z={name:"person",mixins:[T],components:{Combobox:y,ComboboxNumber:g,ComboboxProduction:_,KanbanBoard:k,PeopleAvatar:b,RouteSectionTabs:S,Schedule:v,SearchField:D,SearchQueryList:P,TaskInfo:$,TodosList:C,TimesheetList:x,UserCalendar:L},data(){return{activeTab:"todos",currentSort:"entity_name",daysOff:[],dayOffError:!1,isTasksLoading:!1,isTasksLoadingError:!1,loading:{savingSearch:!1},person:null,productionId:void 0,scheduleHeight:0,selectedDate:n().format("YYYY-MM-DD"),sortOptions:["entity_name","priority","task_status_short_name","start_date","due_date","estimation","last_comment_date"].map(s=>({label:s,value:s})),zoomLevel:1,zoomOptions:[{label:"Week",value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}]}},mounted(){var s;this.updateActiveTab(),this.personTasksSearchText.length>0&&((s=this.searchField)==null||s.setValue(this.personTasksSearchText)),setTimeout(()=>{var e,t;(e=this.searchField)==null||e.focus(),(t=this.$refs["schedule-widget"])==null||t.scrollToDate(this.tasksStartDate)},300),this.loadPerson(this.$route.params.person_id),window.addEventListener("resize",this.resetScheduleHeight)},afterDestroy(){window.removeEventListener("resize",this.resetScheduleHeight),this.$store.commit("LOAD_PERSON_TASKS_END",{tasks:[],userFilters:{},taskTypeMap:this.taskTypeMap})},computed:{...O(["displayedPersonTasks","displayedPersonDoneTasks","getProductionTaskStatuses","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","nbSelectedTasks","personMap","personTasksScrollPosition","personTasksSearchText","personTaskSearchQueries","personTaskSelectionGrid","personTimeSpentMap","personTimeSpentTotal","openProductions","productionMap","selectedTasks","taskStatuses","taskTypeMap","user"]),isCurrentUserAllowed(){return this.isCurrentUserManager||this.user.id===this.person.id?!0:this.isCurrentUserSupervisor?this.user.departments.some(e=>this.person.departments.includes(e)):!1},loggablePersonTasks(){return this.displayedPersonTasks.filter(s=>this.taskTypeMap.get(s.task_type_id).allow_timelog)},loggableDoneTasks(){return this.displayedPersonDoneTasks.filter(s=>this.taskTypeMap.get(s.task_type_id).allow_timelog)},searchField(){return this.$refs["person-tasks-search-field"]},taskList(){return this.$refs["task-list"]},haveDoneList(){return this.$refs["done-list"]},sortedTasks(){const s=this.currentSort==="entity_name",e=this.currentSort==="priority",t=this.currentSort==="due_date",a=this.currentSort==="start_date",i=[...this.displayedPersonTasks];return s?i.sort(d("project_name").thenBy("task_type_name").thenBy("full_entity_name")):e?i.sort(d("priority",-1).thenBy((r,o)=>r.due_date?o.due_date?r.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):t?i.sort(d((r,o)=>r.due_date?o.due_date?r.due_date.localeCompare(o.due_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):a?i.sort(d((r,o)=>r.start_date?o.start_date?r.start_date.localeCompare(o.start_date):-1:1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name")):i.sort(d(this.currentSort,-1).thenBy("project_name").thenBy("task_type_name").thenBy("entity_name"))},tasksStartDate(){return this.scheduleTasks.length?h(this.scheduleTasks):n()},tasksEndDate(){return this.scheduleTasks.length?u(this.scheduleTasks):n().add(15,"days")},scheduleTasks(){return this.scheduleItems.flatMap(s=>s.children)},scheduleItems(){const s=new Map;this.sortedTasks.forEach(t=>{if(!s.get(t.project_id)){const r=this.productionMap.get(t.project_id),o=this.buildProjectScheduleItem(r);s.set(t.project_id,o)}const a=s.get(t.project_id),i=this.buildTaskScheduleItem(a,t);i&&a.children.push(i)});const e=Array.from(s.values());return e.forEach(t=>{let a=n(),i=n().add(1,"days"),r=0;t.children.length>0&&(a=h(t.children),i=u(t.children)),t.children.forEach(o=>{this.formatDuration(o.estimation)&&(r+=o.estimation)}),Object.assign(t,{startDate:a,endDate:i,man_days:r,daysOff:this.daysOff})}),e},boardTasks(){const s=this.sortedTasks.concat(this.displayedPersonDoneTasks);return this.selectedProduction?s.filter(e=>e.project_id===this.selectedProduction.id):s},boardStatuses(){if(this.selectedProduction)return this.getBoardStatusesByProduction(this.selectedProduction);const s={};return this.userOpenProductions.forEach(e=>{this.getBoardStatusesByProduction(e).forEach(a=>{s[a.id]||(s[a.id]=[]),s[a.id].push(e.id)})}),this.taskStatuses.filter(e=>!e.for_concept).map(e=>({...e,productions:s[e.id]||[]})).filter(e=>e.productions.length>0).sort((e,t)=>e.priority-t.priority)},productionList(){return[{name:this.$t("main.all")},...this.userOpenProductions]},selectedProduction(){return this.productionMap.get(this.productionId)},userOpenProductions(){return this.person?this.openProductions.filter(s=>s.team.includes(this.person.id)):[]},todoTabs(){const s=this.openProductions.some(e=>this.getBoardStatusesByProduction(e).length);return[{label:this.$t("main.tasks"),name:"todos"},s?{label:this.$t("board.title"),name:"board"}:void 0,{label:this.$t("tasks.calendar"),name:"calendar"},{label:this.$t("schedule.title"),name:"schedule"},{label:`${this.$t("tasks.validated")} (${this.displayedPersonDoneTasks.length})`,name:"done"},{label:this.$t("timesheets.title"),name:"timesheets"}].filter(Boolean)}},methods:{...A(["clearSelectedTasks","loadAggregatedPersonDaysOff","loadPersonTasks","setPersonTasksSearch","savePersonTasksSearch","removePersonTasksSearch","setDayOff","setPersonTasksScrollPosition","setTimeSpent","unsetDayOff","updateTask"]),onAssignation(s){this.person.id===s.person_id&&this.loadPerson(this.person.id)},resetScheduleHeight(){this.$nextTick(()=>{var s,e,t,a,i,r;if(this.isActiveTab("schedule")){const o=((s=this.$refs.page)==null?void 0:s.offsetHeight)||0,c=((e=this.$refs.header)==null?void 0:e.offsetHeight)||0,f=((t=this.$refs.tabs)==null?void 0:t.offsetHeight)||0,p=((a=this.$refs.search)==null?void 0:a.offsetHeight)||0,m=((i=this.$refs.query)==null?void 0:i.offsetHeight)||0;this.scheduleHeight=o-c-f-p-m,(r=this.$refs["schedule-widget"])==null||r.resetScheduleSize()}})},buildProjectScheduleItem(s){return{...s,avatar:!0,color:M.fromString(s.name,!0),priority:1,expanded:!0,loading:!1,children:[],editable:!1}},buildTaskScheduleItem(s,e){let t=n(),a;if(!e.start_date&&!e.real_start_date&&!e.due_date&&!e.end_date)return null;e.start_date?t=l(e.start_date):e.real_start_date&&(t=l(e.real_start_date));const i=e.estimation;e.due_date?a=l(e.due_date):e.end_date?a=l(e.end_date):e.estimation&&(a=t.clone().add(i,"days")),(!a||a.isBefore(t))&&(a=t.clone().add(1,"days"));const r=this.taskTypeMap.get(e.task_type_id);return{...e,name:`${e.full_entity_name} / ${r.name}`,startDate:t,endDate:a,expanded:!1,loading:!1,man_days:i,editable:!1,unresizable:!1,parentElement:s,color:r.color,children:[]}},isActiveTab(s){return this.activeTab===s},onSearchChange(s){this.setPersonTasksSearch(s)},async loadPerson(s){if(this.person=this.personMap.get(s),!this.person){this.$router.push({name:"not-found"});return}if(!(this.person.is_bot||!this.isCurrentUserAllowed)){this.isTasksLoading=!0,this.isTasksLoadingError=!1,this.loadPersonTasks({personId:this.person.id,date:this.selectedDate}).then(()=>{setTimeout(()=>{this.$nextTick(()=>{var e;(e=this.taskList)==null||e.setScrollPosition(this.personTasksScrollPosition)}),this.resizeHeaders()},0)}).catch(e=>{console.error(e),this.isTasksLoadingError=!0}).finally(()=>{this.isTasksLoading=!1});try{this.daysOff=await this.loadAggregatedPersonDaysOff({personId:s})}catch(e){console.error(e)}}},resizeHeaders(){this.$nextTick(()=>{var s,e;(s=this.taskList)==null||s.resizeHeaders(),(e=this.haveDoneList)==null||e.resizeHeaders()})},changeSearch(s){var e;(e=this.searchField)==null||e.setValue(s.search_query),this.onSearchChange(s.search_query)},saveSearchQuery(s){this.loading.savingSearch||(this.loading.savingSearch=!0,this.savePersonTasksSearch(s).catch(console.error).finally(()=>{this.loading.savingSearch=!1}))},removeSearchQuery(s){this.removePersonTasksSearch(s).catch(e=>{e&&console.error(e)})},updateActiveTab(){const s=["board","calendar","done","schedule","timesheets"],e=this.$route.query.section;if(this.activeTab=s.includes(e)?e:"todos",this.activeTab==="board"){const t=this.userOpenProductions.find(({id:a})=>a===this.$route.query.productionId);t?this.productionId=t.id:this.$router.push({query:{productionId:this.productionId,section:this.activeTab}})}this.clearSelectedTasks()},onTimeSpentChange(s){s.personId=this.person.id,s.date=this.selectedDate,this.setTimeSpent(s)},onDateChanged(s){this.selectedDate=n(s).format("YYYY-MM-DD"),this.loadPerson(this.person.id)},async onSetDayOff(s){var e,t;this.dayOffError=!1;try{await this.setDayOff({...s,personId:this.person.id}),(e=this.$refs["timesheet-list"])==null||e.closeSetDayOffModal()}catch(a){this.dayOffError=((t=a.body)==null?void 0:t.message)||!0}},async onUnsetDayOff(){var s,e;this.dayOffError=!1;try{await this.unsetDayOff(),(s=this.$refs["timesheet-list"])==null||s.closeUnsetDayOffModal()}catch(t){this.dayOffError=((e=t.body)==null?void 0:e.message)||!0}},saveTaskScheduleItem(s){const e=B(s.startDate,s.endDate),t=I(this.organisation,e);s.man_days=t,s.startDate&&s.endDate&&this.updateTask({taskId:s.id,data:{estimation:t,start_date:s.startDate.format("YYYY-MM-DD"),due_date:s.endDate.format("YYYY-MM-DD")}})},getBoardStatusesByProduction(s){const e=this.getProductionTaskStatuses(s.id).filter(t=>{var i,r;if(t.for_concept)return!1;const a=(r=(i=s.task_statuses_link)==null?void 0:i[t.id])==null?void 0:r.roles_for_board;return a==null?void 0:a.includes(this.user.role)});return w(e,s)}},metaInfo(){var s;return{title:`${((s=this.person)==null?void 0:s.name)||"..."} - Kitsu`}},watch:{$route(){const s=this.$route.params.person_id;this.updateActiveTab(),this.person&&this.person.id!==s&&this.loadPerson(s)},activeTab(){this.resetScheduleHeight(),this.$nextTick(()=>{var s;(s=this.$refs["schedule-widget"])==null||s.scrollToDate(this.tasksStartDate)})},"$route.query.section"(){this.updateActiveTab()},productionId(){this.$router.push({query:{productionId:this.productionId,tab:this.activeTab}})},zoomLevel(){var s;(s=this.$refs["schedule-widget"])==null||s.scrollToDate(this.tasksStartDate)}},socket:{events:{"task:assign"(s){this.onAssignation(s)},"task:unassign"(s){this.onAssignation(s)}}}};var H=function(){var e=this,t=e._self._c;return t("div",{ref:"page",staticClass:"columns fixed-page"},[t("div",{staticClass:"column main-column"},[e.person?t("div",{staticClass:"person page"},[t("div",{ref:"header",staticClass:"flexrow page-header"},[t("div",{staticClass:"flexrow-item"},[t("people-avatar",{attrs:{person:e.person,size:80,"font-size":30,"is-text":!1}})],1),t("div",{staticClass:"flexrow-item entity-title"},[e._v(" "+e._s(e.person.name)+" ")])]),!e.person.is_bot&&e.isCurrentUserAllowed?[t("route-section-tabs",{staticClass:"section-tabs mt1",attrs:{"active-tab":e.activeTab,route:e.$route,tabs:e.todoTabs}}),e.isActiveTab("calendar")?e._e():t("div",{ref:"search",staticClass:"flexrow"},[t("search-field",{ref:"person-tasks-search-field",staticClass:"search-field flexrow-item",attrs:{"can-save":""},on:{change:e.onSearchChange,save:e.saveSearchQuery}}),e.isActiveTab("board")?t("combobox-production",{staticClass:"flexrow-item production-field",attrs:{label:e.$t("main.production"),"production-list":e.productionList},model:{value:e.productionId,callback:function(a){e.productionId=a},expression:"productionId"}}):e._e(),t("span",{staticClass:"filler"}),e.isActiveTab("schedule")?t("combobox-number",{staticClass:"flexrow-item zoom-level mb0",attrs:{label:e.$t("schedule.zoom_level"),options:e.zoomOptions},model:{value:e.zoomLevel,callback:function(a){e.zoomLevel=a},expression:"zoomLevel"}}):e._e(),t("combobox",{staticClass:"flexrow-item",attrs:{label:e.$t("main.sorted_by"),options:e.sortOptions,"locale-key-prefix":"tasks.fields."},model:{value:e.currentSort,callback:function(a){e.currentSort=a},expression:"currentSort"}})],1),e.isActiveTab("calendar")?e._e():t("div",{ref:"query",staticClass:"query-list"},[t("search-query-list",{attrs:{queries:e.personTaskSearchQueries,type:"person"},on:{"change-search":e.changeSearch,"remove-search":e.removeSearchQuery}})],1),e.isActiveTab("todos")?t("todos-list",{ref:"task-list",attrs:{"empty-text":e.$t("people.no_task_assigned"),"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,"selection-grid":e.personTaskSelectionGrid,tasks:e.sortedTasks},on:{scroll:e.setPersonTasksScrollPosition}}):e.isActiveTab("done")?t("todos-list",{ref:"done-list",attrs:{tasks:e.displayedPersonDoneTasks,"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,done:!0,"selection-grid":e.personTaskSelectionGrid}}):e.isActiveTab("board")?t("kanban-board",{attrs:{"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,statuses:e.boardStatuses,tasks:e.boardTasks,user:e.user,production:e.selectedProduction}}):e._e(),e.isActiveTab("calendar")?t("user-calendar",{ref:"user-calendar",staticClass:"calendar",attrs:{"days-off":e.daysOff,tasks:e.sortedTasks}}):e.isActiveTab("timesheets")&&e.isCurrentUserManager?t("timesheet-list",{ref:"timesheet-list",attrs:{tasks:e.loggablePersonTasks,"done-tasks":e.loggableDoneTasks,"is-loading":e.isTasksLoading,"is-error":e.isTasksLoadingError,"day-off-error":e.dayOffError,"time-spent-map":e.personTimeSpentMap,"time-spent-total":e.personTimeSpentTotal,"hide-done":e.personTasksSearchText.length===0,"hide-day-off":!(e.isCurrentUserAdmin||e.user.id===e.person.id)},on:{"date-changed":e.onDateChanged,"time-spent-change":e.onTimeSpentChange,"set-day-off":e.onSetDayOff,"unset-day-off":e.onUnsetDayOff}}):e.isActiveTab("schedule")?t("div",[e.scheduleItems.length>0?t("schedule",{ref:"schedule-widget",attrs:{"days-off":e.daysOff,"start-date":e.tasksStartDate.clone().add(-3,"months"),"end-date":e.tasksEndDate.clone().add(3,"months"),hierarchy:e.scheduleItems,"zoom-level":e.zoomLevel,height:e.scheduleHeight,"is-loading":e.isTasksLoading,"is-estimation-linked":!0,"with-milestones":!1},on:{"item-changed":e.saveTaskScheduleItem,"estimation-changed":a=>e.saveTaskScheduleItem(a.item)}}):t("div",{staticClass:"has-text-centered"},[e._v(" "+e._s(e.$t("main.empty_schedule"))+" ")])],1):e._e()]:e._e()],2):e._e()]),e.nbSelectedTasks===1?t("div",{staticClass:"column side-column"},[t("task-info",{attrs:{task:e.selectedTasks.values().next().value}})],1):e._e()])},Y=[],j=E(z,H,Y,!1,null,"1a2a6703");const q=j.exports;export{q as default};
//# sourceMappingURL=Person-DRB2wnqD.js.map
