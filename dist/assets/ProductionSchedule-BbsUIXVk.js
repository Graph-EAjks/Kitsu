import{_ as x,O,aj as V,Y as A,L as B,A as S,m as C,a0 as T,ce as E,bU as z,cf as U,b as Y,bF as c,cg as M,ch as j,ci as L,cj as N,bL as q,r as g,o as P,c as v,e as y,t as I,f as m,d as F}from"./index-CVkAUrXu.js";const R={name:"production-schedule",components:{ComboboxNumber:O,DateField:V,Schedule:A,TaskInfo:B},data(){return{currentTask:null,daysOffByPerson:[],endDate:S().add(6,"months").endOf("day"),scheduleItems:[],startDate:S().startOf("day"),selectedStartDate:null,selectedEndDate:null,zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.reset()},computed:{...C(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","user"]),assetMap(){return T.cache.assetMap},assetTypeMap(){return E.cache.assetTypeMap},shotMap(){return z.cache.shotMap},taskTypeMap(){return U.cache.taskTypeMap}},methods:{...Y(["editProduction","loadAggregatedPersonDaysOff","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadSequenceScheduleItems","loadShots","loadTasks","saveScheduleItem"]),loadData(){this.loading.schedule=!0,this.loadScheduleItems(this.currentProduction).then(e=>{const n=c(this.selectedStartDate),a=c(this.selectedEndDate);e=e.map(i=>{const s=this.taskTypeMap.get(i.task_type_id);let o,u;i.start_date?o=c(i.start_date):o=S(),o.isSameOrAfter(a)&&(o=a.clone().add(-1,"days")),o.isBefore(n)&&(o=n.clone()),i.end_date?u=c(i.end_date):u=o.clone().add(1,"days"),u.isSameOrAfter(a)&&(u=a.clone());const D=M(s.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,s.for_entity);return{...i,color:s.color,for_entity:s.for_entity,name:`${s.for_entity} / ${s.name}`,priority:s.priority,startDate:o,endDate:u,editable:this.isInDepartment(s),expanded:!1,loading:!1,route:s.for_entity==="Shot"&&this.isTVShow?null:D,children:[]}}),this.scheduleItems=j(e,this.currentProduction,this.taskTypeMap),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},reset(){this.currentProduction.start_date&&(this.startDate=c(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=c(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.loadData()},convertScheduleItems(e,n){return n.map(a=>{let i;if(a.start_date?i=c(a.start_date):i=S(),i.isAfter(this.endDate))return;let s;if(a.end_date?s=c(a.end_date):s=i.clone().add(1,"days"),s.isBefore(i)&&(s=i.clone().add(1,"days")),s.isBefore(this.startDate))return;const o={...a,startDate:i,endDate:s,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id)),children:[],parentElement:e};return this.isTVShow&&(o.route=M(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),o}).filter(Boolean)},async expandTaskTypeElement(e,n=null){if(e.expanded=!e.expanded,e.expanded){try{e.loading=!0,e.children=[],e.people=[];const a=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,i={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)},s=await a(i);let o=this.convertScheduleItems(e,s);if(this.isTVShow)e.children=o;else{e.for_entity==="Asset"&&await this.loadAssets({withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();const u=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"}),D=[...new Set(u.flatMap(t=>t.assignees))];await this.loadDaysOff(D);const f={},p={};u.forEach(t=>{var d;t.start_date&&(e.for_entity==="Asset"?(t.entity=this.assetMap.get(t.entity_id),t.entity_type_id=t.entity.asset_type_id):e.for_entity==="Shot"?(t.entity=this.shotMap.get(t.entity_id),t.entity_type_id=t.entity.sequence_id):t.entity_type_id=e.for_entity,!((d=t.entity)!=null&&d.canceled)&&(f[t.entity_type_id]||(f[t.entity_type_id]={}),t.assignees.length||(t.assignees=["unassigned"]),t.assignees.forEach(r=>{const l=c(t.start_date);if(l.isAfter(this.endDate))return;t.startDate=l;let h;if(t.due_date?h=c(t.due_date):t.end_date?h=c(t.end_date):t.estimation&&(h=L(t.startDate,Math.ceil(N(this.organisation,t.estimation))-1,this.daysOffByPerson[r])),!h||h.isBefore(l)){const b=l.isoWeekday()===5?3:1;h=l.clone().add(b,"days")}if(!h.isSameOrAfter(l)){const b=l.isoWeekday()===5?3:1;h=l.clone().add(b,"days")}h.isBefore(this.startDate)||(t.endDate=h,f[t.entity_type_id][r]||(f[t.entity_type_id][r]=[],p[r]=r!=="unassigned"?{...this.personMap.get(r),daysOff:this.daysOffByPerson[r]}:{id:r,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),f[t.entity_type_id][r].push(t))})))}),e.for_entity==="Asset"&&(o=o.filter(t=>{const d=this.assetTypeMap.get(t.object_id);return d&&(!d.task_types.length||d.task_types.includes(e.task_type_id))}));const _=([t],[d])=>t==="unassigned"?1:d==="unassigned"?-1:p[t].full_name.localeCompare(p[d].full_name),w=(t,d)=>{var r,l;return(l=t.entity)==null?void 0:l.name.localeCompare((r=d.entity)==null?void 0:r.name,void 0,{numeric:!0})};o.forEach(t=>{const d=f[t.object_id]||{},r=new Map(Object.entries(d).sort(_).map(([l,h])=>[l,h.sort(w)]));t.children=r}),e.children=o,e.people=p}}catch(a){console.error(a),e.children=[],e.people=[]}finally{e.loading=!1}n&&n(e)}},async loadDaysOff(e){this.daysOffByPerson=[];for(const n of e){const a=await this.loadAggregatedPersonDaysOff({personId:n}).catch(()=>[]);this.daysOffByPerson[n]=a}},estimationChanged({item:e,days:n}){e.man_days=q(this.organisation,n),this.saveScheduleItem(e)},scheduleItemChanged(e){if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const n=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(n)&&(e.startDate=n),e.endDate.isBefore(a)&&(e.endDate=a.add(-1,"days"))}this.saveScheduleItem(e)},getMinDate(e){let n=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(n)&&(n=a.startDate)}),n.clone()},getMaxDate(e){let n=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(n)&&(n=a.endDate)}),n.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1}},watch:{selectedStartDate(){this.startDate=c(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=c(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},W={class:"columns fixed-page"},G={class:"column main-column"},K={class:"flexrow project-dates"},H={class:"flexrow-item"},J={class:"label"},Q={class:"flexrow-item field"},X={class:"label"},Z={key:0,class:"column side-column is-hidden-mobile hide-small-screen"};function $(e,n,a,i,s,o){const u=g("date-field"),D=g("combobox-number"),f=g("schedule"),p=g("task-info");return P(),v("div",W,[y("div",G,[y("div",K,[y("div",H,[y("label",J,I(e.$t("main.start_date")),1),m(u,{"can-delete":!1,utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":n[0]||(n[0]=_=>s.selectedStartDate=_)},null,8,["modelValue"])]),y("div",Q,[y("label",X,I(e.$t("main.end_date")),1),m(u,{"can-delete":!1,utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":n[1]||(n[1]=_=>s.selectedEndDate=_)},null,8,["modelValue"])]),m(D,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":n[2]||(n[2]=_=>s.zoomLevel=_)},null,8,["label","options","modelValue"])]),m(f,{"start-date":s.startDate,"end-date":s.endDate,hierarchy:s.scheduleItems,"zoom-level":s.zoomLevel,"is-loading":s.loading.schedule,"is-error":s.errors.schedule,"hide-man-days":!0,multiline:e.isTVShow,subchildren:!e.isTVShow,onItemChanged:o.scheduleItemChanged,onEstimationChanged:o.estimationChanged,onRootElementExpanded:o.expandTaskTypeElement},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","subchildren","onItemChanged","onEstimationChanged","onRootElementExpanded"])]),s.currentTask?(P(),v("div",Z,[m(p,{task:s.currentTask,"is-loading":!1},null,8,["task"])])):F("",!0)])}const ee=x(R,[["render",$],["__scopeId","data-v-16f199b1"]]);export{ee as default};
//# sourceMappingURL=ProductionSchedule-BbsUIXVk.js.map
