import{_ as A,O as B,aj as V,Y as C,L as T,A as S,m as E,a0 as z,ce as j,bU as U,cf as Y,b as L,bF as l,cg as P,ch as N,ci as q,cj as F,bL as R,r as g,o as v,c as I,e as D,t as w,f as m,d as W}from"./index-B8sWbM3o.js";const G={name:"production-schedule",components:{ComboboxNumber:B,DateField:V,Schedule:C,TaskInfo:T},data(){return{currentTask:null,daysOffByPerson:[],endDate:S().add(6,"months").endOf("day"),scheduleItems:[],startDate:S().startOf("day"),selectedStartDate:null,selectedEndDate:null,zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.reset()},computed:{...E(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","user"]),assetMap(){return z.cache.assetMap},assetTypeMap(){return j.cache.assetTypeMap},shotMap(){return U.cache.shotMap},taskTypeMap(){return Y.cache.taskTypeMap}},methods:{...L(["editProduction","loadAggregatedPersonDaysOff","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadSequenceScheduleItems","loadShots","loadTasks","saveScheduleItem"]),loadData(){this.loading.schedule=!0,this.loadScheduleItems(this.currentProduction).then(e=>{const n=l(this.selectedStartDate),a=l(this.selectedEndDate);e=e.map(i=>{const s=this.taskTypeMap.get(i.task_type_id);let o,u;i.start_date?o=l(i.start_date):o=S(),o.isSameOrAfter(a)&&(o=a.clone().add(-1,"days")),o.isBefore(n)&&(o=n.clone()),i.end_date?u=l(i.end_date):u=o.clone().add(1,"days"),u.isSameOrAfter(a)&&(u=a.clone());const p=P(s.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,s.for_entity);return{...i,color:s.color,for_entity:s.for_entity,name:`${s.for_entity} / ${s.name}`,priority:s.priority,startDate:o,endDate:u,editable:this.isInDepartment(s),expanded:!1,loading:!1,route:s.for_entity==="Shot"&&this.isTVShow?null:p,children:[]}}),this.scheduleItems=N(e,this.currentProduction,this.taskTypeMap),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},reset(){this.currentProduction.start_date&&(this.startDate=l(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=l(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.loadData()},convertScheduleItems(e,n){return n.map(a=>{let i;a.start_date?i=l(a.start_date):i=S(),i.isBefore(this.startDate)&&(i=this.startDate.clone());let s;a.end_date?s=l(a.end_date):s=i.clone().add(1,"days"),s.isBefore(i)&&(s=i.clone().add(1,"days")),s.isAfter(this.endDate)&&(s=this.endDate.clone());const o={...a,startDate:i,endDate:s,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id)),children:[],parentElement:e};return this.isTVShow&&(o.route=P(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),o})},async expandTaskTypeElement(e,n=null){if(e.expanded=!e.expanded,e.expanded){try{e.loading=!0,e.children=[],e.people=[];const a=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,i={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)},s=await a(i);let o=this.convertScheduleItems(e,s);const u=new Map(o.map(p=>[p.object_id,p]));if(this.isTVShow)e.children=o;else{e.for_entity==="Asset"&&await this.loadAssets({withShared:!1,withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();const p=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"}),b=[...new Set(p.flatMap(t=>t.assignees))];await this.loadDaysOff(b);const y={},f={};p.forEach(t=>{var d;t.start_date&&(e.for_entity==="Asset"?(t.entity=this.assetMap.get(t.entity_id),t.entity_type_id=t.entity.asset_type_id):e.for_entity==="Shot"?(t.entity=this.shotMap.get(t.entity_id),t.entity_type_id=t.entity.sequence_id):t.entity_type_id=e.for_entity,!((d=t.entity)!=null&&d.canceled)&&(y[t.entity_type_id]||(y[t.entity_type_id]={}),t.assignees.length||(t.assignees=["unassigned"]),t.assignees.forEach(r=>{const _=u.get(t.entity_type_id),c=l(t.start_date);if(c.isAfter(this.endDate))return;c.isBefore(_.startDate)&&(_.startDate=c.clone()),t.startDate=c;let h;if(t.due_date?h=l(t.due_date):t.end_date?h=l(t.end_date):t.estimation&&(h=q(t.startDate,Math.ceil(F(this.organisation,t.estimation))-1,this.daysOffByPerson[r])),!h||h.isBefore(c)){const M=c.isoWeekday()===5?3:1;h=c.clone().add(M,"days")}if(!h.isSameOrAfter(c)){const M=c.isoWeekday()===5?3:1;h=c.clone().add(M,"days")}h.isBefore(this.startDate)||(h.isAfter(_.endDate)&&(_.endDate=h.clone()),t.endDate=h,y[t.entity_type_id][r]||(y[t.entity_type_id][r]=[],f[r]=r!=="unassigned"?{...this.personMap.get(r),daysOff:this.daysOffByPerson[r]}:{id:r,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),y[t.entity_type_id][r].push(t))})))}),e.for_entity==="Asset"&&(o=o.filter(t=>{const d=this.assetTypeMap.get(t.object_id);return d&&(!d.task_types.length||d.task_types.includes(e.task_type_id))}));const x=([t],[d])=>t==="unassigned"?1:d==="unassigned"?-1:f[t].full_name.localeCompare(f[d].full_name),O=(t,d)=>{var r,_;return(_=t.entity)==null?void 0:_.name.localeCompare((r=d.entity)==null?void 0:r.name,void 0,{numeric:!0})};o.forEach(t=>{const d=y[t.object_id]||{},r=new Map(Object.entries(d).sort(x).map(([_,c])=>[_,c.sort(O)]));t.children=r}),e.children=o,e.people=f}}catch(a){console.error(a),e.children=[],e.people=[]}finally{e.loading=!1}n&&n(e)}},async loadDaysOff(e){this.daysOffByPerson=[];for(const n of e){const a=await this.loadAggregatedPersonDaysOff({personId:n}).catch(()=>[]);this.daysOffByPerson[n]=a}},estimationChanged({item:e,days:n}){e.man_days=R(this.organisation,n),this.saveScheduleItem(e)},scheduleItemChanged(e){if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const n=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(n)&&(e.startDate=n),e.endDate.isBefore(a)&&(e.endDate=a.add(-1,"days"))}this.saveScheduleItem(e)},getMinDate(e){let n=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(n)&&(n=a.startDate)}),n.clone()},getMaxDate(e){let n=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(n)&&(n=a.endDate)}),n.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1}},watch:{selectedStartDate(){this.startDate=l(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=l(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},K={class:"columns fixed-page"},H={class:"column main-column"},J={class:"flexrow project-dates"},Q={class:"flexrow-item"},X={class:"label"},Z={class:"flexrow-item field"},$={class:"label"},k={key:0,class:"column side-column is-hidden-mobile hide-small-screen"};function ee(e,n,a,i,s,o){const u=g("date-field"),p=g("combobox-number"),b=g("schedule"),y=g("task-info");return v(),I("div",K,[D("div",H,[D("div",J,[D("div",Q,[D("label",X,w(e.$t("main.start_date")),1),m(u,{"can-delete":!1,utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":n[0]||(n[0]=f=>s.selectedStartDate=f)},null,8,["modelValue"])]),D("div",Z,[D("label",$,w(e.$t("main.end_date")),1),m(u,{"can-delete":!1,utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":n[1]||(n[1]=f=>s.selectedEndDate=f)},null,8,["modelValue"])]),m(p,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":n[2]||(n[2]=f=>s.zoomLevel=f)},null,8,["label","options","modelValue"])]),m(b,{"start-date":s.startDate,"end-date":s.endDate,hierarchy:s.scheduleItems,"zoom-level":s.zoomLevel,"is-loading":s.loading.schedule,"is-error":s.errors.schedule,"hide-man-days":!0,multiline:e.isTVShow,subchildren:!e.isTVShow,onItemChanged:o.scheduleItemChanged,onEstimationChanged:o.estimationChanged,onRootElementExpanded:o.expandTaskTypeElement},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","subchildren","onItemChanged","onEstimationChanged","onRootElementExpanded"])]),s.currentTask?(v(),I("div",k,[m(y,{task:s.currentTask,"is-loading":!1},null,8,["task"])])):W("",!0)])}const se=A(G,[["render",ee],["__scopeId","data-v-24a42683"]]);export{se as default};
//# sourceMappingURL=ProductionSchedule-BixCBpXW.js.map
