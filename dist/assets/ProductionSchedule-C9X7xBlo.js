import{_ as b,M as v,ah as I,W as y,J as P,z as u,m as x,b as M,bF as o,ca as f,cb as C,bL as V,r as h,o as m,c as p,e as i,t as _,f as c,d as E}from"./index-a83mlrHR.js";const z={name:"production-schedule",components:{ComboboxNumber:v,DateField:I,Schedule:y,TaskInfo:P},data(){return{currentTask:null,endDate:u().add(6,"months").endOf("day"),scheduleItems:[],startDate:u().startOf("day"),selectedStartDate:null,selectedEndDate:null,zoomLevel:1,zoomOptions:[{label:"Week",value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.reset()},computed:{...x(["assetTypeMap","currentEpisode","currentProduction","isCurrentUserAdmin","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","taskTypeMap","user"])},methods:{...M(["editProduction","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadSequenceScheduleItems","saveScheduleItem"]),loadData(){this.loading.schedule=!0,this.loadScheduleItems(this.currentProduction).then(e=>{const a=o(this.selectedStartDate),s=o(this.selectedEndDate);e=e.map(n=>{const t=this.taskTypeMap.get(n.task_type_id);let d,r;n.start_date?d=o(n.start_date):d=u(),d.isSameOrAfter(s)&&(d=s.clone().add(-1,"days")),d.isBefore(a)&&(d=a.clone()),n.end_date?r=o(n.end_date):r=d.clone().add(1,"days"),r.isSameOrAfter(s)&&(r=s.clone());const D=f(t.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,t.for_entity);return{...n,color:t.color,for_entity:t.for_entity,name:t.name,priority:t.priority,startDate:d,endDate:r,editable:this.isInDepartment(t),expanded:!1,loading:!1,route:t.for_entity==="Shot"&&this.isTVShow?null:D,children:[]}}),this.scheduleItems=C(e,this.currentProduction,this.taskTypeMap),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},reset(){this.currentProduction.start_date&&(this.startDate=o(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=o(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.loadData()},convertScheduleItems(e,a){return a.map(s=>{let n,t;s.start_date?n=o(s.start_date):n=u(),e&&n.isBefore(e.startDate)&&(n=e.startDate.clone()),e&&n.isAfter(e.endDate)&&(n=e.endDate.clone().add(-1,"days")),s.end_date?t=o(s.end_date):t=n.clone().add(1,"days"),t.isBefore(n)&&(t=n.clone().add(1,"days"));const d={...s,startDate:n,endDate:t,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(s.task_type_id)),children:[],parentElement:e};return this.isTVShow&&(d.route=f(s.task_type_id,this.currentProduction.id,s.object_id,e.for_entity)),d})},expandTaskTypeElement(e){const a={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)};if(e.expanded=!e.expanded,e.expanded){e.loading=!0;let s="loadAssetTypeScheduleItems";e.for_entity==="Shot"&&(this.isTVShow?s="loadEpisodeScheduleItems":s="loadSequenceScheduleItems"),this[s](a).then(n=>{e.loading=!1,e.children=this.convertScheduleItems(e,n)}).catch(n=>{console.error(n),e.loading=!1,e.children=[]})}},estimationChanged({item:e,days:a}){e.man_days=V(this.organisation,a),this.saveScheduleItem(e)},scheduleItemChanged(e){if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const a=this.getMinDate(e),s=this.getMaxDate(e);e.startDate.isAfter(a)&&(e.startDate=a),e.endDate.isBefore(s)&&(e.endDate=s.add(-1,"days"))}this.saveScheduleItem(e)},getMinDate(e){let a=this.endDate.clone();return e.children.forEach(s=>{s.startDate&&s.startDate.isBefore(a)&&(a=s.startDate)}),a.clone()},getMaxDate(e){let a=this.startDate.clone();return e.children.forEach(s=>{s.endDate&&s.endDate.isAfter(a)&&(a=s.endDate)}),a.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1}},watch:{selectedStartDate(){this.startDate=o(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=o(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},k={class:"columns fixed-page"},w={class:"column main-column"},A={class:"flexrow project-dates"},T={class:"flexrow-item"},B={class:"label"},U={class:"flexrow-item field"},Y={class:"label"},O={key:0,class:"column side-column is-hidden-mobile hide-small-screen"};function L(e,a,s,n,t,d){const r=h("date-field"),D=h("combobox-number"),S=h("schedule"),g=h("task-info");return m(),p("div",k,[i("div",w,[i("div",A,[i("div",T,[i("label",B,_(e.$t("main.start_date")),1),c(r,{modelValue:t.selectedStartDate,"onUpdate:modelValue":a[0]||(a[0]=l=>t.selectedStartDate=l)},null,8,["modelValue"])]),i("div",U,[i("label",Y,_(e.$t("main.end_date")),1),c(r,{modelValue:t.selectedEndDate,"onUpdate:modelValue":a[1]||(a[1]=l=>t.selectedEndDate=l)},null,8,["modelValue"])]),c(D,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:t.zoomOptions,modelValue:t.zoomLevel,"onUpdate:modelValue":a[2]||(a[2]=l=>t.zoomLevel=l)},null,8,["label","options","modelValue"])]),c(S,{"start-date":t.startDate,"end-date":t.endDate,hierarchy:t.scheduleItems,"zoom-level":t.zoomLevel,"is-loading":t.loading.schedule,"is-error":t.errors.schedule,"hide-man-days":!0,onItemChanged:d.scheduleItemChanged,onEstimationChanged:d.estimationChanged,onRootElementExpanded:d.expandTaskTypeElement},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","onItemChanged","onEstimationChanged","onRootElementExpanded"])]),t.currentTask?(m(),p("div",O,[c(g,{task:t.currentTask,"is-loading":!1},null,8,["task"])])):E("",!0)])}const j=b(z,[["render",L],["__scopeId","data-v-3ecbcd28"]]);export{j as default};
//# sourceMappingURL=ProductionSchedule-C9X7xBlo.js.map
