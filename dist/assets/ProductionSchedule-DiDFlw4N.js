import{ci as W,cj as ne,ck as q,c0 as Q,cl as B,aL as X,cm as ie,k as M,o as c,w as ae,e as u,f as h,ai as z,d as S,b as Z,ac as J,af as le,ad as oe,_ as de,m as re,a as ce,bR as ue,cd as he,u as me,Q as pe,aF as fe,aE as ge,ao as ye,ak as _e,cn as De,K as ve,Z as Se,$ as ke,aG as be,b7 as Ve,B as Te,r as v,c as m,t as b,F as x,g as A,G as N,a7 as we,bJ as D,bQ as U,co as O,cp as Pe,A as C,cq as j,a3 as Ee,cr as R,cs as Me,M as Ie,ct as xe,bZ as G,cu as Ce,a2 as H,aH as K,bP as Ye}from"./index-BYDZMa76.js";import{B as Ae}from"./BaseModal-BUx2WK_X.js";/**
 * @license lucide-vue-next v0.533.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Be=W("grip-vertical",[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]]);/**
 * @license lucide-vue-next v0.533.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Oe=W("list-restart",[["path",{d:"M21 6H3",key:"1jwq7v"}],["path",{d:"M7 12H3",key:"13ou7f"}],["path",{d:"M7 18H3",key:"1sijw9"}],["path",{d:"M12 18a5 5 0 0 0 9-3 4.5 4.5 0 0 0-4.5-4.5c-1.33 0-2.54.54-3.41 1.41L11 14",key:"qth677"}],["path",{d:"M11 10v4h4",key:"172dkj"}]]),Ue={__name:"EditScheduleVersionModal",props:{isError:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},scheduleVersionToEdit:{type:Object,required:!0},version:{type:String,required:!0},versionOptions:{type:Array,required:!0}},emits:["cancel","confirm"],setup(e,{emit:t}){const a=e,o=t,{t:s}=ne(),n=q({id:null,name:"",locked:"false",version:a.version||""}),d=q({name:!1}),k=Q(null),I=Q(null),f=B(()=>!!a.scheduleVersionToEdit?.id),V=B(()=>!!n.name&&!d.name),_=B(()=>f.value?s("schedule.edit_version"):s("schedule.create_version")),T=B(()=>[{label:s("schedule.fields.new"),value:"new",separator:!0},{label:`${s("schedule.versions.from")} ${s("schedule.versions.reference")}`,value:"ref",separator:!0},...a.versionOptions.filter(i=>!i.canceled).sort(X.firstBy("created_at")).map(i=>({label:`${s("schedule.versions.from")} ${i.name}`,value:i.id}))]);function w(i){if(d.name=!1,!i||a.scheduleVersionToEdit.name===i)return;a.versionOptions.map(y=>y.name).includes(i)&&(d.name=!0)}function P(){if(!V.value)return;const i={id:a.scheduleVersionToEdit.id??null,name:n.name,locked:n.locked==="true",version:n.version};o("confirm",i)}return ie(()=>{n.id=a.scheduleVersionToEdit.id||null,n.name=a.scheduleVersionToEdit.name||"",n.locked=a.scheduleVersionToEdit.locked?"true":"false",n.version=a.version||"new",f.value?I.value?.focus():k.value?.focus()}),(i,r)=>(c(),M(Ae,{active:"",title:_.value,onCancel:r[5]||(r[5]=y=>i.$emit("cancel"))},{default:ae(()=>[u("form",{onSubmit:r[3]||(r[3]=z(()=>{},["prevent"]))},[f.value?S("",!0):(c(),M(Z,{key:0,ref_key:"versionCombobox",ref:k,label:i.$t("schedule.fields.create_from_version"),options:T.value,modelValue:n.version,"onUpdate:modelValue":r[0]||(r[0]=y=>n.version=y)},null,8,["label","options","modelValue"])),h(J,{ref_key:"nameField",ref:I,label:i.$t("schedule.fields.name"),"error-text":i.$t("schedule.edit_version_exist"),errored:d.name,maxlength:20,onEnter:P,"onUpdate:modelValue":[w,r[1]||(r[1]=y=>n.name=y)],modelValue:n.name,modelModifiers:{trim:!0}},null,8,["label","error-text","errored","modelValue"]),f.value?(c(),M(le,{key:1,label:i.$t("schedule.fields.locked"),modelValue:n.locked,"onUpdate:modelValue":r[2]||(r[2]=y=>n.locked=y)},null,8,["label","modelValue"])):S("",!0)],32),h(oe,{"error-text":i.$t("schedule.edit_version_error"),"is-error":e.isError,"is-loading":e.isLoading,"is-disabled":!V.value,onConfirm:P,onCancel:r[4]||(r[4]=y=>i.$emit("cancel"))},null,8,["error-text","is-error","is-loading","is-disabled"])]),_:1},8,["title"]))}},je={name:"production-schedule",components:{ButtonSimple:Te,Checkbox:Ve,ChevronDownIcon:be,ChevronRightIcon:ke,Combobox:Z,ComboboxNumber:Se,ComboboxTaskType:ve,ConfirmModal:De,DateField:_e,EditScheduleVersionModal:Ue,GripVerticalIcon:Be,HardDeleteModal:ye,ListRestartIcon:Oe,PeopleAvatar:ge,PeopleName:fe,Schedule:pe,Spinner:me,TrashIcon:he,TextField:J,XIcon:ue},data(){return{assignments:{assigned:!1,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1},availableTaskTypes:[],daysOffByPerson:[],draggedEntities:[],endDate:C().add(6,"months").endOf("day"),isSidePanelOpen:!1,scheduleItems:[],startDate:C().startOf("day"),selectedStartDate:null,selectedEndDate:null,selectedTaskType:null,zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],mode:"prev",modeOptions:[{label:this.$t("schedule.mode_prev"),value:"prev"},{label:this.$t("schedule.mode_real"),value:"real"}],scheduleVersionToEdit:{},version:"ref",loading:{schedule:!1,editScheduleVersion:!1,applyScheduleVersion:!1},errors:{schedule:!1,editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1},modals:{editScheduleVersion:!1,deleteScheduleVersion:!1,applyScheduleVersion:!1}}},mounted(){this.reset()},computed:{...ce(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","productionAssetTypes","scheduleVersions","user"]),estimatedDailyQuota(){const e=K(this.assignments.startDate),t=K(this.assignments.endDate),a=Ye(e,t),o=this.draggedEntities.reduce((n,d)=>n+(d.children?.length??0),0),s=this.availablePersons.length;return a&&s?o/a/s:0},assetMap(){return H.cache.assetMap},assets(){return H.cache.assets},assetTypeMap(){return Ce.cache.assetTypeMap},availablePersons(){const e=this.taskTypeMap.get(this.selectedTaskType.task_type_id);return this.team.filter(t=>!this.assignments.excludes.includes(t.id)&&t.role!=="client"&&(["admin","manager"].includes(t.role)||!t.departments.length||t.departments.includes(e?.department_id)))},currentVersion(){return this.scheduleVersions.find(e=>e.id===this.version)},hasDraggedEntities(){return this.draggedEntities.some(e=>e.children.length)},isLockedSchedule(){return this.mode==="real"||this.currentVersion?.locked||!this.isCurrentUserManager},shotMap(){return G.cache.shotMap},shots(){return G.cache.shots},taskTypeMap(){return xe.cache.taskTypeMap},team(){return Ie(this.currentProduction.team.map(e=>this.personMap.get(e)).filter(e=>e&&!e.is_bot))},isVersioned(){return this.mode==="prev"&&this.version!=="ref"},versionOptions(){const e=this.scheduleVersions.filter(o=>!o.canceled).sort(X.firstBy("created_at")).map(o=>({label:o.locked?`${o.name} (${this.$t("schedule.versions.locked")})`:o.name,value:o.id})),t=this.scheduleVersions.find(o=>o.id===this.currentProduction.from_schedule_version_id);return[{label:t?`${this.$t("schedule.versions.reference")} (${this.$t("schedule.versions.from")} ${t.name})`:this.$t("schedule.versions.reference"),value:"ref",separator:!0},...e]}},methods:{...re(["applyScheduleVersionToProduction","assignSelectedTasks","createScheduleVersion","createScheduleVersionedTask","deleteScheduleVersion","editProduction","loadAggregatedPersonDaysOff","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadScheduleVersions","loadSequenceScheduleItems","loadShots","loadTasks","loadTasksFromScheduleVersion","saveScheduleItem","unassignPersonFromTask","unassignSelectedTasks","updateScheduleVersion","updateScheduleVersionedTask","updateTask"]),async loadData(){return this.loading.schedule=!0,this.availableTaskTypes=[],await this.loadScheduleVersions(),this.loadScheduleItems(this.currentProduction).then(e=>{const t=D(this.selectedStartDate),a=D(this.selectedEndDate);e=e.map(o=>{const s=this.taskTypeMap.get(o.task_type_id);let n,d;o.start_date?n=D(o.start_date):n=C(),n.isSameOrAfter(a)&&(n=a.clone().add(-1,"days")),n.isBefore(t)&&(n=t.clone()),o.end_date?d=D(o.end_date):d=n.clone().add(1,"days"),d.isSameOrAfter(a)&&(d=a.clone());const k=R(s.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,s.for_entity);return{...o,color:s.color,for_entity:s.for_entity,name:`${s.for_entity} / ${s.name}`,priority:s.priority,startDate:n,endDate:d,editable:this.isInDepartment(s)&&!this.isLockedSchedule,expanded:!1,loading:!1,route:s.for_entity==="Shot"&&this.isTVShow?null:k,children:[]}}),this.scheduleItems=Me(e,this.currentProduction,this.taskTypeMap),this.availableTaskTypes=this.scheduleItems.map(o=>({...this.taskTypeMap.get(o.task_type_id),name:o.name})),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},async reset(){this.closeSidePanel(),this.currentProduction.start_date&&(this.startDate=D(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=D(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.version="ref",await this.loadData()},convertScheduleItems(e,t){return t.map(a=>{let o;a.start_date?o=D(a.start_date):o=C(),o.isBefore(this.startDate)&&(o=this.startDate.clone()),o.isAfter(this.endDate)&&(o=this.endDate.clone());let s;a.end_date?s=D(a.end_date):s=o.clone().add(1,"days"),s.isBefore(o)&&(s=o.clone().add(1,"days")),s.isAfter(this.endDate)&&(s=this.endDate.clone());const n={...a,startDate:o,endDate:s,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id))&&!this.isLockedSchedule,children:[],parentElement:e};return this.isTVShow&&(n.route=R(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),n})},async expandTaskTypeElement(e,t=null,a=!1,o=!0){if(e.expanded=a||!e.expanded,e.expanded){try{e.loading=!0,this.selectedTaskType=this.isTVShow?null:e,this.assignments.loading=o,e.children=[],e.people={},e.entitiesByType={};const s=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,n={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)},d=await s(n);let k=this.convertScheduleItems(e,d);const I=new Map(k.map(f=>[f.object_id,f]));if(this.isTVShow)e.children=k;else{e.for_entity==="Asset"&&await this.loadAssets({withShared:!1,withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();let f=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"});if(this.isVersioned){const i=this.taskTypeMap.get(e.task_type_id),r=await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:i}),y=new Map(r.map(g=>[g.task_id,g]));f=f.map(g=>{const p=y.get(g.id);return p?.start_date?{...g,versionedTaskId:p.id,start_date:p.start_date,due_date:p.due_date,estimation:p.estimation,assignees:p.assignees}:null}).filter(Boolean)}const V=[...new Set(f.flatMap(i=>i.assignees))];await this.loadDaysOff(V);const _={},T={};f.forEach(i=>{i.start_date&&(e.for_entity==="Asset"?(i.entity=this.assetMap.get(i.entity_id),i.entity_type_id=i.entity.asset_type_id):e.for_entity==="Shot"?(i.entity=this.shotMap.get(i.entity_id),i.entity_type_id=i.entity.sequence_id):i.entity_type_id=e.for_entity,!i.entity?.canceled&&(_[i.entity_type_id]||(_[i.entity_type_id]={}),i.assignees.length||(i.assignees=["unassigned"]),i.assignees.forEach(r=>{const y=I.get(i.entity_type_id);let g;if(this.mode==="real"){if(!i.real_start_date)return;g=D(i.real_start_date)}else g=D(i.start_date);if(g.isAfter(this.endDate))return;g.isBefore(y.startDate)&&(y.startDate=g.clone()),i.startDate=g;let p;if(this.mode==="real"?p=i.done_date?D(i.done_date):C.tz():i.due_date?p=D(i.due_date):i.end_date?p=D(i.end_date):i.estimation&&(p=O(i.startDate,Math.ceil(j(this.organisation,i.estimation))-1,this.daysOffByPerson[r])),!p||p.isBefore(g)){const Y=g.isoWeekday()===5?3:1;p=g.clone().add(Y,"days")}if(!p.isSameOrAfter(g)){const Y=g.isoWeekday()===5?3:1;p=g.clone().add(Y,"days")}p.isBefore(this.startDate)||(p.isAfter(y.endDate)&&(y.endDate=p.clone()),i.endDate=p,_[i.entity_type_id][r]||(_[i.entity_type_id][r]=[],T[r]=r!=="unassigned"?{...this.personMap.get(r),daysOff:this.daysOffByPerson[r]}:{id:r,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),i.editable=!this.isLockedSchedule,i.unresizable=!1,i.parentElement=y,_[i.entity_type_id][r].push(i))})))}),e.for_entity==="Asset"&&(k=k.filter(i=>{const r=this.assetTypeMap.get(i.object_id);return r&&(!r.task_types.length||r.task_types.includes(e.task_type_id))}));const w=([i],[r])=>i==="unassigned"?1:r==="unassigned"?-1:T[i].full_name.localeCompare(T[r].full_name),P=(i,r)=>i.entity?.name.localeCompare(r.entity?.name,void 0,{numeric:!0});k.forEach(i=>{const r=_[i.object_id]||{},y=new Map(Object.entries(r).sort(w).map(([g,p])=>[g,p.sort(P)]));i.children=y}),e.children=Ee(k),e.people=T,e.entitiesByType=Object.fromEntries(Object.entries(_).map(([i,r])=>[i,Object.entries(r).flatMap(([y,g])=>y!=="unassigned"?g.map(p=>p.entity_id):void 0).filter(Boolean)]))}}catch(s){console.error(s),e.children=[],e.people=[]}finally{e.loading=!1}t&&t(e),this.selectTaskTypeElement(e,null,o)}},async loadDaysOff(e){this.daysOffByPerson=[];for(const t of e){const a=await this.loadAggregatedPersonDaysOff({personId:t}).catch(()=>[]);this.daysOffByPerson[t]=a}},filteredAssignments(e){return this.assignments.assigned?e:e.filter(t=>!t.assigned)},saveTaskChanged(e){return this.isVersioned?this.updateScheduleVersionedTask({id:e.versionedTaskId,estimation:e.estimation,startDate:e.startDate.format("YYYY-MM-DD"),dueDate:e.endDate.format("YYYY-MM-DD"),assignees:e.assignees}):this.updateTask({taskId:e.id,data:{estimation:e.estimation,start_date:e.startDate.format("YYYY-MM-DD"),due_date:e.endDate.format("YYYY-MM-DD")}})},async onScheduleItemChanged(e){if(e.type==="Task"){const t=e.assignees.flatMap(a=>this.daysOffByPerson[a]).filter(Boolean);e.startDate=O(e.startDate,0,t),e.endDate=O(e.startDate,Math.ceil(j(this.organisation,e.estimation))-1,t),e.startDate.isBefore(e.parentElement.startDate)&&(e.parentElement.startDate=e.startDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.startDate.isBefore(e.parentElement.parentElement.startDate)&&(e.parentElement.parentElement.startDate=e.parentElement.startDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),e.endDate.isAfter(e.parentElement.endDate)&&(e.parentElement.endDate=e.endDate.clone(),this.updateScheduleItem(e.parentElement),e.parentElement.endDate.isAfter(e.parentElement.parentElement.endDate)&&(e.parentElement.parentElement.endDate=e.parentElement.endDate.clone(),this.updateScheduleItem(e.parentElement.parentElement))),await this.saveTaskChanged(e);return}if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.isVersioned||this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const t=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(t)&&(e.startDate=t),e.endDate.isBefore(a)&&(e.endDate=a)}await this.updateScheduleItem(e)},async updateScheduleItem(e){const t=this.scheduleItems.find(a=>a===e);t&&(t.startDate=e.startDate,t.start_date=e.startDate.format("YYYY-MM-DD"),t.endDate=e.endDate,t.end_date=e.endDate.format("YYYY-MM-DD")),this.isVersioned||await this.saveScheduleItem(e)},getMinDate(e){let t=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(t)&&(t=a.startDate)}),t.clone()},getMaxDate(e){let t=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(t)&&(t=a.endDate)}),t.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1},scrollScheduleToToday(){this.$refs.schedule?.scrollToToday()},resetSidePanel(){this.assignments={...this.assignments,entityTypes:null,excludes:[],forcedDailyQuota:null,loading:!1,saving:!1,startDate:null,endDate:null,task:{},type:null,unassign:!1}},toggleSidePanel(){this.isSidePanelOpen&&this.assignments.type==="task"&&(this.assignments.type=null,this.isSidePanelOpen=!1),this.isSidePanelOpen=!this.isSidePanelOpen,this.isSidePanelOpen&&this.assignments.type!=="task"&&!this.assignments.entityTypes&&this.selectedTaskType&&this.selectTaskTypeElement(this.selectedTaskType)},selectParentElement(e){e.expanded?this.selectTaskTypeElement(e):this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)})},onSelectTaskType(e){this.selectedTaskType=this.scheduleItems.find(t=>t.task_type_id===e),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)},async selectTaskTypeElement(e,t=void 0,a=!0){if(this.isTVShow)return;this.selectedTaskType=e,a&&this.resetSidePanel(),this.assignments.loading=!0;const o=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"});if(e.for_entity==="Asset")await this.loadAssets({withShared:!1,withTasks:!1}),this.assignments.entityTypes=this.productionAssetTypes.filter(s=>!s.task_types.length||s.task_types.includes(e.task_type_id)).map(s=>({id:s.id,name:s.name,for_entity:e.for_entity,expanded:s.id===t?.object_id,entity_type_id:s.id,children:this.assets.filter(n=>n.asset_type_id===s.id&&!n.canceled&&!n.shared&&o.some(d=>d.entity_id===n.id)).map(n=>({...n,assigned:e.entitiesByType[s.id]?.includes(n.id)}))}));else if(e.for_entity==="Shot"){await this.loadShots();const s=this.shots.filter(n=>o.some(d=>d.entity_id===n.id)).reduce((n,d)=>(n[d.parent_id]||(n[d.parent_id]=[]),d.assigned=e.entitiesByType[d.parent_id]?.includes(d.id),n[d.parent_id].push(d),n),{});this.assignments.entityTypes=Object.keys(s).map(n=>{const d=s[n];return{id:n,name:d[0].sequence_name,for_entity:e.for_entity,expanded:n===t?.object_id,children:d}})}this.assignments.loading=!1},selectTaskElement(e,t,a,o){if(o.length!==1){this.closeSidePanel();return}this.resetSidePanel(),this.isSidePanelOpen=!0,this.selectedTaskType=e,this.draggedEntities=[{...t,children:[{...a.entity}]}],this.assignments.type="task";const s=e.start_date,n=D(s).isAfter(e.end_date)?s:e.end_date;this.assignments.startDate=s,this.assignments.endDate=n,this.assignments.task={...a,estimation:j(this.organisation,a.estimation),startDate:a.startDate.format("YYYY-MM-DD"),endDate:a.endDate.format("YYYY-MM-DD")},this.assignments.excludes=this.team.filter(d=>!a.assignees.includes(d.id)).map(d=>d.id),this.assignments.unassign=!0},closeSidePanel(){this.isSidePanelOpen=!1,this.resetSidePanel()},onAssignmentItemSelected(e){const t=C().utc().toDate();this.assignments.type="entity",this.assignments.startDate=e.start_date||t,this.assignments.endDate=e.end_date||t,e.children=this.filteredAssignments(e.children),this.draggedEntities=[e]},onAssignmentItemDragStart(e,t,a){e.stopPropagation(),e.dataTransfer.dropEffect="move",e.dataTransfer.effectAllowed="move",e.dataTransfer.setData(`task-type-${a.task_type_id}`,!0),e.dataTransfer.setData("taskTypeId",a.task_type_id),e.dataTransfer.setData("entityId",t.id),t.children=this.filteredAssignments(t.children),this.draggedEntities=[t]},onScheduleItemDropped(e,t){this.assignments.type="entity";const a=e.start_date||t.start_date,o=D(a).isAfter(t.end_date)?a:t.end_date;this.assignments.startDate=a,this.assignments.endDate=o},removeFromAssignments(e){this.assignments.excludes.push(e.id)},submitAssignments(){this.assignments.type==="entity"?this.saveAssignments():this.assignments.type==="task"&&this.saveTask()},async saveAssignments(){this.assignments.saving=!0;const e=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:this.selectedTaskType.task_type_id,relations:"true"}),a=1/(this.assignments.forcedDailyQuota??this.estimatedDailyQuota);for(const o of this.draggedEntities){const s=D(this.assignments.startDate),n=D(this.assignments.endDate);let d=0,k=0,I=s.clone();for(const f of o.children){const V=e.find(i=>i.entity_id===f.id);if(!V)continue;let _;this.isVersioned&&(_=(await this.loadTasksFromScheduleVersion({version:{id:this.version},taskType:{id:V.task_type_id}})).find(r=>r.task_id===V.id)??{taskId:V.id,version:this.version,assignees:[]},V.versionedTaskId=_.id),this.assignments.unassign&&(this.isVersioned?_.assignees=[]:await this.unassignSelectedTasks({taskIds:[V.id]})),d++;let T=I,w=null,P=null;for(;k<this.availablePersons.length;){P=this.availablePersons[k],T=O(T,0,this.daysOffByPerson[P.id]);const{due_date:i}=Pe(this.organisation,s,w,d*a,this.daysOffByPerson[P.id]);if(w=D(i),w.isAfter(n))k++,d=1,T=s.clone(),w=null;else{this.isVersioned?(_.startDate=T.format("YYYY-MM-DD"),_.dueDate=w.format("YYYY-MM-DD"),_.estimation=U(this.organisation,a),_.assignees.push(P.id),_.id?await this.updateScheduleVersionedTask(_):await this.createScheduleVersionedTask(_)):await Promise.all([this.assignSelectedTasks({personId:P.id,taskIds:[V.id]}),this.updateTask({taskId:V.id,data:{estimation:U(this.organisation,a),start_date:T.format("YYYY-MM-DD"),due_date:w.format("YYYY-MM-DD")}})]),d*a%1!==0?I=w.clone():I=w.clone().add(1,"days");break}}}this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}this.assignments.saving=!1},async saveTask(){this.assignments.saving=!0;try{const e={...this.assignments.task,startDate:D(this.assignments.task.startDate),endDate:D(this.assignments.task.endDate),estimation:U(this.organisation,this.assignments.task.estimation),assignees:this.availablePersons.map(t=>t.id)};await this.onScheduleItemChanged(e),this.isVersioned||(await this.unassignSelectedTasks({taskIds:[e.id]}),await Promise.all(e.assignees.map(t=>this.assignSelectedTasks({personId:t,taskIds:[e.id]})))),this.assignments.task.startDate=e.startDate.format("YYYY-MM-DD"),this.assignments.task.endDate=e.endDate.format("YYYY-MM-DD"),this.expandTaskTypeElement(this.selectedTaskType,()=>{this.$refs.schedule?.refreshItemPositions(this.selectedTaskType)},!0,!1)}catch(e){console.error(e)}finally{this.assignments.saving=!1}},async onScheduleItemAssigned(e,t){if(e.assignees.push(t),e.parentElement.children.get(t).push(e),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.assignSelectedTasks({personId:t,taskIds:[e.id]})},async onScheduleItemUnassigned(e,t){e.assignees=e.assignees.filter(o=>o!==t);const a=e.parentElement.children.get(t);if(a.splice(a.indexOf(e),1),this.isVersioned)return this.updateScheduleVersionedTask({id:e.versionedTaskId,assignees:e.assignees});await this.unassignPersonFromTask({person:{id:t},task:e})},onModeChanged(){this.closeSidePanel(),this.refreshSchedule()},onVersionChanged(){this.closeSidePanel(),this.refreshSchedule()},refreshSchedule(){this.scheduleItems.forEach(e=>{e.expanded&&this.expandTaskTypeElement(e,()=>{this.$refs.schedule?.refreshItemPositions(e)},!0,!1)})},openEditScheduleVersion(e={}){this.scheduleVersionToEdit=e,this.modals.editScheduleVersion=!0},openDeleteScheduleVersion(e){this.scheduleVersionToEdit=this.scheduleVersions.find(({id:t})=>t===e),this.modals.deleteScheduleVersion=!0},async editVersion(e){if(this.modals.editScheduleVersion=!1,e.id)await this.updateScheduleVersion(e);else{const t=await this.createScheduleVersion(e);this.version=t.id}this.scheduleVersionToEdit={}},async deleteVersion(e){this.modals.deleteScheduleVersion=!1,await this.deleteScheduleVersion(e),this.version===e.id&&(this.version="ref",this.onVersionChanged()),this.scheduleVersionToEdit={}},async applyToProduction(){this.loading.applyScheduleVersion=!0,this.errors.applyScheduleVersion=!1;try{await this.applyScheduleVersionToProduction(this.version),this.modals.applyScheduleVersion=!1}catch(e){console.error(e),this.errors.applyScheduleVersion=!0}finally{this.loading.applyScheduleVersion=!1}await this.loadScheduleVersions()}},watch:{selectedStartDate(){this.startDate=D(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=D(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},ze={class:"columns fixed-page"},Le={class:"column main-column"},Fe={class:"flexrow project-dates"},qe={class:"flexrow-item"},Qe={class:"flexrow-item"},Ne={key:0,class:"flexrow-item ml1"},Re={class:"label"},Ge={class:"flexrow"},He={class:"flexrow",style:{"margin-top":"23px"}},Ke={key:0,class:"column side-column"},We={class:"side"},Xe={class:"mt1"},Ze={class:"details"},Je={key:0,class:"mt2"},$e={key:1,class:"assignments parent mt1"},es=["onDragstart","onClick"],ss={class:"name"},ts=["onClick"],ns={key:0,class:"assignments children"},is=["onDragstart","onClick"],as={class:"name"},ls={key:2,class:"assignments mt1"},os={class:"flexrow"},ds={class:"flexrow-item"},rs={class:"flexrow-item"},cs={key:0},us={key:1,class:"dragged-items"},hs={class:"assignees"},ms=["title"],ps={key:0},fs={class:"has-text-centered"},gs={key:1},ys={class:"assignee"},_s={class:"person"},Ds={key:1,class:"flexrow mt2"},vs={class:"mr05"},Ss={key:2,class:"mt2"},ks={key:3,class:"flexrow mt2"},bs={class:"flexrow-item"},Vs={class:"flexrow-item"},Ts={key:4,class:"flexrow mt2"},ws={class:"mt2 has-text-right"},Ps=["disabled","text"];function Es(e,t,a,o,s,n){const d=v("date-field"),k=v("combobox-number"),I=v("combobox"),f=v("button-simple"),V=v("schedule"),_=v("x-icon"),T=v("combobox-task-type"),w=v("spinner"),P=v("grip-vertical-icon"),i=v("chevron-right-icon"),r=v("chevron-down-icon"),y=v("list-restart-icon"),g=v("people-avatar"),p=v("people-name"),Y=v("checkbox"),L=v("text-field"),$=v("trash-icon"),ee=v("edit-schedule-version-modal"),se=v("hard-delete-modal"),te=v("confirm-modal");return c(),m(x,null,[u("div",ze,[u("div",Le,[u("div",Fe,[u("div",qe,[h(d,{"can-delete":!1,label:e.$t("main.start_date"),utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":t[0]||(t[0]=l=>s.selectedStartDate=l)},null,8,["label","modelValue"])]),u("div",Qe,[h(d,{"can-delete":!1,label:e.$t("main.end_date"),utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":t[1]||(t[1]=l=>s.selectedEndDate=l)},null,8,["label","modelValue"])]),h(k,{class:"flexrow-item zoom-level nowrap",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":t[2]||(t[2]=l=>s.zoomLevel=l)},null,8,["label","options","modelValue"]),h(I,{class:"flexrow-item ml1",label:e.$t("schedule.mode"),modelValue:s.mode,"onUpdate:modelValue":[t[3]||(t[3]=l=>s.mode=l),n.onModeChanged],options:s.modeOptions},null,8,["label","modelValue","options","onUpdate:modelValue"]),s.mode==="prev"?(c(),m("div",Ne,[u("label",Re,b(e.$t("schedule.version")),1),u("div",Ge,[h(I,{class:"flexrow-item",modelValue:s.version,"onUpdate:modelValue":[t[4]||(t[4]=l=>s.version=l),n.onVersionChanged],options:n.versionOptions},null,8,["modelValue","options","onUpdate:modelValue"]),h(f,{class:"ml05",icon:"calendar-plus",title:e.$t("schedule.new_version"),onClick:t[5]||(t[5]=l=>n.openEditScheduleVersion())},null,8,["title"]),h(f,{class:"ml05",disabled:s.version==="ref",icon:"pencil",title:e.$t("schedule.edit_version"),onClick:t[6]||(t[6]=l=>n.openEditScheduleVersion(n.currentVersion))},null,8,["disabled","title"]),h(f,{class:"ml05",disabled:s.version==="ref",icon:"trash",title:e.$t("schedule.delete_version"),onClick:t[7]||(t[7]=l=>n.openDeleteScheduleVersion(s.version))},null,8,["disabled","title"])])])):S("",!0),t[29]||(t[29]=u("div",{class:"filler"},null,-1)),u("div",He,[!e.isTVShow&&s.mode==="prev"?(c(),M(f,{key:0,class:"flexrow-item",disabled:s.version==="ref",icon:"save",text:e.$t("schedule.apply_to_prod"),onClick:t[8]||(t[8]=l=>s.modals.applyScheduleVersion=!0)},null,8,["disabled","text"])):S("",!0),h(f,{class:"flexrow-item",icon:"clock",text:e.$t("schedule.today"),onClick:n.scrollScheduleToToday},null,8,["text","onClick"]),e.isTVShow?S("",!0):(c(),M(f,{key:1,active:s.isSidePanelOpen&&s.assignments.type!=="task",class:"flexrow-item",disabled:n.isLockedSchedule,icon:"list",text:e.$t("menu.assign_tasks"),onClick:n.toggleSidePanel},null,8,["active","disabled","text","onClick"]))])]),h(V,{ref:"schedule","start-date":s.startDate,"end-date":s.endDate,hierarchy:s.scheduleItems,"zoom-level":s.zoomLevel,"is-loading":s.loading.schedule,"is-error":s.errors.schedule,"is-estimation-linked":"","hide-man-days":"",multiline:e.isTVShow,reassignable:!n.isLockedSchedule,subchildren:!e.isTVShow,type:s.mode,onItemAssign:n.onScheduleItemAssigned,onItemChanged:n.onScheduleItemChanged,onItemDrop:n.onScheduleItemDropped,onItemSelected:n.selectTaskTypeElement,onItemUnassign:n.onScheduleItemUnassigned,onRootElementExpanded:n.expandTaskTypeElement,onRootElementSelected:n.selectParentElement,onTaskSelected:n.selectTaskElement,onTaskUnselected:t[9]||(t[9]=l=>n.closeSidePanel())},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","reassignable","subchildren","type","onItemAssign","onItemChanged","onItemDrop","onItemSelected","onItemUnassign","onRootElementExpanded","onRootElementSelected","onTaskSelected"])]),s.isSidePanelOpen&&!n.isLockedSchedule&&!e.isTVShow?(c(),m("div",Ke,[u("div",We,[u("a",{class:"close-button",onClick:t[10]||(t[10]=(...l)=>n.toggleSidePanel&&n.toggleSidePanel(...l))},[h(_,{class:"align-middle",size:16})]),u("h2",Xe,b(s.assignments.type==="task"?e.$t("schedule.edit_task"):e.$t("menu.assign_tasks")),1),u("div",Ze,[h(T,{class:"mb05","add-placeholder":"",placeholder:e.$t("schedule.select_task_type"),label:e.$t("news.task_type"),"task-type-list":s.availableTaskTypes,"model-value":s.selectedTaskType?.task_type_id,"onUpdate:modelValue":n.onSelectTaskType},null,8,["placeholder","label","task-type-list","model-value","onUpdate:modelValue"]),!s.assignments.loading&&s.assignments.entityTypes?.length&&!s.assignments.type?(c(),M(f,{key:0,class:"mt2 mb05",icon:"user-check","is-on":s.assignments.assigned,title:e.$t("schedule.show_assigned"),onClick:t[11]||(t[11]=l=>s.assignments.assigned=!s.assignments.assigned)},null,8,["is-on","title"])):S("",!0)]),s.assignments.loading?(c(),m("div",Je,[h(w,{class:"mauto",size:20})])):s.assignments.type?(c(),m("div",ls,[u("form",{class:"mt1",onSubmit:t[23]||(t[23]=z(l=>n.submitAssignments(),["prevent"]))},[u("div",os,[u("div",ds,[h(d,{"can-delete":!1,disabled:s.assignments.type!=="entity",label:e.$t("main.start_date"),utc:"",modelValue:s.assignments.startDate,"onUpdate:modelValue":t[12]||(t[12]=l=>s.assignments.startDate=l)},null,8,["disabled","label","modelValue"])]),u("div",rs,[h(d,{"can-delete":!1,disabled:s.assignments.type!=="entity",label:e.$t("main.end_date"),utc:"",modelValue:s.assignments.endDate,"onUpdate:modelValue":t[13]||(t[13]=l=>s.assignments.endDate=l)},null,8,["disabled","label","modelValue"])])]),(c(!0),m(x,null,A(s.draggedEntities,l=>(c(),m("div",{key:l.id},[u("div",{class:"dragged-type",style:N({background:s.selectedTaskType.color})},b(l.name),5),l.children.length?(c(),m("ul",us,[(c(!0),m(x,null,A(l.children,E=>(c(),m("li",{class:"dragged-item",key:E.id,style:N({background:`color-mix(in srgb, ${s.selectedTaskType.color} 40%, transparent)`,"border-left":`4px solid ${s.selectedTaskType.color}`})},b(l.name)+" / "+b(E.name),5))),128))])):(c(),m("div",cs,b(e.$t("schedule.no_entity")),1)),t[30]||(t[30]=u("hr",null,null,-1))]))),128)),u("table",hs,[u("thead",null,[u("tr",null,[u("td",null,[we(b(e.$t("schedule.assign"))+" ",1),s.assignments.excludes.length?(c(),m("a",{key:0,class:"reset-assignees",title:e.$t("schedule.reset_list"),onClick:t[14]||(t[14]=l=>s.assignments.excludes=[])},[h(y,{class:"align-middle",size:18,"stroke-width":1.5})],8,ms)):S("",!0)])])]),n.availablePersons.length?(c(),m("tbody",gs,[(c(!0),m(x,null,A(n.availablePersons,l=>(c(),m("tr",{key:l.id},[u("td",ys,[u("div",_s,[h(g,{"is-link":!1,"font-size":14,person:l,size:28},null,8,["person"]),h(p,{person:l},null,8,["person"])]),h(f,{class:"is-small",icon:"minus",title:e.$t("main.avatar.unassign",{personName:l.name}),type:"button",onClick:E=>n.removeFromAssignments(l)},null,8,["title","onClick"])])]))),128))])):(c(),m("tbody",ps,[u("tr",null,[u("td",fs,b(e.$t("schedule.no_assignee")),1)])]))]),s.assignments.type==="entity"?(c(),M(Y,{key:0,class:"pa05",disabled:!n.availablePersons.length,label:e.$t("schedule.force_unassign"),toggle:!0,modelValue:s.assignments.unassign,"onUpdate:modelValue":t[15]||(t[15]=l=>s.assignments.unassign=l)},null,8,["disabled","label","modelValue"])):S("",!0),s.assignments.type==="entity"?(c(),m("div",Ds,[u("label",vs,b(e.$t("schedule.forced_daily_quotas")),1),h(L,{class:"mb0 daily-quotas","input-class":" is-small",step:.01,type:"number",modelValue:s.assignments.forcedDailyQuota,"onUpdate:modelValue":t[16]||(t[16]=l=>s.assignments.forcedDailyQuota=l)},null,8,["modelValue"]),s.assignments.forcedDailyQuota?(c(),m("a",{key:0,class:"reset-quotas ml05",onClick:t[17]||(t[17]=l=>s.assignments.forcedDailyQuota=null)},[h($,{class:"align-middle",size:14})])):S("",!0)])):S("",!0),s.assignments.type==="entity"?(c(),m("div",Ss,b(e.$t("schedule.estimated_daily_quotas"))+" "+b(n.estimatedDailyQuota.toFixed(2)),1)):S("",!0),s.assignments.type==="task"?(c(),m("div",ks,[u("div",bs,[h(d,{"can-delete":!1,label:e.$t("main.start_date"),utc:"","with-margin":!1,modelValue:s.assignments.task.startDate,"onUpdate:modelValue":t[18]||(t[18]=l=>s.assignments.task.startDate=l)},null,8,["label","modelValue"])]),u("div",Vs,[h(d,{"can-delete":!1,disabled:"",label:e.$t("main.end_date"),utc:"","with-margin":!1,modelValue:s.assignments.task.endDate,"onUpdate:modelValue":t[19]||(t[19]=l=>s.assignments.task.endDate=l)},null,8,["label","modelValue"])])])):S("",!0),s.assignments.type==="task"?(c(),m("div",Ts,[h(L,{class:"mb0 estimation mr05","input-class":" thin",label:e.$t("main.estimation"),step:.01,placeholder:"0.00",type:"number","unit-label":e.$t("schedule.md"),modelValue:s.assignments.task.estimation,"onUpdate:modelValue":t[20]||(t[20]=l=>s.assignments.task.estimation=l)},null,8,["label","unit-label","modelValue"])])):S("",!0),u("div",ws,[s.assignments.type==="entity"?(c(),m(x,{key:0},[h(f,{disabled:!n.hasDraggedEntities||!n.availablePersons.length,"is-loading":s.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),u("button",{class:"button is-link ml05",disabled:s.assignments.saving,text:e.$t("main.back"),type:"button",onClick:t[21]||(t[21]=l=>s.assignments.type=null)},b(e.$t("main.back")),9,Ps)],64)):S("",!0),s.assignments.type==="task"?(c(),m(x,{key:1},[h(f,{disabled:!s.assignments.task.estimation,"is-loading":s.assignments.saving,"is-primary":"",text:e.$t("main.apply"),type:"submit"},null,8,["disabled","is-loading","text"]),u("button",{class:"button is-link ml05",onClick:t[22]||(t[22]=l=>n.closeSidePanel())},b(e.$t("main.cancel")),1)],64)):S("",!0)])],32)])):(c(),m("ul",$e,[(c(!0),m(x,null,A(s.assignments.entityTypes,l=>(c(),m("li",{key:l.id},[u("div",{class:"assignment-item",draggable:"true",onDragstart:E=>n.onAssignmentItemDragStart(E,l,s.selectedTaskType),onClick:E=>n.onAssignmentItemSelected(l)},[h(P,{class:"icon"}),u("span",ss,b(l.name)+" ("+b(n.filteredAssignments(l.children).length)+") ",1),u("span",{class:"expand",onClick:z(E=>l.expanded=!l.expanded,["stop"])},[l.expanded?(c(),M(r,{key:1})):(c(),M(i,{key:0}))],8,ts)],40,es),l.expanded?(c(),m("ul",ns,[(c(!0),m(x,null,A(n.filteredAssignments(l.children),E=>(c(),m("li",{key:E.id},[u("div",{class:"assignment-item",draggable:"true",onDragstart:F=>n.onAssignmentItemDragStart(F,{...l,children:[E]},s.selectedTaskType),onClick:F=>n.onAssignmentItemSelected({...l,children:[E]})},[h(P,{class:"icon"}),u("span",as,b(E.name),1)],40,is)]))),128))])):S("",!0)]))),128))]))])])):S("",!0)]),s.modals.editScheduleVersion?(c(),M(ee,{key:0,"schedule-version-to-edit":s.scheduleVersionToEdit,version:s.version,"version-options":e.scheduleVersions,"is-loading":s.loading.editScheduleVersion,"is-error":s.errors.editScheduleVersion,onCancel:t[24]||(t[24]=l=>s.modals.editScheduleVersion=!1),onConfirm:n.editVersion},null,8,["schedule-version-to-edit","version","version-options","is-loading","is-error","onConfirm"])):S("",!0),s.modals.deleteScheduleVersion?(c(),M(se,{key:1,active:"","error-text":e.$t("schedule.delete_version_error"),"is-loading":s.loading.delete,"is-error":s.errors.deleteScheduleVersion,"lock-text":s.scheduleVersionToEdit?.name,text:e.$t("schedule.delete_version_message"),onCancel:t[25]||(t[25]=l=>s.modals.deleteScheduleVersion=!1),onConfirm:t[26]||(t[26]=l=>n.deleteVersion(s.scheduleVersionToEdit))},null,8,["error-text","is-loading","is-error","lock-text","text"])):S("",!0),s.modals.applyScheduleVersion?(c(),M(te,{key:2,active:"",text:e.$t("schedule.apply_to_prod_confirm"),"error-text":e.$t("schedule.apply_to_prod_error"),"is-loading":s.loading.applyScheduleVersion,"is-error":s.errors.applyScheduleVersion,onCancel:t[27]||(t[27]=l=>s.modals.applyScheduleVersion=!1),onConfirm:t[28]||(t[28]=l=>n.applyToProduction())},null,8,["text","error-text","is-loading","is-error"])):S("",!0)],64)}const xs=de(je,[["render",Es],["__scopeId","data-v-07985c34"]]);export{xs as default};
//# sourceMappingURL=ProductionSchedule-DiDFlw4N.js.map
