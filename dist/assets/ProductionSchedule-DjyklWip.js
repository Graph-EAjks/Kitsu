import{_ as w,N as x,ai as O,X as V,K as A,A as S,m as B,$ as C,cd as T,bU as z,ce as E,b as U,bF as d,cf as M,cg as Y,ch as j,ci as N,bL as L,r as g,o as P,c as v,e as y,t as I,f as m,d as q}from"./index-CF4pEdXG.js";const F={name:"production-schedule",components:{ComboboxNumber:x,DateField:O,Schedule:V,TaskInfo:A},data(){return{currentTask:null,daysOffByPerson:[],endDate:S().add(6,"months").endOf("day"),scheduleItems:[],startDate:S().startOf("day"),selectedStartDate:null,selectedEndDate:null,zoomLevel:1,zoomOptions:[{label:this.$t("main.week"),value:0},{label:"1",value:1},{label:"2",value:2},{label:"3",value:3}],loading:{schedule:!1},errors:{schedule:!1}}},mounted(){this.reset()},computed:{...B(["currentEpisode","currentProduction","isCurrentUserManager","isCurrentUserSupervisor","isTVShow","organisation","personMap","user"]),assetMap(){return C.cache.assetMap},assetTypeMap(){return T.cache.assetTypeMap},shotMap(){return z.cache.shotMap},taskTypeMap(){return E.cache.taskTypeMap}},methods:{...U(["editProduction","loadAggregatedPersonDaysOff","loadAssets","loadAssetTypeScheduleItems","loadEpisodeScheduleItems","loadScheduleItems","loadSequenceScheduleItems","loadShots","loadTasks","saveScheduleItem"]),loadData(){this.loading.schedule=!0,this.loadScheduleItems(this.currentProduction).then(e=>{const n=d(this.selectedStartDate),a=d(this.selectedEndDate);e=e.map(i=>{const s=this.taskTypeMap.get(i.task_type_id);let o,r;i.start_date?o=d(i.start_date):o=S(),o.isSameOrAfter(a)&&(o=a.clone().add(-1,"days")),o.isBefore(n)&&(o=n.clone()),i.end_date?r=d(i.end_date):r=o.clone().add(1,"days"),r.isSameOrAfter(a)&&(r=a.clone());const h=M(s.id,this.currentProduction.id,this.currentEpisode?this.currentEpisode.id:null,s.for_entity);return{...i,color:s.color,for_entity:s.for_entity,name:`${s.for_entity} / ${s.name}`,priority:s.priority,startDate:o,endDate:r,editable:this.isInDepartment(s),expanded:!1,loading:!1,route:s.for_entity==="Shot"&&this.isTVShow?null:h,children:[]}}),this.scheduleItems=Y(e,this.currentProduction,this.taskTypeMap),this.loading.schedule=!1}).catch(e=>{console.error(e),this.loading.schedule=!1})},reset(){this.currentProduction.start_date&&(this.startDate=d(this.currentProduction.start_date)),this.currentProduction.end_date&&(this.endDate=d(this.currentProduction.end_date)),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate(),this.loadData()},convertScheduleItems(e,n){return n.map(a=>{let i;if(a.start_date?i=d(a.start_date):i=S(),i.isAfter(this.endDate))return;let s;if(a.end_date?s=d(a.end_date):s=i.clone().add(1,"days"),s.isBefore(i)&&(s=i.clone().add(1,"days")),s.isBefore(this.startDate))return;const o={...a,startDate:i,endDate:s,expanded:!1,loading:!1,editable:this.isInDepartment(this.taskTypeMap.get(a.task_type_id)),children:[],parentElement:e};return this.isTVShow&&(o.route=M(a.task_type_id,this.currentProduction.id,a.object_id,e.for_entity)),o}).filter(Boolean)},async expandTaskTypeElement(e,n=null){if(e.expanded=!e.expanded,e.expanded){try{e.loading=!0,e.children=[],e.people=[];const a=this.isTVShow?["Asset","Shot"].includes(e.for_entity)?this.loadEpisodeScheduleItems:this.loadSequenceScheduleItems:e.for_entity==="Shot"?this.loadSequenceScheduleItems:this.loadAssetTypeScheduleItems,i={production:this.currentProduction,taskType:this.taskTypeMap.get(e.task_type_id)};let s=await a(i);e.for_entity==="Asset"&&(s=s.filter(r=>{const h=this.assetTypeMap.get(r.object_id);return h&&(!h.task_types.length||h.task_types.includes(e.task_type_id))}));const o=this.convertScheduleItems(e,s);if(this.isTVShow)e.children=o;else{e.for_entity==="Asset"&&await this.loadAssets({withTasks:!1}),e.for_entity==="Shot"&&await this.loadShots();const r=await this.loadTasks({project_id:this.currentProduction.id,task_type_id:e.task_type_id,relations:"true"}),h=[...new Set(r.flatMap(t=>t.assignees))];await this.loadDaysOff(h);const u={},D={};r.forEach(t=>{var p;t.start_date&&(e.for_entity==="Asset"?(t.entity=this.assetMap.get(t.entity_id),t.entity_type_id=t.entity.asset_type_id):e.for_entity==="Shot"?(t.entity=this.shotMap.get(t.entity_id),t.entity_type_id=t.entity.sequence_id):t.entity_type_id=e.for_entity,!((p=t.entity)!=null&&p.canceled)&&(u[t.entity_type_id]||(u[t.entity_type_id]={}),t.assignees.length||(t.assignees=["unassigned"]),t.assignees.forEach(l=>{const f=d(t.start_date);if(f.isAfter(this.endDate))return;t.startDate=f;let c;if(t.due_date?c=d(t.due_date):t.end_date?c=d(t.end_date):t.estimation&&(c=j(t.startDate,Math.ceil(N(this.organisation,t.estimation))-1,this.daysOffByPerson[l])),!c||c.isBefore(f)){const b=f.isoWeekday()===5?3:1;c=f.clone().add(b,"days")}if(!c.isSameOrAfter(f)){const b=f.isoWeekday()===5?3:1;c=f.clone().add(b,"days")}c.isBefore(this.startDate)||(t.endDate=c,u[t.entity_type_id][l]||(u[t.entity_type_id][l]=[],D[l]=l!=="unassigned"?{...this.personMap.get(l),daysOff:this.daysOffByPerson[l]}:{id:l,avatar:!1,color:"#888",full_name:this.$t("main.unassigned")}),u[t.entity_type_id][l].push(t))})))});const _=([t],[p])=>t==="unassigned"?1:p==="unassigned"?-1:D[t].full_name.localeCompare(D[p].full_name);o.forEach(t=>{const p=u[t.object_id]||{},l=new Map(Object.entries(p).sort(_));t.children=l}),e.children=o,e.people=D}}catch(a){console.error(a),e.children=[],e.people=[]}finally{e.loading=!1}n&&n(e)}},async loadDaysOff(e){this.daysOffByPerson=[];for(const n of e){const a=await this.loadAggregatedPersonDaysOff({personId:n}).catch(()=>[]);this.daysOffByPerson[n]=a}},estimationChanged({item:e,days:n}){e.man_days=L(this.organisation,n),this.saveScheduleItem(e)},scheduleItemChanged(e){if(e.startDate&&e.endDate&&e.parentElement)e.parentElement.startDate=this.getMinDate(e.parentElement),e.parentElement.endDate=this.getMaxDate(e.parentElement),this.saveScheduleItem(e.parentElement);else if(!e.parentElement){const n=this.getMinDate(e),a=this.getMaxDate(e);e.startDate.isAfter(n)&&(e.startDate=n),e.endDate.isBefore(a)&&(e.endDate=a.add(-1,"days"))}this.saveScheduleItem(e)},getMinDate(e){let n=this.endDate.clone();return e.children.forEach(a=>{a.startDate&&a.startDate.isBefore(n)&&(n=a.startDate)}),n.clone()},getMaxDate(e){let n=this.startDate.clone();return e.children.forEach(a=>{a.endDate&&a.endDate.isAfter(n)&&(n=a.endDate)}),n.clone()},isInDepartment(e){return this.isCurrentUserManager?!0:this.isCurrentUserSupervisor?this.user.departments.length===0?!0:e.department_id&&this.user.departments.includes(e.department_id):!1}},watch:{selectedStartDate(){this.startDate=d(this.selectedStartDate);const e=this.startDate.format("YYYY-MM-DD");this.currentProduction.start_date&&this.currentProduction.start_date!==e&&this.editProduction({...this.currentProduction,start_date:e})},selectedEndDate(){this.endDate=d(this.selectedEndDate);const e=this.endDate.format("YYYY-MM-DD");this.currentProduction.end_date&&this.currentProduction.end_date!==e&&this.editProduction({...this.currentProduction,end_date:e})},currentProduction(){this.reset()}},head(){return{title:`${this.currentProduction.name} | ${this.$t("schedule.title")} - Kitsu`}}},K={class:"columns fixed-page"},R={class:"column main-column"},W={class:"flexrow project-dates"},G={class:"flexrow-item"},X={class:"label"},H={class:"flexrow-item field"},J={class:"label"},Q={key:0,class:"column side-column is-hidden-mobile hide-small-screen"};function Z(e,n,a,i,s,o){const r=g("date-field"),h=g("combobox-number"),u=g("schedule"),D=g("task-info");return P(),v("div",K,[y("div",R,[y("div",W,[y("div",G,[y("label",X,I(e.$t("main.start_date")),1),m(r,{"can-delete":!1,utc:"",modelValue:s.selectedStartDate,"onUpdate:modelValue":n[0]||(n[0]=_=>s.selectedStartDate=_)},null,8,["modelValue"])]),y("div",H,[y("label",J,I(e.$t("main.end_date")),1),m(r,{"can-delete":!1,utc:"",modelValue:s.selectedEndDate,"onUpdate:modelValue":n[1]||(n[1]=_=>s.selectedEndDate=_)},null,8,["modelValue"])]),m(h,{class:"flexrow-item zoom-level",label:e.$t("schedule.zoom_level"),options:s.zoomOptions,modelValue:s.zoomLevel,"onUpdate:modelValue":n[2]||(n[2]=_=>s.zoomLevel=_)},null,8,["label","options","modelValue"])]),m(u,{"start-date":s.startDate,"end-date":s.endDate,hierarchy:s.scheduleItems,"zoom-level":s.zoomLevel,"is-loading":s.loading.schedule,"is-error":s.errors.schedule,"hide-man-days":!0,multiline:e.isTVShow,subchildren:!e.isTVShow,onItemChanged:o.scheduleItemChanged,onEstimationChanged:o.estimationChanged,onRootElementExpanded:o.expandTaskTypeElement},null,8,["start-date","end-date","hierarchy","zoom-level","is-loading","is-error","multiline","subchildren","onItemChanged","onEstimationChanged","onRootElementExpanded"])]),s.currentTask?(P(),v("div",Q,[m(D,{task:s.currentTask,"is-loading":!1},null,8,["task"])])):q("",!0)])}const k=w(F,[["render",Z],["__scopeId","data-v-8b031103"]]);export{k as default};
//# sourceMappingURL=ProductionSchedule-DjyklWip.js.map
