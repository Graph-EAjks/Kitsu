import{ad as M,C as N,m as w,b as B,_ as S,r as u,o as a,c as r,f as d,e as s,t as l,d as m,F as I,g as E,a3 as X,aI as x,bM as G,l as v,a5 as Q,am as W,ah as Z,ae as tt,a8 as et,B as z,cb as st,ce as U,cf as L,cg as R,k as ot,a9 as it,n as A,p as g,X as j,ch as at,bk as nt,ci as rt,bA as lt,y as dt,bF as $,aB as D,a as ut,a_ as ct,G as mt,cj as H,U as pt,Y as O,a2 as ht,ck as q,cl as _t,ab as ft,w as F,H as kt,$ as C}from"./index-JuS52hil.js";import{B as yt}from"./BooleanCell-OLBmpNqU.js";import{P as bt}from"./ProductionBrief-DTbmB7ds.js";import{T as Tt}from"./TaskStatusCell-BKiIxjC7.js";import{S as vt}from"./StatusAutomationList-frpxbC4N.js";const gt={name:"production-backgrounds",components:{BooleanField:M,Combobox:N},data(){return{selectedBackgroundId:null}},computed:{...w(["backgrounds","currentProduction","productionBackgrounds"]),remainingBackgrounds(){return this.backgrounds.filter(({id:t})=>!this.currentProduction.preview_background_files.includes(t))},remainingBackgroundsOptions(){return this.remainingBackgrounds.map(t=>({label:t.name,value:t.id}))}},methods:{...B(["addBackgroundToProduction","removeBackgroundFromProduction","setDefaultBackgroundToProduction"]),addBackground(){this.addBackgroundToProduction(this.selectedBackgroundId)},removeBackground(t){this.removeBackgroundFromProduction(t)},resetSelection(){var t;this.selectedBackgroundId=((t=this.remainingBackgrounds[0])==null?void 0:t.id)||""},isGlobalDefaultBackground(t){return t.is_default&&this.isCurrentDefaultBackground(t)},isCurrentDefaultBackground(t){const e=this.currentProduction.default_preview_background_file_id;return e?t.id===e:t.is_default},setDefaultBackground(t,e){this.setDefaultBackgroundToProduction(e?t.id:null)}},watch:{remainingBackgrounds:{deep:!0,immediate:!0,handler(){this.resetSelection()}}}},Pt={class:"production-backgrounds"},wt={key:0,class:"flexrow mt1 mb1"},St={key:1,class:"box"},At={key:2,class:"datatable"},It={class:"datatable-head"},Ct={class:"name"},Dt={class:"is-default"},Vt={class:"datatable-body"},$t={class:"name"},Et={class:"flexrow"},Bt=["href"],Ft=["src","alt"],Ut={class:"is-default"},Lt=["onClick"];function Rt(t,e,n,_,i,o){var y,p;const k=u("combobox"),b=u("boolean-field");return a(),r("div",Pt,[(y=o.remainingBackgrounds)!=null&&y.length?(a(),r("div",wt,[d(k,{class:"flexrow-item mb0",options:o.remainingBackgroundsOptions,modelValue:i.selectedBackgroundId,"onUpdate:modelValue":e[0]||(e[0]=f=>i.selectedBackgroundId=f)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...f)=>o.addBackground&&o.addBackground(...f))},l(t.$t("main.add")),1)])):m("",!0),(p=t.currentProduction.preview_background_files)!=null&&p.length?(a(),r("table",At,[s("thead",It,[s("tr",null,[s("th",Ct,l(t.$t("backgrounds.fields.name")),1),s("th",Dt,l(t.$t("backgrounds.fields.is_default")),1),e[2]||(e[2]=s("th",{class:"actions"},null,-1))])]),s("tbody",Vt,[(a(!0),r(I,null,E(t.productionBackgrounds,f=>(a(),r("tr",{class:"datatable-row",key:f.id},[s("td",$t,[s("span",Et,[s("a",{class:"thumbnail-wrapper thumbnail-picture entity-thumbnail flexrow-item",href:f.url,target:"_blank"},[s("img",{src:f.thumbnail,alt:f.name,width:"100",height:"67"},null,8,Ft)],8,Bt),X(" "+l(f.name),1)])]),s("td",Ut,[d(b,{class:"ml05 mb0",disabled:o.isGlobalDefaultBackground(f),label:t.$t("backgrounds.fields.is_default"),"model-value":String(o.isCurrentDefaultBackground(f)),onClick:P=>o.setDefaultBackground(f,P==="true")},null,8,["disabled","label","model-value","onClick"])]),s("td",null,[s("button",{class:"button",onClick:P=>o.removeBackground(f.id)},l(t.$t("main.remove")),9,Lt)])]))),128))])])):(a(),r("div",St,l(t.$t("settings.production.empty_list")),1))])}const Ot=S(gt,[["render",Rt],["__scopeId","data-v-3d68c5bb"]]),qt={name:"production-board",components:{BooleanField:M,ValidationTag:x},data(){return{availableRoles:["user","vendor","supervisor","manager","admin"]}},computed:{...w(["currentProduction","productionTaskStatuses"]),sortedProductionTaskStatuses(){return G([...this.productionTaskStatuses],this.currentProduction)}},methods:{...B(["editTaskStatusLink","loadContext"]),getActiveRoles(t){var e;return((e=this.currentProduction.task_statuses_link[t.id])==null?void 0:e.roles_for_board)||[]},isActiveRole(t,e){return this.getActiveRoles(t).includes(e)},async updateRolesForBoard(t,e,n=!0){const _=[...this.getActiveRoles(t)];e.forEach(o=>{n&&!this.isActiveRole(t,o)?_.push(o):!n&&this.isActiveRole(t,o)&&_.splice(_.indexOf(o),1)});const i={...this.currentProduction.task_statuses_link[t.id],roles_for_board:_,project_id:this.currentProduction.id,task_status_id:t.id};await this.editTaskStatusLink(i),await this.loadContext()}}},Mt={class:"production-board"},Nt={key:0,class:"box"},xt={key:1,class:"datatable"},Gt={class:"th-name"},zt={class:"th-short-name"},jt={class:"th-roles"},Ht={class:"datatable-body"},Jt={class:"name"},Yt={class:"roles"},Kt=["onClick"],Xt=["onClick"];function Qt(t,e,n,_,i,o){var y;const k=u("validation-tag"),b=u("boolean-field");return a(),r("div",Mt,[(y=t.currentProduction.task_statuses)!=null&&y.length?(a(),r("table",xt,[s("thead",null,[s("tr",null,[s("th",Gt,l(t.$t("task_status.fields.name")),1),s("th",zt,l(t.$t("task_status.fields.short_name")),1),s("th",jt,l(t.$t("board.settings.visible")),1)])]),s("tbody",Ht,[(a(!0),r(I,null,E(o.sortedProductionTaskStatuses,p=>(a(),r(I,null,[p?(a(),r("tr",{class:"datatable-row task-status",key:p.id},[s("td",null,l(p.name),1),s("td",Jt,[d(k,{"is-static":!0,task:{task_status_id:p.id}},null,8,["task"])]),s("td",Yt,[(a(!0),r(I,null,E(i.availableRoles,f=>(a(),v(b,{class:"role-field",key:`${p.id}-${f}`,label:t.$t(`people.role.${f}`),"model-value":String(o.isActiveRole(p,f)),onClick:P=>o.updateRolesForBoard(p,[f],P==="true")},null,8,["label","model-value","onClick"]))),128)),o.getActiveRoles(p).length<i.availableRoles.length?(a(),r("button",{key:0,class:"button",onClick:f=>o.updateRolesForBoard(p,i.availableRoles)},l(t.$t("board.settings.select_all")),9,Kt)):(a(),r("button",{key:1,class:"button",onClick:f=>o.updateRolesForBoard(p,i.availableRoles,!1)},l(t.$t("board.settings.unselect_all")),9,Xt))])])):m("",!0)],64))),256))])])):(a(),r("div",Nt,l(t.$t("settings.production.empty_list")),1))])}const Wt=S(qt,[["render",Qt],["__scopeId","data-v-c258ff92"]]),Zt={name:"production-parameters",components:{ComboboxBoolean:Q,ComboboxStyled:W,DateField:Z,FileUpload:tt,TextField:et,ButtonSimple:z},emits:["confirm"],data(){return{formData:null,isLoading:!1,isError:!1,isLocalTVShow:!1,productionTypeOptions:st,homepageOptions:U,form:{name:"",code:"",start_date:new Date,end_date:new Date,nb_episodes:0,episode_span:0,fps:"",max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",ratio:"",resolution:"",production_type:"short"}}},computed:{...w(["currentProduction","productionAvatarFormData","isTVShow"])},mounted(){this.resetForm()},watch:{currentProduction:{handler(){this.resetForm(),this.updateTvShowRelatedDatas(this.isTVShow)},deep:!0},"form.production_type"(t){this.updateTvShowRelatedDatas(t==="tvshow")}},methods:{...B(["editProduction","storeProductionPicture","uploadProductionAvatar"]),onFileSelected(t){this.formData=t,this.storeProductionPicture(t)},isEmpty(t){return!t||t.length===0},runConfirmation(){this.$emit("confirm",this.form)},updateTvShowRelatedDatas(t){this.isLocalTVShow=t,t&&this.currentProduction?(this.form.nb_episodes=this.currentProduction.nb_episodes,this.form.episode_span=this.currentProduction.episode_span):(this.form.nb_episodes=0,this.form.episode_span=0)},resetForm(){var t;(t=this.$refs.fileField)==null||t.reset(),this.storeProductionPicture(null),this.currentProduction?this.form={name:this.currentProduction.name,code:this.currentProduction.code,start_date:L(this.currentProduction.start_date).toDate(),end_date:L(this.currentProduction.end_date).toDate(),production_type:this.currentProduction.production_type||"short",episode_span:this.currentProduction.episode_span,fps:this.currentProduction.fps,max_retakes:this.currentProduction.max_retakes,nb_episodes:this.currentProduction.nb_episodes,is_clients_isolated:this.currentProduction.is_clients_isolated?"true":"false",is_preview_download_allowed:this.currentProduction.is_preview_download_allowed?"true":"false",is_set_preview_automated:this.currentProduction.is_set_preview_automated?"true":"false",is_publish_default_for_artists:this.currentProduction.is_publish_default_for_artists?"true":"false",ratio:this.currentProduction.ratio,resolution:this.currentProduction.resolution,homepage:this.currentProduction.homepage}:this.form={name:"",code:"",start_date:new Date,end_date:new Date,production_type:"short",nb_episodes:0,episode_span:0,max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",fps:"",ratio:"",resolution:"",homepage:U[0].value}},async editParameters(){this.isLoading=!0,this.isError=!1;try{this.productionAvatarFormData&&await this.uploadProductionAvatar(this.currentProduction.id),await this.editProduction({...this.form,id:this.currentProduction.id,start_date:R(this.form.start_date),end_date:R(this.form.end_date)})}catch{this.isError=!0}this.isLoading=!1}}},te={class:"columns"},ee={class:"column is-one-third box"},se={class:"columns"},oe={class:"mr1"},ie={key:9},ae={class:"label"},ne={key:10,class:"error mt1"},re={class:"has-text-right mt2"};function le(t,e,n,_,i,o){const k=u("text-field"),b=u("date-field"),y=u("combobox-styled"),p=u("combobox-boolean"),f=u("file-upload"),P=u("button-simple"),T=ot("focus");return a(),r("div",te,[s("div",ee,[s("form",{class:"form",onSubmit:e[14]||(e[14]=it(()=>{},["prevent"]))},[A(d(k,{label:t.$t("productions.fields.name"),onEnter:o.runConfirmation,modelValue:i.form.name,"onUpdate:modelValue":e[0]||(e[0]=c=>i.form.name=c)},null,8,["label","onEnter","modelValue"]),[[T]]),d(k,{label:t.$t("productions.fields.code"),onEnter:o.runConfirmation,modelValue:i.form.code,"onUpdate:modelValue":e[1]||(e[1]=c=>i.form.code=c)},null,8,["label","onEnter","modelValue"]),s("div",se,[s("div",oe,[d(b,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.start_date"),"max-date":i.form.end_date,"with-margin":!1,modelValue:i.form.start_date,"onUpdate:modelValue":e[2]||(e[2]=c=>i.form.start_date=c)},null,8,["label","max-date","modelValue"])]),s("div",null,[d(b,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.end_date"),"min-date":i.form.start_date,"with-margin":!1,modelValue:i.form.end_date,"onUpdate:modelValue":e[3]||(e[3]=c=>i.form.end_date=c)},null,8,["label","min-date","modelValue"])])]),d(y,{class:"mb2","locale-key-prefix":"productions.type.",label:t.$t("productions.fields.type"),options:i.productionTypeOptions,onEnter:o.runConfirmation,modelValue:i.form.production_type,"onUpdate:modelValue":e[4]||(e[4]=c=>i.form.production_type=c)},null,8,["label","options","onEnter","modelValue"]),t.currentProduction&&t.currentProduction.id?(a(),v(y,{key:0,class:"mb2","locale-key-prefix":"productions.homepage.",label:t.$t("productions.fields.homepage"),options:i.homepageOptions,onEnter:o.runConfirmation,modelValue:i.form.homepage,"onUpdate:modelValue":e[5]||(e[5]=c=>i.form.homepage=c)},null,8,["label","options","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(k,{key:1,type:"number",max:60,step:.001,label:t.$t("productions.fields.fps"),onEnter:o.runConfirmation,modelValue:i.form.fps,"onUpdate:modelValue":e[6]||(e[6]=c=>i.form.fps=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(k,{key:2,label:t.$t("productions.fields.ratio"),onEnter:o.runConfirmation,modelValue:i.form.ratio,"onUpdate:modelValue":e[7]||(e[7]=c=>i.form.ratio=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(k,{key:3,label:t.$t("productions.fields.resolution"),onEnter:o.runConfirmation,modelValue:i.form.resolution,"onUpdate:modelValue":e[8]||(e[8]=c=>i.form.resolution=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(p,{key:4,label:t.$t("productions.fields.is_clients_isolated"),onEnter:o.runConfirmation,modelValue:i.form.is_clients_isolated,"onUpdate:modelValue":e[9]||(e[9]=c=>i.form.is_clients_isolated=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(p,{key:5,label:t.$t("productions.fields.is_preview_download_allowed"),onEnter:o.runConfirmation,modelValue:i.form.is_preview_download_allowed,"onUpdate:modelValue":e[10]||(e[10]=c=>i.form.is_preview_download_allowed=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(p,{key:6,label:t.$t("productions.fields.is_set_preview_automated"),onEnter:o.runConfirmation,modelValue:i.form.is_set_preview_automated,"onUpdate:modelValue":e[11]||(e[11]=c=>i.form.is_set_preview_automated=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(p,{key:7,label:t.$t("productions.fields.is_publish_default"),onEnter:o.runConfirmation,modelValue:i.form.is_publish_default_for_artists,"onUpdate:modelValue":e[12]||(e[12]=c=>i.form.is_publish_default_for_artists=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),v(k,{key:8,type:"number",step:1,label:t.$t("productions.fields.max_retakes"),onEnter:o.runConfirmation,modelValue:i.form.max_retakes,"onUpdate:modelValue":e[13]||(e[13]=c=>i.form.max_retakes=c)},null,8,["label","onEnter","modelValue"])):m("",!0),t.currentProduction&&t.currentProduction.id?(a(),r("div",ie,[s("label",ae,l(t.$t("productions.picture")),1),d(f,{ref:"fileField","is-primary":!1,label:t.$t("main.csv.upload_file"),onFileselected:o.onFileSelected,accept:".png,.jpg,.jpeg"},null,8,["label","onFileselected"])])):m("",!0),i.isError?(a(),r("p",ne,l(t.$t("productions.edit_error")),1)):m("",!0),s("div",re,[d(P,{"is-primary":!0,class:g({"is-loading":i.isLoading}),disabled:i.isLoading,text:t.$t("main.save"),onClick:o.editParameters},null,8,["class","disabled","text","onClick"])])],32)])])}const de=S(Zt,[["render",le],["__scopeId","data-v-2784be8e"]]),ue={name:"status-automation-item",components:{TaskStatusCell:Tt,TaskTypeName:j},props:{statusAutomation:{type:Object,default:null},productionId:{type:String,default:null},deletable:{type:Boolean,default:!1}},computed:{...w(["isCurrentUserClient","getTaskStatus","getTaskType"]),statusAutomationPath(){const t={name:"status-automation",params:{production_id:this.productionId,status_automation_id:this.statusAutomation.id,type:at(this.statusAutomation.for_entity)}};return(this.statusAutomation.episode_id||this.$route.params.episode_id)&&(t.name="episode-status-automation",t.params.episode_id=this.statusAutomation.episode_id||this.$route.params.episode_id),t}}},ce={class:"status-automation flexrow"},me={class:"flexrow-item entity-type"},pe={class:"in-task-type flexrow-item"},he={class:"in-task-status flexrow-item"},_e={class:"flexrow-item trigger-type"},fe={class:"out-task-type flexrow-item"},ke={key:0,class:"flexrow-item"},ye={class:"out-task-status flexrow-item"};function be(t,e,n,_,i,o){const k=u("task-type-name"),b=u("task-status-cell");return a(),r("div",ce,[s("span",me,l(n.statusAutomation.entity_type),1),s("span",pe,[d(k,{class:"in-task-type flexrow-item","task-type":t.getTaskType(n.statusAutomation.in_task_type_id)},null,8,["task-type"])]),s("span",he,[n.statusAutomation.in_field_type!=="ready_for"?(a(),v(b,{key:0,entry:t.getTaskStatus(n.statusAutomation.in_task_status_id)},null,8,["entry"])):m("",!0)]),s("span",_e," changes "+l(n.statusAutomation.out_field_type==="ready_for"?"ready for to":"task status for"),1),s("span",fe,[d(k,{"task-type":t.getTaskType(n.statusAutomation.out_task_type_id)},null,8,["task-type"])]),n.statusAutomation.out_field_type==="status"?(a(),r("span",ke," to ")):m("",!0),s("span",ye,[n.statusAutomation.out_field_type==="status"?(a(),v(b,{key:0,entry:t.getTaskStatus(n.statusAutomation.out_task_status_id)},null,8,["entry"])):m("",!0)])])}const Te=S(ue,[["render",be],["__scopeId","data-v-37b59f3a"]]),ve={name:"combobox-status-automation",components:{ChevronDownIcon:nt,ComboboxMask:rt,StatusAutomationItem:Te},emits:["update:modelValue"],data(){return{showStatusAutomationsList:!1}},props:{label:{default:"",type:String},statusAutomationsList:{default:()=>[],type:Array},modelValue:{default:"",type:String},narrow:{default:!1,type:Boolean},withMargin:{default:!0,type:Boolean},addPlaceholder:{default:!1,type:Boolean}},mounted(){this.selectedStatusAutomation=this.statusAutomation},computed:{...w(["isDarkTheme","statusAutomationMap"]),currentStatusAutomation(){return this.modelValue?this.statusAutomationMap.get(this.modelValue):this.addPlaceholder?{short_name:"+ status",color:"#999"}:this.statusAutomationsList[0]}},methods:{selectStatusAutomation(t){this.$emit("update:modelValue",t.id),this.showStatusAutomationsList=!1},backgroundColor(t){return(!t||t.is_default)&&!this.isDarkTheme?"#ECECEC":(!t||t.is_default)&&this.isDarkTheme?"#5F626A":this.isDarkTheme?lt.darkenColor(t.color):t.color},color(t){return!t||!t.is_default||this.isDarkTheme?"white":"#333"},toggleStatusAutomationsList(){this.showStatusAutomationsList=!this.showStatusAutomationsList}}},ge={key:0,class:"label"},Pe={class:"status-automation-combo"},we={class:"selected-status-automation-line flexrow-item"},Se={key:0,class:"select-input",ref:"select"},Ae=["onClick"];function Ie(t,e,n,_,i,o){const k=u("status-automation-item"),b=u("chevron-down-icon"),y=u("combobox-mask");return a(),r("div",{class:g({field:n.withMargin,"field--narrow":n.narrow})},[n.label.length>0?(a(),r("label",ge,l(n.label),1)):m("",!0),s("div",Pe,[s("div",{class:"flexrow",onClick:e[0]||(e[0]=(...p)=>o.toggleStatusAutomationsList&&o.toggleStatusAutomationsList(...p))},[s("div",we,[o.currentStatusAutomation?(a(),v(k,{key:0,"status-automation":o.currentStatusAutomation},null,8,["status-automation"])):m("",!0)]),d(b,{class:"down-icon flexrow-item"})]),i.showStatusAutomationsList?(a(),r("div",Se,[(a(!0),r(I,null,E(n.statusAutomationsList,p=>(a(),r("div",{class:"status-automation-line",key:p.id,onClick:f=>o.selectStatusAutomation(p)},[p?(a(),v(k,{key:0,"status-automation":p},null,8,["status-automation"])):m("",!0)],8,Ae))),128))],512)):m("",!0)]),d(y,{displayed:i.showStatusAutomationsList,onClick:o.toggleStatusAutomationsList},null,8,["displayed","onClick"])],2)}const Ce=S(ve,[["render",Ie],["__scopeId","data-v-d5d44aae"]]),De={name:"production-status-automations",components:{ComboboxStatusAutomation:Ce,StatusAutomationList:vt},data(){return{statusAutomations:[],statusAutomationId:""}},mounted(){this.remainingStatusAutomations.length>0&&(this.statusAutomationId=this.remainingStatusAutomations[0].id)},computed:{...w(["currentProduction","productionStatusAutomations","statusAutomationMap","remainingStatusAutomations"])},methods:{...B(["addStatusAutomationToProduction"]),isEmpty(t){return!t||t.length===0},addStatusAutomation(){this.addStatusAutomationToProduction(this.statusAutomationId),this.remainingStatusAutomations.length>0?this.statusAutomationId=this.remainingStatusAutomations[0].id:this.statusAutomationId=""}}},Ve={class:"columns"},$e={class:"column"},Ee={key:0,class:"flexrow mt1 mb1 add-status-automation"},Be={key:1,class:"box"};function Fe(t,e,n,_,i,o){const k=u("combobox-status-automation"),b=u("status-automation-list");return a(),r("div",Ve,[s("div",$e,[t.remainingStatusAutomations.length>0?(a(),r(I,{key:0},[t.remainingStatusAutomations?(a(),r("div",Ee,[d(k,{class:"flexrow-item selector","status-automations-list":t.remainingStatusAutomations,modelValue:i.statusAutomationId,"onUpdate:modelValue":e[0]||(e[0]=y=>i.statusAutomationId=y)},null,8,["status-automations-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...y)=>o.addStatusAutomation&&o.addStatusAutomation(...y))},l(t.$t("main.add")),1)])):m("",!0)],64)):m("",!0),o.isEmpty(t.productionStatusAutomations)?(a(),r("div",Be,l(t.$t("settings.production.empty_automation_list")),1)):m("",!0),o.isEmpty(t.productionStatusAutomations)?m("",!0):(a(),v(b,{key:2,entries:t.productionStatusAutomations},null,8,["entries"]))])])}const Ue=S(De,[["render",Fe],["__scopeId","data-v-f177d5cf"]]),Le={name:"production-task-type",components:{TaskTypeCell:dt},props:{taskType:{required:!0,type:Object},scheduleItem:{required:!0,type:Object}},emits:["date-changed","remove"],data(){return{startDate:null,endDate:null,silent:!0}},computed:{...w(["currentProduction","getTaskTypePriority"]),productionTimeRange(){return{to:$(this.currentProduction.start_date).toDate(),from:$(this.currentProduction.end_date).toDate()}},endDateTimeRange(){return{to:this.startDate,from:$(this.currentProduction.end_date).toDate()}}},mounted(){this.startDate=$(this.scheduleItem.start_date).toDate(),this.endDate=$(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})},watch:{startDate(){if(this.silent)return;const t=D(this.startDate);let e=D(this.endDate);this.silent=!0,e.isBefore(t)&&(e=t.clone().add(1,"days"),this.endDate=e.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},endDate(){if(this.silent)return;let t=D(this.startDate);const e=D(this.endDate);this.silent=!0,e.isBefore(t)&&(t=e.clone().add(-1,"days"),this.startDate=t.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},scheduleItem(){this.silent=!0,this.startDate=$(this.scheduleItem.start_date).toDate(),this.endDate=$(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})}}},Re={class:"short-name"},Oe={class:"remove"};function qe(t,e,n,_,i,o){const k=u("task-type-cell");return a(),r("tr",{class:"datatable-row",key:n.taskType.id},[d(k,{"task-type":n.taskType},null,8,["task-type"]),s("td",Re,l(n.taskType.short_name),1),s("td",Oe,[s("button",{class:"button",onClick:e[0]||(e[0]=b=>t.$emit("remove",{scheduleItem:n.scheduleItem,taskType:n.taskType}))},l(t.$t("main.remove")),1)])])}const Me=S(Le,[["render",qe],["__scopeId","data-v-31881e19"]]),Ne={name:"setting-importer",components:{ButtonSimple:z,ComboboxProduction:ut},emits:["import-from-production","import-item"],data(){return{importProductionId:null}},props:{items:{type:Array,default:()=>[]},loadingImport:{type:Boolean,default:!0}},mounted(){this.availableProductions.length>0&&(this.importProductionId=this.availableProductions[0].id)},computed:{...w(["currentProduction","openProductions"]),availableProductions(){return this.openProductions.filter(t=>t.id!==this.currentProduction.id)},sizeStyle(){return{width:this.size?this.size+"px":"auto"}}}},xe={key:0,class:"project-import flexcolumn"},Ge={key:0,class:"import-list"},ze=["onClick"],je={class:"infos mt05"};function He(t,e,n,_,i,o){const k=u("combobox-production"),b=u("button-simple");return a(),r("div",null,[o.availableProductions.length>0?(a(),r("div",xe,[d(k,{class:"flexrow-item",label:t.$t("settings.import_from_production"),"production-list":o.availableProductions,"with-margin":!1,modelValue:i.importProductionId,"onUpdate:modelValue":e[0]||(e[0]=y=>i.importProductionId=y)},null,8,["label","production-list","modelValue"]),d(b,{class:"flexrow-item mt05",disabled:!i.importProductionId,"is-loading":n.loadingImport,text:t.$t("main.import"),onClick:e[1]||(e[1]=y=>t.$emit("import-from-production",i.importProductionId))},null,8,["disabled","is-loading","text"])])):m("",!0),s("div",null,[s("p",{class:g({label:!0,mt2:o.availableProductions.length>0})},l(t.$t("settings.available_items")),3),n.items.length>0?(a(),r("div",Ge,[(a(!0),r(I,null,E(n.items,y=>(a(),r("div",{key:`unlisted-item-${y.id}`,class:"flexrow item-to-add mb05",onClick:p=>t.$emit("import-item",y)},[ct(t.$slots,"item-line",{item:y},void 0,!0)],8,ze))),128))])):m("",!0),s("p",je,l(t.$t("settings.no_more_available_items")),1)])])}const Je=S(Ne,[["render",He],["__scopeId","data-v-0afc0fce"]]),Ye={name:"production-task-types",components:{ComboboxTaskType:mt,draggable:H,ProductionTaskType:Me,RouteSectionTabs:pt,SettingImporter:Je,TaskTypeName:j},data(){return{activeTab:"assets",assetTaskTypes:{list:[]},editTaskTypes:{list:[]},episode_span:0,episodeTaskTypes:{list:[]},sequenceTaskTypes:{list:[]},shotTaskTypes:{list:[]},taskTypeId:"",loading:{import:!1,episode_span:!1,scheduleTimeUpdate:!1,scheduleTimeDelete:!1},errors:{episode_span:!1,scheduleTimeUpdate:!1,delete:!1}}},mounted(){this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.$route.query.section?this.activeTab=this.$route.query.section:this.isShotsOnly?this.activeTab="shots":this.activeTab="assets",this.resetDisplayedTaskTypes(),this.currentProduction&&(this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction).then(()=>{this.resetDisplayedTaskTypes()}).catch(t=>{console.error(t)}))},computed:{...w(["currentProduction","currentScheduleItems","getProductionTaskTypes","productionTaskTypes","productionAssetTaskTypes","productionShotTaskTypes","productionEditTaskTypes","productionSequenceTaskTypes","productionEpisodeTaskTypes","taskStatusMap","taskTypeMap","taskTypes","isTVShow"]),remainingTaskTypes(){return O(this.taskTypes.filter(t=>!this.currentProduction.task_types.includes(t.id)))},remainingTaskTypesForEntity(){return O(this.remainingTaskTypes.filter(t=>`${t.for_entity.toLowerCase()}s`===this.activeTab))},isAssetsOnly(){return this.currentProduction.production_type==="assets"},isShotsOnly(){return this.currentProduction.production_type==="shots"},taskTypeGroups(){let t=[];return this.isShotsOnly||t.push(this.assetTaskTypes),this.isAssetsOnly||(t=t.concat([this.shotTaskTypes,this.editTaskTypes,this.sequenceTaskTypes,this.episodeTaskTypes])),t},taskTypeTabs(){return[{label:this.$t("assets.title"),name:"assets"},{label:this.$t("shots.title"),name:"shots"},{label:this.$t("sequences.title"),name:"sequences"},{label:this.$t("episodes.title"),name:"episodes"},{label:this.$t("edits.title"),name:"edits"}]}},methods:{...B(["addTaskTypeToProduction","createScheduleItem","deleteScheduleItem","editProduction","editTaskTypeLink","loadAllScheduleItems","loadContext","removeTaskTypeFromProduction","saveScheduleItem"]),isEmpty(t){return!t||t.length===0},resetDisplayedTaskTypes(){["Asset","Shot","Sequence","Episode","Edit"].forEach(t=>{const e=this[`production${t}TaskTypes`];let n=ht([...e],this.currentProduction);n=n.map(_=>({taskType:_,scheduleItem:this.getScheduleItemForTaskType(_)})),this[`${t.toLowerCase()}TaskTypes`]={entity:`${t.toLowerCase()}s`,title:this.$t(`${t.toLowerCase()}s.title`),list:n}})},getScheduleItemForTaskType(t){return this.currentScheduleItems.find(n=>n.task_type_id===t.id)||{start_date:q(D()),end_date:q(D())}},async addTaskType(t){const e=t&&t.id?t.id:this.taskTypeId;await this.addTaskTypeToProduction({taskTypeId:e,priority:this.assetTaskTypes.length});try{await this.createScheduleItem({startDate:D(),endDate:D(),project_id:this.currentProduction.id,task_type_id:e})}catch(n){console.error(n)}this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async removeTaskType({taskType:t,scheduleItem:e}){this.errors.delete=!1;try{await this.removeTaskTypeFromProduction(t.id),e!==null&&(this.loading.scheduleTimeDelete=!0,await this.deleteScheduleItem(e),this.loading.scheduleTimeDelete=!1)}catch{this.errors.delete=!0,this.loading.scheduleTimeDelete=!1;return}await this.$nextTick(),this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async editEpisodeSpan(){this.loading.episode_span=!0,this.errors.episode_span=!1;try{await this.editProduction({id:this.currentProduction.id,episode_span:this.episode_span})}catch(t){this.errors.episode_span=!0,console.error(t)}this.loading.episode_span=!1},async onDateChanged(t){this.errors.scheduleTimeUpdate=!1;try{await this.saveScheduleItem(t)}catch(e){console.error(e),this.errors.scheduleTimeUpdate=!0}},async savePriorities(t){const e=new Date().getTime();this.lastCall=this.lastCall||0,e-this.lastCall>1e3&&!this.isSaving?(this.lastCall=e,this.isSaving=!0,await _t.runPromiseAsSeries(t.map(async n=>await this.editTaskTypeLink(n))),this.isSaving=!1,this.newSaveCall&&await this.savePriorities(t),setTimeout(()=>{this.$store.commit("SORT_VALIDATION_COLUMNS",this.taskTypeMap)},100)):this.newSaveCall=!0},async updatePriorities(t){const e=[];t.forEach((n,_)=>{_+=1;const i={projectId:this.currentProduction.id,taskTypeId:n.taskType.id,priority:_};e.push(i)}),await this.savePriorities(e),await this.loadContext()},async importTaskTypesFromProduction(t){this.loading.import=!0;const e=this.getProductionTaskTypes(t).filter(_=>`${_.for_entity.toLowerCase()}s`===this.activeTab),n=ft.capitalize(this.activeTab).slice(0,-1);await this[`production${n}TaskTypes`].forEach(async _=>{const i=this.getScheduleItemForTaskType(e[0]);await this.removeTaskType({taskType:_,scheduleItem:i})}),setTimeout(async()=>{await e.forEach(async _=>{await this.addTaskType(_)}),this.loading.import=!1},500)}},watch:{currentProduction:{handler(){this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction),this.resetDisplayedTaskTypes()},deep:!0},$route(){this.$route.query.section&&(this.activeTab=this.$route.query.section,this.$nextTick(()=>{this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null}))}}},Ke={class:"columns"},Xe={class:"column"},Qe={key:0,class:"flexrow mt1 mb1 add-task-type"},We=["disabled"],Ze={key:1,class:"error mt1 mb1"},ts={key:2,class:"box"},es={key:0,class:"datatable list"},ss={key:1,class:"empty"},os={class:"column"};function is(t,e,n,_,i,o){const k=u("route-section-tabs"),b=u("combobox-task-type"),y=u("production-task-type"),p=u("draggable"),f=u("task-type-name"),P=u("setting-importer");return a(),r("div",null,[s("div",null,[d(k,{class:"section-tabs","active-tab":i.activeTab,route:t.$route,tabs:o.taskTypeTabs},null,8,["active-tab","route","tabs"]),s("div",Ke,[s("div",Xe,[o.remainingTaskTypes.length>0?(a(),r("div",Qe,[d(b,{class:"flexrow-item selector","task-type-list":o.remainingTaskTypesForEntity,modelValue:i.taskTypeId,"onUpdate:modelValue":e[0]||(e[0]=T=>i.taskTypeId=T)},null,8,["task-type-list","modelValue"]),s("button",{class:"button flexrow-item",disabled:i.loading.scheduleTimeDelete,onClick:e[1]||(e[1]=(...T)=>o.addTaskType&&o.addTaskType(...T))},l(t.$t("main.add")),9,We)])):m("",!0),i.errors.delete||i.errors.scheduleTimeUpdate?(a(),r("p",Ze,l(t.$t("productions.edit_error")),1)):m("",!0),o.isEmpty(t.currentProduction.task_types)?(a(),r("div",ts,l(t.$t("settings.production.empty_list")),1)):(a(!0),r(I,{key:3},E(o.taskTypeGroups,(T,c)=>(a(),r("div",{key:c},[T.list.length>0&&T.entity===i.activeTab?(a(),r("table",es,[d(p,{class:"datatable-body","item-key":"taskType.id",tag:"tbody",onEnd:V=>o.updatePriorities(T.list),modelValue:T.list,"onUpdate:modelValue":V=>T.list=V},{item:F(({element:V})=>[d(y,{class:"task-type","task-type":V.taskType,"schedule-item":V.scheduleItem,onDateChanged:o.onDateChanged,onRemove:o.removeTaskType},null,8,["task-type","schedule-item","onDateChanged","onRemove"])]),_:2},1032,["onEnd","modelValue","onUpdate:modelValue"])])):m("",!0),T.list.length===0&&T.entity===i.activeTab?(a(),r("p",ss,l(t.$t("task_types.no_task_types")),1)):m("",!0)]))),128))]),s("div",os,[d(P,{items:o.remainingTaskTypesForEntity,"loading-import":i.loading.import,onImportFromProduction:o.importTaskTypesFromProduction,onImportItem:o.addTaskType},{"item-line":F(({item:T})=>[d(f,{class:"pointer","task-type":T},null,8,["task-type"])]),_:1},8,["items","loading-import","onImportFromProduction","onImportItem"])])])])])}const as=S(Ye,[["render",is],["__scopeId","data-v-1f19917c"]]),ns={name:"production-settings",components:{BooleanCell:yt,Combobox:N,ComboboxStatus:kt,draggable:H,ProductionBackgrounds:Ot,ProductionBoard:Wt,ProductionBrief:bt,ProductionParameters:de,ProductionStatusAutomations:Ue,ProductionTaskTypes:as,ValidationTag:x},data(){return{activeTab:"parameters",assetTypeId:"",taskStatusItems:[],taskStatusId:""}},mounted(){if(!this.isCurrentUserManager){this.$router.push({name:"not-found"});return}this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value),this.remainingTaskStatuses.length>0&&(this.taskStatusId=this.remainingTaskStatuses[0].id),this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},computed:{...w(["assetTypes","currentProduction","isCurrentUserManager","productionAssetTypes","productionTaskStatuses","taskStatus"]),remainingAssetTypes(){return this.assetTypes.filter(t=>!this.currentProduction.asset_types.includes(t.id)).map(t=>({label:t.name,value:t.id}))},remainingTaskStatuses(){return this.taskStatus.filter(t=>!this.currentProduction.task_statuses.includes(t.id)&&!t.for_concept)},sortedProductionTaskStatuses(){return G(this.productionTaskStatuses,this.currentProduction)}},methods:{...B(["addAssetTypeToProduction","addTaskStatusToProduction","editTaskStatusLink","loadContext","removeAssetTypeFromProduction","removeTaskStatusFromProduction"]),isEmpty(t){return!t||t.length===0},isActiveTab(t){return this.activeTab===t},addAssetType(){this.addAssetTypeToProduction(this.assetTypeId),this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value)},removeAssetType(t){this.removeAssetTypeFromProduction(t)},async addTaskStatus(){var t;await this.addTaskStatusToProduction(this.taskStatusId),await this.loadContext(),this.taskStatusId=(t=this.remainingTaskStatuses[0])==null?void 0:t.id},async removeTaskStatus(t){var e;await this.removeTaskStatusFromProduction(t),await this.loadContext(),this.taskStatusId=(e=this.remainingTaskStatuses[0])==null?void 0:e.id},async updateTaskStatusPriority(){await this.updateTaskStatusPriorities(this.taskStatusItems)},async updateTaskStatusPriorities(t){const e=t.map((n,_)=>({...this.currentProduction.task_statuses_link[n.id],priority:_+1,project_id:this.currentProduction.id,task_status_id:n.id}));for(const n of e)await this.editTaskStatusLink(n);await this.loadContext()}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})},sortedProductionTaskStatuses:{immediate:!0,handler(){this.taskStatusItems=JSON.parse(JSON.stringify(this.sortedProductionTaskStatuses))}}},head(){return{title:`${this.currentProduction.name} | ${this.$t("settings.title")} - Kitsu`}}},rs={class:"production-settings fixed-page"},ls={class:"wrapper"},ds={class:"tabs"},us={class:"tab"},cs={class:"tab"},ms={class:"tab"},ps={class:"flexrow mt1 mb1 add-asset-type"},hs={key:0,class:"box"},_s={key:1,class:"datatable list"},fs={class:"datatable-body"},ks={class:"name"},ys=["onClick"],bs={class:"tab"},Ts={class:"tab"},vs={key:0,class:"flexrow mt1 mb1 add-task-status"},gs={key:1,class:"box"},Ps={key:2,class:"datatable"},ws={class:"th-name"},Ss={class:"th-short-name"},As={class:"th-bool"},Is={class:"th-bool"},Cs={class:"th-bool"},Ds={class:"th-bool"},Vs={class:"datatable-row task-status"},$s={class:"name"},Es=["onClick"],Bs={class:"tab"},Fs={class:"tab"},Us={class:"tab"};function Ls(t,e,n,_,i,o){const k=u("production-parameters"),b=u("production-brief"),y=u("combobox"),p=u("production-task-types"),f=u("combobox-status"),P=u("validation-tag"),T=u("boolean-cell"),c=u("draggable"),V=u("production-board"),J=u("production-status-automations"),Y=u("production-backgrounds");return a(),r("div",rs,[s("div",ls,[s("div",ds,[s("ul",null,[s("li",{class:g({"is-active":o.isActiveTab("parameters")})},[s("a",{onClick:e[0]||(e[0]=h=>i.activeTab="parameters")},l(t.$t("productions.parameters.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("brief")})},[s("a",{onClick:e[1]||(e[1]=h=>i.activeTab="brief")},l(t.$t("productions.brief.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("taskStatus")})},[s("a",{onClick:e[2]||(e[2]=h=>i.activeTab="taskStatus")},l(t.$t("task_status.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("board")})},[s("a",{onClick:e[3]||(e[3]=h=>i.activeTab="board")},l(t.$t("board.settings.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("taskTypes")})},[s("a",{onClick:e[4]||(e[4]=h=>i.activeTab="taskTypes")},l(t.$t("task_types.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("assetTypes")})},[s("a",{onClick:e[5]||(e[5]=h=>i.activeTab="assetTypes")},l(t.$t("asset_types.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("statusAutomations")})},[s("a",{onClick:e[6]||(e[6]=h=>i.activeTab="statusAutomations")},l(t.$t("status_automations.title")),1)],2),s("li",{class:g({"is-active":o.isActiveTab("backgrounds")})},[s("a",{onClick:e[7]||(e[7]=h=>i.activeTab="backgrounds")},l(t.$t("backgrounds.title")),1)],2)])]),A(s("div",us,[d(k)],512),[[C,o.isActiveTab("parameters")]]),A(s("div",cs,[d(b)],512),[[C,o.isActiveTab("brief")]]),A(s("div",ms,[s("div",ps,[d(y,{class:"flexrow-item",options:o.remainingAssetTypes,modelValue:i.assetTypeId,"onUpdate:modelValue":e[8]||(e[8]=h=>i.assetTypeId=h)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[9]||(e[9]=(...h)=>o.addAssetType&&o.addAssetType(...h))},l(t.$t("main.add")),1)]),o.isEmpty(t.currentProduction.asset_types)?(a(),r("div",hs,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",_s,[s("tbody",fs,[(a(!0),r(I,null,E(t.productionAssetTypes,h=>(a(),r("tr",{class:"datatable-row",key:h.id},[s("td",ks,l(h.name),1),s("td",null,[s("button",{class:"button",onClick:K=>o.removeAssetType(h.id)},l(t.$t("main.remove")),9,ys)])]))),128))])]))],512),[[C,o.isActiveTab("assetTypes")]]),A(s("div",bs,[d(p)],512),[[C,o.isActiveTab("taskTypes")]]),A(s("div",Ts,[o.isEmpty(o.remainingTaskStatuses)?m("",!0):(a(),r("div",vs,[d(f,{class:"flexrow-item selector","task-status-list":o.remainingTaskStatuses,modelValue:i.taskStatusId,"onUpdate:modelValue":e[10]||(e[10]=h=>i.taskStatusId=h)},null,8,["task-status-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[11]||(e[11]=(...h)=>o.addTaskStatus&&o.addTaskStatus(...h))},l(t.$t("main.add")),1)])),o.isEmpty(t.currentProduction.task_statuses)?(a(),r("div",gs,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",Ps,[s("thead",null,[s("tr",null,[s("th",ws,l(t.$t("task_status.fields.name")),1),s("th",Ss,l(t.$t("task_status.fields.short_name")),1),s("th",As,l(t.$t("task_status.fields.is_done")),1),s("th",Is,l(t.$t("task_status.fields.is_retake")),1),s("th",Cs,l(t.$t("task_status.fields.is_artist_allowed")),1),s("th",Ds,l(t.$t("task_status.fields.is_client_allowed")),1)])]),d(c,{class:"datatable-body","item-key":"id",tag:"tbody",modelValue:i.taskStatusItems,"onUpdate:modelValue":e[12]||(e[12]=h=>i.taskStatusItems=h),onEnd:o.updateTaskStatusPriority},{item:F(({element:h})=>[s("tr",Vs,[s("td",null,l(h.name),1),s("td",$s,[d(P,{"is-static":!0,task:{task_status_id:h.id}},null,8,["task"])]),d(T,{value:h.is_done},null,8,["value"]),d(T,{value:h.is_retake},null,8,["value"]),d(T,{value:h.is_artist_allowed},null,8,["value"]),d(T,{value:h.is_client_allowed},null,8,["value"]),s("td",null,[s("button",{class:"button",onClick:K=>o.removeTaskStatus(h.id)},l(t.$t("main.remove")),9,Es)])])]),_:1},8,["modelValue","onEnd"])]))],512),[[C,o.isActiveTab("taskStatus")]]),A(s("div",Bs,[d(V)],512),[[C,o.isActiveTab("board")]]),A(s("div",Fs,[d(J)],512),[[C,o.isActiveTab("statusAutomations")]]),A(s("div",Us,[d(Y)],512),[[C,o.isActiveTab("backgrounds")]])])])}const xs=S(ns,[["render",Ls],["__scopeId","data-v-d1570b5f"]]);export{xs as default};
//# sourceMappingURL=ProductionSettings-C_kKsfIG.js.map
