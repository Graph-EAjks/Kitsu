import{_ as g,m as E,a as P,b as M,ag as N,r as c,c as r,o as a,d as p,f as u,e as s,t as l,F as S,g as $,a7 as Y,aQ as x,bO as G,k as T,B as z,ac as W,ae as X,ak as Z,ap as tt,af as et,aJ as U,aI as L,cq as R,cg as st,j as ot,ai as it,l as w,n as v,O as j,cr as at,cs as nt,aG as rt,bD as lt,q as dt,bJ as V,aB as C,C as ut,aH as ct,R as mt,ct as J,K as pt,aa as ht,cu as _t,cv as O,a6 as ft,a3 as q,w as F,J as kt,a1 as I}from"./index-DKuAAOtP.js";import{B as yt}from"./BooleanCell-DXzV7A44.js";import{P as bt}from"./ProductionBrief-Cs7vuknD.js";import{T as Tt}from"./TaskStatusCell-DaxKdM-m.js";import{S as vt}from"./StatusAutomationList-BvVNpWWs.js";const gt={name:"production-backgrounds",components:{BooleanField:N,Combobox:M},data(){return{selectedBackgroundId:null}},computed:{...P(["backgrounds","currentProduction","productionBackgrounds"]),remainingBackgrounds(){return this.backgrounds.filter(({id:t})=>!this.currentProduction.preview_background_files.includes(t))},remainingBackgroundsOptions(){return this.remainingBackgrounds.map(t=>({label:t.name,value:t.id}))}},methods:{...E(["addBackgroundToProduction","removeBackgroundFromProduction","setDefaultBackgroundToProduction"]),addBackground(){this.addBackgroundToProduction(this.selectedBackgroundId)},removeBackground(t){this.removeBackgroundFromProduction(t)},resetSelection(){this.selectedBackgroundId=this.remainingBackgrounds[0]?.id||""},isGlobalDefaultBackground(t){return t.is_default&&this.isCurrentDefaultBackground(t)},isCurrentDefaultBackground(t){const e=this.currentProduction.default_preview_background_file_id;return e?t.id===e:t.is_default},setDefaultBackground(t,e){this.setDefaultBackgroundToProduction(e?t.id:null)}},watch:{remainingBackgrounds:{deep:!0,immediate:!0,handler(){this.resetSelection()}}}},Pt={class:"production-backgrounds"},wt={key:0,class:"flexrow mt1 mb1"},St={key:1,class:"box"},At={key:2,class:"datatable"},It={class:"datatable-head"},Ct={class:"name"},Dt={class:"is-default"},Vt={class:"datatable-body"},$t={class:"name"},Et={class:"flexrow"},Bt=["href"],Ft=["src","alt"],Ut={class:"is-default"},Lt=["onClick"];function Rt(t,e,n,_,i,o){const f=c("combobox"),y=c("boolean-field");return a(),r("div",Pt,[o.remainingBackgrounds?.length?(a(),r("div",wt,[u(f,{class:"flexrow-item mb0",options:o.remainingBackgroundsOptions,modelValue:i.selectedBackgroundId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.selectedBackgroundId=d)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...d)=>o.addBackground&&o.addBackground(...d))},l(t.$t("main.add")),1)])):p("",!0),t.currentProduction.preview_background_files?.length?(a(),r("table",At,[s("thead",It,[s("tr",null,[s("th",Ct,l(t.$t("backgrounds.fields.name")),1),s("th",Dt,l(t.$t("backgrounds.fields.is_default")),1),e[2]||(e[2]=s("th",{class:"actions"},null,-1))])]),s("tbody",Vt,[(a(!0),r(S,null,$(t.productionBackgrounds,d=>(a(),r("tr",{class:"datatable-row",key:d.id},[s("td",$t,[s("span",Et,[s("a",{class:"thumbnail-wrapper thumbnail-picture entity-thumbnail flexrow-item",href:d.url,target:"_blank"},[s("img",{src:d.thumbnail,alt:d.name,width:"100",height:"67"},null,8,Ft)],8,Bt),Y(" "+l(d.name),1)])]),s("td",Ut,[u(y,{class:"ml05 mb0",disabled:o.isGlobalDefaultBackground(d),label:t.$t("backgrounds.fields.is_default"),"model-value":String(o.isCurrentDefaultBackground(d)),onClick:k=>o.setDefaultBackground(d,k==="true")},null,8,["disabled","label","model-value","onClick"])]),s("td",null,[s("button",{class:"button",onClick:k=>o.removeBackground(d.id)},l(t.$t("main.remove")),9,Lt)])]))),128))])])):(a(),r("div",St,l(t.$t("settings.production.empty_list")),1))])}const Ot=g(gt,[["render",Rt],["__scopeId","data-v-3d68c5bb"]]),qt={name:"production-board",components:{BooleanField:N,ValidationTag:x},data(){return{availableRoles:["user","vendor","supervisor","manager","admin"]}},computed:{...P(["currentProduction","productionTaskStatuses"]),sortedProductionTaskStatuses(){return G([...this.productionTaskStatuses],this.currentProduction)}},methods:{...E(["editTaskStatusLink","loadContext"]),getActiveRoles(t){return this.currentProduction.task_statuses_link[t.id]?.roles_for_board||[]},isActiveRole(t,e){return this.getActiveRoles(t).includes(e)},async updateRolesForBoard(t,e,n=!0){const _=[...this.getActiveRoles(t)];e.forEach(o=>{n&&!this.isActiveRole(t,o)?_.push(o):!n&&this.isActiveRole(t,o)&&_.splice(_.indexOf(o),1)});const i={...this.currentProduction.task_statuses_link[t.id],roles_for_board:_,project_id:this.currentProduction.id,task_status_id:t.id};await this.editTaskStatusLink(i),await this.loadContext()}}},Mt={class:"production-board"},Nt={key:0,class:"box"},xt={key:1,class:"datatable"},Gt={class:"th-name"},zt={class:"th-short-name"},jt={class:"th-roles"},Jt={class:"datatable-body"},Ht={class:"name"},Kt={class:"roles"},Qt=["onClick"],Yt=["onClick"];function Wt(t,e,n,_,i,o){const f=c("validation-tag"),y=c("boolean-field");return a(),r("div",Mt,[t.currentProduction.task_statuses?.length?(a(),r("table",xt,[s("thead",null,[s("tr",null,[s("th",Gt,l(t.$t("task_status.fields.name")),1),s("th",zt,l(t.$t("task_status.fields.short_name")),1),s("th",jt,l(t.$t("board.settings.visible")),1)])]),s("tbody",Jt,[(a(!0),r(S,null,$(o.sortedProductionTaskStatuses,d=>(a(),r(S,null,[d?(a(),r("tr",{class:"datatable-row task-status",key:d.id},[s("td",null,l(d.name),1),s("td",Ht,[u(f,{"is-static":!0,task:{task_status_id:d.id}},null,8,["task"])]),s("td",Kt,[(a(!0),r(S,null,$(i.availableRoles,k=>(a(),T(y,{class:"role-field",key:`${d.id}-${k}`,label:t.$t(`people.role.${k}`),"model-value":String(o.isActiveRole(d,k)),onClick:A=>o.updateRolesForBoard(d,[k],A==="true")},null,8,["label","model-value","onClick"]))),128)),o.getActiveRoles(d).length<i.availableRoles.length?(a(),r("button",{key:0,class:"button",onClick:k=>o.updateRolesForBoard(d,i.availableRoles)},l(t.$t("board.settings.select_all")),9,Qt)):(a(),r("button",{key:1,class:"button",onClick:k=>o.updateRolesForBoard(d,i.availableRoles,!1)},l(t.$t("board.settings.unselect_all")),9,Yt))])])):p("",!0)],64))),256))])])):(a(),r("div",Nt,l(t.$t("settings.production.empty_list")),1))])}const Xt=g(qt,[["render",Wt],["__scopeId","data-v-c258ff92"]]),Zt={name:"production-parameters",components:{ComboboxBoolean:et,ComboboxStyled:tt,DateField:Z,FileUpload:X,TextField:W,ButtonSimple:z},emits:["confirm"],data(){return{formData:null,isLoading:!1,isError:!1,isLocalTVShow:!1,productionTypeOptions:st,homepageOptions:R,form:{name:"",code:"",start_date:new Date,end_date:new Date,nb_episodes:0,episode_span:0,fps:"",max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",ratio:"",resolution:"",production_type:"short"}}},computed:{...P(["currentProduction","productionAvatarFormData","isTVShow"])},mounted(){this.resetForm()},watch:{currentProduction:{handler(){this.resetForm(),this.updateTvShowRelatedDatas(this.isTVShow)},deep:!0},"form.production_type"(t){this.updateTvShowRelatedDatas(t==="tvshow")}},methods:{...E(["editProduction","storeProductionPicture","uploadProductionAvatar"]),onFileSelected(t){this.formData=t,this.storeProductionPicture(t)},isEmpty(t){return!t||t.length===0},runConfirmation(){this.$emit("confirm",this.form)},updateTvShowRelatedDatas(t){this.isLocalTVShow=t,t&&this.currentProduction?(this.form.nb_episodes=this.currentProduction.nb_episodes,this.form.episode_span=this.currentProduction.episode_span):(this.form.nb_episodes=0,this.form.episode_span=0)},resetForm(){this.$refs.fileField?.reset(),this.storeProductionPicture(null),this.currentProduction?this.form={name:this.currentProduction.name,code:this.currentProduction.code,start_date:L(this.currentProduction.start_date).toDate(),end_date:L(this.currentProduction.end_date).toDate(),production_type:this.currentProduction.production_type||"short",episode_span:this.currentProduction.episode_span,fps:this.currentProduction.fps,max_retakes:this.currentProduction.max_retakes,nb_episodes:this.currentProduction.nb_episodes,is_clients_isolated:this.currentProduction.is_clients_isolated?"true":"false",is_preview_download_allowed:this.currentProduction.is_preview_download_allowed?"true":"false",is_set_preview_automated:this.currentProduction.is_set_preview_automated?"true":"false",is_publish_default_for_artists:this.currentProduction.is_publish_default_for_artists?"true":"false",ratio:this.currentProduction.ratio,resolution:this.currentProduction.resolution,homepage:this.currentProduction.homepage}:this.form={name:"",code:"",start_date:new Date,end_date:new Date,production_type:"short",nb_episodes:0,episode_span:0,max_retakes:0,is_clients_isolated:"false",is_preview_download_allowed:"false",is_set_preview_automated:"false",is_publish_default_for_artists:"false",fps:"",ratio:"",resolution:"",homepage:R[0].value}},async editParameters(){this.isLoading=!0,this.isError=!1;try{this.productionAvatarFormData&&await this.uploadProductionAvatar(this.currentProduction.id),await this.editProduction({...this.form,id:this.currentProduction.id,start_date:U(this.form.start_date),end_date:U(this.form.end_date)})}catch{this.isError=!0}this.isLoading=!1}}},te={class:"columns"},ee={class:"column is-one-third box"},se={class:"columns"},oe={class:"mr1"},ie={key:9},ae={class:"label"},ne={key:10,class:"error mt1"},re={class:"has-text-right mt2"};function le(t,e,n,_,i,o){const f=c("text-field"),y=c("date-field"),d=c("combobox-styled"),k=c("combobox-boolean"),A=c("file-upload"),B=c("button-simple"),b=ot("focus");return a(),r("div",te,[s("div",ee,[s("form",{class:"form",onSubmit:e[14]||(e[14]=it(()=>{},["prevent"]))},[w(u(f,{label:t.$t("productions.fields.name"),onEnter:o.runConfirmation,modelValue:i.form.name,"onUpdate:modelValue":e[0]||(e[0]=m=>i.form.name=m)},null,8,["label","onEnter","modelValue"]),[[b]]),u(f,{label:t.$t("productions.fields.code"),onEnter:o.runConfirmation,modelValue:i.form.code,"onUpdate:modelValue":e[1]||(e[1]=m=>i.form.code=m)},null,8,["label","onEnter","modelValue"]),s("div",se,[s("div",oe,[u(y,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.start_date"),"max-date":i.form.end_date,"with-margin":!1,modelValue:i.form.start_date,"onUpdate:modelValue":e[2]||(e[2]=m=>i.form.start_date=m)},null,8,["label","max-date","modelValue"])]),s("div",null,[u(y,{class:"mb0","can-delete":!1,label:t.$t("productions.fields.end_date"),"min-date":i.form.start_date,"with-margin":!1,modelValue:i.form.end_date,"onUpdate:modelValue":e[3]||(e[3]=m=>i.form.end_date=m)},null,8,["label","min-date","modelValue"])])]),u(d,{class:"mb2","locale-key-prefix":"productions.type.",label:t.$t("productions.fields.type"),options:i.productionTypeOptions,onEnter:o.runConfirmation,modelValue:i.form.production_type,"onUpdate:modelValue":e[4]||(e[4]=m=>i.form.production_type=m)},null,8,["label","options","onEnter","modelValue"]),t.currentProduction&&t.currentProduction.id?(a(),T(d,{key:0,class:"mb2","locale-key-prefix":"productions.homepage.",label:t.$t("productions.fields.homepage"),options:i.homepageOptions,onEnter:o.runConfirmation,modelValue:i.form.homepage,"onUpdate:modelValue":e[5]||(e[5]=m=>i.form.homepage=m)},null,8,["label","options","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:1,type:"number",max:60,step:.001,label:t.$t("productions.fields.fps"),onEnter:o.runConfirmation,modelValue:i.form.fps,"onUpdate:modelValue":e[6]||(e[6]=m=>i.form.fps=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:2,label:t.$t("productions.fields.ratio"),onEnter:o.runConfirmation,modelValue:i.form.ratio,"onUpdate:modelValue":e[7]||(e[7]=m=>i.form.ratio=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:3,label:t.$t("productions.fields.resolution"),onEnter:o.runConfirmation,modelValue:i.form.resolution,"onUpdate:modelValue":e[8]||(e[8]=m=>i.form.resolution=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:4,label:t.$t("productions.fields.is_clients_isolated"),onEnter:o.runConfirmation,modelValue:i.form.is_clients_isolated,"onUpdate:modelValue":e[9]||(e[9]=m=>i.form.is_clients_isolated=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:5,label:t.$t("productions.fields.is_preview_download_allowed"),onEnter:o.runConfirmation,modelValue:i.form.is_preview_download_allowed,"onUpdate:modelValue":e[10]||(e[10]=m=>i.form.is_preview_download_allowed=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:6,label:t.$t("productions.fields.is_set_preview_automated"),onEnter:o.runConfirmation,modelValue:i.form.is_set_preview_automated,"onUpdate:modelValue":e[11]||(e[11]=m=>i.form.is_set_preview_automated=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(k,{key:7,label:t.$t("productions.fields.is_publish_default"),onEnter:o.runConfirmation,modelValue:i.form.is_publish_default_for_artists,"onUpdate:modelValue":e[12]||(e[12]=m=>i.form.is_publish_default_for_artists=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),T(f,{key:8,type:"number",step:1,label:t.$t("productions.fields.max_retakes"),onEnter:o.runConfirmation,modelValue:i.form.max_retakes,"onUpdate:modelValue":e[13]||(e[13]=m=>i.form.max_retakes=m)},null,8,["label","onEnter","modelValue"])):p("",!0),t.currentProduction&&t.currentProduction.id?(a(),r("div",ie,[s("label",ae,l(t.$t("productions.picture")),1),u(A,{ref:"fileField","is-primary":!1,label:t.$t("main.csv.upload_file"),onFileselected:o.onFileSelected,accept:".png,.jpg,.jpeg"},null,8,["label","onFileselected"])])):p("",!0),i.isError?(a(),r("p",ne,l(t.$t("productions.edit_error")),1)):p("",!0),s("div",re,[u(B,{"is-primary":!0,class:v({"is-loading":i.isLoading}),disabled:i.isLoading,text:t.$t("main.save"),onClick:o.editParameters},null,8,["class","disabled","text","onClick"])])],32)])])}const de=g(Zt,[["render",le],["__scopeId","data-v-2784be8e"]]),ue={name:"status-automation-item",components:{TaskStatusCell:Tt,TaskTypeName:j},props:{statusAutomation:{type:Object,default:null},productionId:{type:String,default:null},deletable:{type:Boolean,default:!1}},computed:{...P(["isCurrentUserClient","getTaskStatus","getTaskType"]),statusAutomationPath(){const t={name:"status-automation",params:{production_id:this.productionId,status_automation_id:this.statusAutomation.id,type:at(this.statusAutomation.for_entity)}};return(this.statusAutomation.episode_id||this.$route.params.episode_id)&&(t.name="episode-status-automation",t.params.episode_id=this.statusAutomation.episode_id||this.$route.params.episode_id),t}}},ce={class:"status-automation flexrow"},me={class:"flexrow-item entity-type"},pe={class:"in-task-type flexrow-item"},he={class:"in-task-status flexrow-item"},_e={class:"flexrow-item trigger-type"},fe={class:"out-task-type flexrow-item"},ke={key:0,class:"flexrow-item"},ye={class:"out-task-status flexrow-item"};function be(t,e,n,_,i,o){const f=c("task-type-name"),y=c("task-status-cell");return a(),r("div",ce,[s("span",me,l(n.statusAutomation.entity_type),1),s("span",pe,[u(f,{class:"in-task-type flexrow-item","task-type":t.getTaskType(n.statusAutomation.in_task_type_id)},null,8,["task-type"])]),s("span",he,[n.statusAutomation.in_field_type!=="ready_for"?(a(),T(y,{key:0,entry:t.getTaskStatus(n.statusAutomation.in_task_status_id)},null,8,["entry"])):p("",!0)]),s("span",_e," changes "+l(n.statusAutomation.out_field_type==="ready_for"?"ready for to":"task status for"),1),s("span",fe,[u(f,{"task-type":t.getTaskType(n.statusAutomation.out_task_type_id)},null,8,["task-type"])]),n.statusAutomation.out_field_type==="status"?(a(),r("span",ke," to ")):p("",!0),s("span",ye,[n.statusAutomation.out_field_type==="status"?(a(),T(y,{key:0,entry:t.getTaskStatus(n.statusAutomation.out_task_status_id)},null,8,["entry"])):p("",!0)])])}const Te=g(ue,[["render",be],["__scopeId","data-v-37b59f3a"]]),ve={name:"combobox-status-automation",components:{ChevronDownIcon:rt,ComboboxMask:nt,StatusAutomationItem:Te},emits:["update:modelValue"],data(){return{showStatusAutomationsList:!1}},props:{label:{default:"",type:String},statusAutomationsList:{default:()=>[],type:Array},modelValue:{default:"",type:String},narrow:{default:!1,type:Boolean},withMargin:{default:!0,type:Boolean},addPlaceholder:{default:!1,type:Boolean}},mounted(){this.selectedStatusAutomation=this.statusAutomation},computed:{...P(["isDarkTheme","statusAutomationMap"]),currentStatusAutomation(){return this.modelValue?this.statusAutomationMap.get(this.modelValue):this.addPlaceholder?{short_name:"+ status",color:"#999"}:this.statusAutomationsList[0]}},methods:{selectStatusAutomation(t){this.$emit("update:modelValue",t.id),this.showStatusAutomationsList=!1},backgroundColor(t){return(!t||t.is_default)&&!this.isDarkTheme?"#ECECEC":(!t||t.is_default)&&this.isDarkTheme?"#5F626A":this.isDarkTheme?lt.darkenColor(t.color):t.color},color(t){return!t||!t.is_default||this.isDarkTheme?"white":"#333"},toggleStatusAutomationsList(){this.showStatusAutomationsList=!this.showStatusAutomationsList}}},ge={key:0,class:"label"},Pe={class:"status-automation-combo"},we={class:"selected-status-automation-line flexrow-item"},Se={key:0,class:"select-input",ref:"select"},Ae=["onClick"];function Ie(t,e,n,_,i,o){const f=c("status-automation-item"),y=c("chevron-down-icon"),d=c("combobox-mask");return a(),r("div",{class:v({field:n.withMargin,"field--narrow":n.narrow})},[n.label.length>0?(a(),r("label",ge,l(n.label),1)):p("",!0),s("div",Pe,[s("div",{class:"flexrow",onClick:e[0]||(e[0]=(...k)=>o.toggleStatusAutomationsList&&o.toggleStatusAutomationsList(...k))},[s("div",we,[o.currentStatusAutomation?(a(),T(f,{key:0,"status-automation":o.currentStatusAutomation},null,8,["status-automation"])):p("",!0)]),u(y,{class:"down-icon flexrow-item"})]),i.showStatusAutomationsList?(a(),r("div",Se,[(a(!0),r(S,null,$(n.statusAutomationsList,k=>(a(),r("div",{class:"status-automation-line",key:k.id,onClick:A=>o.selectStatusAutomation(k)},[k?(a(),T(f,{key:0,"status-automation":k},null,8,["status-automation"])):p("",!0)],8,Ae))),128))],512)):p("",!0)]),u(d,{displayed:i.showStatusAutomationsList,onClick:o.toggleStatusAutomationsList},null,8,["displayed","onClick"])],2)}const Ce=g(ve,[["render",Ie],["__scopeId","data-v-d5d44aae"]]),De={name:"production-status-automations",components:{ComboboxStatusAutomation:Ce,StatusAutomationList:vt},data(){return{statusAutomations:[],statusAutomationId:""}},mounted(){this.remainingStatusAutomations.length>0&&(this.statusAutomationId=this.remainingStatusAutomations[0].id)},computed:{...P(["currentProduction","productionStatusAutomations","statusAutomationMap","remainingStatusAutomations"])},methods:{...E(["addStatusAutomationToProduction"]),isEmpty(t){return!t||t.length===0},addStatusAutomation(){this.addStatusAutomationToProduction(this.statusAutomationId),this.remainingStatusAutomations.length>0?this.statusAutomationId=this.remainingStatusAutomations[0].id:this.statusAutomationId=""}}},Ve={class:"columns"},$e={class:"column"},Ee={key:0,class:"flexrow mt1 mb1 add-status-automation"},Be={key:1,class:"box"};function Fe(t,e,n,_,i,o){const f=c("combobox-status-automation"),y=c("status-automation-list");return a(),r("div",Ve,[s("div",$e,[t.remainingStatusAutomations.length>0?(a(),r(S,{key:0},[t.remainingStatusAutomations?(a(),r("div",Ee,[u(f,{class:"flexrow-item selector","status-automations-list":t.remainingStatusAutomations,modelValue:i.statusAutomationId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.statusAutomationId=d)},null,8,["status-automations-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[1]||(e[1]=(...d)=>o.addStatusAutomation&&o.addStatusAutomation(...d))},l(t.$t("main.add")),1)])):p("",!0)],64)):p("",!0),o.isEmpty(t.productionStatusAutomations)?(a(),r("div",Be,l(t.$t("settings.production.empty_automation_list")),1)):p("",!0),o.isEmpty(t.productionStatusAutomations)?p("",!0):(a(),T(y,{key:2,entries:t.productionStatusAutomations},null,8,["entries"]))])])}const Ue=g(De,[["render",Fe],["__scopeId","data-v-f177d5cf"]]),Le={name:"production-task-type",components:{TaskTypeCell:dt},props:{taskType:{required:!0,type:Object},scheduleItem:{required:!0,type:Object}},emits:["date-changed","remove"],data(){return{startDate:null,endDate:null,silent:!0}},computed:{...P(["currentProduction","getTaskTypePriority"]),productionTimeRange(){return{to:V(this.currentProduction.start_date).toDate(),from:V(this.currentProduction.end_date).toDate()}},endDateTimeRange(){return{to:this.startDate,from:V(this.currentProduction.end_date).toDate()}}},mounted(){this.startDate=V(this.scheduleItem.start_date).toDate(),this.endDate=V(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})},watch:{startDate(){if(this.silent)return;const t=C(this.startDate);let e=C(this.endDate);this.silent=!0,e.isBefore(t)&&(e=t.clone().add(1,"days"),this.endDate=e.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},endDate(){if(this.silent)return;let t=C(this.startDate);const e=C(this.endDate);this.silent=!0,e.isBefore(t)&&(t=e.clone().add(-1,"days"),this.startDate=t.toDate());const n={...this.scheduleItem};n.startDate=t,n.endDate=e,this.$emit("date-changed",n),this.$nextTick(()=>{this.silent=!1})},scheduleItem(){this.silent=!0,this.startDate=V(this.scheduleItem.start_date).toDate(),this.endDate=V(this.scheduleItem.end_date).toDate(),this.$nextTick(()=>{this.silent=!1})}}},Re={class:"short-name"},Oe={class:"remove"};function qe(t,e,n,_,i,o){const f=c("task-type-cell");return a(),r("tr",{class:"datatable-row",key:n.taskType.id},[u(f,{"task-type":n.taskType},null,8,["task-type"]),s("td",Re,l(n.taskType.short_name),1),s("td",Oe,[s("button",{class:"button",onClick:e[0]||(e[0]=y=>t.$emit("remove",{scheduleItem:n.scheduleItem,taskType:n.taskType}))},l(t.$t("main.remove")),1)])])}const Me=g(Le,[["render",qe],["__scopeId","data-v-31881e19"]]),Ne={name:"setting-importer",components:{ButtonSimple:z,ComboboxProduction:ut},emits:["import-from-production","import-item"],data(){return{importProductionId:null}},props:{items:{type:Array,default:()=>[]},loadingImport:{type:Boolean,default:!0}},mounted(){this.availableProductions.length>0&&(this.importProductionId=this.availableProductions[0].id)},computed:{...P(["currentProduction","openProductions"]),availableProductions(){return this.openProductions.filter(t=>t.id!==this.currentProduction.id)},sizeStyle(){return{width:this.size?this.size+"px":"auto"}}}},xe={key:0,class:"project-import flexcolumn"},Ge={key:0,class:"import-list"},ze=["onClick"],je={class:"infos mt05"};function Je(t,e,n,_,i,o){const f=c("combobox-production"),y=c("button-simple");return a(),r("div",null,[o.availableProductions.length>0?(a(),r("div",xe,[u(f,{class:"flexrow-item",label:t.$t("settings.import_from_production"),"production-list":o.availableProductions,"with-margin":!1,modelValue:i.importProductionId,"onUpdate:modelValue":e[0]||(e[0]=d=>i.importProductionId=d)},null,8,["label","production-list","modelValue"]),u(y,{class:"flexrow-item mt05",disabled:!i.importProductionId,"is-loading":n.loadingImport,text:t.$t("main.import"),onClick:e[1]||(e[1]=d=>t.$emit("import-from-production",i.importProductionId))},null,8,["disabled","is-loading","text"])])):p("",!0),s("div",null,[s("p",{class:v({label:!0,mt2:o.availableProductions.length>0})},l(t.$t("settings.available_items")),3),n.items.length>0?(a(),r("div",Ge,[(a(!0),r(S,null,$(n.items,d=>(a(),r("div",{key:`unlisted-item-${d.id}`,class:"flexrow item-to-add mb05",onClick:k=>t.$emit("import-item",d)},[ct(t.$slots,"item-line",{item:d},void 0,!0)],8,ze))),128))])):p("",!0),s("p",je,l(t.$t("settings.no_more_available_items")),1)])])}const He=g(Ne,[["render",Je],["__scopeId","data-v-0afc0fce"]]),Ke={name:"production-task-types",components:{ComboboxTaskType:pt,draggable:J,ProductionTaskType:Me,RouteSectionTabs:mt,SettingImporter:He,TaskTypeName:j},data(){return{activeTab:"assets",assetTaskTypes:{list:[]},editTaskTypes:{list:[]},episode_span:0,episodeTaskTypes:{list:[]},sequenceTaskTypes:{list:[]},shotTaskTypes:{list:[]},taskTypeId:"",loading:{import:!1,episode_span:!1,scheduleTimeUpdate:!1,scheduleTimeDelete:!1},errors:{episode_span:!1,scheduleTimeUpdate:!1,delete:!1}}},mounted(){this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.$route.query.section?this.activeTab=this.$route.query.section:this.isShotsOnly?this.activeTab="shots":this.activeTab="assets",this.resetDisplayedTaskTypes(),this.currentProduction&&(this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction).then(()=>{this.resetDisplayedTaskTypes()}).catch(t=>{console.error(t)}))},computed:{...P(["currentProduction","currentScheduleItems","getProductionTaskTypes","productionTaskTypes","productionAssetTaskTypes","productionShotTaskTypes","productionEditTaskTypes","productionSequenceTaskTypes","productionEpisodeTaskTypes","taskStatusMap","taskTypeMap","taskTypes","isTVShow"]),remainingTaskTypes(){return q(this.taskTypes.filter(t=>!this.currentProduction.task_types.includes(t.id)))},remainingTaskTypesForEntity(){return q(this.remainingTaskTypes.filter(t=>`${t.for_entity.toLowerCase()}s`===this.activeTab))},isAssetsOnly(){return this.currentProduction.production_type==="assets"},isShotsOnly(){return this.currentProduction.production_type==="shots"},taskTypeGroups(){let t=[];return this.isShotsOnly||t.push(this.assetTaskTypes),this.isAssetsOnly||(t=t.concat([this.shotTaskTypes,this.editTaskTypes,this.sequenceTaskTypes,this.episodeTaskTypes])),t},taskTypeTabs(){return[{label:this.$t("assets.title"),name:"assets"},{label:this.$t("shots.title"),name:"shots"},{label:this.$t("sequences.title"),name:"sequences"},{label:this.$t("episodes.title"),name:"episodes"},{label:this.$t("edits.title"),name:"edits"}]}},methods:{...E(["addTaskTypeToProduction","createScheduleItem","deleteScheduleItem","editProduction","editTaskTypeLink","loadAllScheduleItems","loadContext","removeTaskTypeFromProduction","saveScheduleItem"]),isEmpty(t){return!t||t.length===0},resetDisplayedTaskTypes(){["Asset","Shot","Sequence","Episode","Edit"].forEach(t=>{const e=this[`production${t}TaskTypes`];let n=ft([...e],this.currentProduction);n=n.map(_=>({taskType:_,scheduleItem:this.getScheduleItemForTaskType(_)})),this[`${t.toLowerCase()}TaskTypes`]={entity:`${t.toLowerCase()}s`,title:this.$t(`${t.toLowerCase()}s.title`),list:n}})},getScheduleItemForTaskType(t){return this.currentScheduleItems.find(n=>n.task_type_id===t.id)||{start_date:O(C()),end_date:O(C())}},async addTaskType(t){const e=t&&t.id?t.id:this.taskTypeId;await this.addTaskTypeToProduction({taskTypeId:e,priority:this.assetTaskTypes.length});try{await this.createScheduleItem({startDate:C(),endDate:C(),project_id:this.currentProduction.id,task_type_id:e})}catch(n){console.error(n)}this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async removeTaskType({taskType:t,scheduleItem:e}){this.errors.delete=!1;try{await this.removeTaskTypeFromProduction(t.id),e!==null&&(this.loading.scheduleTimeDelete=!0,await this.deleteScheduleItem(e),this.loading.scheduleTimeDelete=!1)}catch{this.errors.delete=!0,this.loading.scheduleTimeDelete=!1;return}await this.$nextTick(),this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null,this.resetDisplayedTaskTypes()},async editEpisodeSpan(){this.loading.episode_span=!0,this.errors.episode_span=!1;try{await this.editProduction({id:this.currentProduction.id,episode_span:this.episode_span})}catch(t){this.errors.episode_span=!0,console.error(t)}this.loading.episode_span=!1},async onDateChanged(t){this.errors.scheduleTimeUpdate=!1;try{await this.saveScheduleItem(t)}catch(e){console.error(e),this.errors.scheduleTimeUpdate=!0}},async savePriorities(t){const e=new Date().getTime();this.lastCall=this.lastCall||0,e-this.lastCall>1e3&&!this.isSaving?(this.lastCall=e,this.isSaving=!0,await _t.runPromiseAsSeries(t.map(async n=>await this.editTaskTypeLink(n))),this.isSaving=!1,this.newSaveCall&&await this.savePriorities(t),setTimeout(()=>{this.$store.commit("SORT_VALIDATION_COLUMNS",this.taskTypeMap)},100)):this.newSaveCall=!0},async updatePriorities(t){const e=[];t.forEach((n,_)=>{_+=1;const i={projectId:this.currentProduction.id,taskTypeId:n.taskType.id,priority:_};e.push(i)}),await this.savePriorities(e),await this.loadContext()},async importTaskTypesFromProduction(t){this.loading.import=!0;const e=this.getProductionTaskTypes(t).filter(_=>`${_.for_entity.toLowerCase()}s`===this.activeTab),n=ht.capitalize(this.activeTab).slice(0,-1);await this[`production${n}TaskTypes`].forEach(async _=>{const i=this.getScheduleItemForTaskType(e[0]);await this.removeTaskType({taskType:_,scheduleItem:i})}),setTimeout(async()=>{await e.forEach(async _=>{await this.addTaskType(_)}),this.loading.import=!1},500)}},watch:{currentProduction:{handler(){this.episode_span=this.currentProduction.episode_span,this.loadAllScheduleItems(this.currentProduction),this.resetDisplayedTaskTypes()},deep:!0},$route(){this.$route.query.section&&(this.activeTab=this.$route.query.section,this.$nextTick(()=>{this.remainingTaskTypesForEntity.length>0?this.taskTypeId=this.remainingTaskTypesForEntity[0].id:this.taskTypeId=null}))}}},Qe={class:"columns"},Ye={class:"column"},We={key:0,class:"flexrow mt1 mb1 add-task-type"},Xe=["disabled"],Ze={key:1,class:"error mt1 mb1"},ts={key:2,class:"box"},es={key:0,class:"datatable list"},ss={key:1,class:"empty"},os={class:"column"};function is(t,e,n,_,i,o){const f=c("route-section-tabs"),y=c("combobox-task-type"),d=c("production-task-type"),k=c("draggable"),A=c("task-type-name"),B=c("setting-importer");return a(),r("div",null,[s("div",null,[u(f,{class:"section-tabs","active-tab":i.activeTab,route:t.$route,tabs:o.taskTypeTabs},null,8,["active-tab","route","tabs"]),s("div",Qe,[s("div",Ye,[o.remainingTaskTypes.length>0?(a(),r("div",We,[u(y,{class:"flexrow-item selector","task-type-list":o.remainingTaskTypesForEntity,modelValue:i.taskTypeId,"onUpdate:modelValue":e[0]||(e[0]=b=>i.taskTypeId=b)},null,8,["task-type-list","modelValue"]),s("button",{class:"button flexrow-item",disabled:i.loading.scheduleTimeDelete,onClick:e[1]||(e[1]=(...b)=>o.addTaskType&&o.addTaskType(...b))},l(t.$t("main.add")),9,Xe)])):p("",!0),i.errors.delete||i.errors.scheduleTimeUpdate?(a(),r("p",Ze,l(t.$t("productions.edit_error")),1)):p("",!0),o.isEmpty(t.currentProduction.task_types)?(a(),r("div",ts,l(t.$t("settings.production.empty_list")),1)):(a(!0),r(S,{key:3},$(o.taskTypeGroups,(b,m)=>(a(),r("div",{key:m},[b.list.length>0&&b.entity===i.activeTab?(a(),r("table",es,[u(k,{class:"datatable-body","item-key":"taskType.id",tag:"tbody",onEnd:D=>o.updatePriorities(b.list),modelValue:b.list,"onUpdate:modelValue":D=>b.list=D},{item:F(({element:D})=>[u(d,{class:"task-type","task-type":D.taskType,"schedule-item":D.scheduleItem,onDateChanged:o.onDateChanged,onRemove:o.removeTaskType},null,8,["task-type","schedule-item","onDateChanged","onRemove"])]),_:2},1032,["onEnd","modelValue","onUpdate:modelValue"])])):p("",!0),b.list.length===0&&b.entity===i.activeTab?(a(),r("p",ss,l(t.$t("task_types.no_task_types")),1)):p("",!0)]))),128))]),s("div",os,[u(B,{items:o.remainingTaskTypesForEntity,"loading-import":i.loading.import,onImportFromProduction:o.importTaskTypesFromProduction,onImportItem:o.addTaskType},{"item-line":F(({item:b})=>[u(A,{class:"pointer","task-type":b},null,8,["task-type"])]),_:1},8,["items","loading-import","onImportFromProduction","onImportItem"])])])])])}const as=g(Ke,[["render",is],["__scopeId","data-v-1f19917c"]]),ns={name:"production-settings",components:{BooleanCell:yt,Combobox:M,ComboboxStatus:kt,draggable:J,ProductionBackgrounds:Ot,ProductionBoard:Xt,ProductionBrief:bt,ProductionParameters:de,ProductionStatusAutomations:Ue,ProductionTaskTypes:as,ValidationTag:x},data(){return{activeTab:"parameters",assetTypeId:"",taskStatusItems:[],taskStatusId:""}},mounted(){if(!this.isCurrentUserManager){this.$router.push({name:"not-found"});return}this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value),this.remainingTaskStatuses.length>0&&(this.taskStatusId=this.remainingTaskStatuses[0].id),this.$route.query.tab&&(this.activeTab=this.$route.query.tab)},computed:{...P(["assetTypes","currentProduction","isCurrentUserManager","productionAssetTypes","productionTaskStatuses","taskStatus"]),remainingAssetTypes(){return this.assetTypes.filter(t=>!this.currentProduction.asset_types.includes(t.id)).map(t=>({label:t.name,value:t.id}))},remainingTaskStatuses(){return this.taskStatus.filter(t=>!this.currentProduction.task_statuses.includes(t.id)&&!t.for_concept)},sortedProductionTaskStatuses(){return G(this.productionTaskStatuses,this.currentProduction)}},methods:{...E(["addAssetTypeToProduction","addTaskStatusToProduction","editTaskStatusLink","loadContext","removeAssetTypeFromProduction","removeTaskStatusFromProduction"]),isEmpty(t){return!t||t.length===0},isActiveTab(t){return this.activeTab===t},addAssetType(){this.addAssetTypeToProduction(this.assetTypeId),this.remainingAssetTypes.length>0&&(this.assetTypeId=this.remainingAssetTypes[0].value)},removeAssetType(t){this.removeAssetTypeFromProduction(t)},async addTaskStatus(){await this.addTaskStatusToProduction(this.taskStatusId),await this.loadContext(),this.taskStatusId=this.remainingTaskStatuses[0]?.id},async removeTaskStatus(t){await this.removeTaskStatusFromProduction(t),await this.loadContext(),this.taskStatusId=this.remainingTaskStatuses[0]?.id},async updateTaskStatusPriority(){await this.updateTaskStatusPriorities(this.taskStatusItems)},async updateTaskStatusPriorities(t){const e=t.map((n,_)=>({...this.currentProduction.task_statuses_link[n.id],priority:_+1,project_id:this.currentProduction.id,task_status_id:n.id}));for(const n of e)await this.editTaskStatusLink(n);await this.loadContext()}},watch:{activeTab(){this.$route.query.tab!==this.activeTab&&this.$router.push({query:{tab:this.activeTab}})},sortedProductionTaskStatuses:{immediate:!0,handler(){this.taskStatusItems=JSON.parse(JSON.stringify(this.sortedProductionTaskStatuses))}}},head(){return{title:`${this.currentProduction.name} | ${this.$t("settings.title")} - Kitsu`}}},rs={class:"production-settings fixed-page"},ls={class:"wrapper"},ds={class:"tabs"},us={class:"tab"},cs={class:"tab"},ms={class:"tab"},ps={class:"flexrow mt1 mb1 add-asset-type"},hs={key:0,class:"box"},_s={key:1,class:"datatable list"},fs={class:"datatable-body"},ks={class:"name"},ys=["onClick"],bs={class:"tab"},Ts={class:"tab"},vs={key:0,class:"flexrow mt1 mb1 add-task-status"},gs={key:1,class:"box"},Ps={key:2,class:"datatable"},ws={class:"th-name"},Ss={class:"th-short-name"},As={class:"th-bool"},Is={class:"th-bool"},Cs={class:"th-bool"},Ds={class:"th-bool"},Vs={class:"datatable-row task-status"},$s={class:"name"},Es=["onClick"],Bs={class:"tab"},Fs={class:"tab"},Us={class:"tab"};function Ls(t,e,n,_,i,o){const f=c("production-parameters"),y=c("production-brief"),d=c("combobox"),k=c("production-task-types"),A=c("combobox-status"),B=c("validation-tag"),b=c("boolean-cell"),m=c("draggable"),D=c("production-board"),H=c("production-status-automations"),K=c("production-backgrounds");return a(),r("div",rs,[s("div",ls,[s("div",ds,[s("ul",null,[s("li",{class:v({"is-active":o.isActiveTab("parameters")})},[s("a",{onClick:e[0]||(e[0]=h=>i.activeTab="parameters")},l(t.$t("productions.parameters.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("brief")})},[s("a",{onClick:e[1]||(e[1]=h=>i.activeTab="brief")},l(t.$t("productions.brief.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("taskStatus")})},[s("a",{onClick:e[2]||(e[2]=h=>i.activeTab="taskStatus")},l(t.$t("task_status.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("board")})},[s("a",{onClick:e[3]||(e[3]=h=>i.activeTab="board")},l(t.$t("board.settings.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("taskTypes")})},[s("a",{onClick:e[4]||(e[4]=h=>i.activeTab="taskTypes")},l(t.$t("task_types.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("assetTypes")})},[s("a",{onClick:e[5]||(e[5]=h=>i.activeTab="assetTypes")},l(t.$t("asset_types.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("statusAutomations")})},[s("a",{onClick:e[6]||(e[6]=h=>i.activeTab="statusAutomations")},l(t.$t("status_automations.title")),1)],2),s("li",{class:v({"is-active":o.isActiveTab("backgrounds")})},[s("a",{onClick:e[7]||(e[7]=h=>i.activeTab="backgrounds")},l(t.$t("backgrounds.title")),1)],2)])]),w(s("div",us,[u(f)],512),[[I,o.isActiveTab("parameters")]]),w(s("div",cs,[u(y)],512),[[I,o.isActiveTab("brief")]]),w(s("div",ms,[s("div",ps,[u(d,{class:"flexrow-item",options:o.remainingAssetTypes,modelValue:i.assetTypeId,"onUpdate:modelValue":e[8]||(e[8]=h=>i.assetTypeId=h)},null,8,["options","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[9]||(e[9]=(...h)=>o.addAssetType&&o.addAssetType(...h))},l(t.$t("main.add")),1)]),o.isEmpty(t.currentProduction.asset_types)?(a(),r("div",hs,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",_s,[s("tbody",fs,[(a(!0),r(S,null,$(t.productionAssetTypes,h=>(a(),r("tr",{class:"datatable-row",key:h.id},[s("td",ks,l(h.name),1),s("td",null,[s("button",{class:"button",onClick:Q=>o.removeAssetType(h.id)},l(t.$t("main.remove")),9,ys)])]))),128))])]))],512),[[I,o.isActiveTab("assetTypes")]]),w(s("div",bs,[u(k)],512),[[I,o.isActiveTab("taskTypes")]]),w(s("div",Ts,[o.isEmpty(o.remainingTaskStatuses)?p("",!0):(a(),r("div",vs,[u(A,{class:"flexrow-item selector","task-status-list":o.remainingTaskStatuses,modelValue:i.taskStatusId,"onUpdate:modelValue":e[10]||(e[10]=h=>i.taskStatusId=h)},null,8,["task-status-list","modelValue"]),s("button",{class:"button flexrow-item",onClick:e[11]||(e[11]=(...h)=>o.addTaskStatus&&o.addTaskStatus(...h))},l(t.$t("main.add")),1)])),o.isEmpty(t.currentProduction.task_statuses)?(a(),r("div",gs,l(t.$t("settings.production.empty_list")),1)):(a(),r("table",Ps,[s("thead",null,[s("tr",null,[s("th",ws,l(t.$t("task_status.fields.name")),1),s("th",Ss,l(t.$t("task_status.fields.short_name")),1),s("th",As,l(t.$t("task_status.fields.is_done")),1),s("th",Is,l(t.$t("task_status.fields.is_retake")),1),s("th",Cs,l(t.$t("task_status.fields.is_artist_allowed")),1),s("th",Ds,l(t.$t("task_status.fields.is_client_allowed")),1)])]),u(m,{class:"datatable-body","item-key":"id",tag:"tbody",modelValue:i.taskStatusItems,"onUpdate:modelValue":e[12]||(e[12]=h=>i.taskStatusItems=h),onEnd:o.updateTaskStatusPriority},{item:F(({element:h})=>[s("tr",Vs,[s("td",null,l(h.name),1),s("td",$s,[u(B,{"is-static":!0,task:{task_status_id:h.id}},null,8,["task"])]),u(b,{value:h.is_done},null,8,["value"]),u(b,{value:h.is_retake},null,8,["value"]),u(b,{value:h.is_artist_allowed},null,8,["value"]),u(b,{value:h.is_client_allowed},null,8,["value"]),s("td",null,[s("button",{class:"button",onClick:Q=>o.removeTaskStatus(h.id)},l(t.$t("main.remove")),9,Es)])])]),_:1},8,["modelValue","onEnd"])]))],512),[[I,o.isActiveTab("taskStatus")]]),w(s("div",Bs,[u(D)],512),[[I,o.isActiveTab("board")]]),w(s("div",Fs,[u(H)],512),[[I,o.isActiveTab("statusAutomations")]]),w(s("div",Us,[u(K)],512),[[I,o.isActiveTab("backgrounds")]])])])}const xs=g(ns,[["render",Ls],["__scopeId","data-v-d1570b5f"]]);export{xs as default};
//# sourceMappingURL=ProductionSettings-Ddkmh1OM.js.map
