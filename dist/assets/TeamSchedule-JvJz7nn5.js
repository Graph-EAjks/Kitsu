import{g as h,B as m,a1 as f,v as g,a as T,p as _,b6 as y,a8 as D,E as k,r as b,d as v,A as S,j as P,T as x,s as C,l as o,m as $,b7 as u,b as I,cm as l,bQ as n,bc as w,cn as M,co as p,ak as r,n as O}from"./index-C_9nnu8s.js";import{C as E}from"./ComboboxStudio-BF4nMUV6.js";const U={name:"team-schedule",mixins:[h],components:{ButtonSimple:m,ComboboxDepartment:f,ComboboxNumber:g,ComboboxProduction:T,ComboboxStudio:E,ComboboxTaskType:_,Datepicker:y,DepartmentName:D,EntityThumbnail:k,PeopleField:b,ProductionName:v,Schedule:S,Spinner:P,TableInfo:x,TaskInfo:C},data(){return{draggedTasks:[],endDate:o().add(3,"months"),isTaskSidePanelOpen:!1,personDates:{},scheduleItems:[],selectedDepartment:null,selectedEndDate:null,selectedPerson:null,selectedStartDate:null,selectedStudio:null,startDate:o(),unassignedTasks:[],totalUnassignedTasks:0,zoomLevel:1,zoomOptions:[{label:"1",value:1},{label:"2",value:2},{label:"3",value:3},{label:"4",value:4}],loading:{hasMoreUnassignedTasks:!1,unassignedTasks:!1},errors:{unassignedTasks:!1,schedule:!1},filters:{productionId:null,taskTypeId:null},pagination:{unassignedTasks:1}}},mounted(){this.selectedDepartment=this.$route.query.department||void 0,this.selectedStudio=this.$route.query.studio||void 0;const t=parseInt(this.$route.query.zoom)||1;this.zoomLevel=Math.min(Math.max(t,1),4),this.init()},computed:{...$(["daysOff","departmentMap","displayedPeople","getProductionTaskTypes","openProductions","organisation","productionMap","studios","taskTypeMap","user"]),locale(){return this.user.locale==="fr_FR"?u.fr:u.en},daysOffByPerson(){return this.daysOff.reduce((t,e)=>(t[e.person_id]||(t[e.person_id]=[]),t[e.person_id].push(e),t),{})},selectablePeople(){let t=this.displayedPeople.filter(e=>!e.is_bot);return this.selectedDepartment&&(t=t.filter(e=>e.departments.includes(this.selectedDepartment))),this.selectedStudio&&(t=t.filter(e=>e.studio_id===this.selectedStudio)),t},productionList(){return this.addAllValue(this.openProductions)},taskTypeList(){const t=this.filters.productionId,e=this.getProductionTaskTypes(t).filter(s=>s.for_entity!=="Concept");return this.addAllValue(e)}},methods:{...I(["assignSelectedTasks","fetchPersonTasks","getPersonsTasksDates","loadDaysOff","loadOpenTasks","loadPeople","unassignPersonFromTask","updateTask"]),addAllValue(t){return[{id:"",color:"#999",name:this.$t("main.all"),short_name:this.$t("main.all")},...t]},async init(){await this.loadPeople(),await this.loadPersonDates(),await this.loadDaysOff(),this.refreshSchedule(),this.scrollScheduleToToday(),this.startDate=o(),this.endDate=o().add(3,"months"),Object.values(this.personDates).forEach(t=>{t.startDate.isBefore(this.startDate)&&(this.startDate=t.startDate.clone()),t.endDate.isAfter(this.endDate)&&(this.endDate=t.endDate.clone())}),this.selectedStartDate=this.startDate.toDate(),this.selectedEndDate=this.endDate.toDate()},toggleTaskSidePanel(){this.isTaskSidePanelOpen=!this.isTaskSidePanelOpen,this.isTaskSidePanelOpen||(this.unassignedTasks=[],this.errors.unassignedTasks=!1)},async loadUnassignedTasks(t=!1){this.loading.unassignedTasks=!0,this.errors.unassignedTasks=!1;const e=t?this.pagination.unassignedTasks+1:1;try{const{data:s,is_more:a,stats:i}=await this.loadOpenTasks({limit:20,page:e,person_id:"unassigned",project_id:this.filters.productionId,task_type_id:this.filters.taskTypeId});t?this.pagination.unassignedTasks++:this.unassignedTasks=[],this.unassignedTasks=this.unassignedTasks.concat(s.map(d=>{var c;return{...d,full_name:`${d.entity_type_name} / ${d.entity_name} / ${d.type_name}`,man_days:l(this.organisation,d.estimation),department:this.departmentMap.get((c=this.taskTypeMap.get(d.task_type_id))==null?void 0:c.department_id),production:this.productionMap.get(d.project_id)}})),this.totalUnassignedTasks=i.total,this.loading.hasMoreUnassignedTasks=a}catch(s){this.errors.unassignedTasks=!0,console.error(s)}this.loading.unassignedTasks=!1},async loadPersonDates(t=!1){const e=await this.getPersonsTasksDates();this.personDates={},e.forEach(s=>{this.personDates[s.person_id]={endDate:n(s.max_date),startDate:n(s.min_date)}}),t&&this.scheduleItems.forEach(s=>{const a=this.personDates[s.id];a&&(s.startDate=a.startDate,s.endDate=a.endDate)})},refreshSchedule(){const t=this.selectedPerson?[this.selectedPerson]:this.selectablePeople;this.scheduleItems=this.convertScheduleItems(t)},convertScheduleItems(t){return t.map(e=>{let s=o(),a=o();const i=this.personDates[e.id];return i&&i.startDate&&i.endDate&&(s=n(i.startDate),a=n(i.endDate)),{...e,avatar:!0,color:e.color||w.fromString(e.name,!0),startDate:s,endDate:a,expanded:!1,loading:!1,editable:!1,route:M(e.id,"schedule"),children:[],daysOff:this.daysOffByPerson[e.id]}})},buildTaskScheduleItem(t,e){let s=o(),a;if(!e.start_date||!e.due_date)return null;e.start_date&&(s=n(e.start_date)),e.due_date?a=n(e.due_date):e.end_date?a=n(e.end_date):e.estimation&&(a=p(e.startDate,Math.ceil(l(this.organisation,e.estimation))-1,e.parentElement.daysOff)),(!a||a.isBefore(s))&&(a=s.clone().add(1,"days"));const i=this.taskTypeMap.get(e.task_type_id);return{...e,name:`${e.full_entity_name} / ${i.name}`,startDate:s,endDate:a,man_days:e.estimation,editable:!0,unresizable:!1,color:i.color,parentElement:t}},saveTaskScheduleItem(t){return this.updateTask({taskId:t.id,data:{start_date:t.startDate.format("YYYY-MM-DD"),due_date:t.endDate.format("YYYY-MM-DD"),estimation:t.estimation}})},onTaskDragStart(t,e){t.stopPropagation(),t.target.classList.add("drag"),t.dataTransfer.dropEffect="move",t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("taskId",e.id),this.draggedTasks=[e]},onTaskDrag(t){t.stopPropagation(),t.target.classList.add("dragging")},onTaskDragEnd(t){t.target.classList.remove("drag"),t.target.classList.remove("dragging"),this.draggedTasks=[]},async onScheduleItemDropped(t,e,s){if(t.type==="Task"){const a=this.buildTaskScheduleItem(e,t);e.children.push(a),e.children.sort(r.firstBy("startDate").thenBy("project_name").thenBy("name")),s&&s(e),await this.assignSelectedTasks({personId:e.id,taskIds:[a.id]}),await this.saveTaskScheduleItem(a),await this.loadUnassignedTasks()}},async onScheduleItemChanged(t){t.type==="Task"&&(t.estimation&&(t.endDate=p(t.startDate,Math.ceil(l(this.organisation,t.estimation))-1,t.parentElement.daysOff)),await this.saveTaskScheduleItem(t),await this.loadPersonDates(!0),await this.loadDaysOff())},onScheduleItemAssigned(t,e){t.type==="Task"&&(e.children.sort(r.firstBy("startDate").thenBy("project_name").thenBy("name")),this.assignSelectedTasks({personId:e.id,taskIds:[t.id]}))},onScheduleItemUnassigned(t,e){t.type==="Task"&&this.unassignPersonFromTask({person:e,task:t})},async expandPersonElement(t,e){if(t.expanded=!t.expanded,!!t.expanded){t.loading=!0,t.children=[];try{const s=await this.fetchPersonTasks(t.id);t.children=s.map(a=>this.buildTaskScheduleItem(t,a)).filter(Boolean).sort(r.firstBy("startDate").thenBy("project_name").thenBy("name")),e&&e(t)}catch(s){console.error(s)}t.loading=!1}},onUpdateSelectedStartDate(t){this.startDate=n(t)},onUpdateSelectedEndDate(t){this.endDate=n(t)},scrollScheduleToToday(){var t;(t=this.$refs.schedule)==null||t.scrollToToday()},updateRoute({department:t,studio:e,zoom:s}){const a={...this.$route.query};t!==void 0&&(a.department=t||void 0),e!==void 0&&(a.studio=e||void 0),s!==void 0&&(a.zoom=String(s)),JSON.stringify(a)!==JSON.stringify(this.$route.query)&&this.$router.push({query:a})}},watch:{selectedDepartment(t){this.updateRoute({department:t}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedStudio(t){this.updateRoute({studio:t}),this.selectedPerson&&!this.selectablePeople.includes(this.selectedPerson)&&this.$refs["people-field"].clear(),this.refreshSchedule()},selectedPerson(){this.refreshSchedule()},zoomLevel(t){this.updateRoute({zoom:t})},isTaskSidePanelOpen:{immediate:!0,handler(){this.isTaskSidePanelOpen&&this.loadUnassignedTasks()}}},metaInfo(){return{title:`${this.$t("team_schedule.title_main")} - Kitsu`}}};var z=function(){var e=this,s=e._self._c;return s("div",{staticClass:"columns fixed-page"},[s("div",{staticClass:"column main-column"},[s("div",{staticClass:"flexrow project-dates"},[s("div",{staticClass:"flexrow-item"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.start_date"))+" ")]),s("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:e.locale,"monday-first":!0,typeable:!0,format:"yyyy-MM-dd"},on:{selected:e.onUpdateSelectedStartDate},model:{value:e.selectedStartDate,callback:function(a){e.selectedStartDate=a},expression:"selectedStartDate"}})],1),s("div",{staticClass:"flexrow-item"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.end_date"))+" ")]),s("datepicker",{attrs:{"wrapper-class":"datepicker","input-class":"date-input input short",language:e.locale,"monday-first":!0,typeable:!0,format:"yyyy-MM-dd"},on:{selected:e.onUpdateSelectedEndDate},model:{value:e.selectedEndDate,callback:function(a){e.selectedEndDate=a},expression:"selectedEndDate"}})],1),s("combobox-number",{staticClass:"flexrow-item zoom-level",attrs:{label:e.$t("schedule.zoom_level"),options:e.zoomOptions},model:{value:e.zoomLevel,callback:function(a){e.zoomLevel=a},expression:"zoomLevel"}}),s("combobox-department",{staticClass:"flexrow-item",attrs:{label:e.$t("main.department")},model:{value:e.selectedDepartment,callback:function(a){e.selectedDepartment=a},expression:"selectedDepartment"}}),s("combobox-studio",{staticClass:"flexrow-item",attrs:{label:e.$t("main.studio")},model:{value:e.selectedStudio,callback:function(a){e.selectedStudio=a},expression:"selectedStudio"}}),s("div",{staticClass:"flexrow-item people-filter"},[s("label",{staticClass:"label"},[e._v(" "+e._s(e.$t("main.person"))+" ")]),s("people-field",{ref:"people-field",attrs:{people:e.selectablePeople,placeholder:e.$t("team_schedule.person_placeholder"),wide:""},model:{value:e.selectedPerson,callback:function(a){e.selectedPerson=a},expression:"selectedPerson"}})],1),s("div",{staticClass:"filler"}),s("div",{staticClass:"flexrow"},[s("button-simple",{staticClass:"flexrow-item",attrs:{icon:"clock",text:e.$t("schedule.today")},on:{click:e.scrollScheduleToToday}}),s("button-simple",{staticClass:"flexrow-item",attrs:{active:e.isTaskSidePanelOpen,icon:"list",text:e.$t("tasks.unassigned_tasks")},on:{click:e.toggleTaskSidePanel}})],1)],1),s("schedule",{ref:"schedule",attrs:{"dragged-items":e.draggedTasks,"end-date":e.endDate,"hide-man-days":!0,hierarchy:e.scheduleItems,"is-error":e.errors.schedule,"is-estimation-linked":!0,multiline:!0,reassignable:!0,"start-date":e.startDate,"with-milestones":!1,"zoom-level":e.zoomLevel},on:{"item-assign":e.onScheduleItemAssigned,"item-changed":e.onScheduleItemChanged,"item-drop":e.onScheduleItemDropped,"item-unassign":e.onScheduleItemUnassigned,"root-element-expanded":e.expandPersonElement}})],1),e.isTaskSidePanelOpen?s("div",{staticClass:"column side-column"},[s("task-info",[s("a",{staticClass:"close-button",on:{click:e.toggleTaskSidePanel}},[e._v("x")]),s("h2",{staticClass:"mt1"},[e._v(" "+e._s(e.$t("tasks.unassigned_tasks"))+" "),e.loading.unassignedTasks?e._e():[e._v(" ("+e._s(e.totalUnassignedTasks)+") ")]],2),s("div",{staticClass:"mb2"},[s("combobox-production",{staticClass:"mb05",attrs:{label:e.$t("main.production"),"production-list":e.productionList},on:{input:function(a){return e.loadUnassignedTasks()}},model:{value:e.filters.productionId,callback:function(a){e.$set(e.filters,"productionId",a)},expression:"filters.productionId"}}),s("combobox-task-type",{staticClass:"mb05",attrs:{label:e.$t("news.task_type"),"task-type-list":e.taskTypeList},on:{input:function(a){return e.loadUnassignedTasks()}},model:{value:e.filters.taskTypeId,callback:function(a){e.$set(e.filters,"taskTypeId",a)},expression:"filters.taskTypeId"}})],1),e.unassignedTasks.length>0?[s("ul",{staticClass:"task-list"},e._l(e.unassignedTasks,function(a){return s("li",{key:a.id,staticClass:"task-item",attrs:{draggable:""},on:{dragstart:function(i){return e.onTaskDragStart(i,a)},drag:e.onTaskDrag,dragend:e.onTaskDragEnd}},[s("div",{staticClass:"ui-droppable",style:{borderColor:a.type_color}},[s("div",{staticClass:"flexrow"},[s("div",{staticClass:"flexrow-item filler"},[s("production-name",{staticClass:"strong mb05",attrs:{production:a.production,size:25}}),s("div",{staticClass:"ellipsis"},[e._v(e._s(a.full_name))]),a.man_days?s("em",[e._v(" "+e._s(e.$t("main.estimation"))+": "+e._s(a.man_days)+" "+e._s(e.$tc("main.man_days",a.man_days))+" ")]):e._e()],1),a.entity_preview_file_id?s("entity-thumbnail",{staticClass:"task-thumbnail flexrow-item",attrs:{"preview-file-id":a.entity_preview_file_id}}):e._e()],1),a.department?s("department-name",{staticClass:"task-department",attrs:{department:a.department,"no-padding":"","only-dot":""}}):e._e()],1)])}),0),e.loading.hasMoreUnassignedTasks?s("div",{staticClass:"has-text-centered"},[e.loading.unassignedTasks?s("spinner",{staticClass:"mt2"}):s("button",{staticClass:"button mt2",on:{click:function(a){return e.loadUnassignedTasks(!0)}}},[e._v(" "+e._s(e.$t("main.load_more"))+" ")])],1):e._e()]:e.loading.unassignedTasks?s("div",[s("spinner",{staticClass:"mt2"})],1):e.errors.unassignedTasks?s("div",[s("table-info",{attrs:{"is-error":""}}),s("div",{staticClass:"has-text-centered pa1"},[s("button-simple",{staticClass:"has-text-centered",attrs:{text:e.$t("main.reload")},on:{click:function(a){return e.loadUnassignedTasks()}}})],1)],1):s("div",{staticClass:"has-text-centered"},[s("em",[e._v(e._s(e.$t("main.no_results")))])])],2)],1):e._e()])},L=[],B=O(U,z,L,!1,null,"736a7273");const Y=B.exports;export{Y as default};
//# sourceMappingURL=TeamSchedule-JvJz7nn5.js.map
